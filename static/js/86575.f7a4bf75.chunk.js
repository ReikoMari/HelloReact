"use strict";(self.webpackChunkhelloworld=self.webpackChunkhelloworld||[]).push([[86575],{78677:(e,t,i)=>{i.d(t,{A:()=>m,a:()=>g,b:()=>_});var n,r,s,a,o,l,c=i(57528),h=i(73398),d=i(64839),u=i(32307),p=i(70367);class m extends d.Y{}function _(e){const t=new u.N5;t.include(h.c),t.fragment.uniforms.add(new p.N("colorTexture",(e=>e.color)),new p.N("depthTexture",(e=>e.depth)));const i=e.haze;return t.fragment.code.add((0,d.H)(n||(n=(0,c.A)(["\n    void main() {\n      "," depthSample = texture(depthTexture, uv) ",";\n      if (depthSample "," ) {\n          fragColor = vec4(0);\n          return;\n      }\n      fragColor = texture(colorTexture, uv);\n    }\n    "])),i?(0,d.H)(r||(r=(0,c.A)(["vec4"]))):(0,d.H)(s||(s=(0,c.A)(["float"]))),i?"":(0,d.H)(a||(a=(0,c.A)([".r"]))),i?(0,d.H)(o||(o=(0,c.A)(["== vec4(0)"]))):(0,d.H)(l||(l=(0,c.A)(["!= 1.0"]))))),t}const g=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:m,build:_},Symbol.toStringTag,{value:"Module"}))},28590:(e,t,i)=>{i.d(t,{B:()=>y,a:()=>o,b:()=>v});var n,r,s,a,o,l,c=i(57528),h=i(10909),d=i(79360),u=i(25252),p=i(5517),m=i(21390),_=i(64839),g=i(32307),f=i(70367);function v(e){const t=new g.N5;if(t.include(u.W),e.background===o.Only){const i=e.output===d.xV.ColorComposite;return i?t.fragment.uniforms.add(new p.t("backgroundColor",(e=>e.backgroundColor))):t.fragment.include(h.z),t.fragment.code.add((0,_.H)(n||(n=(0,c.A)(["\n    void main() {\n      fragColor = vec4(",", 1.0);\n    }\n  "])),i?(0,_.H)(r||(r=(0,c.A)(["backgroundColor"]))):(0,_.H)(s||(s=(0,c.A)(["gridColor(uv)"]))))),t}return t.include(d.Pt,e),t.fragment.uniforms.add(new f.N("tex",(e=>e.texture))),t.fragment.uniforms.add(new m.m("opacity",(e=>e.opacity))),t.fragment.code.add((0,_.H)(a||(a=(0,c.A)(["void main() {\nvec4 bgColor = getBackground(uv);\nfragColor = blendLayers(bgColor, texture(tex, uv), opacity);\n}"])))),t}(l=o||(o={}))[l.BelowLayer=0]="BelowLayer",l[l.Only=1]="Only",l[l.COUNT=2]="COUNT";const y=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return o},build:v},Symbol.toStringTag,{value:"Module"}))},32581:(e,t,i)=>{i.d(t,{B:()=>d,b:()=>h});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(70367);const c={maxSearchSteps:8,maxDistanceAreaTex:16};function h(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("edgesTexture",(e=>e.inputTexture)),new l.N("areaTexture",(e=>e.areaTexture)),new l.N("searchTexture",(e=>e.searchTexture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["\n    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )\n    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )\n\n    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {\n      return texture(tex, coord + offset.x * resolution, 0.0);\n    }\n\n    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {\n      e.r = bias + e.r * scale;\n      return 255.0 * texture( searchTex, e, 0.0 ).r;\n    }\n\n    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x += 0.25 * resolution.x;\n      texcoord.x += resolution.x;\n      texcoord.x += 2.0 * resolution.x;\n      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);\n      return texcoord.x;\n    }\n\n    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 0.0, 1.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 2.0, 0.0 ) * resolution;\n        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n      }\n      texcoord.x -= 0.25 * resolution.x;\n      texcoord.x -= resolution.x;\n      texcoord.x -= 2.0 * resolution.x;\n      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );\n      return texcoord.x;\n    }\n\n    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord += vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y -= 0.25 * resolution.y;\n      texcoord.y -= resolution.y;\n      texcoord.y -= 2.0 * resolution.y;\n      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );\n      return texcoord.y;\n    }\n\n    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {\n      vec2 e = vec2( 1.0, 0.0 );\n      for ( int i = 0; i < ","; i ++ ) {\n        e = texture( edgesTex, texcoord, 0.0 ).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * resolution;\n        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n      }\n      texcoord.y += 0.25 * resolution.y;\n      texcoord.y += resolution.y;\n      texcoord.y += 2.0 * resolution.y;\n      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );\n      return texcoord.y;\n    }\n\n    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n      vec2 texcoord = float( "," ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n      return texture( areaTex, texcoord, 0.0 ).rg;\n    }\n\n    void main() {\n      vec2 size = vec2(textureSize(edgesTexture, 0));\n      vec2 resolution = 1.0 / size;\n      vec2 pixelCoord = uv * size;\n      vec4 offsets[2];\n      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );\n      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );\n      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( "," );\n\n      ivec4 subsampleIndices = ivec4(0.0);\n      vec4 weights = vec4(0.0);\n      vec2 e = texture( edgesTexture, uv ).rg;\n      if ( e.g > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );\n        coords.y = offsets[1].y;\n        d.x = coords.x;\n        float e1 = texture( edgesTexture, coords, 0.0 ).r;\n        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );\n        d.y = coords.x;\n        d = d * size.x - pixelCoord.x;\n        vec2 sqrt_d = sqrt( abs(d) );\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;\n        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n      }\n\n      if ( e.r > 0.0 ) {\n        vec2 d;\n        vec2 coords;\n        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );\n        coords.x = offsets[0].x;\n        d.x = coords.y;\n        float e1 = texture( edgesTexture, coords, 0.0 ).g;\n        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );\n        d.y = coords.y;\n        d = d * size.y - pixelCoord.y;\n        vec2 sqrt_d = sqrt(abs(d));\n        coords.y -= 1.0 * resolution.y;\n        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;\n        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\n        // for some reason the following lines are necessary to prevent\n        // texture lookup precision issues on some Intel integrated graphics chips\n        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);\n        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);\n      }\n      fragColor = weights;\n    }"])),a.H.int(c.maxSearchSteps),a.H.int(c.maxSearchSteps),a.H.int(c.maxSearchSteps),a.H.int(c.maxSearchSteps),a.H.int(c.maxDistanceAreaTex),a.H.int(c.maxSearchSteps))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},58090:(e,t,i)=>{i.d(t,{B:()=>h,b:()=>c});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(70367);function c(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("blendWeightsTexture",(e=>e.inputTexture)),new l.N("colorTexture",(e=>e.color))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["void main() {\nvec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\nvec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\nvec4 a;\na.rb = texture(blendWeightsTexture, uv).rb;\na.g = texture(blendWeightsTexture, offsets.zw).g;\na.a = texture(blendWeightsTexture, offsets.xy).a;\nif ( dot(a, vec4(1.0)) < 1e-5 ) {\nfragColor = texture( colorTexture, uv, 0.0 );\n} else {\nvec2 offset;\noffset.x = a.a > a.b ? a.a : -a.b;\noffset.y = a.g > a.r ? -a.g : a.r;\nif ( abs( offset.x ) > abs( offset.y )) {\noffset.y = 0.0;\n} else {\noffset.x = 0.0;\n}\nvec4 C = texture( colorTexture, uv, 0.0 );\nvec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );\nfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\nfragColor = mix(C, Cop, s);\n}\n}"])))),e}const h=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},60071:(e,t,i)=>{i.d(t,{C:()=>j,a:()=>W,b:()=>q});var n,r,s,a,o,l,c,h,d,u,p,m,_,g,f,v,y,b,w,x,C=i(57528),T=i(34761),A=i(13191),M=i(9392),S=i(45462),P=i(97808),R=i(65058),E=i(94759),O=i(43557),D=i(95756),I=i(5517),L=i(58350),N=i(21390),F=i(64839),V=i(43425),H=i(32307),U=i(70367),z=i(66470);const q=(0,M.fA)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),G=(0,M.fA)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),B=3996e-9,k=(0,M.fA)(parseFloat(Number(q[0]+G[0]).toFixed(6)),parseFloat(Number(q[1]+G[1]).toFixed(6)),parseFloat(Number(q[2]+G[2]).toFixed(6)));function W(e){const t=new H.N5;t.attributes.add(z.r.POSITION,"vec2"),t.include(P.U,{textureCoordinateType:P.q.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:A}=t;return i.uniforms.add(new V.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new V.X("inverseViewMatrix",((e,t)=>(0,T.Qw)(Z,t.camera.viewMatrix)))),i.code.add((0,F.H)(n||(n=(0,C.A)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),A.uniforms.add(new I.t("backgroundColor",(e=>e.backgroundColor)),new D.G("radii",(e=>e.radii)),new I.t("cameraPosition",((e,t)=>t.camera.eye)),new L.E("heightParameters",(e=>e.heightParameters)),new N.m("innerFadeDistance",(e=>e.innerFadeDistance)),new N.m("altitudeFade",(e=>e.altitudeFade)),new U.N("depthTexture",(e=>e.depthTexture)),new N.m("hazeStrength",(e=>e.hazeStrength))),A.constants.add("betaRayleigh","vec3",q),A.constants.add("betaCombined","vec3",k),A.constants.add("betaMie","float",B),A.constants.add("scaleHeight","float",S.nv*S.yv),(0,O.Gc)(A),t.include(E.C),e.haze&&(A.include(R.D),A.uniforms.add(new D.G("nearFar",((e,t)=>t.camera.nearFar)))),A.code.add((0,F.H)(r||(r=(0,C.A)(["vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = planet ? heightParameters[1] - radius * radius : heightParameters[2];\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),A.code.add((0,F.H)(s||(s=(0,C.A)(["float chapmanApproximation(float X, float h, float cosZenith) {\nfloat c = sqrt(X + h);\nfloat cExpH = c * exp(-h);\nif (cosZenith >= 0.0) {\nreturn cExpH / (c * cosZenith + 1.0);\n} else {\nfloat x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);\nfloat c0 = sqrt(x0);\nreturn 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);\n}\n}"])))),A.code.add((0,F.H)(a||(a=(0,C.A)(["float getOpticalDepth(vec3 position, vec3 dir, float h) {\nreturn scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));\n}"])))),A.code.add((0,F.H)(o||(o=(0,C.A)(["\n    const int STEPS = 6;\n\n    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {\n      float reducedPlanetRadius = radii[0] - 20000.0;\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);\n      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);\n      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;\n      bool insideAtmosphere = heightParameters[0] < radii[1];\n\n      if (!(hitsAtmosphere || insideAtmosphere)) {\n        return vec3(0);\n      }\n\n      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;\n\n      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;\n\n      if (heightParameters[0] < reducedPlanetRadius) {\n        // Long light rays from the night side of the planet lead to numerical instability\n        // Do not render the atmosphere in such cases\n        if (dot(rayDir, normalize(cameraPos)) < -0.025) {\n          return vec3(0);\n        }\n        start = rayPlanetIntersect.y;\n      }\n\n      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;\n      float maxEnd = end;\n\n      ","\n\n      vec3 samplePoint = cameraPos + rayDir * end;\n      float multiplier = hitsPlanet ? -1.0 : 1.0;\n\n      vec3 scattering = vec3(0);\n      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);\n      float stepSize = (end - start) / float(STEPS);\n      for (int i = 0; i < STEPS; i++) {\n        samplePoint -= stepSize * rayDir;\n        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);\n\n        if (i > 0) {\n          scattering *= "," exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));\n        }\n\n        if (dot(normalize(samplePoint), lightDir) > -0.3) {\n\n          float scale = exp(-scaleFract);\n          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);\n\n          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);\n          ","\n        }\n\n        lastOpticalDepth = opticalDepth;\n\n      }\n\n      float mu = dot(rayDir, lightDir);\n      float mumu = 1.0 + mu * mu;\n\n      float phaseRayleigh = 0.0596831 * mumu;\n\n      ","\n    }\n\n    ","\n\n    ","\n\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n      ","\n\n      ","\n\n      col = tonemapACES(col);\n      fragColor = delinearizeGamma(vec4(col, alpha));\n      ","\n    }\n  "])),e.haze?(0,F.H)(l||(l=(0,C.A)(["if (terrainDepth != -1.0) { end = terrainDepth; }"]))):"",e.haze?"":(0,F.H)(c||(c=(0,C.A)(["mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "]))),e.haze?"":(0,F.H)(h||(h=(0,C.A)(["scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);"]))),e.haze?(0,F.H)(d||(d=(0,C.A)(["return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;"]))):(0,F.H)(u||(u=(0,C.A)(["\n            const float g = 0.8;\n            const float gg = g * g;\n            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;\n            phaseMie = clamp(phaseMie, 0.0, 128.0);\n            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);"]))),e.haze?"":(0,F.H)(p||(p=(0,C.A)(["\n            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {\n              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);\n              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {\n                return fragColor;\n              }\n\n              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));\n              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);\n              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;\n              if (relDist > 1.0) {\n                return surfaceColor;\n              }\n\n              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));\n            }\n\n            float getGlow(float dist, float radius, float intensity) {\n              return pow(radius / max(dist, 1e-6), intensity);\n            }\n\n            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){\n\n              // Get the amount of atmosphere between camera and the Sun along the view ray\n              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;\n              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));\n\n              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray\n              // This will make the colour of the Sun reddish on the horizon and white from space\n              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));\n\n              // Alignment of light direction and view ray\n              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);\n              // Draw the Sun as a bright disc\n              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));\n\n              return normalize(sunTransmittance) * sunDisc;\n            }"]))),e.haze&&e.reduced?(0,F.H)(m||(m=(0,C.A)(["\n        float getDepth(vec2 uv){\n          return linearDepthFromTexture(depthTexture, uv, nearFar);\n        }\n\n        float textureBilinear(vec2 uv) {\n          // Information about the high-resolution depth texture\n          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));\n          vec2 texelSize = 1.0 / depthTextureSize;\n\n          // The uv inside the upper right pixel - of the tile of 4 pixels -\n          // that the atmosphere uv maps to in the depth texture\n          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);\n\n          // Relative distance of the uv coordinates inside the depth texture pixel\n          vec2 f = fract(depthUV);\n\n          // Snap to the centre of the depth texture pixel\n          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;\n\n          // Read the depth texture pixel and its three neighbours\n          float d0 = getDepth(snapUV);\n          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));\n          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));\n          float d3 = getDepth(snapUV + texelSize);\n\n          // Return the bilinearly interpolated value of the neighbouring pixels based\n          // on the sample position in the depth texture pixel\n          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);\n        }\n        "]))):"",e.haze?(0,F.H)(_||(_=(0,C.A)(["\n          vec4 depthSample = texture(depthTexture, vuv0).rgba;\n          if (depthSample != vec4(0)) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n\n              ","\n\n            terrainDepth = max(0.0, length(cameraSpaceRay));\n          }else{\n            discard;\n          }\n          "])),e.reduced?(0,F.H)(g||(g=(0,C.A)(["cameraSpaceRay *= -textureBilinear(vuv0);"]))):(0,F.H)(f||(f=(0,C.A)(["cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0, nearFar);"])))):(0,F.H)(v||(v=(0,C.A)(["",""])),e.reduced?"":(0,F.H)(y||(y=(0,C.A)(["\n                float depthSample = texture(depthTexture, vuv0).r;\n                if (depthSample != 1.0) {\n                  fragColor = vec4(0);\n                  return;\n                }"])))),e.haze?(0,F.H)(b||(b=(0,C.A)(["\n            vec3 col = vec3(0);\n            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);\n            if(depthSample != vec4(0)){\n              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            }\n            // Alpha is ignored for haze blending\n            float alpha = 1.0;\n            "]))):(0,F.H)(w||(w=(0,C.A)(["\n            vec3 col = linearizeGamma(backgroundColor);\n            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            col += getSun(cameraPosition, rayDir, mainLightDirection);\n            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));"]))),e.haze?"":(0,F.H)(x||(x=(0,C.A)(["fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);"]))))),t}const Z=(0,A.vt)(),j=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:q,build:W},Symbol.toStringTag,{value:"Module"}))},16619:(e,t,i)=>{i.d(t,{C:()=>P,a:()=>O,b:()=>R});var n,r,s,a,o,l,c,h,d,u,p=i(57528),m=i(15941),_=i(44680),g=i(19555),f=i(72745),v=i(46141),y=i(60645),b=i(89426),w=i(73398),x=i(95756),C=i(21390),T=i(64839),A=i(72106),M=i(32307),S=i(70367);class P extends T.Y{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=v.n.default.raymarchingSteps,this.weatherTile=(0,f.vt)(),this.viewMatrix=(0,_.vt)()}}function R(e){const t=new M.N5;t.include(w.c,!1);const i=t.fragment;return i.uniforms.add(new C.m("cloudRadius",(e=>e.cloudRadius)),new C.m("power",(e=>(0,m.Cc)(35,120,e.absorption))),new C.m("sigmaE",(e=>1+e.absorption)),new C.m("density",(e=>(0,m.Cc)(0,.3,e.density))),new C.m("cloudSize",(e=>(0,m.Cc)(0,.02,Math.max(.01,1-e.cloudSize)))),new C.m("detailSize",(e=>(0,m.Cc)(0,.2,Math.max(.01,1-e.detailSize)))),new C.m("smoothness",(e=>(0,m.Cc)(0,.5,1-e.smoothness))),new C.m("cloudHeight",(e=>(0,m.Cc)(0,1500,e.cloudHeight))),new C.m("coverage",(e=>e.coverage)),new A.k("view",(e=>e.viewMatrix)),new S.N("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new x.G("cloudVariables",(e=>(0,g.hZ)(E,e.coverage,e.absorption)))),i.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),i.code.add((0,T.H)(n||(n=(0,p.A)(["\n    const int STEPS = ",";\n    const int STEPS_LIGHT = 6;\n    const float stepL = 300.0 / float(STEPS_LIGHT);\n    const float cloudStart = 1500.0;\n\n    vec3 rayDirection(vec2 fragCoord) {\n      vec2 xy = fragCoord - halfCubeMapSize;\n      return normalize(vec3(-xy, -halfCubeMapSize));\n    }\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }"])),e.steps===y.p.SIXTEEN?(0,T.H)(r||(r=(0,p.A)(["16"]))):e.steps===y.p.HUNDRED?(0,T.H)(s||(s=(0,p.A)(["100"]))):(0,T.H)(a||(a=(0,p.A)(["200"]))))),i.code.add((0,T.H)(o||(o=(0,p.A)(["\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = ",";\n      const float dataWidth = ",";\n      const float tileRows = ",";\n      const vec3 atlasDimensions = vec3(",", ",", tileRows * tileRows);\n\n      //Change from Y being height to Z being height\n      vec3 p = float(",") * pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }\n\n    float getCloudMap(vec2 p){\n      // Shift the texture center to origin to avoid seam artifacts\n      vec2 uv = ("," * p) / "," + 0.5;\n\n      return texture(cloudShapeTexture, uv).a;\n    }\n    "])),T.H.float(b.jj),T.H.float(b.jj),T.H.float(b.ik),T.H.float(b.CQ),T.H.float(b.CQ),T.H.float(b.Y8),T.H.float(b.fI),T.H.float(b.jj))),i.code.add((0,T.H)(l||(l=(0,p.A)(["float clouds(vec3 p) {\nfloat cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat cloudMap = getCloudMap(cloudSize * p.xy);\ncloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat shape = getCloudShape(8.0 * cloudSize * p, 0.0);\ncloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\ncloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nreturn density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n}"])))),i.code.add((0,T.H)(c||(c=(0,p.A)(["vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = dot(start, start) - (radius * radius);\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}\nfloat HenyeyGreenstein(float g, float costh) {\nreturn (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n}"])))),i.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),i.code.add((0,T.H)(h||(h=(0,p.A)(["float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\nfloat lightRayDensity = clouds(p);\nlightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\nfloat beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\nreturn mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n}"])))),i.code.add((0,T.H)(d||(d=(0,p.A)(["float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\nif (dir.z < 0.0) {\nreturn 0.0;\n}\ntotalTransmittance = 1.0;\nfloat stepS = totalDistance / float(STEPS);\nfloat cameraHeight = length(org);\nfloat mu = 0.5 + 0.5 * dot(sunDirection, dir);\nfloat phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\nvec3 p = org + distToStart  * dir;\nfloat dist = distToStart;\nfloat shading = 0.0;\nfor (int i = 0; i < STEPS; i++) {\nfloat sampleDensity = clouds(p);\nfloat sampleSigmaE = sampleDensity * sigmaE;\nif (sampleDensity > 0.0 ) {\nfloat ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\nfloat luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\nfloat transmittance = exp(-sampleSigmaE * stepS);\nshading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\ntotalTransmittance *= transmittance;\nif (totalTransmittance <= 0.001) {\ntotalTransmittance = 0.0;\nbreak;\n}\n}\ndist += stepS;\np = org + dir * dist;\n}\nreturn shading;\n}"])))),i.code.add((0,T.H)(u||(u=(0,p.A)(["void main() {\nif (coverage ==  0.0) {\nfragColor = vec4(0.0, 1.0, 0.0, 1.0);\nreturn;\n}\nvec3 rayDir = rayDirection(gl_FragCoord.xy);\nrayDir = normalize(view * rayDir);\nvec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\nbool hitsPlanet = rayDir.z < 0.0;\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat totalTransmittance = 1.0;\nfloat shading = 0.0;\nif (hitsPlanet) {\nshading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);\ntotalTransmittance = hazeFactor;\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\nreturn;\n}\nvec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\nvec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\nfloat distToStart = rayStartIntersect.y;\nfloat totalDistance = rayEndIntersect.y - distToStart;\nvec3 sunDirection = normalize(vec3(0, 0, 1));\nshading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);\nshading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);\ntotalTransmittance = mix(0.0, totalTransmittance, hazeFactor);\nfragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\n}"])))),t}const E=(0,f.vt)(),O=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:P,build:R},Symbol.toStringTag,{value:"Module"}))},2565:(e,t,i)=>{i.d(t,{C:()=>C,b:()=>w});var n,r,s=i(57528),a=i(34761),o=i(13191),l=i(50819),c=i(94759),h=i(43557),d=i(26719),u=i(36324),p=i(24475),m=i(80883),_=i(81449),g=i(5517),f=i(64839),v=i(43425),y=i(32307),b=i(66470);function w(){const e=new y.N5,{attributes:t,varyings:i,vertex:o,fragment:w}=e;return t.add(b.r.POSITION,"vec2"),i.add("worldRay","vec3"),o.uniforms.add(new v.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new v.X("inverseViewMatrix",((e,t)=>(0,a.Qw)(x,t.camera.viewMatrix)))),o.code.add((0,f.H)(n||(n=(0,s.A)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;\ngl_Position = vec4(position, 1.0, 1.0);\n}"])))),w.include(m.a),w.include(_.W),e.include(l.W,{pbrMode:d.A9.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(u.p),e.include(c.C),e.include(h.qU),e.include(p.g),w.uniforms.add(new g.t("cameraPosition",((e,t)=>t.camera.eye))),w.code.add((0,f.H)(r||(r=(0,s.A)(["void main() {\nvec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);\nfragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);\n}"])))),e}const x=(0,o.vt)(),C=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}))},42287:(e,t,i)=>{i.d(t,{C:()=>Re,b:()=>Pe});var n,r,s,a,o,l,c,h,d,u,p,m,_,g,f,v,y,b,w,x,C,T,A,M,S,P,R,E,O,D,I,L,N,F,V,H,U,z,q,G,B,k,W,Z,j,Q=i(57528),X=i(14556),Y=i(29898),$=i(44493),K=i(13545),J=i(28710),ee=i(72412),te=i(34981),ie=i(26917),ne=i(59046),re=i(97808),se=i(54478),ae=i(55386),oe=i(36358),le=i(49399),ce=i(48020),he=i(65058),de=i(90011),ue=i(72937),pe=i(21372),me=i(67799),_e=i(43557),ge=i(81993),fe=i(26719),ve=i(47331),ye=i(1773),be=i(12057),we=i(90235),xe=i(55806),Ce=i(81148),Te=i(64839),Ae=i(32307),Me=i(70367),Se=i(10773);function Pe(e){const t=new Ae.N5;t.include(oe.em,e),t.include(ae.Mh,e),t.include(se.c,e),t.include(re.U,e),t.include(ee.oD,e),t.include(K.cz,e),t.include(xe.H,e),t.include(ie.S4,e),t.include(ve.E,e),t.include(J.j,e);const{vertex:i,fragment:Pe}=t;e.pbrMode!==fe.A9.Normal&&e.pbrMode!==fe.A9.Schematic||(t.include(fe._Z,e),e.hasNormalTexture&&t.include(ue.W,e));const Re=e.output===te.V.Shadow||e.output===te.V.ShadowHighlight||e.output===te.V.ShadowExcludeHighlight;Re&&e.componentData===K.Sg.Varying?i.code.add((0,Te.H)(n||(n=(0,Q.A)(["#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"])))):i.code.add((0,Te.H)(r||(r=(0,Q.A)(["#define discardShadows(castShadows) {}"]))));const Ee=e.integratedMeshMode===$.g.ColorOverlay||e.integratedMeshMode===$.g.ColorOverlayWithWater,Oe=Ee&&e.output===te.V.Color&&e.pbrMode===fe.A9.WaterOnIntegratedMesh;return Ee&&(t.include(me.kA,e),t.include(be.Tv,e),e.spherical?i.code.add((0,Te.H)(s||(s=(0,Q.A)(["\n      const float invEllipsoidRadius = ",";\n      vec2 projectOverlay(vec3 pos) {\n        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);\n      }\n      "])),Te.H.float(1/(e.ellipsoidMode===Ce.T.Earth?X.$O.radius:e.ellipsoidMode===Ce.T.Mars?X.sH.radius:X.Sw.radius)))):i.code.add((0,Te.H)(a||(a=(0,Q.A)(["vec2 projectOverlay(vec3 pos) { return pos.xy; }"]))))),Oe&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add((0,Te.H)(o||(o=(0,Q.A)(["\n    void main() {\n      bool castShadows;\n      vec4 externalColor = forwardExternalColor(castShadows);\n      discardShadows(castShadows);\n\n      vertexDiscardByOpacity(externalColor.a);\n\n      ","\n\n      if (externalColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      forwardPosition(readElevationOffset());\n      forwardNormal();\n      forwardTextureCoordinates();\n      forwardVertexColor();\n      forwardLinearDepth();\n      ","\n      ","\n      ","\n    }\n  "])),e.output===te.V.ObjectAndLayerIdColor?(0,Te.H)(l||(l=(0,Q.A)(["externalColor.a = 1.0;"]))):"",Te.H.float(we.y),e.output===te.V.ObjectAndLayerIdColor?(0,Te.H)(c||(c=(0,Q.A)(["forwardObjectAndLayerIdColor();"]))):"",Oe?e.spherical?(0,Te.H)(h||(h=(0,Q.A)(["\n                groundNormal = normalize(positionWorld());\n                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));\n                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));"]))):(0,Te.H)(d||(d=(0,Q.A)(["\n                groundNormal = vec3(0.0, 0.0, 1.0);\n                tbnTangent = vec3(1.0, 0.0, 0.0);\n                tbnBiTangent = vec3(0.0, 1.0, 0.0);"]))):"",Ee?(0,Te.H)(u||(u=(0,Q.A)(["setOverlayVTC(projectOverlay(position));"]))):"")),e.output===te.V.Alpha&&(Pe.include(he.D),t.include(ge.Q,e),t.include(de.o,e),Ee&&Pe.uniforms.add(new Me.N("ovColorTex",((e,t)=>(0,be.Lg)(e,t)))),Pe.code.add((0,Te.H)(p||(p=(0,Q.A)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n\n        fragColor = vec4(materialColor.a);\n      }\n    "])),e.multipassEnabled?(0,Te.H)(m||(m=(0,Q.A)(["terrainDepthTest(vPosition_view.z);"]))):"",Ee?(0,Te.H)(_||(_=(0,Q.A)(["\n                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);\n                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))),e.output===te.V.Color&&(Pe.include(he.D),t.include(ge.Q,e),t.include(de.o,e),t.include(pe.f,e),t.include(me.kA,e),e.receiveShadows?(t.include(ye.G,e),Pe.code.add((0,Te.H)(g||(g=(0,Q.A)(["float evaluateShadow() {\nreturn readShadowMap(vPositionWorldCameraRelative, linearDepth);\n}"]))))):Pe.code.add((0,Te.H)(f||(f=(0,Q.A)(["float evaluateShadow() { return 0.0; }"])))),Ee&&Pe.uniforms.add(new Me.N("ovColorTex",((e,t)=>(0,be.Lg)(e,t)))),Pe.code.add((0,Te.H)(v||(v=(0,Q.A)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n    "])),e.multipassEnabled?(0,Te.H)(y||(y=(0,Q.A)(["terrainDepthTest(vPosition_view.z);"]))):"",Ee?(0,Te.H)(b||(b=(0,Q.A)(["vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);"]))):"")),e.pbrMode===fe.A9.Normal||e.pbrMode===fe.A9.Schematic||e.pbrMode===fe.A9.Simplified?((0,_e.O4)(Pe),Pe.code.add((0,Te.H)(w||(w=(0,Q.A)(["\n        ","\n        vec3 normalVertex = shadingNormalWorld();\n        float additionalIrradiance = 0.02 * mainLightIntensity[2];\n      "])),e.pbrMode===fe.A9.Normal?(0,Te.H)(x||(x=(0,Q.A)(["\n                applyPBRFactors();\n                if (int(externalColorMixMode) == 3) {\n                  mrr = vec3(0.0, 0.6, 0.2);\n                }"]))):"")),e.hasNormalTexture?Pe.code.add((0,Te.H)(C||(C=(0,Q.A)(["mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);\nvec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])))):Pe.code.add((0,Te.H)(T||(T=(0,Q.A)(["vec3 shadingNormal = normalVertex;"])))),Pe.code.add((0,Te.H)(A||(A=(0,Q.A)(["","\n      "])),e.spherical?(0,Te.H)(M||(M=(0,Q.A)(["vec3 normalGround = normalize(positionWorld());"]))):(0,Te.H)(S||(S=(0,Q.A)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))))),Pe.code.add((0,Te.H)(P||(P=(0,Q.A)(["\n        vec3 viewDir = normalize(vPositionWorldCameraRelative);\n        ","\n        ","\n\n        ","\n\n        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());\n        ","\n        "])),e.pbrMode===fe.A9.Simplified?(0,Te.H)(R||(R=(0,Q.A)([" float ssao = 1.0 - evaluateAmbientOcclusionInverse();"]))):(0,Te.H)(E||(E=(0,Q.A)([" float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();"]))),e.snowCover?(0,Te.H)(O||(O=(0,Q.A)(["\n                vec3 surfaceNormal = normalize(shadingNormalWorld());\n                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\n                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);\n                ssao = mix(ssao, 0.5 * ssao, snow);\n                shadingNormal = mix(shadingNormal, surfaceNormal, snow);"]))):"",Ee?(0,Te.H)(D||(D=(0,Q.A)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",e.pbrMode===fe.A9.Simplified?(0,Te.H)(I||(I=(0,Q.A)([" vec4 shadedColor = vec4(evaluatePBRSimplifiedLighting(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround), materialColor.a);"]))):"vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);"))):(e.receiveShadows?Pe.code.add((0,Te.H)(L||(L=(0,Q.A)(["float shadow = evaluateShadow();"])))):e.spherical?((0,me.eU)(Pe),Pe.code.add((0,Te.H)(N||(N=(0,Q.A)(["float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());\nfloat shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);"]))))):Pe.code.add((0,Te.H)(F||(F=(0,Q.A)(["float shadow = 0.0;"])))),Oe&&Pe.uniforms.add(new Me.N("ovNormalTex",((e,t)=>{var i;return null===(i=t.overlay)||void 0===i?void 0:i.getTexture(Y.A.WaterNormal)}))),e.snowCover&&Pe.code.add((0,Te.H)(V||(V=(0,Q.A)(["vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));\nfloat snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\nmaterialColor.rgb = mix(materialColor.rgb, vec3(1), snow);"])))),Pe.code.add((0,Te.H)(H||(H=(0,Q.A)(["\n        float ambientOcclusion = evaluateAmbientOcclusion();\n        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());\n\n        ","\n\n        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);\n      ","\n      "])),Ee?(0,Te.H)(U||(U=(0,Q.A)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",Oe?(0,Te.H)(z||(z=(0,Q.A)(["\n              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):""))),Pe.code.add((0,Te.H)(q||(q=(0,Q.A)(["\n        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);\n        ","\n      }\n    "])),e.transparencyPassType===Se.y.Color?"fragColor = premultiplyAlpha(fragColor);":""))),(e.output===te.V.LinearDepth||Re)&&(t.include(le.L,e),Pe.code.add((0,Te.H)(G||(G=(0,Q.A)(["void main() {\ndiscardBySlice(vPositionWorldCameraRelative);\nvec4 textureColor = readBaseColorTexture();\ndiscardOrAdjustAlpha(textureColor);\noutputDepth(linearDepth);\n}"]))))),e.output===te.V.Normal&&(t.include(pe.f,e),Pe.code.add((0,Te.H)(B||(B=(0,Q.A)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,\n        // see the ssao fragment shader\n        float alpha = ",";\n        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);\n      }\n    "])),e.normalType===ne.W.Ground?"0.0":"1.0"))),e.output===te.V.ObjectAndLayerIdColor&&t.fragment.code.add((0,Te.H)(k||(k=(0,Q.A)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),Ee?(0,Te.H)(W||(W=(0,Q.A)(["fragColor = getOverlayColorTexel(vtcOverlay);"]))):"outputObjectAndLayerIdColor();")),e.output===te.V.Highlight&&(t.include(ce.Qh),Pe.code.add((0,Te.H)(Z||(Z=(0,Q.A)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n\n        outputHighlight();\n      }\n    "])),Ee?(0,Te.H)(j||(j=(0,Q.A)(["\n                vec4 overlayColor = getCombinedOverlayColor();\n                if (overlayColor.a == 0.0) {\n                  fragColor = vec4(0.0);\n                  return;\n                }"]))):""))),t}const Re=Object.freeze(Object.defineProperty({__proto__:null,build:Pe},Symbol.toStringTag,{value:"Module"}))},80517:(e,t,i)=>{i.d(t,{C:()=>h,a:()=>u,b:()=>d});var n,r=i(57528),s=i(73398),a=i(21390),o=i(64839),l=i(32307),c=i(70367);class h extends o.Y{constructor(){super(...arguments),this.opacity=1}}function d(e){const t=new l.N5;return t.include(s.c),t.fragment.uniforms.add(new c.N("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new a.m("opacity",(e=>e.opacity))),t.fragment.code.add((0,o.H)(n||(n=(0,r.A)(["\n    void main() {\n      fragColor = texture(tex, uv) ",";\n    }"])),e.hasOpacityFactor?"* opacity":"")),t}const u=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:h,build:d},Symbol.toStringTag,{value:"Module"}))},21199:(e,t,i)=>{i.d(t,{E:()=>d,b:()=>h});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(70367);const c={threshold:.05,localConstrastAdaption:2};function h(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("colorTexture",(e=>e.color))),e.outputs.add("fragEdges","vec2"),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["\n    float absMax3(vec3 v) {\n      vec3 t = abs(v);\n      return max(max(t.r, t.g), t.b);\n    }\n\n    void main() {\n      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));\n      vec4 offsets[3];\n      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);\n      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);\n      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);\n\n      // Calculate color deltas:\n      vec4 delta;\n      vec3 C = texture(colorTexture, uv).rgb;\n\n      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;\n      delta.x = absMax3(C - Cleft);\n\n      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;\n      delta.y = absMax3(C - Ctop);\n\n      vec2 edges = step(vec2(","), delta.xy);\n\n      // discard if there is no edge:\n      if (dot(edges, vec2(1.0)) == 0.0) {\n        discard;\n      }\n\n      // Calculate right and bottom deltas:\n      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;\n      delta.z = absMax3(C - Cright);\n\n      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;\n      delta.w = absMax3(C - Cbottom);\n\n      // Calculate the maximum delta in the direct neighborhood:\n      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n\n      // Calculate left-left and top-top deltas:\n      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;\n      delta.z = absMax3(C - Cleftleft);\n\n      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;\n      delta.w = absMax3(C - Ctoptop);\n\n      // Calculate the final maximum delta:\n      maxDelta = max(max(maxDelta, delta.z), delta.w);\n\n      // Local contrast adaptation in action:\n      edges *= step(maxDelta, float(",") * delta.xy);\n\n      fragEdges = edges;\n    }\n  "])),a.H.float(c.threshold),a.H.float(c.localConstrastAdaption))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},49249:(e,t,i)=>{i.d(t,{E:()=>R,b:()=>M});var n,r,s,a,o=i(57528),l=i(19555),c=i(72745),h=i(26917),d=i(81993),u=i(95756),p=i(58350),m=i(21390),_=i(64839),g=i(32307),f=i(7223),v=i(66470),y=i(78275),b=i(69466),w=i(80320),x=i(28014),C=i(27860),T=i(70690),A=i(35804);function M(e){const t=new g.N5,{vertex:i,fragment:c}=t;return e.legacy&&i.uniforms.add(new P("model"),new P("localView")),t.include(y.T,e),t.include(x.E7,e),t.include(C.C,e),t.include(A.A,e),t.include(T.u,e),t.include(h.HQ,e),t.include(w.W,e),t.include(b.M,e),t.include(d.Q,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),e.multipassEnabled&&t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add(new u.G("pixelToNDC",((e,t)=>(0,l.hZ)(S,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new p.E("viewport",((e,t)=>t.camera.fullViewport)),new m.m("pixelRatio",((e,t)=>t.camera.pixelRatio))),t.attributes.add(v.r.POSITION0,"vec3"),t.attributes.add(v.r.POSITION1,"vec3"),t.attributes.add(v.r.VARIANTOFFSET,"float"),t.attributes.add(v.r.VARIANTSTROKE,"float"),t.attributes.add(v.r.VARIANTEXTENSION,"float"),i.code.add((0,_.H)(n||(n=(0,o.A)(["\n    const float opaqueCutoff = 1.0 / 255.0;\n\n    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {\n      vec2 sideness = unpackedAttributes.sideness;\n      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;\n\n      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;\n\n      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);\n      ","\n\n      vec4 projPosV0 = projFromViewPosition(viewPosV0);\n      vec4 projPosV1 = projFromViewPosition(viewPosV1);\n      vec4 projPos = projFromViewPosition(viewPos);\n\n      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);\n      vec2 ndcToPixel = viewport.zw * 0.5;\n      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;\n      float lineLengthPixels = length(screenSpaceLinePixels);\n\n      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;\n      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;\n      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;\n\n      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;\n      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;\n\n      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;\n      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;\n\n      vSizeFalloffFactor = falloffFactor;\n\n      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;\n      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;\n\n      const float aaPaddingPixels = 1.0;\n\n      // Line size with padding\n      float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;\n      float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;\n\n      // Half line width in NDC including padding for anti aliasing\n      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;\n      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;\n      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;\n\n      // Compute screen space position of vertex, offsetting for line size and end caps\n      vec2 ndcOffset = (\n          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)\n        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC\n      );\n\n      projPos.xy += ndcOffset * projPos.w;\n      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;\n\n      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));\n\n      // Line length with end caps\n      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;\n\n      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;\n\n      // Position in pixels with origin at first vertex of line segment\n      vPosition = vec3(\n        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,\n        pixelPositionAlongLine,\n        pixelPositionAlongLine / extendedLineLengthPixels\n      );\n\n      // The line width radius in pixels\n      vRadius = lineWidthPixels * 0.5;\n      vLineLengthPixels = extendedLineLengthPixels;\n\n      // discard short edges below a certain length threshold\n      ","\n      gl_Position = projPos;\n    }\n\n    void main() {\n      ComponentData component = readComponentData();\n      UnpackedAttributes unpackedAttributes = unpackAttributes(component);\n\n      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;\n      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);\n      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);\n\n      // Component color\n      vColor = component.color;\n\n      // Discard fully transparent edges\n      if (vColor.a < opaqueCutoff) {\n        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n        return;\n      }\n\n      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0, component)) {\n        return;\n      }\n\n      // General geometric computation for all types of edges\n      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(component), unpackedAttributes);\n\n      // Specific computation for different edge styles\n      calculateStyleOutputs(unpackedAttributes);\n    }\n  "])),e.multipassEnabled?"vViewPos = viewPos;":"",e.mode===x.Z5.SKETCH?(0,_.H)(r||(r=(0,o.A)(["\n        if (lineLengthPixels <= 3.0) {\n          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n          return;\n        }"]))):e.mode===x.Z5.MIXED?(0,_.H)(s||(s=(0,o.A)(["\n        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {\n           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n           return;\n        }"]))):"")),c.code.add((0,_.H)(a||(a=(0,o.A)(["\n    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {\n      float positionX = position.x - calculateLineOffset();\n\n      if (radius < 1.0) {\n        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);\n        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);\n        return vec2(0.5 - min(coverageX, coverageY), 0.0);\n      }\n      else {\n        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius\n        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);\n\n        vec2 lineToPosition = vec2(positionX, positionOnCap);\n        return vec2(length(lineToPosition) - radius, positionOnCap / radius);\n      }\n    }\n\n    void main() {\n      ","\n      float radius = vRadius * calculateLinePressure();\n\n      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);\n      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);\n\n      discardByCoverage(radius, coverage);\n      discardBySlice(vWorldPosition);\n\n      fragColor = vec4(vColor.rgb, vColor.a * coverage);\n    }\n  "])),e.multipassEnabled?"terrainDepthTest(vViewPos.z);":"")),t}const S=(0,c.vt)();class P extends f.n{constructor(e){super(e,"mat4")}}const R=Object.freeze(Object.defineProperty({__proto__:null,build:M},Symbol.toStringTag,{value:"Module"}))},48761:(e,t,i)=>{i.d(t,{F:()=>x,a:()=>A,b:()=>C});var n,r,s,a,o=i(57528),l=i(34761),c=i(13191),h=i(9392),d=i(97808),u=i(65058),p=i(94759),m=i(95756),_=i(5517),g=i(21390),f=i(64839),v=i(43425),y=i(32307),b=i(70367),w=i(66470);class x extends f.Y{constructor(){super(...arguments),this.fogColor=(0,h.vt)(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}}function C(){const e=new y.N5;e.attributes.add(w.r.POSITION,"vec2"),e.include(d.U,{textureCoordinateType:d.q.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add(new v.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new v.X("inverseViewMatrix",((e,t)=>(0,l.Qw)(T,t.camera.viewMatrix)))),t.code.add((0,f.H)(n||(n=(0,o.A)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),i.uniforms.add(new g.m("atmosphereC",(e=>e.atmosphereC)),new _.t("cameraPosition",((e,t)=>t.camera.eye)),new m.G("nearFar",((e,t)=>t.camera.nearFar)),new b.N("depthTexture",(e=>e.depthTexture)),new g.m("fogStrength",(e=>e.fogStrength)),new g.m("fogAmount",(e=>e.fogAmount)),new _.t("fogColor",(e=>e.fogColor))),e.include(p.C),i.include(u.D),i.code.add((0,f.H)(r||(r=(0,o.A)(["vec2 sphereIntersect(vec3 start, vec3 dir) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat d = (b * b) - 4.0 * a * atmosphereC;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),i.code.add((0,f.H)(s||(s=(0,o.A)(["vec4 applyFog(float dist, vec3 rayDir){\nif(dist == -1.0){\nvec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);\ndist = 0.055 * rayAtmosphereIntersect.y;\n}\nfloat fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));\nreturn vec4(fogAmount * fogColor, fogAmount);\n}"])))),i.code.add((0,f.H)(a||(a=(0,o.A)(["vec3 tonemapACES(vec3 x) {\nreturn clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n}\nvoid main() {\nvec3 rayDir = normalize(worldRay);\nfloat terrainDepth = -1.0;\nfloat depthSample = texture(depthTexture, vuv0).r;\nfloat zNorm = 2.0 * depthSample - 1.0;\nfloat linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));\nif(depthSample < 1.0 && depthSample > 0.0){\nvec3 cameraSpaceRay = normalize(eyeDir);\ncameraSpaceRay /= cameraSpaceRay.z;\ncameraSpaceRay *= linDepth;\nterrainDepth = max(0.0, length(cameraSpaceRay));\n}\nvec4 fog = applyFog(terrainDepth, rayDir);\nfragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));\n}"])))),e}const T=(0,c.vt)(),A=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:x,build:C},Symbol.toStringTag,{value:"Module"}))},35072:(e,t,i)=>{i.d(t,{H:()=>c,a:()=>d,b:()=>h});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(70367);class c extends a.Y{}function h(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("tex",(e=>e.texture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["void main() {\nfragColor = vec4(1.0 - texture(tex, uv).a);\n}"])))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},61157:(e,t,i)=>{i.d(t,{H:()=>f,b:()=>_});var n,r,s=i(57528),a=i(43047),o=i(55855),l=i(95756),c=i(58350),h=i(64839),d=i(32307),u=i(70367),p=i(66470),m=i(21019);function _(){const e=new d.N5,{vertex:t,fragment:i}=e,o=t.code,_=i.code;return e.attributes.add(p.r.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(p.r.UV0,"vec2"),t.uniforms.add(new u.N("coverageTex",(e=>e.coverageTexture)),new l.G("coverageRounding",(e=>e.coverageRounding))),o.add((0,h.H)(n||(n=(0,s.A)(["void main() {\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\nreturn;\n}\ngl_Position = vec4(position, 0.0, 1.0);\nuv = position.xy * 0.5 + vec2(0.5);\n}"])))),i.uniforms.add(new u.N("tex",(e=>e.blurTexture)),new u.N("highlightTexture",(e=>e.highlightTexture)),new c.E("uColor",(e=>e.color)),new c.E("haloColor",(e=>e.haloColor)),new c.E("opacities",(e=>(0,a.s)(g,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)))),i.constants.add("inner","float",1-(m.o-m.b)/m.o),_.add((0,h.H)(r||(r=(0,s.A)(["void main() {\nvec4 blurredHighlightValue = texture(tex, uv);\nfloat highlightIntensity = blurredHighlightValue.a;\nif (highlightIntensity == 0.0) {\ndiscard;\n}\nvec4 origin_color = texture(highlightTexture, uv);\nfloat outlineIntensity;\nfloat fillIntensity;\nif (blurredHighlightValue.g > blurredHighlightValue.b) {\noutlineIntensity = haloColor.w * opacities[1];\nfillIntensity = uColor.w * opacities[3];\n}\nelse {\noutlineIntensity = haloColor.w * opacities[0];\nfillIntensity = uColor.w * opacities[2];\n}\nfloat outlineFactor = smoothstep(0.0, inner, highlightIntensity);\nfloat fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;\nfloat intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;\nfragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);\n}"])))),e}const g=(0,o.vt)(),f=Object.freeze(Object.defineProperty({__proto__:null,build:_},Symbol.toStringTag,{value:"Module"}))},43666:(e,t,i)=>{i.d(t,{H:()=>m,a:()=>g,b:()=>_});var n,r,s=i(57528),a=i(72745),o=i(56289),l=i(95756),c=i(64839),h=i(32307),d=i(27374),u=i(70367),p=i(66470);class m extends c.Y{constructor(){super(...arguments),this.blurSize=(0,a.vt)()}}function _(){const e=new h.N5,{attributes:t,varyings:i,vertex:a,fragment:m}=e;return t.add(p.r.POSITION,"vec2"),t.add(p.r.UV0,"vec2"),i.add("blurCoordinate","vec3"),a.uniforms.add(new u.N("coverageTex",(e=>e.coverageTexture)),new l.G("coverageRounding",(e=>e.coverageRounding))),a.code.add((0,c.H)(n||(n=(0,s.A)(["void main() {\ngl_Position = vec4(position, 0.0, 1.0);\nvec4 cov = texture(coverageTex, uv0 * coverageRounding);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\n}\nblurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);\n}"])))),m.uniforms.add(new o.t("blurSize",(e=>e.blurSize)),new d.o("tex",(e=>e.blurInputTexture))),m.code.add((0,c.H)(r||(r=(0,s.A)(["void main() {\nvec2 uv = blurCoordinate.xy;\nvec4 center = texture(tex, uv);\nif (blurCoordinate.z == 1.0) {\nfragColor = center;\n} else {\nvec4 sum = center * 0.204164;\nsum += texture(tex, uv + blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv - blurSize * 1.407333) * 0.304005;\nsum += texture(tex, uv + blurSize * 3.294215) * 0.093913;\nsum += texture(tex, uv - blurSize * 3.294215) * 0.093913;\nfragColor = sum;\n}\n}"])))),e}const g=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:m,build:_},Symbol.toStringTag,{value:"Module"}))},21019:(e,t,i)=>{i.d(t,{H:()=>c,a:()=>m,b:()=>p,c:()=>h,g:()=>d,o:()=>u});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(27374);class c extends a.Y{}function h(){const e=new o.N5,{outputs:t,fragment:i}=e;return e.include(s.c),i.uniforms.add(new l.o("textureInput",(e=>e.input))),i.constants.add("sampleArea","int",Math.ceil(u/2)),t.add("fragGrid","vec2"),i.code.add((0,a.H)(n||(n=(0,r.A)(["\n    void main() {\n      float red = 0.0;\n      float green = 1.0;\n      int cellSize = ",";\n      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));\n      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));\n\n      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {\n        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {\n          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;\n          vec4 value = texture(textureInput, coord);\n          float mx = floor(max(value.g, value.b));\n\n          red = max(red, ceil(value.r));\n          green = min(green, mx);\n          if(red == 1.0 && green == 0.0) {\n            fragGrid = vec2(red, green);\n            return;\n          }\n        }\n      }\n      fragGrid = vec2(red, green);\n    }"])),a.H.int(d))),e}const d=32,u=9,p=.4,m=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:c,blurSize:p,build:h,gridCellPixelSize:d,outlineSize:u},Symbol.toStringTag,{value:"Module"}))},80573:(e,t,i)=>{i.d(t,{N:()=>y,a:()=>w,b:()=>b});var n,r,s,a,o,l,c,h,d=i(57528),u=i(72745),p=i(39033),m=i(89426),_=i(73398),g=i(95756),f=i(64839),v=i(32307);class y extends f.Y{constructor(){super(...arguments),this.weatherTile=(0,u.fA)(0,0)}}function b(e){const t=new v.N5;if(t.include(_.c,!1),t.fragment.code.add((0,f.H)(n||(n=(0,d.A)(["float remap(float x, float low1, float high1, float low2, float high2) {\nreturn low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n}"])))),e.mode===p.L.Full){const e=2,i=8;t.fragment.code.add((0,f.H)(r||(r=(0,d.A)(["\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    // Safer modulo for positive and negative values\n    vec3 modulo(vec3 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec3 hash(vec3 p3, float frequency){\n      p3 = modulo(p3, frequency);\n      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yxz + 33.33);\n      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);\n    }\n\n    // 5th order polynomial interpolation\n    vec3 fade(vec3 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec3 p, float frequency){\n      // Cell point is in\n      vec3 i = floor(p);\n\n      // Position in the cell in [0, 1]\n      vec3 f = fract(p);\n\n      // Interpolation value for gradient mixing\n      vec3 u = fade(f);\n\n      // Trilinear interpolation of gradients at cube vertices around point\n      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),\n                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),\n                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),\n                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),\n                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      float octaveFrequencyFactor = 2.0;\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * gradientNoise(p, frequency);\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv) {\n      vec2 tile = floor(uv);\n      float z = floor("," * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPointPerlinWorley(vec3 p) {\n      float perlinNoise = getPerlinNoise(p, ",");\n\n      float worley0 = worley(p, "," * 2.0);\n      float worley1 = worley(p, "," * 8.0);\n      float worley2 = worley(p, "," * 14.0);\n\n      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n    }\n\n    float getTextureForPointWorley(vec3 p) {\n      float worley0 = worley(p, ",");\n      float worley1 = worley(p, "," * 2.0);\n      float worley2 = worley(p, "," * 4.0);\n      float worley3 = worley(p, "," * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "])),f.H.float(m.ik),f.H.float(i),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e),f.H.float(e)))}return t.fragment.uniforms.add(new g.G("weatherTile",(e=>e.weatherTile))),t.fragment.code.add((0,f.H)(s||(s=(0,d.A)(["\n    vec2 modulo(vec2 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec2 hash(vec2 p){\n      // Get position of p in weather tile\n      p = modulo(p, ",");\n\n      // Get global coordinates of p\n      p += weatherTile * ",";\n\n      // Limit position to avoid numerical instability\n      p = modulo(p, ",");\n\n      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;\n    }\n\n    vec2 fade(vec2 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec2 p){\n      vec2 i = floor( p );\n      vec2 f = fract( p );\n\n      vec2 u = fade(f);\n\n      // Bilinear interpolation of gradients at cell vertices around point\n      return  mix(\n                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),\n                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),\n                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),\n                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),\n                u.y);\n    }\n\n    float worley(vec2 p){\n      float d = 1.0e10;\n      for (int x = -1; x <= 1; x++){\n        for (int y = -1; y <= 1; y++){\n                vec2 tp = floor(p) + vec2(x, y);\n                tp = p - tp - (0.5 + 0.5 * hash(tp));\n                d = min(d, dot(tp, tp));\n            }\n        }\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n  "])),f.H.float(m.QG),f.H.float(m.QG),f.H.float(m.M4))),t.fragment.code.add((0,f.H)(a||(a=(0,d.A)(["void main() {"])))),e.mode===p.L.Full&&t.fragment.code.add((0,f.H)(o||(o=(0,d.A)(["\n        float padWidth = 1.0;\n        float paddedSize = "," + 2.0 * padWidth;\n        float tileCount = "," * ",";\n        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n        bool padCell = false;\n        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        bool startPadX = false;\n        bool startPadY = false;\n        bool endPadX = false;\n        bool endPadY = false;\n\n        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n          startPadX = true;\n        }\n\n        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n          startPadY = true;\n        }\n\n        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n          endPadX = true;\n        }\n\n        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n          endPadY = true;\n        }\n\n        vec2 padding = vec2(2.0 * padWidth) * tile;\n        vec2 uv;\n\n        if (padCell) {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n          if (startPadX) {\n            pixel.x += ",";\n          }\n\n          if (startPadY) {\n            pixel.y += ",";\n          }\n\n          if (endPadX) {\n            pixel.x -= ",";\n          }\n\n          if (endPadY) {\n            pixel.y -= ",";\n          }\n\n          uv = vec2(pixel.xy / ",");\n        } else {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n          uv = vec2(pixel.xy / ",");\n        }\n\n        vec3 p_ = get3Dfrom2D(uv);\n        vec3 p = p_;\n        p.z /= ("," * ",");\n\n        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        float worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n        p_ = mod(p_ + 1.0, "," * ",");\n        p = p_;\n        p.z /= ("," * ",");\n\n        worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        worleyNoise = getTextureForPointWorley(p);\n\n        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n      "])),f.H.float(m.CQ),f.H.float(m.ik),f.H.float(m.ik),f.H.float(m.CQ),f.H.float(m.CQ),f.H.float(m.CQ),f.H.float(m.CQ),f.H.float(m.CQ),f.H.float(m.CQ),f.H.float(m.ik),f.H.float(m.ik),f.H.float(m.ik),f.H.float(m.ik),f.H.float(m.ik),f.H.float(m.ik))),t.fragment.code.add((0,f.H)(l||(l=(0,d.A)(["\n      vec2 mapUV = "," * (gl_FragCoord.xy / ",");\n      float map = abs(gradientNoise(mapUV));\n      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);\n\n      ",";\n    }\n  "])),f.H.float(m.QG),f.H.float(m.jj),e.mode===p.L.Full?(0,f.H)(c||(c=(0,d.A)(["fragColor.ba = vec2(0.0, map);"]))):(0,f.H)(h||(h=(0,d.A)(["fragColor = vec4(map);"]))))),t}const w=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},16309:(e,t,i)=>{i.d(t,{O:()=>c,a:()=>d,b:()=>h});var n,r=i(57528),s=i(73398),a=i(64839),o=i(32307),l=i(70367);class c extends a.Y{}function h(){const e=new o.N5;return e.include(s.c),e.fragment.uniforms.add(new l.N("colorTexture",(e=>e.colorTexture)),new l.N("alphaTexture",(e=>e.alphaTexture)),new l.N("frontFaceTexture",(e=>e.frontFaceTexture))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["void main() {\nvec4 srcColor = texture(colorTexture, uv);\nif(srcColor.a <= 1e-5){\ndiscard;\n}\nfloat srcAlpha = texture(alphaTexture, uv).r;\nvec4 frontFace = texture(frontFaceTexture, uv);\nfragColor = vec4(mix(srcColor.rgb / srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);\n}"])))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},28080:(e,t,i)=>{i.d(t,{P:()=>A,b:()=>y});var n,r,s,a,o,l,c=i(57528),h=i(20664),d=i(9392),u=i(90376),p=i(5517),m=i(21390),_=i(64839),g=i(43425),f=i(32307),v=i(66470);function y(e){const t=new f.N5;return t.attributes.add(v.r.POSITION,"vec3"),t.attributes.add(v.r.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new p.t("cameraPosition",((e,t)=>t.camera.eye))),t.vertex.uniforms.add(new p.t("offset",((e,t)=>function(e,t){const i=t.camera.eye,n=.5*e.width,r=1/e.width,s=(0,h.J)(b,(0,h.s)(b,(i[0]+n)*r,(i[1]+n)*r,(i[2]+n)*r));return(0,h.z)(s,i,(0,h.h)(s,s,e.width))}(e,t)))),t.vertex.uniforms.add(new m.m("width",(e=>e.width))),t.vertex.uniforms.add(new g.X("proj",((e,t)=>t.camera.projectionMatrix))),t.vertex.uniforms.add(new g.X("view",((e,t)=>t.camera.viewMatrix))),t.vertex.uniforms.add(new m.m("time",(e=>e.time))),t.varyings.add("vUv","vec2"),t.vertex.code.add((0,_.H)(n||(n=(0,c.A)(["\n    vec3 hash31(float p){\n      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n\n    float hash11(float p){\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);\n    }\n\n    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/\n    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){\n      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;\n    }\n\n    void main(void) {\n\n      vUv = position.xz;\n\n      vec3 rand = hash31(instanceFeatureAttribute);\n\n      // Set random position for all particles\n      // The hash function space is not high resolution so offset particles by an additional random value\n      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width\n      // overlaying multiple identical but offset grids\n      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;\n\n      // Random orientation of rain drops\n      float angle = 3.1415 * hash11(instanceFeatureAttribute);\n\n      vec3 up = vec3(0, 0, 1);\n\n      // Gravity and wind direction\n      vec3 direction = normalize(cameraPosition);\n\n      vec3 tangent = normalize(cross(direction, up));\n\n      // Gravity\n      vec3 animatedPos = randomPosition + direction * -time;\n\n      // Rain particles fall straight down and are randomly oriented\n      // Snow particles have random sinusoid trajectories and are rotated to face the camera\n      ","\n    }\n  "])),e.type===u.C.Rain?(0,_.H)(r||(r=(0,c.A)(["\n            // Random rotation for particle\n            vec3 rotationAxis = up;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);\n\n            // Rotate particle to planetary position\n            rotationAxis = tangent;\n            angle = 0.5 * -acos(dot(direction, up));\n            quat = vec4(rotationAxis * sin(angle), cos(angle));\n            transformedPos = rotateVectorByQuaternion(transformedPos, quat);\n\n            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * pos;\n      "]))):(0,_.H)(s||(s=(0,c.A)(["\n            vec3 rotationAxis = direction;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n\n            tangent = rotateVectorByQuaternion(tangent, quat);\n            // Random sinusoid from friction\n            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));\n            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);\n      "]))))),t.fragment.uniforms.add(new m.m("opacity",(e=>e.opacity)),new p.t("particleColor",((t,i)=>function(e,t){const i=t.type===u.C.Rain?C:x,n=(0,h.h)(b,i,T),r=e.camera.eye;(0,h.n)(w,r);const s=Math.max(0,(0,h.k)(w,e.lighting.mainLight.direction));return(0,h.m)(n,n,i,s)}(i,e)))),t.fragment.code.add((0,_.H)(a||(a=(0,c.A)(["\n    void main() {\n\n      // Cut off corners of the triangle\n      if(vUv.x < 0.0 || vUv.y < 0.0){\n        discard;\n      }\n\n      float d = length(vUv - vec2(0.5));\n\n      ","\n      fragColor = opacity * vec4(particleColor * d, d);\n    }\n  "])),e.type===u.C.Rain?(0,_.H)(o||(o=(0,c.A)(["d = 0.35 * smoothstep(0.5, 0.0, d);"]))):(0,_.H)(l||(l=(0,c.A)(["d = smoothstep(0.5, 0.1, d);"]))))),t}const b=(0,d.vt)(),w=(0,d.vt)(),x=(0,d.fA)(1,1,1),C=(0,d.fA)(.85,.85,.85),T=.7,A=Object.freeze(Object.defineProperty({__proto__:null,build:y},Symbol.toStringTag,{value:"Module"}))},745:(e,t,i)=>{i.d(t,{C:()=>D,R:()=>F,a:()=>I,b:()=>L,c:()=>N});var n,r,s,a,o,l,c,h,d,u,p,m,_,g=i(57528),f=i(9392),v=i(72770),y=i(91156),b=i(67199),w=i(79360),x=i(25252),C=i(80883),T=i(53736),A=i(95756),M=i(21390),S=i(60205),P=i(72790),R=i(64839),E=i(32307),O=i(70367);class D extends b.p{constructor(e,t,i,n,r,s){super(e,n,r),this.colormap=t,this.symbolizer=i,this.u_colormap=s,this.backgroundColor=f.uY,this.fboTexture=null,this.baseOpacity=1}}class I extends D{}class L extends D{}function N(e){const t=new E.N5;return t.include(x.W),t.include(b.y,e),t.include(y.M,e),t.include(w.Pt,e),t.fragment.code.add((0,R.H)(n||(n=(0,g.A)(["vec4 applyBackgroundBlend(vec4 layerColor) {\nvec4 bgColor = getBackground(vuv);\nreturn blendLayers(bgColor, layerColor, u_opacity);\n}"])))),e.colorizerType===v.T.Stretch?function(e,t){e.fragment.uniforms.add(new P.c("u_bandCount",(e=>e.symbolizer.u_bandCount)),new S.x("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new S.x("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new S.x("u_factor",(e=>e.symbolizer.u_factor),3),new M.m("u_minOutput",(e=>e.symbolizer.u_minOutput)),new M.m("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new T.e("u_useGamma",(e=>e.symbolizer.u_useGamma)),new S.x("u_gamma",(e=>e.symbolizer.u_gamma),3),new S.x("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new M.m("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add((0,R.H)(s||(s=(0,g.A)(["float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {\nif (val >= maxCutOff) {\nreturn maxOutput;\n} else if (val <= minCutOff) {\nreturn minOutput;\n}\nfloat stretchedVal;\nif (useGamma) {\nfloat tempf = 1.0;\nfloat outRange = maxOutput - minOutput;\nfloat relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);\nif (gamma > 1.0) {\ntempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);\n}\nstretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;\n} else {\nstretchedVal = minOutput + (val - minCutOff) * factor;\n}\nreturn stretchedVal;\n}"]))));const i=t.applyColormap?(0,R.H)(a||(a=(0,g.A)(["fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));"]))):(0,R.H)(o||(o=(0,g.A)(["fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));"])));e.fragment.code.add((0,R.H)(l||(l=(0,g.A)(["\n      void main() {\n        vec2 pixelLocation = getPixelLocation(uv);\n        if (isOutside(pixelLocation)) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n\n        vec4 currentPixel = getPixel(pixelLocation);\n        ","\n      }"])),t.stretchType===v.M.Noop?(0,R.H)(c||(c=(0,g.A)(["\n        fragColor = applyBackgroundBlend(currentPixel);"]))):(0,R.H)(h||(h=(0,g.A)(["\n        if (currentPixel.a == 0.0) {\n          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n        if (u_bandCount == 1) {\n          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          ","\n        } else {\n          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);\n          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);\n          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));\n        }"])),i)))}(t,e):e.colorizerType===v.T.Lut?function(e){e.fragment.code.add((0,R.H)(r||(r=(0,g.A)(["void main() {\nvec2 pixelLocation = getPixelLocation(uv);\nif (isOutside(pixelLocation)) {\nfragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\nreturn;\n}\nvec4 currentPixel = getPixel(pixelLocation);\nfragColor = applyBackgroundBlend(colormap(currentPixel, true));\n}"]))))}(t):e.colorizerType===v.T.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new O.N("u_image",(e=>e.u_image)),new P.c("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new S.x("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new S.x("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new S.x("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new S.x("u_weights",(e=>e.symbolizer.u_weights),6),new A.G("u_factor",(e=>e.symbolizer.u_factor)),new M.m("u_minValue",(e=>e.symbolizer.u_minValue)),new M.m("u_maxValue",(e=>e.symbolizer.u_maxValue)),new A.G("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(C.a),i.code.add((0,R.H)(d||(d=(0,g.A)(["vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {\nval = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);\nvec4 color = colormap(vec4(val, val, val, 1.0), false);\nvec3 hsv = rgb2hsv(color.rgb);\nhsv.z = hillshade;\nreturn vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;\n}"])))),i.code.add((0,R.H)(u||(u=(0,g.A)(["float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){\nif (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {\nreturn 0.0;\n}  else {\nreturn e;\n}\n}"]))));const n=t.applyColormap?(0,R.H)(p||(p=(0,g.A)(["fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));"]))):(0,R.H)(m||(m=(0,g.A)(["hillshade *= alpha;\nfragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));"])));i.code.add((0,R.H)(_||(_=(0,g.A)(["\n    void main() {\n      vec2 pixelLocation = getPixelLocation(uv);\n      if (isOutside(pixelLocation)) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      vec4 currentPixel = getPixel(pixelLocation);\n      if (currentPixel.a == 0.0) {\n        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      //mirror edge pixels\n      vec2 axy = vec2(-1.0, -1.0);\n      vec2 bxy = vec2(0.0, -1.0);\n      vec2 cxy = vec2(1.0, -1.0);\n      vec2 dxy = vec2(-1.0, 0.0);\n      vec2 fxy = vec2(1.0, 0.0);\n      vec2 gxy = vec2(-1.0, 1.0);\n      vec2 hxy = vec2(0.0, 1.0);\n      vec2 ixy = vec2(1.0, 1.0);\n      vec2 onePixel = 1.0 / u_srcImageSize;\n      if (pixelLocation.s < onePixel.s) {\n        axy[0] = 1.0;\n        dxy[0] = 1.0;\n        gxy[0] = 1.0;\n      }\n      if (pixelLocation.t < onePixel.t) {\n        axy[1] = 1.0;\n        bxy[1] = 1.0;\n        cxy[1] = 1.0;\n      }\n      if (pixelLocation.s > 1.0 - onePixel.s) {\n        cxy[0] = -1.0;\n        fxy[0] = -1.0;\n        ixy[0] = -1.0;\n      }\n      if (pixelLocation.t > 1.0 - onePixel.t) {\n        gxy[1] = -1.0;\n        hxy[1] = -1.0;\n        ixy[1] = -1.0;\n      }\n\n      // calculate hillshade\n      vec4 va = texture(u_image, pixelLocation + onePixel * axy);\n      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);\n      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);\n      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);\n      vec4 ve = texture(u_image, pixelLocation);\n      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);\n      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);\n      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);\n      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);\n\n      // calculate the rate of z change along the x, y, and diagonal direction\n      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;\n      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;\n      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);\n      float hillshade = 0.0;\n\n      // traditional single light source\n      if (u_hillshadeType == 0){\n        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;\n        float z = (u_cosZs[0] + cosDelta) / dzd;\n        if (z < 0.0)  z = 0.0;\n        hillshade = z;\n      } else {\n        // multi-directional with 6 light sources\n        for (int k = 0; k < 6; k++) {\n        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;\n        float z = (u_cosZs[k] + cosDelta) / dzd;\n        if (z < 0.0) z = 0.0;\n        hillshade = hillshade + z * u_weights[k];\n        if (k == 5) break;\n        }\n      }\n\n      // set color\n      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);\n      alpha *= u_opacity;\n      ","\n    }\n  "])),n))}(t,e),t}const F=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:L,ColorizerStretchUniforms:I,ColorizerUniforms:D,build:N},Symbol.toStringTag,{value:"Module"}))},59922:(e,t,i)=>{i.d(t,{S:()=>f,a:()=>w,b:()=>y});var n,r=i(57528),s=i(34761),a=i(13191),o=i(73398),l=i(65058),c=i(1773),h=i(27963),d=i(81449),u=i(95756),p=i(64839),m=i(43425),_=i(32307),g=i(70367);const f=255,v=1/f;function y(e){const t=new _.N5,i=t.fragment;return i.include(d.W),i.include(l.D),t.include(h.Ir),t.include(o.c),t.include(c.G,e),i.uniforms.add(new g.N("shadowMap",((e,t)=>t.shadowMap.depthTexture)),new g.N("depthMap",((e,t)=>{var i;return null===(i=t.linearDepth)||void 0===i?void 0:i.getTexture()})),new m.X("inverseViewMatrix",((e,t)=>(0,s.B8)(b,(0,s.Tl)(b,t.camera.viewMatrix,t.camera.center)))),new u.G("nearFar",((e,t)=>t.camera.nearFar))),i.constants.add("sampleValue","float",v),t.outputs.add("sampleCount","float"),i.code.add((0,p.H)(n||(n=(0,r.A)(["void main(void) {\nfloat depth = rgba2float(texture(depthMap, uv));\nif (depth == 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearDepthFromFloat(depth, nearFar);\nif (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {\ndiscard;\n}\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nivec2 texSize = textureSize(shadowMap, 0);\nivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\nfloat depthShadow = readShadowMapDepth(uvShadow, shadowMap);\nbool shadow = depthShadow < lvpos.z;\nif (!shadow) {\ndiscard;\n}\nsampleCount = sampleValue;\n}"])))),t}const b=(0,a.vt)(),w=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:f,build:y},Symbol.toStringTag,{value:"Module"}))},99604:(e,t,i)=>{i.d(t,{S:()=>b,a:()=>C,b:()=>x});var n,r,s,a,o=i(57528),l=i(55855),c=i(73398),h=i(65058),d=i(27963),u=i(81449),p=i(58350),m=i(21390),_=i(64839),g=i(32307),f=i(70367),v=i(59922),y=i(50578);class b extends _.Y{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=(0,l.o8)(w),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const w=(0,l.fA)(.01,0,.25,1);function x(e){const t=new g.N5,i=t.fragment;i.include(u.W),i.include(h.D),t.include(d.Ir),t.include(c.c);const{visualization:l,bandsEnabled:b}=e;i.constants.add("inverseSampleValue","float",v.S),i.uniforms.add(new f.N("shadowCastMap",(e=>e.shadowCastMap)),new m.m("sampleScale",(e=>e.sampleScale)),new m.m("opacityFromElevation",(e=>e.opacityFromElevation)),new p.E("uColor",(e=>e.color)));const w=l===y.o.Gradient,x=l===y.o.Threshold;return w&&b?i.uniforms.add(new m.m("bandSize",(e=>e.bandSize))):x&&i.uniforms.add(new m.m("threshold",(e=>e.threshold))),i.code.add((0,_.H)(n||(n=(0,o.A)(["\n    void main(void) {\n      float record = texture(shadowCastMap, uv).r;\n      float pixelSamples = record * inverseSampleValue;\n      if (pixelSamples < 1.0) {\n        discard;\n      }\n\n      float strength = pixelSamples * sampleScale;\n\n      ","\n\n      ","\n\n      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ",");\n    }\n  "])),x?(0,_.H)(r||(r=(0,o.A)(["\n          if (strength <= threshold) {\n            discard;\n          }"]))):"",w&&b?(0,_.H)(s||(s=(0,o.A)(["strength = ceil(strength / bandSize) * bandSize;"]))):"",w?(0,_.H)(a||(a=(0,o.A)(["* strength"]))):"")),t}const C=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:b,build:x},Symbol.toStringTag,{value:"Module"}))},97157:(e,t,i)=>{i.d(t,{S:()=>R,b:()=>M});var n,r=i(57528),s=i(34761),a=i(13191),o=i(20664),l=i(9392),c=i(73398),h=i(48020),d=i(65058),u=i(1773),p=i(27963),m=i(81449),_=i(95756),g=i(5517),f=i(58350),v=i(21390),y=i(64839),b=i(43425),w=i(32307),x=i(70367),C=i(90877);const T=.99999,A=.025;function M(e){const t=new w.N5;t.include(u.G,e),t.include(p.Ir),t.include(c.c);const i=t.fragment;return i.include(m.W),i.include(d.D),i.uniforms.add(new x.N("defaultDepthTex",((e,t)=>t.shadowMap.getSnapshot(C.z.ExcludeHighlight))),new x.N("highlightDepthTex",((e,t)=>t.shadowMap.getSnapshot(C.z.Highlight))),new x.N("depthMap",((e,t)=>{var i;return null===(i=t.linearDepth)||void 0===i?void 0:i.getTexture()})),new x.N("highlightTexture",(e=>e.highlight)),new f.E("uColor",(e=>e.shadowColor)),new _.G("nearFar",((e,t)=>t.camera.nearFar)),new v.m("opacity",(e=>e.shadowOpacity)),new v.m("occludedOpacity",(e=>e.occludedShadowOpacity)),new v.m("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new g.t("lightingMainDirectionView",((e,t)=>(0,o.n)(P,(0,o.e)(P,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix)))),new b.X("inverseViewMatrix",((e,t)=>(0,s.B8)(S,(0,s.Tl)(S,t.camera.viewMatrix,t.camera.center))))),i.constants.add("unoccludedHighlightFlag","vec4",h.bO),i.code.add((0,y.H)(n||(n=(0,r.A)(["\n    vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, ivec2 iuv) {\n      float leftPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(-1, 0), 0), nearFar);\n      float rightPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(1, 0), 0), nearFar);\n      float bottomPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, -1), 0), nearFar);\n      float topPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, 1), 0), nearFar);\n\n      bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);\n      bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);\n\n      vec3 fragCoordHorizontal = pickLeft\n                                  ? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)\n                                  : vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);\n      vec3 fragCoordVertical = pickBottom\n                                  ? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)\n                                  : vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);\n\n      vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);\n      vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);\n\n      vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));\n      // Flip normal depending on triangle winding order for consistency\n      return pickLeft == pickBottom ? normal : -normal;\n    }\n\n    void main(void) {\n      vec4 highlightInfo = texture(highlightTexture, uv);\n      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;\n      if (visiblyHighlighted > ",") {\n        discard;\n      }\n\n      ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));\n      float depth = rgba2float(texelFetch(depthMap, iuv, 0));\n      // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard\n      if (depth == 0.0) {\n        discard;\n      }\n\n      float currentPixelDepth = linearDepthFromFloat(depth, nearFar);\n      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {\n        discard;\n      }\n\n      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\n      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\n\n      mat4 shadowMatrix;\n      float linearDepth = -currentPixelDepth;\n      int i = chooseCascade(linearDepth, shadowMatrix);\n      if (i >= numCascades) {\n        discard;\n      }\n\n      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\n        discard;\n      }\n\n      ivec2 texSize = textureSize(highlightDepthTex, 0);\n      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));\n\n      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);\n      bool shadowHighlight = depthHighlight < lvpos.z;\n      if (!shadowHighlight) {\n        discard;\n      }\n\n      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);\n      bool shadowDefault = depthDefault < lvpos.z;\n\n      vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, iuv);\n      bool shaded = dot(normal, lightingMainDirectionView) < ",";\n\n      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;\n      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);\n    }\n  "])),y.H.float(T),y.H.float(A))),t}const S=(0,a.vt)(),P=(0,l.vt)(),R=Object.freeze(Object.defineProperty({__proto__:null,build:M},Symbol.toStringTag,{value:"Module"}))},76955:(e,t,i)=>{i.d(t,{S:()=>A,a:()=>P,b:()=>M,c:()=>S});var n,r,s,a,o,l,c,h,d=i(57528),u=i(72745),p=i(9392),m=i(99650),_=i(59395),g=i(43557),f=i(95756),v=i(5517),y=i(21390),b=i(64839),w=i(43425),x=i(32307),C=i(70367),T=i(66470);class A extends b.Y{constructor(){super(...arguments),this.texV=(0,u.vt)(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new M}}class M{constructor(){this.center=(0,p.vt)(),this.v1=(0,p.vt)(),this.v2=(0,p.vt)()}}function S(e){const t=new x.N5,{vertex:i,fragment:u}=t;if((0,g.Gc)(i),e.geometry===m.d.Underground)t.attributes.add(T.r.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new v.t("cameraPosition",((e,t)=>t.camera.eye)),new y.m("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.code.add((0,b.H)(n||(n=(0,d.A)(["void main(void) {\nfloat ndotl = dot(normalize(cameraPosition), mainLightDirection);\nfloat lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\ncolor = vec4(vec3(lighting), undergroundFadeAlpha);\ngl_Position = vec4(position.xy, 1.0, 1.0);\n}"])))),u.code.add((0,b.H)(r||(r=(0,d.A)(["void main() {\nfragColor = color;\n}"]))));else{t.include(_.d,e),t.attributes.add(T.r.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const n=e.geometry===m.d.Cylinder;i.uniforms.add(new w.X("proj",((e,t)=>t.camera.projectionMatrix)),new w.X("view",((e,t)=>t.camera.viewMatrix))),n||(t.varyings.add("innerFactor","float"),i.uniforms.add(new v.t("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new v.t("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new v.t("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new f.G("texV",(e=>e.texV))),i.uniforms.add(new y.m("innerScale",(e=>e.innerScale))));const r=6.2831853,p=1/128;i.code.add((0,b.H)(s||(s=(0,d.A)(["\n\t\tvoid main(void) {\n      ","\n      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\n\n\t\t  gl_Position = transformPosition(proj, view, pos);\n\t\t  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane\n    }\n\t  "])),n?(0,b.H)(a||(a=(0,d.A)(["\n      vec3 pos = position;\n      float ndotl = mainLightDirection.z;\n      vtc = vec2(0.0, position.z + 0.05);"]))):(0,b.H)(o||(o=(0,d.A)(["\n      innerFactor = clamp(-position.z, 0.0, 1.0);\n      float scale = position.y * (1.0 + innerFactor * innerScale);\n      float phi = position.x * "," + 1.0;\n      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;\n      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);\n      vtc.x = position.x  * ",";\n      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;\n      "])),b.H.float(r*p),b.H.float(p)))),u.uniforms.add(new C.N("tex",(e=>e.texture))),n||u.uniforms.add(new y.m("altitudeFade",(e=>e.altitudeFade))),u.code.add((0,b.H)(l||(l=(0,d.A)(["\n\t\tvoid main() {\n\t\t\tvec4 atmosphereColor = texture(tex, vtc) * falloff;\n      ","\n    }"])),n?(0,b.H)(c||(c=(0,d.A)(["fragColor = atmosphereColor;"]))):(0,b.H)(h||(h=(0,d.A)(["\n\t\t\tvec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);\n\t\t\tfragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));\n      "])))))}return t}const P=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:M,SimpleAtmospherePassParameters:A,build:S},Symbol.toStringTag,{value:"Module"}))},21594:(e,t,i)=>{i.d(t,{S:()=>g,b:()=>m});var n,r,s=i(57528),a=i(34761),o=i(13191),l=i(58350),c=i(21390),h=i(64839),d=i(43425),u=i(32307),p=i(66470);function m(){const e=new u.N5;return e.attributes.add(p.r.POSITION,"vec3"),e.attributes.add(p.r.COLOR,"vec4"),e.attributes.add(p.r.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new d.X("transform",((e,t)=>function(e,t){const i=24e-8;return(0,a.C)(_,t.camera.projectionMatrix),_[10]=i-1,_[11]=-1,_[14]=(i-2)*t.camera.near,(0,a.lw)(_,_,t.camera.viewMatrix),(0,a.lw)(_,_,e.modelMatrix)}(e,t))),new l.E("viewport",((e,t)=>t.camera.fullViewport)),new c.m("pixelRatio",((e,t)=>t.camera.pixelRatio))),e.vertex.code.add((0,h.H)(n||(n=(0,s.A)(["void main(void) {\ngl_Position = transform * vec4(position, 0);\nvcolor = color / 1.2;\nvsize = size * 5.0 * pixelRatio;\ngl_PointSize = vsize;\n}"])))),e.fragment.code.add((0,h.H)(r||(r=(0,s.A)(["void main() {\nfloat cap = 0.7;\nfloat scale = 1.0 / cap;\nfloat helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);\nfloat alpha = clamp((cap - helper) * scale, 0.0, 1.0);\nfloat intensity = alpha * alpha * alpha;\nif (vsize < 3.0) {\nintensity *= 0.5;\n}\nfragColor = vec4(vcolor.xyz, intensity);\n}"])))),e}const _=(0,o.vt)(),g=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},42664:(e,t,i)=>{i.d(t,{S:()=>l});var n,r,s,a=i(54787),o={exports:{}};n=o,r=function(){var e=Math.PI,t=Math.sin,i=Math.cos,n=Math.tan,r=Math.asin,s=Math.atan2,a=Math.acos,o=e/180,l=864e5,c=2440588,h=2451545,d={dec:0,ra:0};function u(e){return new Date((e+.5-c)*l)}function p(e){return function(e){return e.valueOf()/l-.5+c}(e)-h}var m=23.4397*o;function _(e,r){return s(t(e)*i(m)-n(r)*t(m),i(e))}function g(e,n){return r(t(n)*i(m)+i(n)*t(m)*t(e))}function f(e,r,a){return s(t(e),i(e)*t(r)-n(a)*i(r))}function v(e,n,s){return r(t(n)*t(s)+i(n)*i(s)*i(e))}function y(e,t){return o*(280.16+360.9856235*e)-t}function b(e){return o*(357.5291+.98560028*e)}function w(e){return o*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function x(t,i){return t+i+102.9372*o+e}function C(e,t){var i=b(e),n=x(i,w(i));return t||(t={dec:0,ra:0}),t.dec=g(n,0),t.ra=_(n,0),t}var T={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,n){var r=o*-i,s=o*t,a=p(e),l=C(a,d),c=y(a,r)-l.ra;return n||(n={azimuth:0,altitude:0}),n.azimuth=f(c,s,l.dec),n.altitude=v(c,s,l.dec),n}},A=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,i){A.push([e,t,i])};var M=9e-4;function S(t,i){return Math.round(t-M-i/(2*e))}function P(t,i,n){return M+(t+i)/(2*e)+n}function R(e,i,n){return h+e+.0053*t(i)-.0069*t(2*n)}function E(e,n,r){return a((t(e)-t(n)*t(r))/(i(n)*i(r)))}function O(e){var n=o*(134.963+13.064993*e),r=o*(93.272+13.22935*e),s=o*(218.316+13.176396*e)+6.289*o*t(n),a=5.128*o*t(r),l=385001-20905*i(n);return{ra:_(s,a),dec:g(s,a),dist:l}}return T.getTimes=function(e,n,r){var s=o*-r,a=o*n,l=S(p(e),s),c=P(0,s,l),h=b(c),d=w(h),m=x(h,d),_=g(m,0),f=R(c,h,m);function v(e){return R(P(E(e,a,_),s,l),h,m)}var y,C,M,O,D,I={solarNoon:u(f),nadir:u(f-.5),polarException:T.PolarException.NORMAL};for(y=0,C=A.length;y<C;y+=1)D=f-((O=v((M=A[y])[0]*o))-f),I[M[1]]=u(D),I[M[2]]=u(O);return I.polarException=function(e){var n=(t(e)-t(a)*t(_))/(i(a)*i(_));return n<-1?T.PolarException.MIDNIGHT_SUN:n>1?T.PolarException.POLAR_NIGHT:T.PolarException.NORMAL}(A[0][0]*o),I},T.getMoonPosition=function(e,t,i){var r=o*-i,s=o*t,a=p(e),l=O(a),c=y(a,r)-l.ra,h=v(c,s,l.dec);return h+=.017*o/n(h+10.26*o/(h+5.1*o)),{azimuth:f(c,s,l.dec),altitude:h,distance:l.dist}},T.getMoonFraction=function(e){var n=p(e),r=C(n),o=O(n),l=149598e3,c=a(t(r.dec)*t(o.dec)+i(r.dec)*i(o.dec)*i(r.ra-o.ra)),h=s(l*t(c),o.dist-l*i(c));return(1+i(h))/2},T},void 0!==(s=r())&&(n.exports=s);const l=(0,a.g)(o.exports)},43074:(e,t,i)=>{i.d(t,{T:()=>ge,a:()=>be,b:()=>fe});var n,r,s,a,o,l,c,h,d,u,p,m,_,g,f,v,y,b,w,x,C,T,A,M,S,P,R,E,O,D,I,L,N,F,V,H,U,z=i(57528),q=i(34761),G=i(13191),B=i(20664),k=i(9392),W=i(29898),Z=i(72412),j=i(34981),Q=i(26917),X=i(59395),Y=i(59046),$=i(838),K=i(97808),J=i(112),ee=i(49399),te=i(48020),ie=i(78264),ne=i(67799),re=i(43557),se=i(2260),ae=i(26719),oe=i(1773),le=i(12057),ce=i(14209),he=i(3799),de=i(5517),ue=i(64839),pe=i(12216),me=i(32307),_e=i(70367);class ge extends ce.Rq{}function fe(e){const t=new me.N5,{vertex:i,fragment:G,varyings:k}=t;t.include($.I),t.include(Y.Y,e),t.include(K.U,e);const ge=()=>{t.include(se.n,e),i.code.add((0,ue.H)(n||(n=(0,z.A)(["vec3 getNormal() {\nfloat z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);\nvec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,\nnormalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);\nreturn normalize(n);\n}"]))))};(0,he.NB)(i,e),t.include(X.d,e);const fe=e.overlayMode!==le.w9.Disabled,be=fe&&e.invisible;switch(e.output){case j.V.Color:{t.include(ce.BK,e),t.include(ne.kA,e),fe&&t.include(le.eO,{...e,pbrMode:e.pbrMode===ae.A9.Simplified?ae.A9.TerrainWithWater:ae.A9.Water});const n=e.overlayMode===le.w9.EnabledWithWater;n&&t.include(J.O,e),k.add("vnormal","vec3"),k.add("vpos","vec3"),k.add("vup","vec3"),ge(),e.screenSizePerspective&&(0,he.S7)(i);const x=e.receiveShadows&&!e.renderOccluded;x&&t.include(Z.oD,e),e.screenSizePerspective&&(k.add("screenSizeDistanceToCamera","float"),k.add("screenSizeCosAngle","float")),i.code.add((0,ue.H)(r||(r=(0,z.A)(["\n        void main(void) {\n          //Position\n          vpos = position;\n          vec3 positionWorld = position + localOrigin;\n          gl_Position = transformPosition(proj, view, vpos);\n\n          //Normal\n          vnormal = getNormal();\n\n          //Up\n          vup = getLocalUp(position, localOrigin);\n\n          ","\n\n          //Texture UV\n          vec2 uv = getUV0();\n          forwardTextureCoordinatesWithTransform(uv);\n          ","\n          ","\n\n          ","\n\n          ","\n\n        }\n      "])),n?(0,ue.H)(s||(s=(0,z.A)(["forwardVertexTangent(vnormal);"]))):(0,ue.H)(a||(a=(0,z.A)([""]))),fe?(0,ue.H)(o||(o=(0,z.A)(["setOverlayVTC(uv);"]))):"",e.tileBorders?(0,ue.H)(l||(l=(0,z.A)(["forwardTextureCoordinates();"]))):"",e.screenSizePerspective?(0,ue.H)(c||(c=(0,z.A)(["\n          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;\n          screenSizeDistanceToCamera = length(viewPos);\n          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;\n          screenSizeCosAngle = abs(viewSpaceNormal.z);"]))):"",x?(0,ue.H)(h||(h=(0,z.A)(["forwardLinearDepth();"]))):"")),t.include(Q.HQ,e),t.include(ne.kA,e),t.include(ie.n,e),t.include(oe.Bz,e),(0,he.yu)(G,e),(0,ne.a8)(G),(0,ne.eU)(G),G.uniforms.add(i.uniforms.get("localOrigin"),new de.t("viewDirection",((e,t)=>(0,B.n)(ye,(0,B.s)(ye,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))))),n&&G.uniforms.add(new _e.N("ovWaterTex",((e,t)=>{var i;return null===(i=t.overlay)||void 0===i?void 0:i.getTexture(W.A.WaterNormal)})),new pe.S("view",((e,t)=>(0,q.Tl)(ve,t.camera.viewMatrix,e.origin)))),G.code.add((0,ue.H)(d||(d=(0,z.A)(["const float sliceOpacity = 0.2;\nfloat lum(vec3 c) {\nreturn (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;\n}"])))),(0,re.Gc)(G),(0,re.O4)(G),G.code.add((0,ue.H)(u||(u=(0,z.A)(["\n        void main() {\n          vec3 normal = normalize(vnormal);\n          float vndl = dot(normal, mainLightDirection);\n\n          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));\n          float shadow = ",";\n\n          float ssao = evaluateAmbientOcclusionInverse();\n          vec4 tileColor = getTileColor();\n\n          ","\n\n          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here\n          // is neglectable because terrain typically renders first into the framebuffer.\n          if(tileColor.a <= 0.0) {\n            discard;\n          }\n\n          bool sliced = rejectBySlice(vpos);\n          if (sliced) {\n            tileColor *= sliceOpacity;\n          }\n\n          vec3 albedo = tileColor.rgb;\n\n          // heuristic shading function used in the old terrain, now used to add ambient lighting\n\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n          ","\n          ","\n          ","\n          ","\n          ","\n          fragColor = highlightSlice(fragColor, vpos);\n        }\n      "])),e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",fe?(0,ue.H)(p||(p=(0,z.A)(["\n              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);\n              vec4 overlayColor = overlayOpacity * overlayColorOpaque;\n              ","\n              vec4 groundColor = tileColor;\n              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;"])),e.invisible?(0,ue.H)(m||(m=(0,z.A)(["if (overlayColor.a == 0.0) { discard; }"]))):""):"",e.pbrMode===ae.A9.Simplified||e.pbrMode===ae.A9.TerrainWithWater?(0,ue.H)(_||(_=(0,z.A)(["fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);"]))):(0,ue.H)(g||(g=(0,z.A)(["fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);"]))),n?(0,ue.H)(f||(f=(0,z.A)(["\n              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);\n                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);\n                vec4 viewPosition = view*vec4(vpos, 1.0);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                float opacity = sliced ? sliceOpacity : 1.0;\n                // un-gamma the ground color to mix in linear space\n                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;\n              }"]))):"",e.screenSizePerspective?(0,ue.H)(v||(v=(0,z.A)(["\n            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));\n            if (perspectiveScale <= 0.25) {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);\n            }\n            else if (perspectiveScale <= 0.5) {\n              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);\n            }\n            else if (perspectiveScale >= 0.99) {\n              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);\n            }\n            else {\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);\n            }"]))):"",e.visualizeNormals?e.spherical?(0,ue.H)(y||(y=(0,z.A)(["\n                  vec3 localUp = normalize(vpos + localOrigin);\n                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));\n                  vec3 forward = normalize(cross(localUp, right));\n                  mat3 tbn = mat3(right, forward, localUp);\n                  vec3 tNormal = normalize(normal * tbn);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):(0,ue.H)(b||(b=(0,z.A)(["\n                  vec3 tNormal = normalize(normal);\n                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):"",e.tileBorders?(0,ue.H)(w||(w=(0,z.A)(["\n              vec2 dVuv = fwidth(vuv0);\n              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));\n              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);\n              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);"]))):""))}break;case j.V.LinearDepth:be&&t.include(le.eO,e),t.include(ee.L,e),(0,Z.Mu)(t),(0,Z.xJ)(t),i.code.add((0,ue.H)(x||(x=(0,z.A)(["\n              void main(void) {\n                ","\n                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n              }\n          "])),be?(0,ue.H)(C||(C=(0,z.A)(["setOverlayVTC(getUV0());"]))):"")),G.code.add((0,ue.H)(T||(T=(0,z.A)(["\n              void main() {\n                ","\n                outputDepth(linearDepth);\n              }\n          "])),be?(0,ue.H)(A||(A=(0,z.A)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case j.V.Shadow:case j.V.ShadowHighlight:case j.V.ShadowExcludeHighlight:t.include(ee.L,e),(0,Z.Mu)(t),(0,Z.xJ)(t),i.code.add((0,ue.H)(M||(M=(0,z.A)(["void main(void) {\ngl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n}"])))),G.code.add((0,ue.H)(S||(S=(0,z.A)(["void main() {\noutputDepth(linearDepth);\n}"]))));break;case j.V.Normal:be&&t.include(le.eO,e),k.add("vnormal","vec3"),(0,he.S7)(i),ge(),i.code.add((0,ue.H)(P||(P=(0,z.A)(["\n        void main(void) {\n          ","\n          gl_Position = transformPosition(proj, view, position);\n          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);\n        }\n      "])),be?(0,ue.H)(R||(R=(0,z.A)(["setOverlayVTC(getUV0());"]))):"")),G.code.add((0,ue.H)(E||(E=(0,z.A)(["\n        void main() {\n          ","\n          vec3 normal = normalize(vnormal);\n          if (gl_FrontFacing == false) {\n            normal = -normal;\n          }\n          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n        }\n      "])),be?(0,ue.H)(O||(O=(0,z.A)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case j.V.Highlight:fe&&t.include(le.eO,e),i.code.add((0,ue.H)(D||(D=(0,z.A)(["\n          void main() {\n            ","\n            gl_Position = transformPosition(proj, view, position);\n          }\n        "])),fe?(0,ue.H)(I||(I=(0,z.A)(["setOverlayVTC(getUV0());"]))):"")),t.include(te.Qh,e),G.code.add((0,ue.H)(L||(L=(0,z.A)(["\n          void main() {\n            ","\n            outputHighlight();\n          }\n        "])),fe?(0,ue.H)(N||(N=(0,z.A)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""))}return e.output===j.V.ObjectAndLayerIdColor&&(fe?(t.include(le.eO,{...e,pbrMode:ae.A9.Disabled}),i.code.add((0,ue.H)(F||(F=(0,z.A)(["void main(void) {\ngl_Position = transformPosition(proj, view, position);\nsetOverlayVTC(getUV0());\n}"])))),G.code.add((0,ue.H)(V||(V=(0,z.A)(["void main() {\nfragColor = getOverlayColorTexel(vtcOverlay);\n}"]))))):(i.code.add((0,ue.H)(H||(H=(0,z.A)(["void main(void) {}"])))),G.code.add((0,ue.H)(U||(U=(0,z.A)(["void main() {\nfragColor = vec4(0.0);\n}"])))))),t}const ve=(0,G.vt)(),ye=(0,k.vt)(),be=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:ge,build:fe},Symbol.toStringTag,{value:"Module"}))},55877:(e,t,i)=>{var n;i.d(t,{u:()=>n}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(n||(n={}))},12016:(e,t,i)=>{i.d(t,{B:()=>l});var n=i(18690),r=i(54901),s=i(76460),a=i(50346),o=i(16783);class l{constructor(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};this._mainMethod=t,this._transferLists=i,this._listeners=[],this._promise=(0,o.ho)(e,{...r,schedule:n}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,r.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>s.A.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(e," worker: ").concat(t))))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),(0,r.hA)((()=>{i.removed=!0,(0,n.TF)(this._listeners,i),this._thread&&null!=i.threadHandle&&i.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t){return this.invokeMethod(this._mainMethod,e,t)}invokeMethod(e,t,i){if(this._thread){const n=this._transferLists[e],r=n?n(t):[];return this._thread.invoke(e,t,{transferList:r,signal:i})}return this._promise?this._promise.then((()=>((0,a.Te)(i),this.invokeMethod(e,t,i)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}},86458:(e,t,i)=>{i.d(t,{W:()=>s});var n=i(9392),r=i(98799);function s(e,t){a[0]=e.x,a[1]=e.y;const i=e.z;return a[2]=void 0!==i?i:0,(0,r.H)(a,e.spatialReference,t)}const a=(0,n.vt)()},98799:(e,t,i)=>{i.d(t,{H:()=>s});var n=i(9392),r=i(482);function s(e,t,i){if(null==t)return!1;const n=(0,r.Yz)(t);return null!=n&&(n(e,0,a,0),i!==a&&(i[0]=a[0],i[1]=a[1],i.length>2&&(i[2]=a[2])),!0)}const a=(0,n.vt)()},88954:(e,t,i)=>{i.d(t,{E$:()=>C,Gs:()=>R,Jq:()=>T,PX:()=>S,Sj:()=>_,U9:()=>P,US:()=>x,Ui:()=>b,b:()=>p,jI:()=>v,lt:()=>w,oJ:()=>f,vf:()=>y,vt:()=>u,xW:()=>A});var n=i(34761),r=i(20664),s=i(9392),a=i(34111),o=i(13312),l=i(98510),c=i(5568),h=i(79650),d=i(93582);function u(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function p(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function m(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return{operations:e,value:e.create()}}(e);return i.operations=e,e.copy(t,i.value),i}function _(e){return m(d.s,(0,d.f)(0,0,0,(0,a.tO)(e).radius))}const g=2**50;function f(){return m(h.b,(0,h.f)([0,0,0],[g,0,0],[0,g,0]))}function v(e,t,i){return e.operations.axisAt(e.value,t,c._.Z,i)}function y(e,t,i,n){return e.operations.axisAt(e.value,t,i,n)}function b(e,t,i){return e.operations.intersectRay(e.value,t,i)}function w(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function x(e,t){return e.operations.altitudeAt(e.value,t)}function C(e,t,i,n){return e.operations.setAltitudeAt(e.value,t,i,n)}function T(e,t,i,s){return t!==s&&(0,n.C)(s,t),(0,r.s)(M,s[12],s[13],s[14]),C(e,M,i,M),s[12]=M[0],s[13]=M[1],s[14]=M[2],s}function A(e,t,i){return e.operations.elevate(e.value,t,i.value)}const M=(0,s.vt)();function S(e,t,i,n,s){return s[0]=(0,r.k)(e,t),s[1]=(0,r.k)(e,i),s[2]=(0,r.k)(e,n),s}function P(e,t,i,n,s){(0,r.c)(i,e),(0,r.c)(E,t),(0,r.n)(E,E),(0,r.b)(n,E,i),(0,r.b)(s,n,i)}function R(e,t){return e?(0,l.lO)(t):t.isGeographic?o.A.PlateCarree:t}const E=(0,s.vt)()},3569:(e,t,i)=>{i.d(t,{r:()=>n});const n="OBJECTID"},71630:(e,t,i)=>{i.d(t,{E:()=>n});class n{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t,t.values.byteLength+256)}}},96138:(e,t,i)=>{i.d(t,{VR:()=>p,hX:()=>u});i(35238),i(81806);var n=i(54901),r=i(76460),s=i(31633),a=i(2413),o=i(45417),l=i(13904);const c=()=>r.A.getLogger("esri.layers.support.ElevationSampler");class h{queryElevation(e){return p(e.clone(),this)}on(){return(0,n.hA)()}projectIfRequired(e,t){return m(e,t)}}class d extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){super(),this.tile=e,this.noDataValue=i;const n=e.tile.extent;this.extent=(0,a.w1)(n,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=n;const r=(0,s.GA)(t.spatialReference),o=t.lodAt(e.tile.level).resolution*r;this.demResolution={min:o,max:o}}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return(0,a.Rj)(this._aaExtent,e,t)}elevationAt(e,t){var i;if(!this.containsAt(e,t)){const i=this.extent,n="".concat(i.xmin,", ").concat(i.ymin,", ").concat(i.xmax,", ").concat(i.ymax);return c().warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(n,")")),this.noDataValue}return null!==(i=this.tile.sample(e,t))&&void 0!==i?i:this.noDataValue}}class u extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){let n;super(),"number"==typeof t?(this.noDataValue=t,n=null):(n=t,this.noDataValue=i),this.samplers=n?e.map((e=>new d(e,n,this.noDataValue))):e;const r=this.samplers[0];if(r){this.extent=r.extent.clone();const{min:e,max:t}=r.demResolution;this.demResolution={min:e,max:t};for(let i=1;i<this.samplers.length;i++){const e=this.samplers[i];this.extent.union(e.extent),this.demResolution.min=Math.min(this.demResolution.min,e.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,e.demResolution.max)}}else this.extent=(0,a.w1)((0,a.vt)(),n.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let i,n=!1;for(const r of this.samplers)if(r.containsAt(e,t)&&(n=!0,i=r.elevationAt(e,t),i!==r.noDataValue))return i;return null!=i?i:(n||c().warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler")),this.noDataValue)}}function p(e,t){const i=m(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":!function(e,t,i){e.z=i.elevationAt(t.x,t.y)}(e,i,t);break;case"polyline":!function(e,t,i){_.spatialReference=t.spatialReference;const n=e.hasM&&!e.hasZ;for(let r=0;r<e.paths.length;r++){const s=e.paths[r],a=t.paths[r];for(let e=0;e<s.length;e++){const t=s[e],r=a[e];_.x=r[0],_.y=r[1],n&&(t[3]=t[2]),t[2]=i.elevationAt(_.x,_.y)}}e.hasZ=!0}(e,i,t);break;case"multipoint":!function(e,t,i){_.spatialReference=t.spatialReference;const n=e.hasM&&!e.hasZ;for(let r=0;r<e.points.length;r++){const s=e.points[r],a=t.points[r];_.x=a[0],_.y=a[1],n&&(s[3]=s[2]),s[2]=i.elevationAt(_.x,_.y)}e.hasZ=!0}(e,i,t)}return e}function m(e,t){if(null==e)return null;const i=e.spatialReference;if(i.equals(t))return e;const n=(0,o.Cv)(e,t);return n||c().error("Cannot project geometry spatial reference (wkid:".concat(i.wkid,") to elevation sampler spatial reference (wkid:").concat(t.wkid,")")),n}const _=new l.A},60586:(e,t,i)=>{i.d(t,{Q:()=>n});class n{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}}},2052:(e,t,i)=>{i.d(t,{i:()=>n});class n{constructor(e,t,i,n){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=t,this.height=i,this.noDataValue=n)}get hasNoDataValues(){if(null==this._hasNoDataValues){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}_ensureBounds(){if(null!=this._minValue)return;const{noDataValue:e,values:t}=this;let i=1/0,n=-1/0,r=!0;for(const s of t)s===e?this._hasNoDataValues=!0:(i=s<i?s:i,n=s>n?s:n,r=!1);r?(this._minValue=0,this._maxValue=0):(this._minValue=i,this._maxValue=n>-3e38?n:0)}}},60883:(e,t,i)=>{i.d(t,{b:()=>a});var n=i(12016);class r extends n.B{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;super("LercWorker","_decode",{_decode:e=>[e.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,t,i){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},i):Promise.resolve(null)}release(){--this.ref<=0&&(s.forEach(((e,t)=>{e===this&&s.delete(t)})),this.destroy())}}const s=new Map;function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=s.get(e);return t||(null!=e?(t=new r((t=>e.immediate.schedule(t))),s.set(e,t)):(t=new r,s.set(null,t))),++t.ref,t}},79701:(e,t,i)=>{i.d(t,{W:()=>g,l:()=>_});var n=i(50076),r=i(76460),s=i(34154),a=i(65256),o=i(50265),l=i(15142),c=i(53430),h=i(65460),d=i(98976);const u=()=>r.A.getLogger("esri.layers.support.labelFormatUtils"),p={type:"simple",evaluate:()=>null},m={getAttribute:(e,t)=>e.field(t)};async function _(e,t,i){if(!e||!e.symbol||!t)return p;const r=e.where,a=(0,h.XJ)(e);let o;if("arcade"===a.type){const e=await(0,d.$I)(a.expression,i,t);if(null==e)return p;o={type:"arcade",evaluate(t,r){try{const i="attributes"in t?e.repurposeFeature(t):t;i.contextTimeZone=null!==r&&void 0!==r?r:null;const n=e.evaluate({$view:{timeZone:r},$feature:i},e.services);if(null!=n)return n.toString()}catch(i){u().error(new n.A("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:i,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,h.tH)(a.expression)}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const n=i.slice(1,-1),r=t.get(n);if(!r)return i;let s=null;return"attributes"in e?e&&e.attributes&&(s=e.attributes[r.name]):s=e.field(r.name),null==s?"":g(s,r)}))};if(r){let e;try{e=await(0,s.G)(r,t)}catch(l){return u().error(new n.A("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:r,error:l})),p}const i=o.evaluate;o.evaluate=(t,s)=>{const a="attributes"in t?void 0:m;try{if(e.testFeature(t,a))return i(t,s)}catch(l){u().error(new n.A("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:r,feature:t,error:l}))}return null}}return o}function g(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:n,min:r}=(0,l.A5)(t),s=+e;if(null!=r&&null!=n&&r<=s&&s<=n)return i.name}let n=e;return(0,c.vE)(t)?n=(0,a.Yq)(n,(0,a.J2)("short-date")):(0,c.WA)(t)&&(n=(0,o.ZV)(+n)),n||""}},12482:(e,t,i)=>{i.d(t,{$7:()=>x,B:()=>w,Fo:()=>v,M7:()=>A,NN:()=>u,Q5:()=>y,Tq:()=>S,Up:()=>b,XF:()=>T,Ze:()=>m,bK:()=>o,bh:()=>d,id:()=>_,ky:()=>h,qt:()=>M,tW:()=>C,w7:()=>l,wF:()=>a,wS:()=>g,xS:()=>f,ze:()=>c});var n=i(31633),r=i(59097);function s(e){return e?M:S}function a(e,t){return null!==t&&void 0!==t&&t.mode?t.mode:s(e).mode}function o(e,t){return null!=t?t:s(e)}function l(e,t){return a(null!=e&&e.hasZ,t)}function c(e,t){return o(null!=e&&!!e.hasZ,t)}function h(e){const t=p(e);return l(e.geometry,t)}function d(e){const t=p(e),i=l(e.geometry,t);return{mode:i,offset:null!=t&&"on-the-ground"!==i?A(t):0}}function u(e){if("on-the-ground"===h(e))return!1;const t=p(e),i=null!==t&&void 0!==t&&t.featureExpressionInfo?t.featureExpressionInfo.expression:null;return!(!i||"0"===i)}function p(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function m(e,t){if(null===e||void 0===e||!e.offset)return 0;const{offset:i,unit:r}=e;if("decimal-degrees"===r)return 0;const s="unknown"!==r&&r?r:"meters",a=(0,n.mq)(t);return a?(0,n.oU)(i,s,a):0}function _(e,t,i){var n,r;if(null===i||void 0===i||!i.mode)return;const s=e.hasZ?e.z:0,a=m(i,e.spatialReference);switch(i.mode){case"absolute-height":return s-a;case"on-the-ground":return 0;case"relative-to-ground":return s-((null!==(n=t.elevationProvider.getElevation(e.x,e.y,s,e.spatialReference,"ground"))&&void 0!==n?n:0)+a);case"relative-to-scene":return s-((null!==(r=t.elevationProvider.getElevation(e.x,e.y,s,e.spatialReference,"scene"))&&void 0!==r?r:0)+a)}}function g(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return v(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,i,n)}function f(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return v(e,t[0],t[1],t.length>2?t[2]:0,i,n,r)}function v(e,t,i,n,r,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(null==s)return;const o=null!=a?a.mode:"absolute-height";if("on-the-ground"===o)return 0;const{absoluteZ:l}=y(t,i,n,r,e,s);return function(e,t,i,n,r,s,a,o){var l,c;const h=m(a,r);switch(o){case"absolute-height":return e-h;case"relative-to-ground":return e-((null!==(l=s.elevationProvider.getElevation(t,i,n,r,"ground"))&&void 0!==l?l:0)+h);case"relative-to-scene":return e-((null!==(c=s.elevationProvider.getElevation(t,i,n,r,"scene"))&&void 0!==c?c:0)+h)}}(l,t,i,n,r,e,a,o)}function y(e,t,i,n,r,s){const a=m(s,n);switch(s.mode){case"absolute-height":return{absoluteZ:i+a,elevation:0};case"on-the-ground":{var o;const i=null!==(o=r.elevationProvider.getElevation(e,t,0,n,"ground"))&&void 0!==o?o:0;return{absoluteZ:i,elevation:i}}case"relative-to-ground":{var l;const s=null!==(l=r.elevationProvider.getElevation(e,t,i,n,"ground"))&&void 0!==l?l:0;return{absoluteZ:i+s+a,elevation:s}}case"relative-to-scene":{var c;const s=null!==(c=r.elevationProvider.getElevation(e,t,i,n,"scene"))&&void 0!==c?c:0;return{absoluteZ:i+s+a,elevation:s}}}}function b(e,t){if(null==t)return!1;const{mode:i}=t;return null!=i&&("scene"===e&&"relative-to-scene"===i||"ground"===e&&"absolute-height"!==i)}function w(e,t,i){return i&&i.mode!==t?"".concat(e," only support ").concat(t," elevation mode"):null}function x(e,t,i){return(null===i||void 0===i?void 0:i.mode)===t?"".concat(e," do not support ").concat(t," elevation mode"):null}function C(e,t){return null!=(null===t||void 0===t?void 0:t.featureExpressionInfo)&&"0"!==t.featureExpressionInfo.expression?"".concat(e," do not support featureExpressionInfo"):null}function T(e,t){t&&e.warn(".elevationInfo=",t)}function A(e){var t;return(null!==(t=null===e||void 0===e?void 0:e.offset)&&void 0!==t?t:0)*(0,r.Ao)(null===e||void 0===e?void 0:e.unit)}const M={mode:"absolute-height",offset:0},S={mode:"on-the-ground",offset:null}},8794:(e,t,i)=>{i.d(t,{q:()=>o});var n=i(54099),r=i(81806),s=i(50346);const a=0===(0,r.A)("mapview-transitions-duration")?0:1/(0,r.A)("mapview-transitions-duration");class o extends n.A{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){var t;if(this._stage===e)return;const i=this._stage;this._stage=e,e?(null===(t=this._stage)||void 0===t?void 0:t.untrashDisplayObject(this))||(this.onAttach(),this.emit("attach")):null===i||void 0===i||i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,s.Tw)(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,s.Tw)(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){var e,t;null!==(e=this._fadeInResolver)&&void 0!==e&&e.call(this),this._fadeInResolver=null,null!==(t=this._fadeOutResolver)&&void 0!==t&&t.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;null===(e=this.parent)||void 0===e||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,t){if(this.fadeTransitionEnabled&&0!==a){const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const n=e*a;this.computedOpacity=i>t?Math.max(t,i-n):Math.min(t,i+n),this.computedVisible=this.computedOpacity>0;const r=t===this.computedOpacity;this.inFadeTransition=!r,r||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}},72770:(e,t,i)=>{var n,r;i.d(t,{M:()=>r,T:()=>n}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(n||(n={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(r||(r={}))},62887:(e,t,i)=>{i.d(t,{IT:()=>n,av:()=>s,o2:()=>r,zk:()=>a});const n=!0,r=32,s=1.5,a=200},89241:(e,t,i)=>{i.d(t,{Pd:()=>s,VS:()=>o,oI:()=>a});var n=i(93345),r=i(21812);const s={geometry:[new r._("a_pos",2,n.pe.BYTE,0,2)]},a={geometry:[new r._("a_pos",2,n.pe.BYTE,0,4),new r._("a_tex",2,n.pe.BYTE,2,4)]},o={geometry:[new r._("a_pos",2,n.pe.UNSIGNED_SHORT,0,4)]}},30520:(e,t,i)=>{i.d(t,{E:()=>n});class n{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}}},78440:(e,t,i)=>{i.d(t,{Y:()=>a});var n=i(63919),r=i(8794),s=i(93453);class a extends r.q{constructor(e,t,i,n,r,a){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:r,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:a;super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new s.A(e),this.resolution=t,this.x=i,this.y=n,this.width=r,this.height=a,this.rangeX=o,this.rangeY=l}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[r,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;(0,n.hZ)(i,a,0,0,0,o,0,r,s,1),(0,n.lw)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}},46141:(e,t,i)=>{i.d(t,{n:()=>a});var n=i(60645);class r{constructor(e,t,i,n,r,s,a,o){let l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=n,this.detailSize=r,this.smoothness=s,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const s=new r([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],n.p.SIXTEEN),a={sunny:s,cloudy:new r([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],n.p.TWOHUNDRED,.6),rainy:new r([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],n.p.TWOHUNDRED,.4),snowy:new r([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],n.p.HUNDRED,.65),foggy:new r([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],n.p.SIXTEEN),default:s}},60645:(e,t,i)=>{i.d(t,{H:()=>c,p:()=>n});var n,r,s=i(35143),a=i(81806),o=i(49753),l=i(99415);(r=n||(n={}))[r.SIXTEEN=0]="SIXTEEN",r[r.HUNDRED=1]="HUNDRED",r[r.TWOHUNDRED=2]="TWOHUNDRED",r[r.COUNT=3]="COUNT";class c extends l.K{constructor(){super(...arguments),this.steps=n.SIXTEEN,this.writeTextureChannels=o.c.RG}}(0,s._)([(0,l.W)({count:n.COUNT})],c.prototype,"steps",void 0),(0,s._)([(0,l.W)({constValue:(0,a.A)("esri-mobile")?1024:2048})],c.prototype,"cubeMapSize",void 0),(0,s._)([(0,l.W)()],c.prototype,"writeTextureChannels",void 0)},39033:(e,t,i)=>{i.d(t,{F:()=>o,L:()=>n});var n,r,s=i(35143),a=i(99415);(r=n||(n={}))[r.Full=0]="Full",r[r.WeatherMap=1]="WeatherMap",r[r.COUNT=2]="COUNT";class o extends a.K{constructor(){super(...arguments),this.mode=n.Full}}(0,s._)([(0,a.W)({count:n.COUNT})],o.prototype,"mode",void 0)},89426:(e,t,i)=>{i.d(t,{CQ:()=>n,M4:()=>o,QG:()=>l,Y8:()=>r,fI:()=>c,ik:()=>s,jj:()=>a});const n=(0,i(81806).A)("esri-mobile")?64:128,r=n/128,s=Math.ceil(Math.sqrt(n)),a=(n+2)*s,o=1e5,l=128,c=a/1560},90376:(e,t,i)=>{i.d(t,{C:()=>n,a:()=>o});var n,r,s=i(35143),a=i(99415);(r=n||(n={}))[r.Rain=0]="Rain",r[r.Snow=1]="Snow",r[r.COUNT=2]="COUNT";class o extends a.K{constructor(){super(...arguments),this.type=n.Rain}}(0,s._)([(0,a.W)({count:n.COUNT})],o.prototype,"type",void 0)},99650:(e,t,i)=>{i.d(t,{$:()=>l,d:()=>n});var n,r,s=i(35143),a=i(99415),o=i(92656);(r=n||(n={}))[r.Cone=0]="Cone",r[r.Cylinder=1]="Cylinder",r[r.Underground=2]="Underground",r[r.COUNT=3]="COUNT";class l extends o.E{constructor(){super(...arguments),this.geometry=n.Cone}}(0,s._)([(0,a.W)({count:n.COUNT})],l.prototype,"geometry",void 0)},92945:(e,t,i)=>{i.d(t,{A:()=>p});var n,r=i(35143),s=i(63241),a=i(54099),o=i(76460),l=i(46053),c=(i(81806),i(47249),i(85842)),h=i(98277);let d=n=class extends(a.A.EventedMixin(h.A)){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get ambientOcclusionEnabled(){var e;return(0,s.Lx)(o.A.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),null!==(e=this._get("ambientOcclusionEnabled"))&&void 0!==e&&e}set ambientOcclusionEnabled(e){(0,s.Lx)(o.A.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",e)}get waterReflectionEnabled(){var e;return(0,s.Lx)(o.A.getLogger(this),"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),null!==(e=this._get("waterReflectionEnabled"))&&void 0!==e&&e}set waterReflectionEnabled(e){(0,s.Lx)(o.A.getLogger(this),"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",e)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new n(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=n.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const s=n.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(u.target=this,u.timezoneOffset=s,this.emit("timezone-will-change",u),u.target=null),null!=e)return isNaN(e.getTime())||r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new n({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"cameraTrackingEnabled",void 0),(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"ambientOcclusionEnabled",null),(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"waterReflectionEnabled",null),(0,r._)([(0,l.MZ)({type:Date})],d.prototype,"defaultDate",null),(0,r._)([(0,l.MZ)({type:Date})],d.prototype,"date",null),d=n=(0,r._)([(0,c.$)("esri.views.3d.environment.SunLighting")],d),(d||(d={})).calculateTimezoneOffset=function(e){let{hours:t,minutes:i,seconds:n}=e;return Math.round(t+i/60+n/3600)};const u={target:null,timezoneOffset:0},p=d},27816:(e,t,i)=>{i.d(t,{A:()=>u});var n,r=i(35143),s=i(63241),a=i(54099),o=i(76460),l=i(46053),c=(i(81806),i(47249),i(85842)),h=i(99372);let d=n=class extends(a.A.EventedMixin(h.A)){constructor(e){super(e),this.cameraTrackingEnabled=!0}get ambientOcclusionEnabled(){var e;return(0,s.Lx)(o.A.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),null!==(e=this._get("ambientOcclusionEnabled"))&&void 0!==e&&e}set ambientOcclusionEnabled(e){(0,s.Lx)(o.A.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",e)}get waterReflectionEnabled(){var e;return(0,s.Lx)(o.A.getLogger(this),"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),null!==(e=this._get("waterReflectionEnabled"))&&void 0!==e&&e}set waterReflectionEnabled(e){(0,s.Lx)(o.A.getLogger(this),"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",e)}clone(){return new n({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new n(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"ambientOcclusionEnabled",null),(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"waterReflectionEnabled",null),(0,r._)([(0,l.MZ)({type:Boolean})],d.prototype,"cameraTrackingEnabled",void 0),d=n=(0,r._)([(0,c.$)("esri.views.3d.environment.VirtualLighting")],d);const u=d},45462:(e,t,i)=>{i.d(t,{GF:()=>r,UP:()=>s,nv:()=>a,yv:()=>o});var n=i(15941);function r(e){const t=1e5;return(0,n.qE)((e-t)/9e5,0,1)}const s=1e4,a=.085,o=1e5},60704:(e,t,i)=>{i.d(t,{Bk:()=>a,ds:()=>o,r8:()=>l});let n,r=null;const s=new Map;async function a(e){null==r&&(null==n&&(n=i.e(38300).then(i.bind(i,38300))),r=await n);const t=e.view;let a=s.get(t);return a||(a=new r.default({view:t}),s.set(t,a)),a.addVoxelLayer(e)}function o(e){return s.get(e)}function l(e){const t=e.view,i=s.get(t);i&&i.removeVoxelLayer(e)<1&&(s.delete(t),0===s.size&&(n=null,r=null))}},6918:(e,t,i)=>{i.d(t,{C:()=>K,c:()=>te});var n=i(35143),r=i(91967),s=i(98773),a=i(76460),o=i(87663),l=i(30726),c=i(50346),h=i(68134),d=i(46053),u=(i(81806),i(47249),i(85842)),p=i(72745),m=i(32535),_=i(79701),g=i(82041),f=i(89422),v=i(26611),y=i(19852),b=i(86098),w=i(49223);function x(e){return e instanceof w.Q?e.graphics3DSymbol:e instanceof b.Z?e:null}var C=i(70374),T=i(20664),A=i(9392),M=i(42294),S=i(38865),P=i(42510),R=i(84248);const E=()=>a.A.getLogger("esri.views.3d.layers.graphics.labelPlacement");class O{constructor(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=i,this.disablePlacement=n}}function D(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:n}=e,r=x(n.graphics3DSymbol),s="point-3d"===(null===r||void 0===r?void 0:r.symbol.type)?r.symbol:null,a=H[t]||N(e);return null!=s&&s.supportsCallout()&&s.hasVisibleVerticalOffset()&&!n.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:V(s.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!n.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&function(e){return"above-center"===e}(a.placement)?{placement:"above-center",verticalOffset:V(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(E().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,n=H[i],r=n||N(e);return i&&!n&&E().warnOncePerTick("the requested label placement '".concat(i,"' is currently unsupported in SceneView.")),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(null==i)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(E().warnOncePerTick(L(null===e||void 0===e?void 0:e.placement,t.disablePlacement.logEntityDescription)),N(t)):e;const n=i.type;switch(n){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return E().warnOncePerTick(L(null===e||void 0===e?void 0:e.placement,"'".concat(n,"' geometries"))),N(t);break;case"point":case"mesh":return e}return e}(r,e)}(e,t);if(null==i)return null;const n=i.anchor,r=!!t.hasLabelVerticalOffset,s=t.verticalOffset;return function(e,t,i){const n=i.graphics3DGraphic.graphic.geometry;if(null==n)return null;switch(n.type){case"point":!function(e,t,i){const n=I(i);if(null==n)return;const r=i.graphics3DGraphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,T.s)(e.translation,0,0,0),n.type){case"icon":case"text":!function(e,t,i,n){const{graphics3DGraphic:r}=i,s=null!=n?n.getScreenSize():null;if(r.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(H[i.labelClass.labelPlacement]&&E().warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center");else{const n=function(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:z;const{graphics3DGraphic:n}=e,r=n.layers[0],s=null!==(t=null===r||void 0===r?void 0:r.stageObject.geometries[0].material)&&void 0!==t?t:null;if(s&&s instanceof R.R){const e=s.parameters.anchorPosition;i[0]=2*(e[0]-.5),i[1]=2*(e[1]-.5)}else i[0]=0,i[1]=0;return i}(i);e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-n[0]);const r=s[1]/2*(t.normalizedOffset[1]-n[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=r,e.centerOffsetUnits="screen"):e.screenOffset[1]=r}}(e,t,i,r);break;case"object":F(e,t,r)}}(e,t,i);break;case"polygon":!function(e,t,i){const n=I(i);if(null!=n)switch(n.type){case"extrude":{const n=i.graphics3DGraphic.layers[0];null!=n?(n.getBoundingBoxObjectSpace(q),(0,M.gX)(q,e.translation),e.translation[2]=(0,M.uJ)(q)/2):(0,T.s)(e.translation,0,0,0),F(e,t,n);break}}}(e,t,i);break;case"mesh":F(e,t,i.graphics3DGraphic.layers[0])}const r=S.VN-P.Xd;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}(new C.A(s,n,r),i,e)}function I(e){const t=x(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function L(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function N(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:A.uY,anchor:"center"};case"polygon":{const t=I(e);return null!=t&&"extrude"===t.type?H["above-center"]:{placement:"center-center",normalizedOffset:A.uY,anchor:"center"}}case"point":case"mesh":return H["above-center"];default:return}}function F(e,t,i){const n=null!=i?i.getBoundingBoxObjectSpace(q):q,r=(0,A.fA)(n[3]-n[0],n[4]-n[1],n[5]-n[2]),s=Math.sqrt(r[0]*r[0]+r[1]*r[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const a=e.translation[2],o=r[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,T.l)(r);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function V(e){const{screenLength:t,minWorldLength:i,maxWorldLength:n}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:n}}const H={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},U={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const ne in U){const e=U[ne],t=H[ne];e.forEach((e=>{H[e]=t}))}Object.freeze&&(Object.freeze(H),Object.keys(H).forEach((e=>{var t;Object.freeze(H[e]),Object.freeze(null===(t=H[e])||void 0===t?void 0:t.normalizedOffset)})));const z=[0,0],q=(0,M.vt)();var G=i(82250);class B{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var k=i(70741),W=i(25175),Z=i(8918),j=i(59752),Q=i(22856);class X{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Y{constructor(e,t,i,n,r){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=n,this.labelFunction=r,this.calloutSymbolLayerIndex=0}}class ${constructor(e,t,i,n,r,s,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=n,this.emptySymbolLabelSupported=r,this.elevationInfoOverride=s,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new Z.x(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let K=class extends r.A{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,h.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>this.setDirty())),(0,h.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.rasterPixelRatio}),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(j.W6.LABELER,this)]),this._textTextureAtlas=new W.C({view:this.view}),this._hudMaterialCollection=new B(this.view._stage),this._calloutMaterialCollection=new B(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,l.WD)(this._textTextureAtlas),this._hudMaterialCollection=(0,l.WD)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,l.WD)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),ie.graphic=null,ie.renderingInfo=null,ie.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const n=new X(e,t);this._labels.set(i,n),e.labelsToInitialize.set(i,n),t.setVisibilityFlag(f.u.LABEL,f.Z.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(f.u.LABEL,f.Z.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&(this._textTextureAtlas.addTextTexture(i,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];null!=i&&(this._textTextureAtlas.removeTextTexture(i,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Q.G}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(J(t))this._dirty=!0;else if(ee(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else(0,o.Bs)(t.labelsToInitialize,((i,n)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(n,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(n),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var t,i;const n=null===(t=e.labelClassAbortController)||void 0===t?void 0:t.signal;e.layer.when&&await e.layer.when(),(0,c.Te)(n),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const r=e.graphics3DCore,o=null===(i=r.layer.labelingInfo)||void 0===i?void 0:i.filter((e=>!!e.symbol));if(!o||0===o.length)return;let l=!1;await(0,s.jJ)(o,(async(t,i)=>{const o=t.symbol,h=x(r.getOrCreateGraphics3DSymbol(o));if(null==h)return void a.A.getLogger(this).error("Failed to create Graphics3DSymbol for label");await h.load(),(0,c.Te)(n);let d=null;(0,g.YX)(o)&&o.hasVisibleCallout()&&(d=(0,v.L)(o,r.symbolCreationContext),await d.load(),(0,c.Te)(n));const u=await(0,s.Ke)((0,_.l)(t,e.layer.fieldsIndex,this.view.spatialReference));if((0,c.Te)(n),!0===u.ok){const r=await this._createTextRenderParameters(h.symbol);(0,c.Te)(n),e.labelClassContexts[i]=new Y(t,h,d,r,u.value)}else a.A.getLogger(this).error("Label expression failed to evaluate: ".concat(u.error)),l=!0})),(0,c.Te)(n)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,c.zf)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==(null===t||void 0===t?void 0:t.type)?null:k.G.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,l.DC)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,n,r,s){const a=new C.J(i,(0,G.Dt)(i.anchor),(0,G.fy)(i.anchor),e.text,(0,p.fA)(e.displayWidth,e.displayHeight));return ie.graphic=t,ie.renderingInfo=null,ie.layer=n,r.createLabel(ie,a,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=D(s);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,i,n,r){ie.graphic=e,ie.layer=r;const s=n.screenOffset[0];return ie.renderingInfo=new y.AG(null,t,n.translation,n.centerOffset,s,n.centerOffsetUnits,n.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(ie)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,n=i.labelClassContexts;if(ee(n)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let r=!1;const s=t.graphic,a=i.layer,o=te(i.layer);for(let h=0;h<n.length;h++){var l,c;const d=e.textRenderers[h],u=e.textLabelPlacements[h];if(null==d||null==u)continue;const p=n[h],m=p.graphics3DSymbol,_=m.symbol&&"label-3d"===m.symbol.type?m.symbol:null,g=m.symbolLayers[0];if(!g)continue;g.setElevationInfoOverride(i.elevationInfoOverride);const v=new O(t,_,p.labelClass),y=this._createTextSymbolGraphic(d,s,u,a,g,v);if(null==y)return!1;y._labelClass=p.labelClass,y._labelIndex=h,t.addLabelGraphic(y,i.stageLayer),t.deconflictionPriority=null!==(l=null===(c=p.textRenderParameters)||void 0===c?void 0:c.definition.size)&&void 0!==l?l:0,t.setVisibilityFlag(f.u.LABEL,f.Z.USER,o),t.setVisibilityFlag(f.u.LABEL,f.Z.SCALE_RANGE,!0),t.setVisibilityFlag(f.u.LABEL,f.Z.DECONFLICTION,!1),r=!0;const b=p.graphics3DCalloutSymbolLayer;if(b&&u.hasLabelVerticalOffset){b.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(s,_,b,u,a);null!=e&&(p.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return i.scaleVisibility&&r&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null===e||void 0===e||e.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(ee(i))return;const n=e.graphics3DGraphic.graphic;for(let a=0;a<i.length;a++){var r;const o=i[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==(null===o||void 0===o?void 0:o.textRenderParameters))continue;const l=o.labelFunction;let c;if("arcade"===l.type)try{const e=l.needsHydrationToEvaluate()?(0,m.wP)(n,t.layer):n;c=l.evaluate(e)}catch(s){c=null}else c=l.evaluate(n);if(null==c||""===c||/^\s+$/.test(c))continue;const h=o.graphics3DSymbol,d="label-3d"===(null===(r=h.symbol)||void 0===r?void 0:r.type)?h.symbol:null;if(!h.symbolLayers[0])continue;const u=D({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:d,labelClass:o.labelClass,disablePlacement:t.disablePlacement});if(null==u)continue;const p=(0,G.Dt)(u.anchor),_=(0,G.QE)(p);e.textRenderers[a]=new P.Js(c,_,o.textRenderParameters,W.C.maxSize),e.textLabelPlacements[a]=u}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const n=new X(e,t);this._labels.set(i,n),e.labelsToInitialize.set(i,n)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,n=this._labels.get(i);e.graphics.delete(i),n&&(this._destroyGraphic(n,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const n=new Map;t.graphics.forEach((e=>n.set(e.graphic.uid,e)));const r=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,n,r),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,n,t)}}}_visibilityInfoChange(e){const t=te(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const n=this._labels.get(i);n&&(this._destroyGraphic(n,i),n.visible=!1,e.labelsToInitialize.set(i,n))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const n=i&&i.emptySymbolLabelSupported||!1,r=(null===i||void 0===i?void 0:i.elevationInfoOverride)||null,s=(null===i||void 0===i?void 0:i.disablePlacement)||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new $(this.view._stage,a,e,t,n,r,s,te(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>te(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,n=this._labels.get(i);n&&n.visible!==t&&(t&&!n.addedToTextureAtlas?(this._addLabelTextureToAtlas(n),n.textInitialized||n.labelingContext.labelsToInitialize.set(i,n)):!t&&n.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(n),n.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>J(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(J(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function J(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function ee(e){return!e||0===e.length}function te(e){var t;return!0===e.labelsVisible&&!(null===(t=e.labelingInfo)||void 0===t||!t.some((e=>!!e.symbol)))}(0,n._)([(0,d.MZ)({constructOnly:!0})],K.prototype,"view",void 0),(0,n._)([(0,d.MZ)({constructOnly:!0})],K.prototype,"deconflictor",void 0),(0,n._)([(0,d.MZ)()],K.prototype,"_textTextureAtlas",void 0),(0,n._)([(0,d.MZ)({type:Boolean,readOnly:!0})],K.prototype,"updating",null),K=(0,n._)([(0,u.$)("esri.views.3d.layers.graphics.Labeler")],K);const ie=new y.Rj(null,null,null)},45270:(e,t,i)=>{i.d(t,{Aw:()=>c,Jb:()=>l,Q5:()=>u,W3:()=>p,d:()=>a,db:()=>d,kV:()=>h,rb:()=>o});var n=i(3112),r=i(35737),s=i(46571);class a extends r.R6{constructor(e,t,i,n){super(t,i),this.point=e,this.createGraphic=n}}function o(e){return(0,s.i3)(e)&&e.intersector===n.dz.PCL&&!!e.target}class l extends r.HE{constructor(e,t,i,n,r){super(e),this.layerUid=e,this.sublayerUid=t,this.nodeIndex=i,this.componentIndex=n,this.triangleNr=r}}class c extends r.R6{constructor(e,t,i){super(t,null),this.point=e,this.createVoxelGraphic=i}}class h extends r.R6{constructor(e,t){super(e,null),this.createTiles3DGraphic=t}}function d(e){return(0,s.i3)(e)&&e.intersector===n.dz.I3S&&!!e.target}function u(e){return(0,s.i3)(e)&&e.intersector===n.dz.VOXEL&&!!e.target}function p(e){return(0,s.i3)(e)&&e.intersector===n.dz.TILES3D&&!!e.target}},33836:(e,t,i)=>{i.d(t,{J:()=>a,b:()=>n});var n,r,s=i(2413);class a{constructor(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.lij=[0,0,0],this.extent=(0,s.vt)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:n.VISIBLE_ON_SURFACE,screenRect:(0,s.vt)(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,n){this.tilingScheme=n,this.id=a.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,n.getExtent(e,t,i,this.extent),this.resolution=n.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],n=2*this.lij[2];return e?(e[0].acquire(t,i,n,this.tilingScheme),e[1].acquire(t,i+1,n,this.tilingScheme),e[2].acquire(t,i,n+1,this.tilingScheme),e[3].acquire(t,i+1,n+1,this.tilingScheme),e):[new a(t,i,n,this.tilingScheme),new a(t,i+1,n,this.tilingScheme),new a(t,i,n+1,this.tilingScheme),new a(t,i+1,n+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,s.C)(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return"".concat(e,"/").concat(t,"/").concat(i)}}(r=n||(n={}))[r.INVISIBLE=0]="INVISIBLE",r[r.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",r[r.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"},61985:(e,t,i)=>{i.d(t,{P:()=>a});var n=i(20664),r=i(9392),s=i(4763);class a{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=(0,s.vt)(),this._points=(0,s.Qy)(),this.lines=new Array(12),this._origin=(0,r.vt)(),this._direction=(0,r.vt)(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:(0,r.vt)(),endpoint:null}}update(e){(0,s.ui)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,n.c)(this._origin,e.eye),(0,n.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)(0,n.c)(this._points[t],e[t]);(0,s.DV)(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return(0,s.m7)(this.frustum,e)}intersectsRay(e){return(0,s.pw)(this.frustum,e)}intersectsLineSegment(e,t){return(0,s.ST)(this.frustum,e,t)}intersectsPoint(e){return(0,s.bU)(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;o(this.lines[t],e[t],e[i]),o(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),o(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function o(e,t,i){e.origin=t,e.endpoint=i,(0,n.E)(e.direction,t,i)}a.planePointIndices=s.c8,a.nearFarLineIndices=[[s.J7.NEAR_BOTTOM_LEFT,s.J7.FAR_BOTTOM_LEFT],[s.J7.NEAR_BOTTOM_RIGHT,s.J7.FAR_BOTTOM_RIGHT],[s.J7.NEAR_TOP_RIGHT,s.J7.FAR_TOP_RIGHT],[s.J7.NEAR_TOP_LEFT,s.J7.FAR_TOP_LEFT]]},95225:(e,t,i)=>{i.d(t,{H:()=>n});class n{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},69495:(e,t,i)=>{i.d(t,{G:()=>d,w:()=>h});var n=i(35143),r=i(91967),s=i(76460),a=i(79369),o=i(52394),l=i(46053),c=(i(81806),i(47249),i(85842));function h(e){return new u({view:e})}const d=.1;let u=class extends r.A{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new a.F,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,o.mg)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new a.Mn(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>d&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,d),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){var e,t,i,n;if(!this.view)return;null===(e=this.view._stage)||void 0===e||null===(e=e.renderer)||void 0===e||e.tick();const r=null===(t=this.view._stage)||void 0===t||null===(t=t.renderer)||void 0===t?void 0:t.usedMemory;let a=(null!==(i=null===(n=this.view.basemapTerrain)||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0)+(r?r.fbos+r.edges+r.plugins:0),o=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const t=e.ignoresMemoryFactor?this._quality:1;a+=e.usedMemory*t,o+=e.unloadedMemory*t}}));const l=null==this._warnMemoryUsage||Math.round(10*a)!==Math.round(10*this._warnMemoryUsage),c=1048576*this.maxMemory;if(a>c&&l){this._warnMemoryUsage=a;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",t=Math.round(100*this._quality);s.A.getLogger(this).warn("Memory Limit exceeded! Limit: ".concat(e(c)," Current: ").concat(e(a)," Projected: ").concat(e(a+o)," Quality: ").concat(t,"%"))}this._usedMemory=a/c,this._memoryPredicted=(a+o)/c;const h=c-a;this._cacheStorage.maxSize=Math.max(0,h+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};(0,n._)([(0,l.MZ)({constructOnly:!0})],u.prototype,"view",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"maxMemory",null),(0,n._)([(0,l.MZ)()],u.prototype,"additionalCacheMemory",null),(0,n._)([(0,l.MZ)({readOnly:!0})],u.prototype,"memoryFactor",null),(0,n._)([(0,l.MZ)({readOnly:!0})],u.prototype,"updating",null),(0,n._)([(0,l.MZ)({readOnly:!0})],u.prototype,"usedMemory",null),(0,n._)([(0,l.MZ)({readOnly:!0})],u.prototype,"usedCacheMemory",null),(0,n._)([(0,l.MZ)()],u.prototype,"_quality",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"_usedMemory",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"_updating",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"_stableQuality",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"_maxMemory",void 0),(0,n._)([(0,l.MZ)()],u.prototype,"_additionalCacheMemory",void 0),u=(0,n._)([(0,c.$)("esri.views.3d.support.MemoryController")],u)},74487:(e,t,i)=>{i.d(t,{d:()=>y});var n=i(15941),r=i(31633),s=i(34761),a=i(20664),o=i(34111),l=i(98510),c=i(64232),h=i(60216),d=i(14487),u=i(5568),p=i(88954),m=i(13927),_=i(96190),g=i(75762),f=i(81284),v=i(64465);class y{constructor(e,t,i,n){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=n,this._tmpCoordinateSystem=(0,p.vt)(n),this.referenceEllipsoid=(0,o.tO)(t),this.sphericalPCPF=(0,l.lO)(t)}set extent(e){e&&(0,p.b)(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return(0,p.US)(this._coordinateSystem,e)}setAltitude(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return(0,p.E$)(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){(0,p.Jq)(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return(0,p.jI)(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return(0,p.vf)(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,u._.X,g.rq.get()),n=this.worldBasisAtPosition(e,u._.Y,g.rq.get()),r=this.worldBasisAtPosition(e,u._.Z,g.rq.get());return(0,s.hZ)(t,i[0],i[1],i[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,g.rq.get()),r=this.worldBasisAtPosition(e,u._.Y,g.rq.get()),s=(0,_.EJ)(t,r,i);return(0,n.KJ)(s)}intersectManifoldClosestSilhouette(e,t,i){return(0,p.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,p.lt)(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){(0,p.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem);const n=g.rq.get();return(0,p.Ui)(this._tmpCoordinateSystem,e,n)?(0,a.c)(i,n):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===v.RT.Global)return this.intersectManifold(e,t,i);(0,p.xW)(this._coordinateSystem,t,this._tmpCoordinateSystem);const n=this._tmpCoordinateSystem.value,r=g.rq.get();return(0,m.Ui)(n.plane,e,r)?(0,a.c)(i,r):null}toRenderCoords(e,t,i){return(0,f.v)(e)?(0,c.g)(e,t,this.spatialReference):(0,d.F)(e,t,i,this.spatialReference)}fromRenderCoords(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,f.v)(t)?(null!=i&&(t.spatialReference=i),(0,h.E)(e,this.spatialReference,t)?t:null):(0,d.F)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case v.RT.Local:return new y(v.RT.Local,t,(0,r.GA)(t),(0,p.oJ)());case v.RT.Global:return new y(v.RT.Global,t,1,(0,p.Sj)(t))}}static renderUnitScaleFactor(e,t){return(0,r.KX)(e)/(0,r.KX)(t)}}},12580:(e,t,i)=>{i.d(t,{L:()=>r,s:()=>s});var n=i(48549);function r(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:new n.l5(e.layout)}}function s(e){return new n.q3(e.layout).createView(e.buffer)}},37431:(e,t,i)=>{i.d(t,{Gc:()=>l,RI:()=>h,Z4:()=>c,dk:()=>u,vr:()=>d});var n=i(76931),r=i(19555),s=i(20664),a=i(95925),o=i(75762);function l(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,a.vt)();return c(e,(0,n.WA)(t),i),(0,s.n)(i.direction,i.direction),i}function c(e,t,i){return h(e,e.screenToRender(t,(0,n.sc)(o.rq.get())),i)}function h(e,t,i){const a=(0,n.sc)((0,r.C)(o.rq.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const l=(0,n.sc)((0,r.C)(o.rq.get(),t));l[2]=1;const c=e.unprojectFromRenderScreen(l,o.rq.get());return null==c?null:((0,s.f)(i.direction,c,i.origin),i)}function d(e,t,i){return u(e,e.screenToRender(t,(0,n.sc)(o.rq.get())),i)}function u(e,t,i){(0,s.c)(i.origin,e.eye);const n=(0,s.s)(o.rq.get(),t[0],t[1],1),r=e.unprojectFromRenderScreen(n,o.rq.get());return null==r?null:((0,s.f)(i.direction,r,i.origin),i)}},88220:(e,t,i)=>{i.d(t,{CB:()=>y,ZD:()=>A,av:()=>b,zC:()=>T});i(35238);var n=i(39356),r=i(85361),s=i(76931),a=i(9392),o=i(14487),l=i(3569),c=i(31933),h=i(22955),d=i(80935),u=i(29808),p=i(3112),m=i(46571),_=i(30310),g=i(97974),f=i(13312),v=i(13904);async function y(e,t,i,n){const r=i?A(e,i):n,a=(0,s.gs)(t.x,t.y);r.requiresGroundFeedback=!0,r.enableDraped=!0;const o=(0,u.hz)(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=p.oH.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(a,o,r);const l=function(e,t,i){const n=new Array;let r=null;for(let s=0;s<t.length;s++){const a=t[s],o=(0,_.FV)(a,e);if(null!=o&&(o===e.map.ground||"type"in o&&(0,c.Eq)(o.type)))break;const l=(0,_.FI)(a,e);if(null==l)continue;if("graphic"===l.type){if(null==r&&s!==t.length-1&&(r=new Set),null!=r){const e=x(l.graphic);if(r.has(e))continue;r.add(e)}if(!C(i,l.graphic))continue}const h=w(e,a),d=a.distanceInRenderSpace;if("media"===l.type){const e=l.element.toSource(h);n.push({...l,mapPoint:h,distance:d,sourcePoint:e})}else n.push({...l,mapPoint:h,distance:d})}return n}(e,o.results.all,r.graphics),d=o.results.ground,g=(0,_.FV)(d,e),f=null!=g&&"type"in g&&(0,c.Eq)(g.type)?g:null,v={screenPoint:t,results:l,ground:{mapPoint:w(e,d),distance:(0,m.i3)(d)?d.distanceInRenderSpace:0,layer:f}};return h.b.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(v.intersector=o),v}function b(e,t,i,n){const r=i?A(e,i):n,a=null!=r.graphics&&(null!=r.graphics.include||null!=r.graphics.exclude),o=(0,s.WA)(t);r.enableDraped=r.include&&!r.include.has(g.fo)||r.exclude&&r.exclude.has(g.fo);const l=e.sceneIntersectionHelper,c=(0,u.hz)(e.state.viewingMode);if(c.options.selectionMode=!0,c.options.store=a?p.oH.ALL:p.oH.MIN,c.options.hud=!(null!==i&&void 0!==i&&i.excludeHud),l.intersectIntersectorScreen(o,c,r),a){for(const t of c.results.all){const i=(0,_.FI)(t,e);if(null==i)return w(e,t);if("graphic"!==i.type||C(r.graphics,i.graphic))return w(e,t)}return null}return w(e,c.results.min)}function w(e,t,i){var n;return t.getIntersectionPoint(P)?(i=T(e,P,i),t.intersector===p.dz.TERRAIN&&e.basemapTerrain&&(i.z=null!==(n=(0,d.R1)(e.basemapTerrain,i))&&void 0!==n?n:0),i):null}function x(e){const t=e.sourceLayer,i=e.layer,n=t&&"objectIdField"in t?t:i&&"objectIdField"in i?i:t;if(n){var r,s;const t=null!==(r=n.objectIdField)&&void 0!==r?r:l.r,i=null===(s=e.attributes)||void 0===s?void 0:s[t];if(i)return"o-".concat(n.id,"-").concat(i)}return"u-".concat(e.uid)}function C(e,t){const i=x(t);return null==e||(null==e.include||e.include.has(i))&&(null==e.exclude||!e.exclude.has(i))}function T(e,t,i){let n=e.spatialReference||f.A.WGS84;return(0,o.F)(t,e.renderSpatialReference,P,n)?t=P:(n=f.A.WGS84,(0,o.F)(t,e.renderSpatialReference,P,n)&&(t=P)),i?(i.x=t[0],i.y=t[1],i.z=t[2],i.spatialReference=n):i=new v.A(t,n),i}function A(e,t){const i=M(e,t.include,R.INCLUDE),n=M(e,t.exclude,R.EXCLUDE);return{include:i.layerUids,exclude:n.layerUids,graphics:{include:i.graphicUids,exclude:n.graphicUids}}}function M(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{layerUids:void 0,graphicUids:void 0};if(!t)return s;if(t instanceof n.A)(function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)})(s,x(t)),i===R.INCLUDE&&(null!=e.graphicsView&&t.layer===e?S(s,e.graphicsView.processor.layer.id):t.layer&&S(s,t.layer.uid));else if((0,r.xZ)(t))for(const n of t)n===e.graphics&&null!=e.graphicsView?S(s,e.graphicsView.processor.layer.id):n===e.map.ground?S(s,g.fo):M(e,n,i,s);else"uid"in t&&S(s,t.uid);return s}function S(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}const P=(0,a.vt)();var R,E;(E=R||(R={}))[E.INCLUDE=0]="INCLUDE",E[E.EXCLUDE=1]="EXCLUDE"},5729:(e,t,i)=>{var n;i.d(t,{U0:()=>r,sK:()=>n,u1:()=>s}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(n||(n={}));const r=(()=>{const e=new Array;return e[n.ELEVATION]=10,e[n.BASEMAP]=10,e[n.I3S_INDEX]=10,e[n.I3S_DATA]=10,e[n.SYMBOLOGY]=5,e})(),s=30},30338:(e,t,i)=>{i.d(t,{$8:()=>_,Md:()=>v,ld:()=>y,qI:()=>g,uf:()=>w});var n=i(15941),r=i(34761),s=i(13191),a=i(19555),o=i(72745),l=i(20664),c=i(9392),h=i(64465),d=i(42664),u=i(94966);const p={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class m{constructor(e,t){this.direct=e,this.ambient=t}}function _(e,t,i,r,s,h){(0,l.s)(h.ambient.color,1,1,1),h.ambient.intensity=p.global.ambient,(0,l.s)(h.direct.color,1,1,1),h.direct.intensity=p.global.direct;const u=t[2],m=(0,n.qE)((Math.abs(u)-p.local.altitude)/(p.global.altitude-p.local.altitude),0,1);let _;if(h.globalFactor=m,null!=e&&(_=d.S.getTimes(e,t[1],t[0])),m<1){let t;if(null!=e)t=function(e,t,i){const n=e.valueOf();let r,s;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(r=n-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(r=n-2,s=n-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const h=s-r,u=r+h/2,p=h/4,m=u-p,_=u+p,g=.06*h,f=r-g/2,v=r+g/2,y=s-g/2,b=s+g/2,w=(0,o.vt)(),x=(0,c.vt)(),C=(0,c.vt)();let k="";if(n<f||n>b)(0,a.C)(w,L),(0,l.c)(x,M),(0,l.c)(C,E),k="night";else if(n<v){const e=(n-f)/(v-f);(0,a.Cc)(w,L,N,e),(0,l.m)(x,M,S,e),(0,l.m)(C,E,O,e),k="sun rising"}else if(n<m){const e=(n-v)/(m-v);(0,a.Cc)(w,N,F,e),(0,l.m)(x,S,P,e),(0,l.m)(C,O,D,e),k="early morning"}else if(n<u){const e=(n-m)/(u-m);(0,a.Cc)(w,F,V,e),(0,l.m)(x,P,R,e),(0,l.m)(C,D,I,e),k="late morning"}else if(n<_){const e=(n-u)/(_-u);(0,a.Cc)(w,V,H,e),(0,l.m)(x,R,U,e),(0,l.m)(C,I,z,e),k="early afternoon"}else if(n<y){const e=(n-_)/(y-_);(0,a.Cc)(w,H,q,e),(0,l.m)(x,U,G,e),(0,l.m)(C,z,B,e),k="late afternoon"}else if(n<b){const e=(n-y)/(b-y);(0,a.Cc)(w,q,L,e),(0,l.m)(x,G,M,e),(0,l.m)(C,B,E,e),k="sun setting"}let W=0;switch(i){case"rainy":case"foggy":W=.8;break;case"snowy":W=.5}W>0&&(A(x,W),A(C,W));const Z=T(i);return{direct:{intensity:w[0]*Z.direct,color:x},ambient:{intensity:w[1]*Z.ambient,color:C},timeOfDay:k}}(e,_,r);else{const e=T(r);t={direct:{intensity:p.local.directAtNoon*e.direct,color:(0,c.fA)(1,1,1)},ambient:{intensity:p.local.ambientAtNoon*e.ambient,color:(0,c.fA)(1,1,1)},timeOfDay:"early afternoon"}}(0,l.m)(h.ambient.color,t.ambient.color,h.ambient.color,m),h.ambient.intensity=(0,n.Cc)(t.ambient.intensity,h.ambient.intensity,m),(0,l.m)(h.direct.color,t.direct.color,h.direct.color,m),h.direct.intensity=(0,n.Cc)(t.direct.intensity,h.direct.intensity,m),h.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,h.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}h.noonFactor=null!=e?function(e,t){const i=e.valueOf();let r,s;t.polarException===d.S.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===d.S.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const a=r+(s-r)/2;return 1-(0,n.qE)(Math.abs(i-a)/432e5,0,1)}(e,_):1,null!=e?f(e,t,i,h.direct.directionToLightSource):g(s,i,h.direct.directionToLightSource)}function g(e,t,i){t===h.RT.Global?(0,l.n)(Z,e.eye):(0,l.s)(Z,0,0,1),(0,l.h)(j,e.viewForward,-1);const n=(0,u.g7)(j,Z),s=Math.max(n-2*X,0),a=.85*s/(s+1),o=Math.max(X,n-X-a);(0,r.$0)(W,-o,e.viewRight),(0,l.e)(i,j,W),(0,l.g)(i,i,(0,l.h)(Q,e.viewRight,Y)),(0,l.n)(i,i)}function f(e,t,i,s){const a=C,o=(0,r.D_)(x);if(i===h.RT.Global)d.S.getPosition(e,0,0,a),(0,l.s)(s,0,0,-1),(0,r.eL)(o,o,-a.azimuth),(0,r.Z8)(o,o,-a.altitude),(0,l.e)(s,s,o);else{const i=p.planarDirection,c=i.globalAngles,h=t[2];let u=(Math.abs(h)-i.localAltitude)/(i.globalAltitude-i.localAltitude);u=(0,n.qE)(u,0,1),u<1?(d.S.getPosition(e,t[1],t[0],a),a.azimuth=(1-u)*a.azimuth+u*c.azimuth,a.altitude=(1-u)*a.altitude+u*c.altitude):(a.azimuth=c.azimuth,a.altitude=c.altitude),(0,l.s)(s,0,-1,0),(0,r.Qr)(o,o,-a.azimuth),(0,r.eL)(o,o,-a.altitude),(0,l.e)(s,s,o)}}function v(e,t){if(t===h.RT.Global)return!0;const i=p.planarDirection;return Math.abs(e)<i.localAltitude}function y(e,t,i,n,r){const s=e.getTime(),a=t.getTime()-s,o=Math.floor(a/i)+1,l=new Array(o);for(let h=0;h<o;++h)k.setTime(s+i*h),l[h]=(0,c.vt)(),f(k,n,r,l[h]);return l}const b=(0,c.fA)(.5773502691896258,-.5773502691896258,.5773502691896258);class w{constructor(){this.ambient={color:(0,c.fA)(1,1,1),intensity:.55},this.direct={color:(0,c.fA)(1,1,1),intensity:.55,directionToLightSource:(0,c.o8)(b)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const x=(0,s.vt)(),C={azimuth:0,altitude:0};function T(e){switch(e){case"disabled":case"sunny":case"cloudy":return new m(1,1);case"rainy":return new m(.4,1.2);case"snowy":return new m(.5,1.3);case"foggy":return new m(.2,1.6)}}function A(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const M=(0,c.fA)(.01,.01,.01),S=(0,c.fA)(1,.6,.5),P=(0,c.fA)(1,.98,.98),R=(0,c.fA)(1,1,1),E=(0,c.fA)(.8,.8,1),O=(0,c.fA)(.8,.8,1),D=(0,c.fA)(.98,.98,1),I=(0,c.fA)(1,1,1),L=(0,o.fA)(.01,p.local.ambientAtNight),N=(0,o.fA)(p.local.directAtTwilight,p.local.ambientAtTwilight),F=(0,o.fA)(.9*p.local.directAtNoon,p.local.ambientAtNoon),V=(0,o.fA)(p.local.directAtNoon,p.local.ambientAtNoon),H=F,U=P,z=D,q=N,G=S,B=O;const k=new Date(0),W=(0,s.vt)(),Z=(0,c.vt)(),j=(0,c.vt)(),Q=(0,c.vt)(),X=.25,Y=.2},93938:(e,t,i)=>{i.d(t,{S:()=>r,b:()=>n});const n={value:.5,readOnly:!0},r={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},94070:(e,t,i)=>{i.d(t,{S:()=>l});var n=i(30726),r=i(745),s=i(93345),a=i(71853);const o={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class l{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=n||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=(0,n.WD)(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...o,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||o}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){null!=e&&e.length>0?this._bandIds&&e.every(((e,t)=>{var i;return!(null===(i=this._bandIds)||void 0===i||!i[t])&&e===this._bandIds[t]}))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,null!=this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?s.Cj.LINEAR:s.Cj.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=(0,n.WD)(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((null==this._rasterTexture||this._dirty)&&this._updateRasterTexture(e,this.bandIds),null!=this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&null==this._transformGridTexture&&(this._transformGridTexture=(0,a.kc)(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:n,opacity:s}=this,o=(0,a.xV)(t,[i,n],[this.source.width,this.source.height],s),l=(0,a.Pp)(e.colormap,e.colormapOffset),c="stretch"===this.symbolizerParameters.type?(0,a.VC)(this.symbolizerParameters):null,h="hillshade"===this.symbolizerParameters.type?(0,a.OI)(this.symbolizerParameters):null;return new r.C(o,l,c||h,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return"bilinear"===this.interpolation&&null!=e.colormap&&"stretch"===e.type}get memoryUsage(){if(null==this._memoryUsed){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((e=>null!=e?e.descriptor.width*e.descriptor.height*4:0)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=(0,n.WD)(this._rasterTexture),this._transformGridTexture=(0,n.WD)(this._transformGridTexture),this._colormapTexture=(0,n.WD)(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=(0,n.WD)(this._rasterTexture));const r=null==t&&null==this.bandIds||null!=t&&null!=this.bandIds&&t.join("")===this.bandIds.join("");if(null!=this._rasterTexture&&r)return;this._rasterTexture=(0,n.WD)(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=(0,a.b4)(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture=(0,n.WD)(this._colormapTexture),this._colormapTexture=(0,a.hE)(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=(0,a.hE)(e,i),void(this._colormap=i)):(this._colormapTexture=(0,n.WD)(this._colormapTexture),void(this._colormap=null))}}},16475:(e,t,i)=>{var n;i.d(t,{X:()=>n}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(n||(n={}))},9902:(e,t,i)=>{i.d(t,{C2:()=>s,D_:()=>o,Ey:()=>c,Ri:()=>u,V$:()=>a,ZH:()=>v,jV:()=>_,kh:()=>f,lR:()=>l,vx:()=>g});var n=i(30015),r=i(16475);class s{constructor(){this._queue=new n.A,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var e;const t=null===(e=this._last)||void 0===e?void 0:e.children;return null!==t&&void 0!==t&&t[0]&&this._queue.pushArray(t),this._last=this._queue.pop(),this._last}}class a{constructor(){this._q=new n.A}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.isLeaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function o(e,t,i){if(null==(null===t||void 0===t?void 0:t.fullExtent))return!1;const n=t.fullExtent,r=e.extent;if(i){if(r[0]<n.xmin||r[1]<n.ymin||r[2]>n.xmax||r[3]>n.ymax)return!1}else if(n.xmin>r[2]||n.ymin>r[3]||n.xmax<r[0]||n.ymax<r[1])return!1;const s=e.surface.tilingScheme.levels[e.level].scale,a=t.minScale;if(a>0&&s>1.00000001*a)return!1;const o=t.maxScale;return!(o>0&&s<.99999999*o)}function l(e,t){const i=e.lij,n=t.lij;return i[0]-n[0]||i[1]-n[1]||i[2]-n[2]}function c(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==i||0===i.length?e===r.X.BACK_TO_FRONT?t.sort(h):t.sort(d):t.sort(((t,n)=>function(e,t,i,n){return p(e,n)===p(t,n)?u(e,t,i):e?i:-i}(t,n,e,i)))}function h(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function d(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function u(e,t,i){const n=e.screenDepth,r=t.screenDepth;return n<r?-i:n>r?i:l(e,t)}function p(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function m(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function _(e,t){const i=e.length;for(let n=0;n<i;++n)e.at(n).updateDistanceToPOI(t);e.sort(m)}function g(e,t,i){let n=1,r=0,s=0;for(;e!==t;)if(n*=.5,r*=.5,s*=.5,1&e.lij[2]&&(r+=.5),0==(1&e.lij[1])&&(s+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,r,s,n)}function f(e){for(let t=0;t<e.length;t++){const i=e[t],n=i.parent;if(n)for(let e=0;e<4;e++){const t=n.children[e];if(t&&t!==i)return!0}}return!1}function v(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],n=i?e:t,r=i?t:e,s=1<<r[0]-n[0];return Math.floor(r[1]/s)===n[1]&&Math.floor(r[2]/s)===n[2]}},91555:(e,t,i)=>{i.d(t,{f5:()=>F,d0:()=>T,Wo:()=>H,em:()=>U});var n=i(35143),r=i(81806),s=i(30726),a=i(63919),o=i(44680),l=i(20664),c=i(9392),h=i(43047),d=i(55855),u=i(51990),p=i(29898),m=i(63599),_=i(44493),g=i(13545),f=i(28710),v=i(64839);class y extends v.Y{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class b{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function w(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(t,i)=>{var n;const r=null!==(n=t._parameterCount)&&void 0!==n?n:0;if(t._parameterCount=r+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=e;else{if(n.equals(t,e))return;n.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function x(){return(e,t)=>{var i;const n=null!==(i=e._parameterCount)&&void 0!==i?i:0;e._parameterCount=n+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(n),Object.defineProperty(e,t,{get(){return this[n]},set(e){this[n]!==e&&(this[n]=e,this._setDirty())}})}}var C,T,A=i(89712),M=i(34981),S=i(59046),P=i(27920),R=i(26719),E=i(90235),O=i(81148),D=i(77845),I=i(83490),L=i(10773),N=i(78992);class F extends y{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=(0,d.fA)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=(0,c.ci)(N.Rk),this.emissiveFactor=(0,c.fA)(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new V,this.componentParameters=new H,this.textureAlphaCutoff=E.H,this.alphaDiscardMode=I.sf.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=O.T.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new _.E;const i=new D.p(e.position),n=(0,o.o8)(e.rotationScale);(0,a.B8)(n,n),(0,a.mg)(n,n),this.transformNormalGlobalFromModel=n,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=(0,s.Gz)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return null!=this.baseColorTexture?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return null!=this.metallicRoughnessTexture?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return null!=this.emissionTexture?this.emissionTexture.glTexture:null}get textureOcclusion(){return null!=this.occlusionTexture?this.occlusionTexture.glTexture:null}get textureNormal(){return null!=this.normalTexture?this.normalTexture.glTexture:null}prepareTechnique(e,t,i,n){const s=this._techniqueConfiguration;s.hasVertexColors=n.colors,s.hasNormals=n.hasNormals,s.textureCoordinateType=n.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasEmissionTexture=null!=this.emissionTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.transparencyPassType=t.identifier===A.zq.Material&&null!=i.transparencyPassType?i.transparencyPassType:L.y.NONE,s.multipassEnabled=t.identifier===A.zq.Material&&i.multipassEnabled,s.cullAboveGround=t.identifier===A.zq.Material&&i.multipassTerrain.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?P.W.View:P.W.None,s.hasColorTexture=null!=this.baseColorTexture;const a=this._computeWhichMaterialPass();if(s.blendingEnabled=a===C.Transparent||a===C.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(p.A.ColorNoRasterImage))}(i)?function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(p.A.WaterNormal))}(i)?_.g.ColorOverlayWithWater:_.g.ColorOverlay:_.g.NoOverlay:_.g.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===_.g.ColorOverlayWithWater?R.A9.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?(0,r.A)("enable-feature:im-shading")&&this.isIntegratedMesh?R.A9.Simplified:R.A9.Schematic:R.A9.Normal:R.A9.Disabled,s.normalType=n.needsNormals?s.hasNormals?S.W.Compressed:S.W.ScreenDerivative:S.W.Ground,s.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===A.zq.ShadowMap)s.output=M.V.Shadow,s.vertexDiscardMode=f.q.None;else if(t.identifier===A.zq.Highlight)s.output=M.V.Highlight,s.vertexDiscardMode=f.q.None;else{switch(a===C.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?f.q.Opaque:f.q.Transparent:s.vertexDiscardMode=f.q.None,s.output=t.output,s.receiveAmbientOcclusion=!1,s.receiveShadows=!1,t.output){case M.V.Color:s.receiveAmbientOcclusion=null!=i.ssao,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.hasScreenSpaceReflections=null!=i.ssr.lastFrameColor,s.hasCloudsReflections=null!=i.cloudsFade.data;break;case M.V.Alpha:s.hasOccludees=i.hasOccludees;break;case M.V.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(m.e,s,this._technique),this._setClean(),this._technique}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(0===this.objectOpacity)return;const n=i.renderable.geometry,r=i.components,s=i.renderable.meta.cameraDepthSquared,a=r.geometryRanges,o=r.highlightRanges,l=r.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case C.Opaque:e.materialOpaque.submitDraw(this,n,a,s);break;case C.Transparent:e.materialTransparent.submitDraw(this,n,a,s);break;case C.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,n,a,s),e.materialTransparent.submitDraw(this,n,a,s);break;case C.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,n,a,s),function(e){var t;return null!=(null===(t=e.overlay)||void 0===t?void 0:t.getTexture(p.A.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,a,s)}const c=this.componentParameters.castShadows!==T.None;c&&e.shadowMap.submitDraw(this,n,a,s),null!=o&&(e.highlight.submitDraw(this,n,o,s),c&&e.highlightShadowMap.submitDraw(this,n,o,s)),c&&null!=l&&e.defaultShadowMap.submitDraw(this,n,l,s)}_computeWhichMaterialPass(){return this.isIntegratedMesh?C.IntegratedMesh:this.objectOpacity<1?C.Transparent:this.componentParameters.opaqueOverride===T.All?C.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===I.sf.Blend||this.alphaDiscardMode===I.sf.MaskBlend?C.Transparent:this.componentParameters.transparent===T.None?C.Opaque:this.componentParameters.transparent===T.All?C.Transparent:C.OpaqueAndTransparent}}(0,n._)([w({vectorOps:h.v})],F.prototype,"baseColor",void 0),(0,n._)([w()],F.prototype,"usePBR",void 0),(0,n._)([w()],F.prototype,"hasParametersFromSource",void 0),(0,n._)([w({vectorOps:l.I})],F.prototype,"mrrFactors",void 0),(0,n._)([w({vectorOps:l.I})],F.prototype,"emissiveFactor",void 0),(0,n._)([w({dispose:!0})],F.prototype,"baseColorTexture",void 0),(0,n._)([w({dispose:!0})],F.prototype,"metallicRoughnessTexture",void 0),(0,n._)([w({dispose:!0})],F.prototype,"emissionTexture",void 0),(0,n._)([w({dispose:!0})],F.prototype,"occlusionTexture",void 0),(0,n._)([w({dispose:!0})],F.prototype,"normalTexture",void 0),(0,n._)([w()],F.prototype,"objectOpacity",void 0),(0,n._)([x()],F.prototype,"commonMaterialParameters",void 0),(0,n._)([x()],F.prototype,"componentParameters",void 0),(0,n._)([w()],F.prototype,"textureAlphaCutoff",void 0),(0,n._)([w()],F.prototype,"alphaDiscardMode",void 0),(0,n._)([w()],F.prototype,"isIntegratedMesh",void 0),(0,n._)([w()],F.prototype,"polygonOffsetEnabled",void 0),(0,n._)([w()],F.prototype,"ellipsoidMode",void 0),(0,n._)([w()],F.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(C||(C={}));class V extends b{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=I.s2.Back,this.hasSlicePlane=!0}}(0,n._)([w()],V.prototype,"doubleSided",void 0),(0,n._)([w()],V.prototype,"cullFace",void 0),(0,n._)([w()],V.prototype,"hasSlicePlane",void 0);class H extends b{constructor(){super(...arguments),this.externalColor=(0,d.fA)(1,1,1,1),this.externalColorMixMode=u.k5.Multiply,this.castShadows=T.All}get transparent(){return this.externalColor[3]<1?T.All:T.None}get opaqueOverride(){return this.externalColorMixMode===u.k5.Replace&&1===this.externalColor[3]?T.All:T.None}get visible(){return this.externalColor[3]>0?T.All:T.None}get type(){return g.Sg.Uniform}}(0,n._)([w({vectorOps:h.v})],H.prototype,"externalColor",void 0),(0,n._)([w()],H.prototype,"externalColorMixMode",void 0),(0,n._)([w()],H.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(T||(T={}));class U extends b{constructor(){super(...arguments),this.texture=null,this.transparent=T.None,this.opaqueOverride=T.None,this.castShadows=T.None}get type(){return g.Sg.Varying}}(0,n._)([w()],U.prototype,"texture",void 0),(0,n._)([w()],U.prototype,"transparent",void 0),(0,n._)([w()],U.prototype,"opaqueOverride",void 0),(0,n._)([w()],U.prototype,"castShadows",void 0)},63599:(e,t,i)=>{i.d(t,{T:()=>f,e:()=>g});var n=i(64465),r=i(44493),s=i(42287),a=i(34981),o=i(16506),l=i(42693),c=i(83490),h=i(60322),d=i(28584),u=i(96643),p=i(10773),m=i(66470),_=i(57162);class g extends l.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===n.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new d.B(e.rctx,g.shader.get().build(this.configuration),f)}_setPipelineState(e){const t=this.configuration,i=t.integratedMeshMode!==r.g.None,n=e===p.y.NONE,s=e===p.y.FrontFace;return(0,_.Ey)({blending:t.output!==a.V.Color&&t.output!==a.V.Alpha||!t.blendingEnabled?null:n?h.V0:(0,h.ez)(e),culling:(0,_.Xt)(t.cullFace),depthTest:{func:(0,h.K_)(e)},depthWrite:n||s?_.kn:null,colorWrite:_.wE,stencilWrite:i||t.hasOccludees?u.v0:null,stencilTest:i?(0,u.ub)(c.dd.IntegratedMeshMaskExcluded):t.hasOccludees?u.qh:null,polygonOffset:n||s?t.hasPolygonOffset?{factor:2,units:2}:null:h.SE})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}g.shader=new o.$(s.C,(()=>i.e(1412).then(i.bind(i,1412))));const f=new Map([[m.r.POSITION,0],[m.r.NORMAL,1],[m.r.NORMALCOMPRESSED,1],[m.r.COLOR,2],[m.r.UV0,3],[m.r.UVREGION,4],[m.r.COMPONENTINDEX,5]])},44493:(e,t,i)=>{i.d(t,{E:()=>v,g:()=>n});var n,r,s=i(35143),a=i(13545),o=i(28710),l=i(34981),c=i(59046),h=i(97808),d=i(27920),u=i(26719),p=i(81148),m=i(24245),_=i(99415),g=i(83490),f=i(10773);(r=n||(n={}))[r.None=0]="None",r[r.NoOverlay=1]="NoOverlay",r[r.ColorOverlay=2]="ColorOverlay",r[r.ColorOverlayWithWater=3]="ColorOverlayWithWater",r[r.COUNT=4]="COUNT";class v extends _.K{constructor(){super(...arguments),this.output=l.V.Color,this.textureCoordinateType=h.q.None,this.componentData=a.Sg.Uniform,this.cullFace=g.s2.Back,this.vertexDiscardMode=o.q.None,this.doubleSidedMode=d.W.WindingOrder,this.alphaDiscardMode=g.sf.Opaque,this.integratedMeshMode=n.None,this.transparencyPassType=f.y.NONE,this.ellipsoidMode=p.T.Earth,this.pbrMode=u.A9.Disabled,this.normalType=c.W.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.hasNormalTextureTransform=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}}(0,s._)([(0,_.W)({count:l.V.COUNT})],v.prototype,"output",void 0),(0,s._)([(0,_.W)({count:h.q.COUNT})],v.prototype,"textureCoordinateType",void 0),(0,s._)([(0,_.W)({count:a.Sg.COUNT})],v.prototype,"componentData",void 0),(0,s._)([(0,_.W)({count:g.s2.COUNT})],v.prototype,"cullFace",void 0),(0,s._)([(0,_.W)({count:o.q.COUNT})],v.prototype,"vertexDiscardMode",void 0),(0,s._)([(0,_.W)({count:d.W.COUNT})],v.prototype,"doubleSidedMode",void 0),(0,s._)([(0,_.W)({count:g.sf.COUNT})],v.prototype,"alphaDiscardMode",void 0),(0,s._)([(0,_.W)({count:n.COUNT})],v.prototype,"integratedMeshMode",void 0),(0,s._)([(0,_.W)({count:f.y.COUNT})],v.prototype,"transparencyPassType",void 0),(0,s._)([(0,_.W)({count:p.T.COUNT})],v.prototype,"ellipsoidMode",void 0),(0,s._)([(0,_.W)({count:u.A9.COUNT})],v.prototype,"pbrMode",void 0),(0,s._)([(0,_.W)({count:c.W.COUNT})],v.prototype,"normalType",void 0),(0,s._)([(0,_.W)()],v.prototype,"spherical",void 0),(0,s._)([(0,_.W)()],v.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasVertexColors",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasNormals",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasSlicePlane",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasColorTexture",void 0),(0,s._)([(0,_.W)()],v.prototype,"receiveAmbientOcclusion",void 0),(0,s._)([(0,_.W)()],v.prototype,"receiveShadows",void 0),(0,s._)([(0,_.W)()],v.prototype,"blendingEnabled",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasScreenSpaceReflections",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasPolygonOffset",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasMetallicRoughnessTexture",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasEmissionTexture",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasOcclusionTexture",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasNormalTexture",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasOccludees",void 0),(0,s._)([(0,_.W)()],v.prototype,"multipassEnabled",void 0),(0,s._)([(0,_.W)()],v.prototype,"cullAboveGround",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasNormalTextureTransform",void 0),(0,s._)([(0,_.W)()],v.prototype,"hasCloudsReflections",void 0),(0,s._)([(0,_.W)()],v.prototype,"snowCover",void 0),(0,s._)([(0,_.W)()],v.prototype,"objectAndLayerIdColor",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"occlusionPass",void 0),(0,s._)([(0,_.W)({constValue:m.c.Draw})],v.prototype,"pbrTextureBindType",void 0),(0,s._)([(0,_.W)({constValue:!0})],v.prototype,"hasSliceHighlight",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"hasSliceInVertexProgram",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"useCustomDTRExponentForWater",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"hasVertexTangents",void 0),(0,s._)([(0,_.W)({constValue:!0})],v.prototype,"supportsTextureAtlas",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"highStepCount",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"instancedDoublePrecision",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"hasModelTransformation",void 0),(0,s._)([(0,_.W)({constValue:!0})],v.prototype,"useFillLights",void 0),(0,s._)([(0,_.W)({constValue:!1})],v.prototype,"objectAndLayerIdColorInstanced",void 0)},13545:(e,t,i)=>{i.d(t,{cz:()=>E,Sg:()=>C,B:()=>R,Hi:()=>P});var n=i(57528),r=i(4212),s=i(14522),a=i(81806),o=i(59581),l=i(34981),c=i(81449),h=i(20123),d=i(7223),u=i(24245);class p extends d.n{constructor(e,t){super(e,"int",u.c.Draw,((i,n,r)=>i.setUniform1i(e,t(n,r))))}}var m,_,g,f,v,y,b,w,x,C,T,A=i(64839),M=i(27374),S=i(66470);(T=C||(C={}))[T.Uniform=0]="Uniform",T[T.Varying=1]="Varying",T[T.COUNT=2]="COUNT";const P=429496.7296;function R(e,t){(0,s.U)(e/P*.5+.5,t)}function E(e,t){switch(t.componentData){case C.Varying:return function(e,t){const{vertex:i,fragment:r}=e;i.include(c.W),i.uniforms.add(new M.o("componentColorTex",(e=>e.componentParameters.texture.texture))),e.attributes.add(S.r.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const s=t.output===l.V.ObjectAndLayerIdColor;s&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(o.A),i.constants.add("elevationScale","float",2*P),i.constants.add("stride","float",(0,a.A)("enable-feature:objectAndLayerId-rendering")?3:2),i.code.add((0,A.H)(m||(m=(0,n.A)(["vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {\nfloat index = componentIndex * stride + typeOffset;\nfloat texSize = float(textureSize(componentColorTex, 0).x);\nfloat coordX = mod(index, texSize);\nfloat coordY = floor(index / texSize);\nreturn vec2(coordX, coordY) + 0.5;\n}"])))),i.code.add((0,A.H)(_||(_=(0,n.A)(["\n  vec4 _readComponentColor() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);\n\n    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);\n   }\n\n   float readElevationOffset() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);\n\n    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);\n    return (rgba2float(encodedElevation) - 0.5) * elevationScale;\n  }\n\n  ","\n\n  vec4 forwardExternalColor(out bool castShadows) {\n    vec4 componentColor = _readComponentColor() * 255.0;\n\n    float shadowFlag = mod(componentColor.b * 255.0, 2.0);\n    componentColor.b -= shadowFlag;\n    castShadows = shadowFlag >= 1.0;\n\n    int decodedColorMixMode;\n    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;\n    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts\n\n    return vExternalColor;\n  }\n"])),s?(0,A.H)(g||(g=(0,n.A)(["\n          void forwardObjectAndLayerIdColor() {\n            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);\n\n            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);\n          }"]))):(0,A.H)(f||(f=(0,n.A)(["void forwardObjectAndLayerIdColor() {}"]))))),r.code.add((0,A.H)(v||(v=(0,n.A)(["\n  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {\n    externalColor = vExternalColor;\n    externalColorMixMode = int(vExternalColorMixMode);\n  }\n\n  void outputObjectAndLayerIdColor() {\n     ","\n  }\n"])),s?(0,A.H)(y||(y=(0,n.A)(["fragColor = vObjectAndLayerIdColor;"]))):""))}(e,t);case C.Uniform:return function(e,t){const{vertex:i,fragment:r}=e;i.uniforms.add(new h.V("externalColor",(e=>e.componentParameters.externalColor))),r.uniforms.add(new p("externalColorMixMode",(e=>e.componentParameters.externalColorMixMode))),e.varyings.add("vExternalColor","vec4"),i.code.add((0,A.H)(b||(b=(0,n.A)(["float readElevationOffset() {\nreturn 0.0;\n}\nvoid forwardObjectAndLayerIdColor() {}\nvec4 forwardExternalColor(out bool castShadows) {\nvExternalColor = externalColor;\ncastShadows = true;\nreturn externalColor;\n}"]))));const s=t.output===l.V.ObjectAndLayerIdColor;r.code.add((0,A.H)(w||(w=(0,n.A)(["\n  void readExternalColor(out vec4 color, out int colorMixMode) {\n    color = vExternalColor;\n    colorMixMode = externalColorMixMode;\n  }\n\n  void outputObjectAndLayerIdColor() {\n    ","\n }\n"])),s?(0,A.H)(x||(x=(0,n.A)(["fragColor = vec4(0,0,0,0);"]))):""))}(e,t);case C.COUNT:return;default:(0,r.Xb)(t.componentData)}}},28710:(e,t,i)=>{i.d(t,{j:()=>u,q:()=>o});var n,r,s,a,o,l,c=i(57528),h=i(4212),d=i(64839);function u(e,t){const i=e.vertex;switch(i.code.add((0,d.H)(n||(n=(0,c.A)(["#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)"])))),t.vertexDiscardMode){case o.None:i.code.add((0,d.H)(r||(r=(0,c.A)(["#define vertexDiscardByOpacity(_opacity_) {}"]))));break;case o.Opaque:i.code.add((0,d.H)(s||(s=(0,c.A)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case o.Transparent:i.code.add((0,d.H)(a||(a=(0,c.A)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case o.COUNT:break;default:(0,h.Xb)(t.vertexDiscardMode)}}(l=o||(o={}))[l.None=0]="None",l[l.Transparent=1]="Transparent",l[l.Opaque=2]="Opaque",l[l.COUNT=3]="COUNT"},16449:(e,t,i)=>{i.d(t,{h:()=>a});var n=i(48549),r=i(97808),s=i(66470);function a(e){const t=(0,n.BP)().vec3f(s.r.POSITION);return e.hasNormals&&t.vec2i16(s.r.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===r.q.Default?t.vec2f(s.r.UV0):e.textureCoordinates===r.q.Atlas&&(t.vec2f(s.r.UV0),t.vec4u16(s.r.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(s.r.COLOR,{glNormalized:!0}),t}},112:(e,t,i)=>{i.d(t,{O:()=>l});var n,r,s,a=i(57528),o=i(64839);function l(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add((0,o.H)(n||(n=(0,a.A)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))):e.vertex.code.add((0,o.H)(r||(r=(0,a.A)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = vec3(1.0, 0.0, 0.0);\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))),e.fragment.code.add((0,o.H)(s||(s=(0,a.A)(["mat3 getTBNMatrix(vec3 n) {\nreturn mat3(tbnTangent, tbnBiTangent, n);\n}"]))))}},32124:(e,t,i)=>{var n;i.d(t,{IU:()=>n,aO:()=>s,wy:()=>r}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(n||(n={}));const r={normal:n.Normal,average:n.Average,lighten:n.Lighten,lighter:n.Lighter,screen:n.Screen,plus:n.Plus,"color-dodge":n.ColorDodge,darken:n.Darken,multiply:n.Multiply,"color-burn":n.ColorBurn,overlay:n.Overlay,"soft-light":n.SoftLight,"hard-light":n.HardLight,"vivid-light":n.VividLight,hue:n.Hue,saturation:n.Saturation,luminosity:n.Luminosity,color:n.Color,difference:n.Difference,exclusion:n.Exclusion,minus:n.Minus,invert:n.Invert,reflect:n.Reflect,"destination-over":n.DestinationOver,"destination-atop":n.DestinationAtop,"destination-in":n.DestinationIn,"destination-out":n.DestinationOut,"source-atop":n.SourceAtop,"source-in":n.SourceIn,"source-out":n.SourceOut,xor:n.Xor};function s(e){return e===n.DestinationOver||e===n.DestinationAtop||e===n.DestinationIn||e===n.DestinationOut||e===n.SourceAtop||e===n.SourceIn||e===n.SourceOut||e===n.Xor}},91156:(e,t,i)=>{i.d(t,{M:()=>l});var n,r=i(57528),s=i(21390),a=i(64839),o=i(70367);function l(e){e.fragment.uniforms.add(new o.N("u_colormap",(e=>e.u_colormap)),new s.m("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new s.m("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new s.m("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["vec4 colormap(vec4 currentPixel, bool isFloat) {\nfloat colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;\nvec4 result;\nif (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {\nresult = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);\nresult = texelFetch(u_colormap, ivec2(texelCoordinates), 0);\n}\nreturn result;\n}"]))))}},67199:(e,t,i)=>{i.d(t,{y:()=>_,p:()=>m});var n,r=i(57528),s=i(95756),a=i(64839),o=i(70367);function l(e){e.fragment.uniforms.add(new o.N("u_transformGrid",(e=>e.u_transformGrid)),new s.G("u_transformSpacing",(e=>e.common.u_transformSpacing)),new s.G("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add((0,a.H)(n||(n=(0,r.A)(["vec2 projectPixelLocation(vec2 coords) {\nvec2 index_image = floor(coords * u_targetImageSize);\nvec2 oneTransformPixel = vec2(4.0, 1.0);\nvec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;\nvec2 pos = fract((index_image + 0.5) / u_transformSpacing);\nvec2 transform_location = index_transform + 0.5;\nvec2 srcLocation;\nif (pos.s <= pos.t) {\nvec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;\nvec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ll_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ll_def, vec3(pos, 1.0));\n} else {\nvec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;\nvec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;\nsrcLocation.s = dot(ur_abc, vec3(pos, 1.0));\nsrcLocation.t = dot(ur_def, vec3(pos, 1.0));\n}\nreturn srcLocation;\n}"]))))}var c,h,d,u=i(25252),p=i(53736);class m extends u.J{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function _(e,t){e.include(l),e.fragment.uniforms.add(new o.N("u_image",(e=>e.u_image)),new p.e("u_flipY",(e=>e.common.u_flipY)),new p.e("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new s.G("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add((0,a.H)(c||(c=(0,r.A)(["vec2 getPixelLocation(vec2 coords) {\nvec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;\nif (!u_applyTransform) {\nreturn targetLocation;\n}\nreturn projectPixelLocation(targetLocation);\n}\nbool isOutside(vec2 coords){\nif (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {\nreturn true;\n} else {\nreturn false;\n}\n}"])))),i?e.fragment.code.add((0,a.H)(h||(h=(0,r.A)(["vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {\nvec2 texelStart = floor(coords * texSize);\nvec2 coord0 = texelStart / texSize;\nvec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;\nvec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;\nvec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;\nvec4 color0 = texture(sampler, coord0);\nvec4 color1 = texture(sampler, coord1);\nvec4 color2 = texture(sampler, coord2);\nvec4 color3 = texture(sampler, coord3);\nvec2 blend = fract(coords * texSize);\nvec4 color01 = mix(color0, color1, blend.x);\nvec4 color23 = mix(color2, color3, blend.x);\nvec4 color = mix(color01, color23, blend.y);\nfloat alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);\ncolor = color * alpha + (1.0 - alpha) * texture(sampler, coords);\nreturn color;\n}\nvec4 getPixel(vec2 pixelLocation) {\nreturn sampleBilinear(u_image, pixelLocation, u_srcImageSize);\n}"])))):e.fragment.code.add((0,a.H)(d||(d=(0,r.A)(["vec4 getPixel(vec2 pixelLocation) {\nreturn texture(u_image, pixelLocation);\n}"]))))}},90011:(e,t,i)=>{i.d(t,{o:()=>u});var n,r,s,a=i(57528),o=i(54478),l=i(77904),c=i(20123),h=i(19771),d=i(64839);function u(e,t){e.include(o.c,t),e.fragment.include(l.N);const i=e.fragment;i.uniforms.add(new c.V("baseColor",(e=>e.baseColor))),i.uniforms.add(new h.J("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add((0,d.H)(n||(n=(0,a.A)(["vec3 _baseColor() {\nreturn baseColor.rgb * vColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a * vColor.a;\n}"])))):i.code.add((0,d.H)(r||(r=(0,a.A)(["vec3 _baseColor() {\nreturn baseColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a;\n}"])))),i.code.add((0,d.H)(s||(s=(0,a.A)(["vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {\nvec3 baseColor = _baseColor();\nfloat baseOpacity = _baseOpacity();\nvec3 color = mixExternalColor(\nbaseColor,\ntextureColor.rgb,\nexternalColor.rgb,\nexternalColorMixMode\n);\nfloat opacity = objectOpacity * mixExternalOpacity(\nbaseOpacity,\ntextureColor.a,\nexternalColor.a,\nexternalColorMixMode\n);\nreturn vec4(color, opacity);\n}"]))))}},21372:(e,t,i)=>{i.d(t,{f:()=>v});var n,r,s,a,o,l,c,h,d=i(57528),u=i(4212),p=i(59046),m=i(55386),_=i(36358),g=i(27920),f=i(64839);function v(e,t){const i=e.fragment;switch(t.doubleSidedMode){case g.W.None:i.code.add((0,f.H)(n||(n=(0,d.A)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn normal;\n}"]))));break;case g.W.View:e.include(_.em,t),i.code.add((0,f.H)(r||(r=(0,d.A)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;\n}"]))));break;case g.W.WindingOrder:i.code.add((0,f.H)(s||(s=(0,d.A)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;default:(0,u.Xb)(t.doubleSidedMode);case g.W.COUNT:}switch(t.normalType){case p.W.Attribute:case p.W.Compressed:e.include(m.Mh,t),i.code.add((0,f.H)(a||(a=(0,d.A)(["vec3 shadingNormalWorld() {\nreturn _adjustDoublesided(normalize(vNormalWorld));\n}\nvec3 shadingNormal_view() {\nvec3 normal = normalize(vNormalView);\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;case p.W.ScreenDerivative:e.include(_.em,t),i.code.add((0,f.H)(o||(o=(0,d.A)(["vec3 shadingNormalWorld() {\nreturn normalize(cross(\ndFdx(vPositionWorldCameraRelative),\ndFdy(vPositionWorldCameraRelative)\n));\n}\nvec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));\n}"]))));break;case p.W.Ground:t.spherical?(e.include(_.em,t),i.code.add((0,f.H)(l||(l=(0,d.A)(["vec3 shadingNormalWorld() {\nreturn normalize(positionWorld());\n}"]))))):i.code.add((0,f.H)(c||(c=(0,d.A)(["vec3 shadingNormalWorld() {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),i.code.add((0,f.H)(h||(h=(0,d.A)(["vec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;\n}"]))));break;default:(0,u.Xb)(t.normalType);case p.W.COUNT:}}},47331:(e,t,i)=>{i.d(t,{E:()=>m});var n,r,s,a=i(57528),o=i(34981),l=i(97808),c=i(11105),h=i(23976),d=i(64839),u=i(27374),p=i(83490);function m(e,t){const i=e.fragment;if(!t.hasColorTexture||t.output!==o.V.Color&&t.alphaDiscardMode===p.sf.Opaque)i.code.add((0,d.H)(s||(s=(0,a.A)(["vec4 readBaseColorTexture() { return vec4(1.0); }"]))));else{e.include(c.r,t);const s=t.textureCoordinateType===l.q.Atlas;i.uniforms.add(new u.o("baseColorTexture",(e=>e.texture))),s?(e.include(h.r),i.code.add((0,d.H)(n||(n=(0,a.A)(["vec4 readBaseColorTexture() {\nreturn textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);\n}"]))))):i.code.add((0,d.H)(r||(r=(0,a.A)(["vec4 readBaseColorTexture() {\nreturn texture(baseColorTexture, vuv0);\n}"]))))}}},10909:(e,t,i)=>{i.d(t,{z:()=>a});var n,r=i(57528),s=i(64839);function a(e){e.code.add((0,s.H)(n||(n=(0,r.A)(["\n    float lineFactorAtPosition(float value) {\n      float pos = value * ",";\n      if(pos < 0.5 || pos > ",") {\n        return 1.0;\n      }\n\n      pos = pos + 0.5;\n      float modulo = mod(pos, 16.0);\n      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;\n    }\n\n    float lineFactorAtUV(vec2 uv) {\n      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));\n    }\n\n    float lineFactor(vec2 uv) {\n      vec2 offset = fwidth(uv) * 0.25;\n      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;\n    }\n\n    vec3 gridColor(vec2 uv) {\n      float line = lineFactor(uv) * 0.1 + 0.9;\n      return vec3(1.0, 0.972, 0.918) * line;\n    }"])),s.H.float(257),s.H.float(256.5)))}},14209:(e,t,i)=>{i.d(t,{BK:()=>b,Rq:()=>y});var n,r,s,a,o,l,c,h,d,u,p=i(57528),m=i(1773),_=i(10909),g=i(38918),f=i(64839),v=i(7223);class y extends m.QR{constructor(){super(...arguments),this.overlayOpacity=1}}function b(e,t){const{vertex:i,fragment:m,varyings:v}=e;v.add("vtc","vec2"),i.uniforms.add(new C("texOffsetAndScale")),m.uniforms.add(new T("tex")),m.uniforms.add(new x("textureOpacities"));const y=t.textureFadingEnabled&&!t.renderOccluded;y&&(i.uniforms.add(new C("nextTexOffsetAndScale")),v.add("nvtc","vec2"),m.uniforms.add(new T("texNext")),m.uniforms.add(new x("nextTexOpacities")),m.uniforms.add(new w("fadeFactor")));const b=t.tileBlendInput===g.k.ColorComposite,A=t.tileBlendInput===g.k.GridComposite;A&&m.include(_.z),b&&m.uniforms.add(new x("backgroundColor")),i.code.add((0,f.H)(n||(n=(0,p.A)(["\n  void forwardTextureCoordinatesWithTransform(in vec2 uv) {\n    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;\n    ","\n  }"])),y?(0,f.H)(r||(r=(0,p.A)(["nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;"]))):(0,f.H)(s||(s=(0,p.A)([""]))))),m.code.add((0,f.H)(a||(a=(0,p.A)(["\n    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {\n      ","\n    }"])),A||b?(0,f.H)(o||(o=(0,p.A)(["\n              if (opacities.y <= 0.0) {\n                return color * opacities.z * opacities.x;\n              }\n              vec4 bg = vec4("," * opacities.y, opacities.y);\n              vec4 layer = color * opacities.z;\n              return (bg * (1.0 - layer.a) + layer) * opacities.x;"])),b?(0,f.H)(l||(l=(0,p.A)(["backgroundColor"]))):(0,f.H)(c||(c=(0,p.A)(["gridColor(uv)"])))):(0,f.H)(h||(h=(0,p.A)(["return color;"]))))),y?m.code.add((0,f.H)(d||(d=(0,p.A)(["vec4 getTileColor() {\nvec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);\nif (fadeFactor >= 1.0) {\nreturn color;\n}\nvec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);\nreturn mix(nextColor, color, fadeFactor);\n}"])))):m.code.add((0,f.H)(u||(u=(0,p.A)(["vec4 getTileColor() {\nreturn getColor(texture(tex, vtc), vtc, textureOpacities);\n}"]))))}class w extends v.n{constructor(e){super(e,"float")}}class x extends v.n{constructor(e){super(e,"vec3")}}class C extends v.n{constructor(e){super(e,"vec4")}}class T extends v.n{constructor(e){super(e,"sampler2D")}}},79360:(e,t,i)=>{i.d(t,{Qo:()=>ae,xV:()=>se,gv:()=>oe,Pt:()=>ue});var n,r,s,a,o,l,c,h,d,u,p,m,_,g,f,v,y,b,w,x,C,T,A,M,S,P,R,E,O,D,I,L,N,F,V,H,U,z,q,G,B,k=i(57528),W=(i(9392),i(32124)),Z=i(10909),j=i(64839);function Q(e,t){const i=t.blendMode;i!==W.IU.Normal&&(i===W.IU.Reflect&&e.code.add((0,j.H)(n||(n=(0,k.A)(["float reflectBlend(in float cb, in float cl) {\nreturn (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);\n}"])))),i!==W.IU.ColorDodge&&i!==W.IU.VividLight||e.code.add((0,j.H)(r||(r=(0,k.A)(["float colorDodge(in float cb, in float cl) {\nreturn (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));\n}"])))),i!==W.IU.ColorBurn&&i!==W.IU.VividLight||e.code.add((0,j.H)(s||(s=(0,k.A)(["float colorBurn(in float cb, in float cl) {\nreturn (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);\n}"])))),i===W.IU.Overlay&&e.code.add((0,j.H)(a||(a=(0,k.A)(["float overlay(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);\n}"])))),i===W.IU.HardLight&&e.code.add((0,j.H)(o||(o=(0,k.A)(["float hardLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));\n}"])))),i===W.IU.SoftLight&&e.code.add((0,j.H)(l||(l=(0,k.A)(["float softLight(in float cb, in float cl) {\nif (cl <= 0.5) {\nreturn cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);\n}\nif (cb <= 0.25) {\nreturn cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);\n}\nreturn cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);\n}"])))),i===W.IU.VividLight&&e.code.add((0,j.H)(c||(c=(0,k.A)(["float vividLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));\n}"])))),i!==W.IU.Hue&&i!==W.IU.Saturation&&i!==W.IU.Color&&i!==W.IU.Luminosity||(e.code.add((0,j.H)(h||(h=(0,k.A)(["float minv3(in vec3 c) {\nreturn min(min(c.r, c.g), c.b);\n}\nfloat maxv3(in vec3 c) {\nreturn max(max(c.r, c.g), c.b);\n}\nfloat lumv3(in vec3 c) {\nreturn dot(c, vec3(0.3, 0.59, 0.11));\n}\nvec3 clipColor(vec3 color) {\nfloat lum = lumv3(color);\nfloat mincol = minv3(color);\nfloat maxcol = maxv3(color);\nif (mincol < 0.0) {\ncolor = lum + ((color - lum) * lum) / (lum - mincol);\n}\nif (maxcol > 1.0) {\ncolor = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);\n}\nreturn color;\n}\nvec3 setLum(vec3 cbase, vec3 clum) {\nreturn clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));\n}"])))),i!==W.IU.Hue&&i!==W.IU.Saturation||e.code.add((0,j.H)(d||(d=(0,k.A)(["float satv3(vec3 c) {\nreturn maxv3(c) - minv3(c);\n}\nvec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)\n{\nfloat minbase = minv3(cbase);\nfloat sbase = satv3(cbase);\nfloat ssat = satv3(csat);\nreturn setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);\n}"]))))),e.code.add((0,j.H)(u||(u=(0,k.A)(["\n    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {\n      ","\n    }\n  "])),i===W.IU.Multiply?(0,j.H)(p||(p=(0,k.A)(["return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Average?(0,j.H)(m||(m=(0,k.A)(["return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Lighten?(0,j.H)(_||(_=(0,k.A)(["return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Darken?(0,j.H)(g||(g=(0,k.A)(["return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Lighter?(0,j.H)(f||(f=(0,k.A)(["return vec4(cl * ol + cb * ob, ol + ob);"]))):i===W.IU.Plus?(0,j.H)(v||(v=(0,k.A)(["return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);"]))):i===W.IU.Minus?(0,j.H)(y||(y=(0,k.A)(["return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);"]))):i===W.IU.Screen?(0,j.H)(b||(b=(0,k.A)(["return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Difference?(0,j.H)(w||(w=(0,k.A)(["return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Invert?(0,j.H)(x||(x=(0,k.A)(["return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);"]))):i===W.IU.DestinationOver?(0,j.H)(C||(C=(0,k.A)(["return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);"]))):i===W.IU.DestinationAtop?(0,j.H)(T||(T=(0,k.A)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);"]))):i===W.IU.DestinationOut?(0,j.H)(A||(A=(0,k.A)(["return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));"]))):i===W.IU.SourceAtop?(0,j.H)(M||(M=(0,k.A)(["return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);"]))):i===W.IU.SourceOut?(0,j.H)(S||(S=(0,k.A)(["return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));"]))):i===W.IU.Xor?(0,j.H)(P||(P=(0,k.A)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));"]))):i===W.IU.DestinationIn?(0,j.H)(R||(R=(0,k.A)(["return vec4(cb * ob * ol, ol * ob);"]))):i===W.IU.SourceIn?(0,j.H)(E||(E=(0,k.A)(["return vec4(cl * ol * ob, ol * ob);"]))):i===W.IU.Hue?(0,j.H)(O||(O=(0,k.A)(["\n          vec3 f = setLumSat(cl, cb, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Saturation?(0,j.H)(D||(D=(0,k.A)(["\n          vec3 f = setLumSat(cb, cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Color?(0,j.H)(I||(I=(0,k.A)(["\n          vec3 f = setLum(cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Luminosity?(0,j.H)(L||(L=(0,k.A)(["\n          vec3 f = setLum(cb, cl);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Exclusion?(0,j.H)(N||(N=(0,k.A)(["\n          vec3 f = cl + cb - 2.0 * cl * cb;\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Reflect?(0,j.H)(F||(F=(0,k.A)(["\n          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.ColorDodge?(0,j.H)(V||(V=(0,k.A)(["\n          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.ColorBurn?(0,j.H)(H||(H=(0,k.A)(["\n          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.Overlay?(0,j.H)(U||(U=(0,k.A)(["\n          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.SoftLight?(0,j.H)(z||(z=(0,k.A)(["\n          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.HardLight?(0,j.H)(q||(q=(0,k.A)(["\n          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):i===W.IU.VividLight?(0,j.H)(G||(G=(0,k.A)(["\n          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):(0,j.H)(B||(B=(0,k.A)([""]))))))}var X,Y,$,K,J,ee,te,ie,ne,re,se,ae,oe,le,ce=i(5517),he=i(21390),de=i(70367);(le=se||(se={}))[le.Composite=0]="Composite",le[le.ColorComposite=1]="ColorComposite",le[le.GridComposite=2]="GridComposite",le[le.GroupBackgroundComposite=3]="GroupBackgroundComposite",le[le.COUNT=4]="COUNT",function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(ae||(ae={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(oe||(oe={}));j.Y;function ue(e,t){const i=t.output===se.GridComposite,n=t.output===se.ColorComposite,r=t.output===se.GroupBackgroundComposite,s=t.output===se.Composite;i&&e.fragment.include(Z.z),n&&e.fragment.uniforms.add(new ce.t("backgroundColor",(e=>e.backgroundColor)));const a=t.baseOpacityMode===ae.Required;a&&e.fragment.uniforms.add(new he.m("baseOpacity",(e=>e.baseOpacity))),s&&e.fragment.uniforms.add(new de.N("fboColor",(e=>e.fboTexture)));const o=t.blendMode!==W.IU.Normal,l=t.premultipliedSource===oe.On;e.fragment.include(Q,t),e.fragment.code.add((0,j.H)(X||(X=(0,k.A)(["\n    vec4 getBackground(vec2 uv) {\n      return "," ",";\n    }\n\n    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {\n      ","\n    }"])),a?(0,j.H)(Y||(Y=(0,k.A)(["baseOpacity *"]))):"",r?(0,j.H)($||($=(0,k.A)(["vec4(0.0, 0.0, 0.0, 0.0)"]))):n?(0,j.H)(K||(K=(0,k.A)(["vec4(backgroundColor, 1.0)"]))):i?(0,j.H)(J||(J=(0,k.A)(["vec4(gridColor(uv), 1.0)"]))):(0,j.H)(ee||(ee=(0,k.A)(["texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)"]))),o?(0,j.H)(te||(te=(0,k.A)(["\n          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;\n          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;\n          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);"]))):(0,j.H)(ie||(ie=(0,k.A)(["\n          float composeAlpha = colorLayer.a * opacity;\n          return ",""])),!l&&(s&&!a||r)?(0,j.H)(ne||(ne=(0,k.A)(["colorLayer * opacity;"]))):(0,j.H)(re||(re=(0,k.A)(["bgColor * (1.0 - composeAlpha) + colorLayer * opacity;"]))))))}},38918:(e,t,i)=>{var n;i.d(t,{k:()=>n}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(n||(n={}))},25252:(e,t,i)=>{i.d(t,{J:()=>h,W:()=>d});var n,r=i(57528),s=i(72745),a=i(95756),o=i(21390),l=i(64839),c=i(66470);class h extends l.Y{constructor(){super(...arguments),this.scale=1,this.offset=s.uY}}function d(e){e.attributes.add(c.r.POSITION,"vec2"),e.attributes.add(c.r.UV0,"vec2"),e.vertex.uniforms.add(new o.m("scale",(e=>e.scale))),e.vertex.uniforms.add(new a.G("offset",(e=>e.offset))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add((0,l.H)(n||(n=(0,r.A)(["void main(void) {\ngl_Position = vec4(position, 0.0, 1.0);\nuv = uv0 * scale + offset;\nvuv = uv0;\n}"]))))}},81148:(e,t,i)=>{i.d(t,{T:()=>n,V:()=>s});var n,r=i(80963);function s(e){return e&&(0,r.q8)(e)?n.Mars:e&&(0,r.KQ)(e)?n.Moon:n.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(n||(n={}))},77845:(e,t,i)=>{i.d(t,{p:()=>a});var n=i(20664),r=i(83755),s=i(9392);class a{constructor(e){this._low=(0,s.vt)(),this._high=(0,s.vt)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){(0,n.c)(this._low,(0,n.c)(o,e));const t=(0,n.z)(o,e,this._low);(0,n.c)(this._high,t)}get(e){return(0,n.g)(e,this._low,this._high)}getLowScaled(e){return(0,n.h)(e,this._low,1)}}const o=(0,r.vt)()},11850:(e,t,i)=>{i.d(t,{lK:()=>a,u7:()=>o});var n=i(66470),r=i(93345),s=i(21812);new s._(n.r.POSITION,3,r.pe.FLOAT,0,12),new s._(n.r.POSITION,3,r.pe.FLOAT,0,20),new s._(n.r.UV0,2,r.pe.FLOAT,12,20),new s._(n.r.POSITION,3,r.pe.FLOAT,0,32),new s._(n.r.NORMAL,3,r.pe.FLOAT,12,32),new s._(n.r.UV0,2,r.pe.FLOAT,24,32),new s._(n.r.POSITION,3,r.pe.FLOAT,0,16),new s._(n.r.COLOR,4,r.pe.UNSIGNED_BYTE,12,16);const a=[new s._(n.r.POSITION,2,r.pe.FLOAT,0,8)],o=[new s._(n.r.POSITION,2,r.pe.FLOAT,0,16),new s._(n.r.UV0,2,r.pe.FLOAT,8,16)]},74527:(e,t,i)=>{i.d(t,{U:()=>o});var n=i(78393),r=i(12016),s=i(12580),a=i(8775);class o extends r.B{constructor(e){super("EdgeProcessingWorker","extract",{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,i){if(i)return(0,a.o6)(e);const n=await this.invoke(new l(e),t);return this._unpackOutput(n)}async extractEdgeLocations(e,t){const i=await this.invokeMethod("extractEdgeLocations",new l(e),t);return(0,s.s)(i)}async extractComponentsEdgeLocations(e,t){const i=await this.invokeMethod("extractComponentsEdgeLocations",new l(e),t);return(0,s.s)(i)}_unpackOutput(e){return{regular:{instancesData:(0,s.s)(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:(0,s.s)(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}class l{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=(0,n.cy)(e.indices)?e.indices:e.indices.buffer,this.indicesType=(0,n.cy)(e.indices)?"Array":(0,n.XJ)(e.indices)?"Uint32Array":"Uint16Array",this.indicesLength=e.indicesLength}}},96141:(e,t,i)=>{i.d(t,{I$:()=>a,In:()=>h,JS:()=>d,gr:()=>c,vJ:()=>o,wO:()=>l});var n=i(57481),r=i(48549),s=i(66470);const a=(0,r.BP)().vec3f(s.r.POSITION).u16(s.r.COMPONENTINDEX),o=(0,r.BP)().vec2u8(s.r.SIDENESS),l=(0,n.U)(o),c=(0,r.BP)().vec3f(s.r.POSITION0).vec3f(s.r.POSITION1).vec2i16(s.r.NORMALCOMPRESSED).u16(s.r.COMPONENTINDEX).u8(s.r.VARIANTOFFSET,{glNormalized:!0}).u8(s.r.VARIANTSTROKE).u8(s.r.VARIANTEXTENSION,{glNormalized:!0}),h=(0,r.BP)().vec3f(s.r.POSITION0).vec3f(s.r.POSITION1).vec2i16(s.r.NORMALCOMPRESSED).vec2i16(s.r.NORMAL2COMPRESSED).u16(s.r.COMPONENTINDEX).u8(s.r.VARIANTOFFSET,{glNormalized:!0}).u8(s.r.VARIANTSTROKE).u8(s.r.VARIANTEXTENSION,{glNormalized:!0}),d=new Map([[s.r.POSITION0,0],[s.r.POSITION1,1],[s.r.COMPONENTINDEX,2],[s.r.VARIANTOFFSET,3],[s.r.VARIANTSTROKE,4],[s.r.VARIANTEXTENSION,5],[s.r.NORMALCOMPRESSED,6],[s.r.NORMAL2COMPRESSED,7],[s.r.SIDENESS,8]])},69413:(e,t,i)=>{i.d(t,{TK:()=>v,TM:()=>f});var n=i(47249),r=i(20664),s=i(9392),a=i(57481),o=i(25672),l=i(96141);class c{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?m:p}write(e,t,i){const n=this._edgeHashFunction(i);b.seed=n;const r=b.getIntRange(0,255),s=b.getIntRange(0,this.settings.variants-1),a=b.getFloat(),o=255*(.5*function(e,t){const i=e<0?-1:1;return Math.abs(e)**t*i}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,i.position0),e.position1.setVec(t,i.position1),e.componentIndex.set(t,i.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,s),e.variantExtension.set(t,o)}trim(e,t){return e.slice(0,t)}}const h=new Float32Array(6),d=new Uint32Array(h.buffer),u=new Uint32Array(1);function p(e){const t=h;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],u[0]=5381;for(let i=0;i<d.length;i++)u[0]=31*u[0]+d[i];return u[0]}function m(e){const t=h;t[0]=g(e.position0[0]),t[1]=g(e.position0[1]),t[2]=g(e.position0[2]),t[3]=g(e.position1[0]),t[4]=g(e.position1[1]),t[5]=g(e.position1[2]),u[0]=5381;for(let i=0;i<d.length;i++)u[0]=31*u[0]+d[i];return u[0]}const _=1e4;function g(e){return Math.round(e*_)/_}class f{constructor(){this._commonWriter=new c}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return l.gr.createBuffer(e)}write(e,t,i){this._commonWriter.write(e,t,i),(0,r.g)(y,i.faceNormal0,i.faceNormal1),(0,r.n)(y,y);const{typedBuffer:n,typedBufferStride:s}=e.normalCompressed;(0,o.aT)(n,t,y[0],y[1],y[2],s)}trim(e,t){return this._commonWriter.trim(e,t)}}f.Layout=l.gr,f.glLayout=(0,a.U)(l.gr,1);class v{constructor(){this._commonWriter=new c}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return l.In.createBuffer(e)}write(e,t,i){this._commonWriter.write(e,t,i);{const{typedBuffer:n,typedBufferStride:r}=e.normalCompressed;(0,o.aT)(n,t,i.faceNormal0[0],i.faceNormal0[1],i.faceNormal0[2],r)}{const{typedBuffer:n,typedBufferStride:r}=e.normal2Compressed;(0,o.aT)(n,t,i.faceNormal1[0],i.faceNormal1[1],i.faceNormal1[2],r)}}trim(e,t){return this._commonWriter.trim(e,t)}}v.Layout=l.In,v.glLayout=(0,a.U)(l.In,1);const y=(0,s.vt)(),b=new n.A},83661:(e,t,i)=>{i.d(t,{K:()=>h,g:()=>l});var n=i(18690),r=i(15941),s=i(20664),a=i(9392);const o=-1;var l,c;function h(e,t,i){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:f;const l=e.vertices.position,c=e.vertices.componentIndex,h=(0,r.kU)(a.anglePlanar),g=(0,r.kU)(a.angleSignificantEdge),v=Math.cos(g),y=Math.cos(h),b=_.edge,w=b.position0,x=b.position1,C=b.faceNormal0,T=b.faceNormal1,A=m(e),M=function(e){const t=e.faces.length/3,i=e.faces,n=e.neighbors;let r=0;for(let l=0;l<t;l++){const e=n[3*l],t=n[3*l+1],s=n[3*l+2],a=i[3*l],c=i[3*l+1],h=i[3*l+2];r+=e===o||a<c?1:0,r+=t===o||c<h?1:0,r+=s===o||h<a?1:0}const s=new Int32Array(4*r);let a=0;for(let l=0;l<t;l++){const e=n[3*l],t=n[3*l+1],r=n[3*l+2],c=i[3*l],h=i[3*l+1],d=i[3*l+2];(e===o||c<h)&&(s[a++]=c,s[a++]=h,s[a++]=l,s[a++]=e),(t===o||h<d)&&(s[a++]=h,s[a++]=d,s[a++]=l,s[a++]=t),(r===o||d<c)&&(s[a++]=d,s[a++]=c,s[a++]=l,s[a++]=r)}return s}(e),S=M.length/4,P=t.allocate(S);let R=0;const E=S,O=i.allocate(E);let D=0,I=0,L=0;const N=(0,n.y1)(0,S),F=new Float32Array(S);F.forEach(((e,t,i)=>{l.getVec(M[4*t],w),l.getVec(M[4*t+1],x),i[t]=(0,s.q)(w,x)})),N.sort(((e,t)=>F[t]-F[e]));const V=new Array,H=new Array;for(let n=0;n<S;n++){const e=N[n],r=F[e],a=M[4*e],m=M[4*e+1],_=M[4*e+2],g=M[4*e+3],f=g===o;if(l.getVec(a,w),l.getVec(m,x),f)(0,s.s)(C,A[3*_],A[3*_+1],A[3*_+2]),(0,s.c)(T,C),b.componentIndex=c.get(a),b.cosAngle=(0,s.k)(C,T);else{if((0,s.s)(C,A[3*_],A[3*_+1],A[3*_+2]),(0,s.s)(T,A[3*g],A[3*g+1],A[3*g+2]),b.componentIndex=c.get(a),b.cosAngle=(0,s.k)(C,T),u(b,y))continue;b.cosAngle<-.9999&&(0,s.c)(T,C)}I+=r,L++,f||d(b,v)?(t.write(P,R++,b),V.push(r)):p(b,h)&&(i.write(O,D++,b),H.push(r))}const U=new Float32Array(V.reverse()),z=new Float32Array(H.reverse());return{regular:{instancesData:t.trim(P,R),lodInfo:{lengths:U}},silhouette:{instancesData:i.trim(O,D),lodInfo:{lengths:z}},averageEdgeLength:I/L}}function d(e,t){return e.cosAngle<t}function u(e,t){return e.cosAngle>t}function p(e,t){const i=(0,r.XM)(e.cosAngle),n=_.fwd,a=_.ortho;return(0,s.E)(n,e.position1,e.position0),i*((0,s.k)((0,s.b)(a,e.faceNormal0,e.faceNormal1),n)>0?-1:1)>t}function m(e){const t=e.faces.length/3,i=e.vertices.position,n=e.faces,r=g.v0,a=g.v1,o=g.v2,l=new Float32Array(3*t);for(let c=0;c<t;c++){const e=n[3*c],t=n[3*c+1],h=n[3*c+2];i.getVec(e,r),i.getVec(t,a),i.getVec(h,o),(0,s.f)(a,a,r),(0,s.f)(o,o,r),(0,s.b)(r,a,o),(0,s.n)(r,r),l[3*c]=r[0],l[3*c+1]=r[1],l[3*c+2]=r[2]}return l}(c=l||(l={}))[c.SOLID=0]="SOLID",c[c.SKETCH=1]="SKETCH";const _={edge:{position0:(0,a.vt)(),position1:(0,a.vt)(),faceNormal0:(0,a.vt)(),faceNormal1:(0,a.vt)(),componentIndex:0,cosAngle:0},ortho:(0,a.vt)(),fwd:(0,a.vt)()},g={v0:(0,a.vt)(),v1:(0,a.vt)(),v2:(0,a.vt)()},f={anglePlanar:4,angleSignificantEdge:35}},8775:(e,t,i)=>{i.d(t,{o6:()=>h,HY:()=>g,hx:()=>d,Jb:()=>_});var n=i(77176);function r(e,t,i){const n=t/3,r=new Uint32Array(i+1),s=new Uint32Array(i+1),a=(e,t)=>{e<t?r[e+1]++:s[t+1]++};for(let f=0;f<n;f++){const t=e[3*f],i=e[3*f+1],n=e[3*f+2];a(t,i),a(i,n),a(n,t)}let o=0,l=0;for(let f=0;f<i;f++){const e=r[f+1],t=s[f+1];r[f+1]=o,s[f+1]=l,o+=e,l+=t}const c=new Uint32Array(6*n),h=r[i],d=(e,t,i)=>{if(e<t){const n=r[e+1]++;c[2*n]=t,c[2*n+1]=i}else{const n=s[t+1]++;c[2*h+2*n]=e,c[2*h+2*n+1]=i}};for(let f=0;f<n;f++){const t=e[3*f],i=e[3*f+1],n=e[3*f+2];d(t,i,f),d(i,n,f),d(n,t,f)}const u=(e,t)=>{const i=2*e,n=t-e;for(let r=1;r<n;r++){const e=c[i+2*r],t=c[i+2*r+1];let n=r-1;for(;n>=0&&c[i+2*n]>e;n--)c[i+2*n+2]=c[i+2*n],c[i+2*n+3]=c[i+2*n+1];c[i+2*n+2]=e,c[i+2*n+3]=t}};for(let f=0;f<i;f++)u(r[f],r[f+1]),u(h+s[f],h+s[f+1]);const p=new Int32Array(3*n),m=(t,i)=>t===e[3*i]?0:t===e[3*i+1]?1:t===e[3*i+2]?2:-1,_=(e,t)=>{const i=m(e,t);p[3*t+i]=-1},g=(e,t,i,n)=>{const r=m(e,t);p[3*t+r]=n;const s=m(i,n);p[3*n+s]=t};for(let f=0;f<i;f++){let e=r[f];const t=r[f+1];let i=s[f];const n=s[f+1];for(;e<t&&i<n;){const t=c[2*e],n=c[2*h+2*i];t===n?(g(f,c[2*e+1],n,c[2*h+2*i+1]),e++,i++):t<n?(_(f,c[2*e+1]),e++):(_(n,c[2*h+2*i+1]),i++)}for(;e<t;)_(f,c[2*e+1]),e++;for(;i<n;)_(c[2*h+2*i],c[2*h+2*i+1]),i++}return p}var s=i(48549),a=i(66470),o=i(96141),l=i(69413),c=i(83661);function h(e){const t=d(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return p.updateSettings(e.writerSettings),m.updateSettings(e.writerSettings),(0,c.K)(t,p,m)}function d(e,t,i,s){if(t){const t=r(i,s,e.count);return new u(i,s,t,e)}const a=(0,n.b)(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:s}),l=r(a.indices,s,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:l,vertices:o.I$.createView(a.buffer)}}class u{constructor(e,t,i,n){this.faces=e,this.facesLength=t,this.neighbors=i,this.vertices=n}}const p=new l.TM,m=new l.TK,_=(0,s.BP)().vec3f(a.r.POSITION0).vec3f(a.r.POSITION1),g=(0,s.BP)().vec3f(a.r.POSITION0).vec3f(a.r.POSITION1).u16(a.r.COMPONENTINDEX)},22278:(e,t,i)=>{i.d(t,{Q:()=>h,T:()=>u});var n=i(32119),r=i(11850),s=i(69008),a=i(76718),o=i(93345),l=i(98433),c=i(96673);function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.lK,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.D,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,h=null;return h=t===r.u7?new Float32Array([l,l,0,0,c,l,1,0,l,c,0,1,c,c,1,1]):new Float32Array([l,l,c,l,l,c,c,c]),new s.Z(e,i,{geometry:t},{geometry:a.g.createVertex(e,o._U.STATIC_DRAW,h)})}const d=4;function u(e){const t=new c.R(d);return t.samplingMode=o.Cj.NEAREST,new l.g(e,t)}},30310:(e,t,i)=>{i.d(t,{FI:()=>p,FV:()=>d,Gy:()=>u,QS:()=>f,SM:()=>g});var n=i(34761),r=i(9392),s=i(42294),a=i(93582),o=i(45270),l=i(21255),c=i(46571),h=i(71488);function d(e,t){var i,n;return(0,c.$I)(e)||(0,c.hH)(e)?_(null===(i=e.target)||void 0===i?void 0:i.object,t):(0,l.DC)(e)?null===(n=t.map)||void 0===n?void 0:n.ground:(0,o.rb)(e)||(0,o.db)(e)||(0,l.mi)(e)||(0,o.Q5)(e)?_(e.target,t):null}function u(e,t){const i=p(e,t);return null!=i&&"graphic"===i.type?i.graphic:null}function p(e,t){var i;if(null==e)return null;if((0,c.$I)(e)||(0,c.hH)(e))return m(null===(i=e.target)||void 0===i?void 0:i.object,t);if((0,o.rb)(e)){const t=e.target.createGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.Q5)(e)){const t=e.target.createVoxelGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.W3)(e)){const t=e.target.createTiles3DGraphic();return{type:"graphic",graphic:t,layer:t.layer}}return(0,l.mi)(e)||(0,h.H)(e)?m(e.target,t):(0,o.db)(e)?function(e,t){const i=_(e,t);if(null==i)return null;const n=t.allLayerViews.find((e=>e.layer===i));return n&&!n.suspended&&"getGraphicFromIntersectorTarget"in n?function(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}(n.getGraphicFromIntersectorTarget(e)):null}(e.target,t):null}function m(e,t){if(null==(null===e||void 0===e?void 0:e.graphicUid))return null;const i=_(e,t);if(null==i)return null;if(i===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid);const n=t.allLayerViews.find((e=>e.layer===i));return!n||n.suspended||null==e.graphicUid?null:"getHit"in n?n.getHit(e.graphicUid):null}function _(e,t){return null==(null===e||void 0===e?void 0:e.layerUid)?null:null!=t.graphicsView&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.allLayers.find((t=>t.uid===e.layerUid))}function g(e,t){if((0,c.$I)(e)||(0,c.hH)(e))return(0,a.b)(e.target.object.boundingVolumeWorldSpace.bounds);if((0,h.H)(e)){(0,n.IL)(v,e.transformation);const t=Math.max(v[0],v[1],v[2]);return e.target.baseBoundingSphere.radius*t}if((0,o.db)(e)){const i=function(e,t){const i=_(e,t);if(null==i)return null;const n=t.allLayerViews.find((e=>e.layer===i));return n&&!n.suspended&&"getAABBFromIntersectorTarget"in n?n.getAABBFromIntersectorTarget(e):null}(e.target,t);return i?.5*(0,s._F)(i):null}return null}function f(e){return!(0,c.$I)(e)&&!(0,c.hH)(e)&&((0,h.H)(e)?e.target.numLodLevels>1:!!(0,o.db)(e))}const v=(0,r.vt)()},50578:(e,t,i)=>{i.d(t,{o:()=>n,q:()=>o});var n,r,s=i(35143),a=i(99415);(r=n||(n={}))[r.Gradient=0]="Gradient",r[r.Threshold=1]="Threshold",r[r.COUNT=2]="COUNT";class o extends a.K{constructor(){super(...arguments),this.visualization=n.Gradient,this.bandsEnabled=!1}}(0,s._)([(0,a.W)({count:n.COUNT})],o.prototype,"visualization",void 0),(0,s._)([(0,a.W)()],o.prototype,"bandsEnabled",void 0)},78275:(e,t,i)=>{i.d(t,{T:()=>_});var n,r=i(57528),s=i(72745),a=i(64839);function o(e){const t=(0,a.H)(n||(n=(0,r.A)(["bool isNaN( float val )\n{\nreturn ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n}"])));e.code.add(t)}var l,c,h,d=i(95756),u=i(72106),p=i(43425);const m=(0,s.fA)(.5,-4e-4);function _(e,t){const i=e.vertex;i.include(o),i.constants.add("depthBias","vec2",m),i.uniforms.add(new d.G("inverseViewport",((e,t)=>t.inverseViewport))),t.legacy?(i.uniforms.add(new p.X("proj",((e,t)=>t.camera.projectionMatrix))),i.code.add((0,a.H)(l||(l=(0,r.A)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = proj * localView * vec4(globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))):(i.uniforms.add(new u.k("transformNormalViewFromGlobal",(e=>e.transformNormalViewFromGlobal)),new p.X("transformProjFromView",(e=>e.transformProjFromView))),i.code.add((0,a.H)(c||(c=(0,r.A)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))),i.code.add((0,a.H)(h||(h=(0,r.A)(["float _calculateProjectedBiasZ(vec4 projPos) {\nfloat offsetZ = depthBias.y;\nreturn sqrt(max(projPos.z,0.0)) * offsetZ;\n}\nvec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {\nvec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);\nif (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {\nprojPos.xy += offsetXY;\n}\nprojPos.z += _calculateProjectedBiasZ(projPos);\nreturn projPos;\n}"]))))}},69466:(e,t,i)=>{i.d(t,{M:()=>a});var n,r=i(57528),s=i(64839);function a(e){const t=e.fragment;t.constants.add("coverageTestThreshold","float",.01),t.code.add((0,s.H)(n||(n=(0,r.A)(["#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }"]))))}},80320:(e,t,i)=>{i.d(t,{W:()=>c});var n,r,s,a,o=i(57528),l=i(64839);function c(e,t){const i=e.vertex;t.silhouette?(i.code.add((0,l.H)(n||(n=(0,o.A)(["bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {\nfloat faceAVisible = dot(viewDir, normalA);\nfloat faceBVisible = dot(viewDir, normalB);\nreturn faceAVisible * faceBVisible < 0.0;\n}"])))),t.legacy?i.code.add((0,l.H)(r||(r=(0,o.A)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {\nvec3 viewNormalA = _modelToViewNormal(data.normal);\nvec3 viewNormalB = _modelToViewNormal(data.normal2);\nvec3 viewDir = -viewPos;\nif (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"])))):i.code.add((0,l.H)(s||(s=(0,o.A)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {\nvec3 worldNormalA = _modelToWorldNormal(data.normal);\nvec3 worldNormalB = _modelToWorldNormal(data.normal2);\nvec3 viewDir = -worldPos;\nif (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"]))))):i.code.add((0,l.H)(a||(a=(0,o.A)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {\nreturn false;\n}"]))))}},28014:(e,t,i)=>{i.d(t,{E7:()=>L,Z5:()=>f,s0:()=>v,zP:()=>N});var n,r,s,a,o,l,c,h,d,u,p,m,_,g,f,v,y,b=i(57528),w=i(13545),x=i(59046),C=i(89299),T=i(81449),A=i(72468),M=i(5517),S=i(21390),P=i(64839),R=i(42759),E=i(72106),O=i(43425),D=i(27374),I=i(66470);function L(e,t){const i=e.vertex;i.include(T.W),e.include(x.Y,t),i.uniforms.add(new S.m("distanceFalloffFactor",(e=>e.distanceFalloffFactor))),i.code.add((0,P.H)(n||(n=(0,b.A)(["float distanceBasedPerspectiveFactor(float distance) {\nreturn clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);\n}"])))),i.uniforms.add(new D.o("componentDataTex",(e=>e.componentDataTexture))),e.attributes.add(I.r.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentVerticalOffsetFieldOffset","float",2),i.constants.add("componentFieldCount","float",3),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("verticalOffsetScale","float",2*w.Hi),i.code.add((0,P.H)(r||(r=(0,b.A)(["\n    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {\n      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;\n      float texSize = float(textureSize(componentDataTex, 0).x);\n      float colIndex = mod(fieldIndex, texSize);\n      float rowIndex = floor(fieldIndex / texSize);\n\n      return vec2(colIndex, rowIndex) + 0.5;\n    }\n\n    struct ComponentData {\n      vec4 color;\n      vec3 normal;\n      vec3 normal2;\n      float lineWidth;\n      float extensionLength;\n      float type;\n      float verticalOffset;\n    };\n\n    ComponentData readComponentData() {\n      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);\n      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);\n      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);\n      vec3 normal = normalModel();\n      vec3 normal2 = ",";\n\n      vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);\n      vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);\n      float verticalOffset = (rgba2float(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) - 0.5) * verticalOffsetScale;\n\n      return ComponentData(\n        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity\n        normal, normal2,\n        otherValue.x * (255.0 / lineWidthFractionFactor),\n        otherValue.y * 255.0 - extensionLengthOffset,\n        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;\n        verticalOffset\n      );\n    }\n  "])),t.silhouette?(0,P.H)(s||(s=(0,b.A)(["decompressNormal(normal2Compressed)"]))):(0,P.H)(a||(a=(0,b.A)(["normal"]))))),t.legacy?i.code.add((0,P.H)(o||(o=(0,b.A)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn (model * vec4(normal, 0.0)).xyz;\n}\nvec3 _modelToViewNormal(vec3 normal) {\nreturn (localView * model * vec4(normal, 0.0)).xyz;\n}"])))):(i.uniforms.add(new R.h("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel))),i.code.add((0,P.H)(l||(l=(0,b.A)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn transformNormalGlobalFromModel * normal;\n}"]))))),t.silhouette?(e.attributes.add(I.r.NORMAL2COMPRESSED,"vec2"),i.code.add((0,P.H)(c||(c=(0,b.A)(["vec3 worldNormal(ComponentData data) {\nreturn _modelToWorldNormal(normalize(data.normal + data.normal2));\n}"]))))):i.code.add((0,P.H)(h||(h=(0,b.A)(["vec3 worldNormal(ComponentData data) {\nreturn _modelToWorldNormal(data.normal);\n}"])))),t.legacy?i.code.add((0,P.H)(d||(d=(0,b.A)(["void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\nworldPos = (model * vec4(modelPos, 1.0)).xyz;\nviewPos = (localView * vec4(worldPos, 1.0)).xyz;\n}"])))):(i.include(C.u,t),i.uniforms.add(new E.k("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new R.h("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new A.W("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL)),new A.W("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new M.t("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new M.t("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH))),i.code.add((0,P.H)(u||(u=(0,b.A)(["\n      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\n        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;\n\n        vec3 transformCameraRelativeFromModel = dpAdd(\n          transformWorldFromModelTL,\n          transformWorldFromModelTH,\n          -transformWorldFromViewTL,\n          -transformWorldFromViewTH\n        );\n\n        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;\n\n        if (verticalOffset != 0.0) {\n          vec3 vUp = ","\n          worldPos += verticalOffset * vUp;\n        }\n\n        viewPos = transformViewFromCameraRelativeRS * worldPos;\n      }\n    "])),t.spherical?(0,P.H)(p||(p=(0,b.A)(["normalize(transformWorldFromModelTL + rotatedModelPosition);"]))):(0,P.H)(m||(m=(0,b.A)(["vec3(0.0, 0.0, 1.0);"])))))),i.uniforms.add(new O.X("transformProjFromView",((e,t)=>t.camera.projectionMatrix))),i.code.add((0,P.H)(_||(_=(0,b.A)(["vec4 projFromViewPosition(vec3 position) {\nreturn transformProjFromView * vec4(position, 1.0);\n}"])))),i.code.add((0,P.H)(g||(g=(0,b.A)(["float calculateExtensionLength(float extensionLength, float lineLength) {\nreturn extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);\n}"]))))}function N(e){return e.mode===f.SKETCH||e.mode===f.MIXED}(y=f||(f={}))[y.SOLID=0]="SOLID",y[y.SKETCH=1]="SKETCH",y[y.MIXED=2]="MIXED",y[y.COUNT=3]="COUNT",function(e){e[e.REGULAR=0]="REGULAR",e[e.SILHOUETTE=1]="SILHOUETTE"}(v||(v={}))},27860:(e,t,i)=>{i.d(t,{C:()=>d});var n,r,s,a=i(57528),o=i(19771),l=i(64839),c=i(28014),h=i(35804);function d(e,t){const i=e.vertex;switch(e.include(h.A,t),t.mode){case c.Z5.SOLID:i.code.add((0,l.H)(n||(n=(0,a.A)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn 0.0;\n}"]))));break;case c.Z5.SKETCH:i.uniforms.add(new o.J("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add((0,l.H)(r||(r=(0,a.A)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn strokesAmplitude;\n}"]))));break;case c.Z5.MIXED:i.uniforms.add(new o.J("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add((0,l.H)(s||(s=(0,a.A)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nfloat type = unpackedAttributes.type;\nif (type <= 0.0) {\nreturn strokesAmplitude;\n}\nelse {\nreturn 0.0;\n}\n}"]))))}}},70690:(e,t,i)=>{i.d(t,{u:()=>v});var n,r,s,a,o,l,c,h,d=i(57528),u=i(81449),p=i(19771),m=i(64839),_=i(27374),g=i(28014),f=i(35804);function v(e,t){e.include(f.A,t);const{vertex:i,fragment:v}=e;switch((0,g.zP)(t)&&(i.uniforms.add(new _.o("strokesTexture",(e=>e.strokesTexture.texture))),i.uniforms.add(new p.J("strokesLog2Resolution",(e=>Math.log2(e.strokesTexture.resolution))),new p.J("strokeVariants",(e=>e.strokesTexture.variants))),e.varyings.add("vStrokeUV","vec2"),v.uniforms.add(new _.o("strokesTexture",(e=>e.strokesTexture.texture)),new p.J("strokesNormalizationScale",(e=>e.strokesTexture.normalizationScale))),i.code.add((0,m.H)(n||(n=(0,d.A)(["void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {\nvec2 sidenessNorm = unpackedAttributes.sidenessNorm;\nfloat lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);\nvStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) / vec2(textureSize(strokesTexture, 0));\nvStrokeUV.x += variantOffset;\n}"])))),e.fragment.include(u.W),v.code.add((0,m.H)(r||(r=(0,d.A)(["float calculateLineOffsetSketch() {\nfloat offsetNorm = rgba2float(texture(strokesTexture, vStrokeUV));\nreturn (offsetNorm - 0.5) * strokesNormalizationScale;\n}\nfloat calculateLinePressureSketch() {\nreturn rgba2float(texture(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));\n}"]))))),t.mode){case g.Z5.SOLID:i.code.add((0,m.H)(s||(s=(0,d.A)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}"])))),v.code.add((0,m.H)(a||(a=(0,d.A)(["float calculateLineOffset() {\nreturn 0.0;\n}\nfloat calculateLinePressure() {\nreturn 1.0;\n}"]))));break;case g.Z5.SKETCH:i.code.add((0,m.H)(o||(o=(0,d.A)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}"])))),v.code.add((0,m.H)(l||(l=(0,d.A)(["float calculateLineOffset() {\nreturn calculateLineOffsetSketch();\n}\nfloat calculateLinePressure() {\nreturn calculateLinePressureSketch();\n}"]))));break;case g.Z5.MIXED:e.varyings.add("vType","float"),i.code.add((0,m.H)(c||(c=(0,d.A)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\nvType = unpackedAttributes.type;\nif (unpackedAttributes.type <= 0.0) {\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}\n}"])))),v.code.add((0,m.H)(h||(h=(0,d.A)(["float calculateLineOffset() {\nif (vType <= 0.0) {\nreturn calculateLineOffsetSketch();\n}\nelse {\nreturn 0.0;\n}\n}\nfloat calculateLinePressure() {\nif (vType <= 0.0) {\nreturn calculateLinePressureSketch();\n}\nelse {\nreturn 1.0;\n}\n}"]))))}}},35804:(e,t,i)=>{i.d(t,{A:()=>p});var n,r,s,a,o,l=i(57528),c=i(4212),h=i(64839),d=i(66470),u=i(28014);function p(e,t){const i=e.vertex;switch(e.attributes.add(d.r.SIDENESS,"vec2"),t.mode===u.Z5.MIXED?i.code.add((0,h.H)(n||(n=(0,l.A)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\nfloat type;\n};"])))):i.code.add((0,h.H)(r||(r=(0,l.A)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\n};"])))),t.mode){case u.Z5.MIXED:i.code.add((0,h.H)(s||(s=(0,l.A)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat fType = component.type;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nif (fType <= 0.0) {\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\n}\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);\n}"]))));break;case u.Z5.SKETCH:i.code.add((0,h.H)(a||(a=(0,l.A)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))));break;case u.Z5.SOLID:i.code.add((0,h.H)(o||(o=(0,l.A)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))));break;case u.Z5.COUNT:break;default:(0,c.Xb)(t.mode)}}},42138:(e,t,i)=>{i.r(t),i.d(t,{default:()=>UC});var n=i(35143),r=i(30358),s=(i(35238),i(48053)),a=i(19276),o=i(30113),l=i(50076),c=i(79053),h=i(54901),d=i(81806),u=i(76460),p=i(30726),m=i(44892),_=i(50346),g=i(68134),f=i(52394),v=i(76931),y=i(16783),b=i(46053),w=i(21403),x=(i(47249),i(85842)),C=i(40565),T=i(91967),A=i(49140),M=i(39314);function S(e,t){const i=(0,M.oY)(e),n=(0,M.oY)(t),r=i.store,s=n.store,a=n.metadata;for(const o in a){const t=a[o],i=r.originOf(o),n=s.originOf(o);if(!t.readOnly&&n!==A.Gr.DEFAULTS)if(i===A.Gr.DEFAULTS)e.set(o,s.get(o));else{const e=r.get(o),t=s.get(o);e&&t&&t instanceof T.A&&e instanceof T.A&&e instanceof t.constructor&&S(e,t)}}}var P=i(9392),R=i(5364),E=i(91605),O=i(9624),D=i(50840),I=i(64232),L=i(2413),N=i(79650),F=i(88954),V=i(68002),H=i(31933),U=i(37248),z=i(5586),q=i(3717),G=i(51004),B=i(54099),k=i(13312),W=i(11352),Z=i(96138),j=i(54883);let Q=class extends B.A.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=j.Gm}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get extent(){const e=this.view.basemapTerrain;if(null==(null===e||void 0===e?void 0:e.extent)||null==e.spatialReference)return null;const t=(0,L.w1)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e,t;return null!==(e=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:k.A.WGS84}elevationAt(e,t){var i,n;if(null==this.extent||!(0,W.lB)(this.extent,e,t)){const i=null!=this.extent?"".concat(this.extent.xmin,", ").concat(this.extent.ymin,", ").concat(this.extent.xmax,", ").concat(this.extent.ymax):null;return u.A.getLogger(this).warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(i,")")),this.noDataValue}return null!==(i=null===(n=this.view.elevationProvider)||void 0===n?void 0:n.getElevation(e,t,0,this.spatialReference,"ground"))&&void 0!==i?i:this.noDataValue}queryElevation(e){return(0,Z.VR)(e.clone(),this)}};(0,n._)([(0,b.MZ)({readOnly:!0})],Q.prototype,"demResolution",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Q.prototype,"extent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Q.prototype,"noDataValue",void 0),(0,n._)([(0,b.MZ)()],Q.prototype,"spatialReference",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Q.prototype,"view",void 0),Q=(0,n._)([(0,x.$)("esri.views.support.GroundViewElevationSampler")],Q);const X=Q;let Y=class extends T.A{constructor(e){super(e),this.view=null,this.layerViews=new a.A}initialize(){this.addHandles((0,g.when)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e?void 0:e.ground}),(e=>e.load()))),this.addHandles(this.layerViews.on("after-changes",(()=>this._layerViewsAfterChangesHandler())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new X({view:this.view}):null:null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?(0,G.w1)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map((e=>(0,g.watch)((()=>e.updating),(()=>this._updateUpdating()),g.sync))).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};(0,n._)([(0,b.MZ)({readOnly:!0})],Y.prototype,"elevationSampler",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Y.prototype,"extent",null),(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],Y.prototype,"updating",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Y.prototype,"view",void 0),(0,n._)([(0,b.MZ)({type:a.A,readOnly:!0})],Y.prototype,"layerViews",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Y.prototype,"suspended",null),Y=(0,n._)([(0,x.$)("esri.views.GroundView")],Y);const $=Y;var K=i(5554),J=i(25348),ee=i(63580),te=i(64465);const ie=()=>Promise.all([i.e(41414),i.e(15751)]).then(i.bind(i,15751)),ne=()=>i.e(7628).then(i.bind(i,7628)),re={"base-dynamic":()=>Promise.all([i.e(10183),i.e(63431)]).then(i.bind(i,63431)),"base-elevation":ne,"base-tile":ie,"bing-maps":ie,"building-scene":()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(87200),i.e(71448),i.e(72003),i.e(44582),i.e(91446),i.e(78504),i.e(38451),i.e(27391),i.e(92764),i.e(74279),i.e(27873),i.e(18582),i.e(11967),i.e(57236),i.e(79942),i.e(8105),i.e(63479)]).then(i.bind(i,68383)),csv:()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(84922)]).then(i.bind(i,42381)),dimension:()=>i.e(65303).then(i.bind(i,65303)),elevation:ne,feature:()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(57036)]).then(i.bind(i,86427)),geojson:()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(37839)]).then(i.bind(i,75044)),graphics:()=>Promise.all([i.e(27391),i.e(25745)]).then(i.bind(i,42208)),group:()=>i.e(92339).then(i.bind(i,92339)),imagery:()=>Promise.all([i.e(10183),i.e(34209)]).then(i.bind(i,34209)),"integrated-mesh":()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(74279),i.e(27873),i.e(18582),i.e(11967),i.e(79942),i.e(57736)]).then(i.bind(i,47119)),"integrated-mesh-3dtiles":()=>i.e(99766).then(i.bind(i,99766)),"line-of-sight":()=>i.e(72925).then(i.bind(i,72925)),"map-image":()=>Promise.all([i.e(10183),i.e(41414),i.e(13230)]).then(i.bind(i,13230)),media:()=>i.e(16849).then(i.bind(i,16849)),"ogc-feature":()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(79711)]).then(i.bind(i,9358)),"open-street-map":ie,"oriented-imagery":()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(57036)]).then(i.bind(i,86427)),"point-cloud":()=>Promise.all([i.e(74279),i.e(71869),i.e(37318)]).then(i.bind(i,37318)),voxel:()=>i.e(53669).then(i.bind(i,53669)),route:()=>Promise.all([i.e(27391),i.e(18242),i.e(89875),i.e(34397)]).then(i.bind(i,86662)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(74279),i.e(27873),i.e(18582),i.e(11967),i.e(79942),i.e(50109),i.e(8105),i.e(66916)]).then(i.bind(i,28001)):Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(74279),i.e(27873),i.e(18582),i.e(11967),i.e(50109),i.e(48476)]).then(i.bind(i,48476)),stream:()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(40875),i.e(70863)]).then(i.bind(i,70863)),tile:ie,"imagery-tile":()=>Promise.all([i.e(59844),i.e(13045)]).then(i.bind(i,13045)),"vector-tile":()=>Promise.all([i.e(66167),i.e(45995),i.e(86547),i.e(37356),i.e(36302)]).then(i.bind(i,36302)),wcs:()=>Promise.all([i.e(59844),i.e(13045)]).then(i.bind(i,13045)),"web-tile":ie,wfs:()=>Promise.all([i.e(3620),i.e(67425),i.e(97216),i.e(72003),i.e(91446),i.e(27391),i.e(92764),i.e(27873),i.e(19504)]).then(i.bind(i,9495)),wms:()=>Promise.all([i.e(10183),i.e(64702)]).then(i.bind(i,64702)),wmts:()=>i.e(84412).then(i.bind(i,84412)),catalog:null,"catalog-dynamic-group":null,"catalog-footprint":null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};const se=e=>null!=re[e.type],ae=e=>{const t=re[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new l.A("".concat(i,":view-not-supported"),"".concat(t," is not supported in 3D"))}(e);return t(e)};var oe=i(98773);const le="analyses-owner-handles";var ce,he;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(ce||(ce={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(he||(he={}));let de=class extends T.A{constructor(e){super(e),this._allAnalysisViews=new a.A,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=ue(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,_.NK)("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,_.NK)()),this._attachedToViewResolver=ue()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===he.REMOVED)throw new l.A("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),le)}_disconnectOwners(){this.removeHandles(le),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const n of e)this._addAnalysis(n);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return(0,h.hA)((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:ce.PENDING,list:he.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=(0,oe.UT)((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=he.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=he.REMOVED,this._scheduleUpdate()):u.A.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,f._)((()=>this._update())))}_update(){this._scheduledUpdateHandle=(0,p.xt)(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===he.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case ce.PENDING:e.createAnalysisViewTask=(0,p.DC)(e.createAnalysisViewTask);break;case ce.CREATED:null!=e.view&&(this._allAnalysisViews.remove(e.view),e.view=(0,p.pR)(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,n=i.type,r=this._analysisModules[n];if(this._creatingViewCount+=1,null==r.module)try{r.module=await this._loadAnalysisModule(n)}catch(Te){throw this._creatingViewCount-=1,Te}if((0,_.G4)(t))throw this._creatingViewCount-=1,(0,_.NK)("AnalysisView creation aborted");const s=new r.module.default({analysis:i,view:this.view});try{await s.when()}catch(Te){throw this._creatingViewCount-=1,Te}if((0,_.G4)(t))throw this._creatingViewCount-=1,s.destroy(),(0,_.NK)("AnalysisView creation aborted");return e.view=s,e.state.view=ce.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s}_loadAnalysisModule(e){switch(e){case"area-measurement":return Promise.all([i.e(52612),i.e(87878),i.e(67868),i.e(13047)]).then(i.bind(i,50905));case"dimension":return Promise.all([i.e(52612),i.e(87878),i.e(23018),i.e(41111),i.e(43184),i.e(99469),i.e(88),i.e(75655),i.e(56878),i.e(67868),i.e(97768)]).then(i.bind(i,23218));case"direct-line-measurement":return Promise.all([i.e(52612),i.e(67868),i.e(99791)]).then(i.bind(i,22172));case"line-of-sight":return Promise.all([i.e(23018),i.e(99469),i.e(88),i.e(65553)]).then(i.bind(i,65553));case"slice":return Promise.all([i.e(87200),i.e(71448),i.e(44582),i.e(78504),i.e(38451),i.e(74279),i.e(23018),i.e(88),i.e(57236),i.e(85893),i.e(7849)]).then(i.bind(i,17141))}}};function ue(){const e=(0,_.Tw)();return e.promise.catch((()=>{})),e}(0,n._)([(0,b.MZ)()],de.prototype,"updating",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],de.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],de.prototype,"_allAnalysisViews",void 0),(0,n._)([(0,b.MZ)()],de.prototype,"_creatingViewCount",void 0),de=(0,n._)([(0,x.$)("esri.views.3d.analysis.AnalysisViewManager3D")],de);const pe=de;var me=i(69098),_e=i(15941),ge=i(14556),fe=i(94966);let ve=class extends T.A{constructor(e){super(e),this.collision=new xe,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===te.RT.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==te.RT.Local?this._set("altitude",e):u.A.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?(0,_e.qE)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,_e.qE)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===te.RT.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e,i}}_createDefaultTiltLocal(){const e=this.collision.enabled?(0,fe.su)([[4e3,be.max],[1e4,(0,_e.kU)(88)],[6e6,(0,_e.kU)(88)]]):()=>be.max;return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e(t),i}}_createDefaultTiltGlobal(){const e=this.collision.enabled?(0,fe.su)([[4e3,be.max],[5e4,(0,_e.kU)(88)],[6e6,(0,_e.kU)(88)],[2e7,be.min]]):(0,fe.su)([[3e5,be.max],[3e6,(0,_e.kU)(88)],[6e6,(0,_e.kU)(88)],[2e7,be.min]]);return function(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we;return i.min=be.min,i.max=e(t),i}}};(0,n._)([(0,b.MZ)()],ve.prototype,"altitude",null),(0,n._)([(0,b.MZ)({readOnly:!0})],ve.prototype,"collision",void 0),(0,n._)([(0,b.MZ)()],ve.prototype,"distance",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],ve.prototype,"minimumPoiDistance",void 0),(0,n._)([(0,b.MZ)()],ve.prototype,"tilt",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],ve.prototype,"mode",void 0),ve=(0,n._)([(0,x.$)("esri.views.3d.state.Constraints")],ve);const ye=function(e){return{min:-2e5,max:4*e.radius}}(ge.$O),be={min:(0,_e.kU)(.5),max:(0,_e.kU)(179.5)},we={min:0,max:0};let xe=class extends T.A{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,n._)([(0,b.MZ)({type:Boolean})],xe.prototype,"enabled",void 0),(0,n._)([(0,b.MZ)({type:Number})],xe.prototype,"elevationMargin",void 0),xe=(0,n._)([(0,x.$)("esri.views.3d.state.Constraints.CollisionConstraint")],xe);let Ce=class extends me.P{constructor(){super(...arguments),this.min=ye.min,this.max=ye.max}};(0,n._)([(0,b.MZ)({type:Number})],Ce.prototype,"min",void 0),(0,n._)([(0,b.MZ)({type:Number})],Ce.prototype,"max",void 0),Ce=(0,n._)([(0,x.$)("esri.views.3d.constraints.AltitudeConstraint")],Ce);let Te=class extends me.P{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,n._)([(0,b.MZ)({type:Number,value:1e-8})],Te.prototype,"near",null),(0,n._)([(0,w.w)("near")],Te.prototype,"castNear",null),(0,n._)([(0,b.MZ)({type:Number,value:1e-8})],Te.prototype,"far",null),(0,n._)([(0,w.w)("far")],Te.prototype,"castFar",null),(0,n._)([(0,b.MZ)({type:["auto","manual"]})],Te.prototype,"mode",void 0),Te=(0,n._)([(0,x.$)("esri.views.3d.constraints.ClipDistanceConstraint")],Te);const Ae={min:(0,_e.KJ)(be.min),max:(0,_e.KJ)(be.max)};let Me=class extends me.P{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,_e.qE)(e,Ae.min,Ae.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,n._)([(0,b.MZ)({type:["auto","manual"]})],Me.prototype,"mode",void 0),(0,n._)([(0,b.MZ)({type:Number,value:Ae.max})],Me.prototype,"max",null),(0,n._)([(0,w.w)("max")],Me.prototype,"castMax",null),Me=(0,n._)([(0,x.$)("esri.views.3d.constraints.TiltConstraint")],Me);let Se=class extends me.P{constructor(){super(...arguments),this.tilt=new Me,this.altitude=new Ce,this.clipDistance=new Te}};(0,n._)([(0,b.MZ)({type:Me})],Se.prototype,"tilt",void 0),(0,n._)([(0,b.MZ)({type:Ce})],Se.prototype,"altitude",void 0),(0,n._)([(0,b.MZ)({type:Te})],Se.prototype,"clipDistance",void 0),Se=(0,n._)([(0,x.$)("esri.views.3d.constraints.Constraints")],Se);var Pe=i(4212),Re=i(53084),Ee=i(92945),Oe=i(27816);const De={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Ee.A,virtual:Oe.A}};var Ie;let Le=Ie=class extends T.A{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new Ie({quality:this.quality})}};(0,n._)([(0,b.MZ)({type:["low","high"],value:"low"})],Le.prototype,"quality",null),Le=Ie=(0,n._)([(0,x.$)("esri.views.3d.environment.SceneViewAtmosphere")],Le);var Ne,Fe=i(41653),Ve=i(98277),He=i(99372);let Ue=Ne=class extends Fe.A{constructor(e){super(e),this.atmosphere=new Le,this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}destroy(){this.atmosphere.destroy()}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Ne({...t,lighting:t.lighting?"virtual"===t.lighting.type?Oe.A.fromWebsceneLighting(t.lighting):Ee.A.fromWebsceneLighting(t.lighting):void 0})}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles((0,h.DQ)(t)),t}_convertLighting(e){var t,i;return e?e instanceof Ee.A||e instanceof Oe.A?e:e instanceof Ve.A?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Ee.A({...e.cloneConstructProperties(),...null===(t=this.lighting)||void 0===t?void 0:t.cloneNonPersistentConstructProperties()}):e instanceof He.A?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Oe.A({...e.cloneConstructProperties(),...null===(i=this.lighting)||void 0===i?void 0:i.cloneNonPersistentConstructProperties()}):(0,C.aq)(De,e):new Ee.A}clone(){return new Ne({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Re.o8)(this.background)})}cloneWithWebsceneEnvironment(e){return new Ne({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Re.o8)(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Ee.A.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Oe.A.fromWebsceneLighting(e.lighting);default:return(0,Pe.Xb)(e.lighting),Ee.A.fromWebsceneLighting(e.lighting)}}};(0,n._)([(0,b.MZ)({type:Le,json:{read:!1},nonNullable:!0})],Ue.prototype,"atmosphere",void 0),(0,n._)([(0,b.MZ)({nonNullable:!0})],Ue.prototype,"lighting",void 0),(0,n._)([(0,w.w)("lighting")],Ue.prototype,"castLighting",null),Ue=Ne=(0,n._)([(0,x.$)("esri.views.3d.environment.SceneViewEnvironment")],Ue);const ze=Ue;var qe,Ge=i(20664),Be=i(86458),ke=i(80963),We=i(34111);!function(e){e[e.Realistic=0]="Realistic",e[e.Local=1]="Local",e[e.Mars=2]="Mars",e[e.None=3]="None"}(qe||(qe={}));var Ze=i(59784),je=i(88321),Qe=i(19555),Xe=i(43047),Ye=i(55855),$e=i(45462),Ke=i(72745),Je=i(60071),et=i(64839),tt=i(16506),it=i(42693),nt=i(32119),rt=i(28584),st=i(93345),at=i(57162);class ot extends et.Y{constructor(){super(...arguments),this.heightParameters=(0,Ye.vt)(),this.radii=(0,Ke.vt)(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=(0,Ke.vt)(),this.backgroundColor=(0,P.vt)()}}class lt extends it.w{initializeProgram(e){return new rt.B(e.rctx,lt.shader.get().build(this.configuration),nt.D)}initializePipeline(){return this.configuration.reduced?(0,at.Ey)({blending:(0,at.ox)(st.dn.ONE,st.dn.ZERO),depthTest:{func:st.MT.ALWAYS},colorWrite:at.wE}):this.configuration.haze?(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ZERO,st.dn.ONE_MINUS_SRC_COLOR,st.dn.ONE),colorWrite:at.wE}):(0,at.Ey)({blending:(0,at.ox)(st.dn.SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}lt.shader=new tt.$(Je.C,(()=>i.e(94679).then(i.bind(i,94679))));var ct=i(99415);class ht extends ct.K{constructor(){super(...arguments),this.haze=!1,this.reduced=!1}}(0,n._)([(0,ct.W)()],ht.prototype,"haze",void 0),(0,n._)([(0,ct.W)()],ht.prototype,"reduced",void 0);var dt=i(16455),ut=i(11850),pt=i(22278),mt=i(81330),_t=i(78677);class gt extends it.w{initializeProgram(e){return new rt.B(e.rctx,gt.shader.get().build(this.configuration),nt.D)}initializePipeline(){return this.configuration.haze?(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ZERO,st.dn.ONE_MINUS_SRC_COLOR,st.dn.ONE),depthTest:{func:st.MT.ALWAYS},colorWrite:at.wE}):(0,at.Ey)({blending:(0,at.ox)(st.dn.SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.MT.ALWAYS},colorWrite:at.wE})}}gt.shader=new tt.$(_t.a,(()=>i.e(12583).then(i.bind(i,12583))));var ft=i(45355);class vt{constructor(e,t){this._view=e,this._context=t,this.type=qe.Realistic,this._handles=new je.A,this._compositingPassParameters=new _t.A,this._atmosphereConfiguration=new ht,this._passParameters=new ot,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=ge.$O.radius,this._fadeHaze=0,this._updateRadius(ge.$O.radius);const i=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.rootTileElevationBounds}),(()=>{var e;return null!==(e=this._view)&&void 0!==e&&e.basemapTerrain?this._updateRootTileElevationBounds():null})),(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.visibleElevationBounds}),(()=>{var e;return null!==(e=this._view)&&void 0!==e&&e.basemapTerrain?this._updateVisibleElevationBounds():null})),(0,g.watch)((()=>{var e;return null===(e=this._view)||void 0===e?void 0:e.environment.background}),(e=>{const t=e instanceof ft.A?(0,Ze.QP)(e.color):Ye.uY;(0,Ge.s)(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),g.syncAndInitial)]);const n=new ht;n.haze=!1,this._atmosphereTechnique=this._context.techniqueRepository.acquire(lt,n),n.haze=!0,this._atmosphereHazeTechnique=this._context.techniqueRepository.acquire(lt,n),n.reduced=!0,n.haze=!1,this._atmosphereReducedTechnique=this._context.techniqueRepository.acquire(lt,n),n.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniqueRepository.acquire(lt,n),this._vao=(0,pt.Q)(i,ut.u7)}destroy(){this._handles.destroy(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,e.offscreenRenderingHelper.depthTexture,t,!1)}renderHaze(e,t,i){var n;this._fadeHaze=t,this._render(e,i?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,null===(n=e.bindParameters.linearDepth)||void 0===n?void 0:n.getTexture(),i,!0)}_render(e,t,i,n,r){if(null==i)return;const s=e.offscreenRenderingHelper;this._update(e.bindParameters.camera),this._passParameters.depthTexture=i;const a=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters);if(n)s.renderDepthDetached((()=>this._renderCommon(a,e)));else{const t=e.rctx.getViewport(),n=(0,Ge.l)(e.bindParameters.camera.eye)-ge.$O.radius;let o;if(n<$e.yv){const e=Math.min(1,Math.max(0,n/$e.yv));o=r?(0,_e.Cc)(.4,.5,e):(0,_e.Cc)(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(n-$e.yv)/(15*$e.yv)));o=r?(0,_e.Cc)(.5,1,e):(0,_e.Cc)(.3,.6,e)}const l=(0,mt.Mv)(Math.round(o*e.bindParameters.camera.fullViewport[2])),c=(0,mt.Mv)(Math.round(o*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,l,c);const h=s.renderToCachedFBO(null,"chapman",(()=>this._renderCommon(a,e)),[0,0,0,1],dt.N.RGBA,null,l,c);e.rctx.setViewport(t.x,t.y,t.width,t.height),this._compositingPassParameters.color=h.getTexture(),this._compositingPassParameters.depth=i,this._atmosphereConfiguration.haze=r;const d=this._context.techniqueRepository.acquire(gt,this._atmosphereConfiguration);e.rctx.bindTechnique(d,e.bindParameters,this._compositingPassParameters),s.renderDepthDetached((()=>e.rctx.screen.draw())),d.release(),h.release()}}_renderCommon(e,t){null!=this._vao&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(st.WR.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=ge.$O.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(ge.$O.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,(0,Qe.hZ)(this._passParameters.radii,e,e+$e.yv),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-$e.UP)*$e.UP)}_update(e){if(!e)return;const t=(0,Ge.p)(e.eye),i=Math.sqrt(t),n=t-this._passParameters.radii[1]*this._passParameters.radii[1],r=(0,_e.qE)((i-this._passParameters.radii[0])/$e.yv,0,1);(0,Xe.s)(this._passParameters.heightParameters,i,t,n,r),this._passParameters.altitudeFade=(0,$e.GF)(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=(0,_e.Cc)((0,_e.Cc)(.6,1,(0,_e.TF)(9500,10500,i-ge.$O.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}var yt=i(2565);class bt extends it.w{constructor(e){super(e,new ct.K,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,bt.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ZERO,st.dn.SRC_ALPHA,st.dn.ONE),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}bt.shader=new tt.$(yt.C,(()=>i.e(86037).then(i.bind(i,86037))));let wt=class extends T.A{constructor(e){super(e),this._technique=new bt(e),this._vao=(0,pt.Q)(e.rctx)}destroy(){this._technique=(0,p.Gz)(this._technique),this._vao=(0,p.WD)(this._vao)}render(e){if(!this._technique.compiled)return void this.requestRender();const t=e.bindParameters.cloudsFade;if(null==this._vao||null==t.data)return;const i=e.rctx.bindTechnique(this._technique,e.bindParameters,xt);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(st.WR.TRIANGLE_STRIP,0,4)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],wt.prototype,"rctx",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wt.prototype,"viewingMode",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wt.prototype,"planetRadius",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wt.prototype,"requestRender",void 0),wt=(0,n._)([(0,x.$)("esri.views.3d.environment.CloudsComposition")],wt);const xt=new et.Y;var Ct=i(49753),Tt=i(63919),At=i(34761),Mt=i(13191),St=i(83755),Pt=i(16619),Rt=i(63401),Et=i(46141);class Ot extends it.w{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,Ot.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.ox)(st.dn.CONSTANT_COLOR,st.dn.ONE_MINUS_CONSTANT_COLOR,st.Tb.ADD,this.configuration.writeTextureChannels===Ct.c.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}Ot.shader=new tt.$(Pt.a,(()=>i.e(96603).then(i.bind(i,96603))));var Dt=i(60645),It=i(80573),Lt=i(39033),Nt=i(89426);class Ft extends it.w{initializeProgram(e){return new rt.B(e.rctx,Ft.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:this.configuration.mode===Lt.L.Full?(0,at.ox)(st.dn.ONE,st.dn.ZERO):(0,at.p3)(st.dn.ZERO,st.dn.ONE,st.dn.ONE,st.dn.ZERO),depthTest:{func:st.MT.ALWAYS},colorWrite:at.wE})}}Ft.shader=new tt.$(It.a,(()=>i.e(12205).then(i.bind(i,12205))));var Vt=i(12331),Ht=i(96673);let Ut=class extends T.A{constructor(e){super(e),this._needsRender=!0,this._passParameters=new It.N,this._fbo=new Vt.H(e.context.renderContext.rctx,new Ht.R(Nt.jj)),this._vao=(0,pt.Q)(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return null!=this._texture?null!=this._weatherMapTechnique&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Lt.L.WeatherMap)):null!=this._fullTechnique&&this._fullTechnique.compiled&&(this._texture=this._render(Lt.L.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||((0,Qe.C)(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=(0,p.Gz)(this._fullTechniqueCached),this._weatherMapTechniqueCached=(0,p.Gz)(this._weatherMapTechniqueCached),this._fbo=(0,p.WD)(this._fbo),this._vao=(0,p.WD)(this._vao)}get _fullTechnique(){if(null==this._fullTechniqueCached){const e=new Lt.F;e.mode=Lt.L.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Ft,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(null==this._weatherMapTechniqueCached){const e=new Lt.F;e.mode=Lt.L.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Ft,e)}return this._weatherMapTechniqueCached}_render(e){if(null==this._vao||null==this._fbo)return null;const t=e===Lt.L.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,n=i.getViewport();i.setViewport(0,0,Nt.jj,Nt.jj),i.bindFramebuffer(this._fbo);const r=i.bindTechnique(t,null,this._passParameters);return i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(n.x,n.y,n.width,n.height),this._needsRender=!1,this._fbo.colorTexture}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ut.prototype,"context",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ut.prototype,"_techniqueRepository",null),Ut=(0,n._)([(0,x.$)("esri.views.3d.environment.NoiseTextureAtlas")],Ut);var zt=i(10209),qt=i(59752),Gt=i(22856);let Bt=class extends T.A{constructor(e){super(e),this._techniques=new Array,this._techniqueConfiguration=new Dt.H,this._bindParameters=new zt.k(null,null),this._passParameters=new Pt.C,this._weatherTile=(0,Ke.vt)(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=(0,_e.Cc)(Et.n.default.coverage[0],Et.n.default.coverage[1],.5),this.density=(0,_e.Cc)(Et.n.default.density[0],Et.n.default.density[1],.5),this.absorption=(0,_e.Cc)(Et.n.default.absorption[0],Et.n.default.absorption[1],.5),this.cloudSize=(0,_e.Cc)(Et.n.default.cloudSize[0],Et.n.default.cloudSize[1],.5),this.detailSize=(0,_e.Cc)(Et.n.default.detailSize[0],Et.n.default.detailSize[1],.5),this.smoothness=(0,_e.Cc)(Et.n.default.smoothness[0],Et.n.default.smoothness[1],.5),this.cloudHeight=(0,_e.Cc)(Et.n.default.cloudHeight[0],Et.n.default.cloudHeight[1],.5),this.raymarchingSteps=Et.n.default.raymarchingSteps,this._viewMatrix=(0,Mt.vt)(),this._dirty=!1,this.running=!1,this._vao=(0,pt.Q)(e.context.renderContext.rctx)}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=t===Ct.c.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[i]=new Ot({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null==e||null==t)return;(0,Qe.hZ)(this._weatherTile,(e+90)/180,(t+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let n=0,r=0;if(null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date){var s;const e=new Date(this.view.environment.lighting.date);e.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(null!==(s=this.view.environment.lighting.displayUTCOffset)&&void 0!==s?s:0)),n=31*e.getUTCMonth()+e.getUTCDate(),r=e.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+n)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+r%100)%(4*this._weatherTileCount),(0,Qe.aI)(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=(0,We.tO)(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask(qt.W6.CLOUDS_GENERATOR,this),(0,g.watch)((()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps]),(()=>this.setDirty()),g.initial)])}destroy(){this._techniques.forEach((e=>(0,p.Gz)(e))),this._frameBufferCube=(0,p.WD)(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=(0,p.pR)(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case Dt.p.SIXTEEN:return 1;case Dt.p.HUNDRED:return 4;case Dt.p.COUNT:case Dt.p.TWOHUNDRED:return 8}}get usedMemory(){var e,t,i,n;return(null!==(e=null===(t=this._frameBufferCube)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(i=null===(n=this._passParameters.noiseTexture)||void 0===n||null===(n=n.textureAtlas)||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0)}_ensureNoiseTexture(){if(null!=this._passParameters.noiseTexture)this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new Ut({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return null!=this._passParameters.noiseTexture.textureAtlas}_ensureFrameBufferCube(e){if(null==this._frameBufferCube){const t=new Ht.R(e);t.target=st.Ap.TEXTURE_CUBE_MAP,t.wrapMode=st.pF.CLAMP_TO_EDGE,this._frameBufferCube=new Vt.H(this.context.renderContext.rctx,t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=(0,p.WD)(this._frameBufferCube)}applyPreset(e,t){const i=e.median,n=e=>{const n=(0,_e.Cc)(e[0],e[1],i);return t<.5?(0,_e.Cc)(e[0],n,2*t):(0,_e.Cc)(n,e[1],2*(t-.5))};this.coverage=n(e.coverage),this.density=n(e.density),this.absorption=n(e.absorption),this.cloudSize=n(e.cloudSize),this.detailSize=n(e.detailSize),this.smoothness=n(e.smoothness),this.cloudHeight=n(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),(0,Qe.C)(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return Gt.G;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===Rt.OQ.CROSS_FADE||!this._ensureNoiseTexture())return Gt.G;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Ct.c2.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=kt[this._faceIndex],n=Wt[this._faceIndex];(0,At.xI)(this._viewMatrix,Zt,i,n),(0,Tt.z0)(this._passParameters.viewMatrix,this._viewMatrix);const r=this.context.renderContext.rctx,s=r.bindTechnique(t,this._bindParameters,this._passParameters);r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const a=r.getViewport(),o=t.configuration.cubeMapSize,l=o/this._tilesPerFace,c=this._tileIndex*l;r.setViewport(0,c,o,l);const h=this._ensureFrameBufferCube(o);r.bindFramebuffer(h);const d=st.Ap.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return h.setColorTextureTarget(d),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush(),r.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Ct.c2.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Gt.G}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Bt.prototype,"context",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Bt.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Bt.prototype,"requestRender",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"coverage",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"density",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"absorption",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"cloudSize",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"detailSize",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"smoothness",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"cloudHeight",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"raymarchingSteps",void 0),(0,n._)([(0,b.MZ)()],Bt.prototype,"running",void 0),Bt=(0,n._)([(0,x.$)("esri.views.3d.environment.CloudsGenerator")],Bt);const kt=[(0,St.fA)(1,0,0),(0,St.fA)(-1,0,0),(0,St.fA)(0,1,0),(0,St.fA)(0,-1,0),(0,St.fA)(0,0,1)],Wt=[(0,St.fA)(0,1,0),(0,St.fA)(0,1,0),(0,St.fA)(0,0,-1),(0,St.fA)(0,0,1),(0,St.fA)(0,1,0)],Zt=(0,St.Ul)();var jt=i(48761);class Qt extends it.w{constructor(e){super(e,new ct.K,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,Qt.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ZERO,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE),colorWrite:at.wE})}}Qt.shader=new tt.$(jt.a,(()=>i.e(71625).then(i.bind(i,71625))));var Xt=i(53203);let Yt=class extends T.A{constructor(e){super(e),this._passParameters=new jt.F;const t=e.context.renderContext.rctx;this._vao=(0,pt.Q)(t,ut.u7),this._technique=new Qt(e);const i=(0,We.tO)(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+$e.yv}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const n=e.offscreenRenderingHelper;n.renderDepthDetached((()=>{this._passParameters.depthTexture=n.depthTexture;const t=e.rctx.bindTechnique(i,e.bindParameters,this._passParameters);this._renderFog(t,e)}))}_renderFog(e,t){const i=t.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(st.WR.TRIANGLE_STRIP,0,4)}_update(e,t){const i=e.bindParameters.camera;(0,Ge.n)(Kt,i.eye);const n=Math.max(0,(0,Ge.k)(Kt,e.bindParameters.lighting.mainLight.direction)),r=t.color;(0,Ge.h)(Jt,r,.1),(0,Ge.m)(this._passParameters.fogColor,Jt,r,n);const s=(0,Ge.l)(i.eye),a=s*s;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-(0,_e.TF)(.95*Xt.ni,1*Xt.ni,Math.abs(s-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Yt.prototype,"context",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Yt.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Yt.prototype,"rctx",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Yt.prototype,"viewingMode",void 0),Yt=(0,n._)([(0,x.$)("esri.views.3d.environment.Fog")],Yt);class $t{constructor(){this.color=(0,P.vt)(),this.strength=0,this.amount=0}}const Kt=(0,P.vt)(),Jt=(0,P.vt)();var ei=i(76955),ti=i(99650);class ii extends it.w{initializeProgram(e){return new rt.B(e.rctx,ii.shader.get().build(this.configuration),nt.D)}initializePipeline(){return this.configuration.geometry===ti.d.Cylinder?(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),culling:at.PI,depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE}):(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}ii.shader=new tt.$(ei.a,(()=>i.e(79435).then(i.bind(i,79435))));const ni=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var ri=i(57481),si=i(48549),ai=i(62577),oi=i(69008),li=i(66470),ci=i(76718),hi=i(98433),di=i(27207);class ui{constructor(e,t){this.type=qe.Local,this._configuration=new ti.$,this._passParameters=new ei.S,this._configuration.geometry=ti.d.Cylinder,this._technique=t.techniqueRepository.acquire(ii,this._configuration);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=(0,di.mT)(this._vao,"geometry");const n=new Ht.R;n.wrapMode=st.pF.CLAMP_TO_EDGE,n.flipped=!0,n.width=1,n.height=512,this._passParameters.texture=new hi.g(i,n,ni)}destroy(){this._passParameters.texture=(0,p.WD)(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);(function(e,t){(0,At.C)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1})(pi,e.bindParameters.camera.viewMatrix),i.setUniformMatrix4fv("view",pi),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(st.WR.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=(0,ai.Y6)(1,2,!1),{data:i,indices:n}=t[0][1],r=mi.createBuffer(n.length),s=r.position;for(let a=0;a<n.length;++a){const e=3*n[a%3==0?a+2:a%3==2?a-2:a];s.set(a,0,i[e]),s.set(a,1,i[e+1]),s.set(a,2,i[e+2])}return new oi.Z(e,nt.D,{geometry:(0,ri.U)(mi)},{geometry:ci.g.createVertex(e,st._U.STATIC_DRAW,r.buffer)})}}const pi=(0,Mt.vt)(),mi=(0,si.BP)().vec3f(li.r.POSITION);var _i=i(75002);const gi=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);var fi=i(86994);const vi=128,yi=-$e.UP,bi=(0,fe.su)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class wi{constructor(e,t){this.view=e,this.type=qe.Mars,this._passParameters=new ei.S,this._vaoCount=0,this._texV1=1;const i=(0,We.tO)(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+yi)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=t.techniqueRepository;const n=t.renderContext.rctx;this._cameraChangeHandle=(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>t.requestRender()),g.syncAndInitial),this._vao=this._createRibbon(n),this._vaoCount=(0,di.mT)(this._vao,"geometry"),this._fadeVao=(0,pt.Q)(n),this._fadeVaoCount=(0,di.mT)(this._fadeVao,"geometry");const r=new Ht.R;r.wrapMode=st.pF.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new hi.g(n,r,gi);const s=new ti.$;s.geometry=ti.d.Cone,this._coneTechnique=this._techniqueRepository.acquire(ii,s),s.geometry=ti.d.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(ii,s)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=(0,p.WD)(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(st.WR.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(st.WR.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=(0,P.vt)(),i=this._planetRadius,n=(0,Ge.l)(e.eye),r=n-i;if(r<0){const e=Math.min(-r/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const s=Math.max(50,r),a=i+yi;this._passParameters.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+s,i,a)-1,this._passParameters.altitudeFade=(0,$e.GF)(r),(0,Ge.h)(t,e.eye,(i+50)/n),xi(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=1-511/512,c=bi(r);let h=this._texV0+l*this._texVScale,d=this._texV0+o*c*this._texVScale;if(r>50){xi(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),n=(0,_e.qE)((t-1.5)/(o-1.5),0,1);h=this._texV0+n*l*this._texVScale,d=this._texV0+(0,_e.Cc)(this._texV1,o*c,n)*this._texVScale}(0,Qe.hZ)(this._passParameters.texV,h,d)}_createRibbon(e){const t=(0,_i.oe)(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let s=0;s<vi;s++){const e=9*s+3;t[e]=s,t[e+1]=this._innerRimFactor,t[e+2]=-1,t[e+3]=s,t[e+4]=this._middleRimFactor,t[e+5]=0,t[e+6]=s,t[e+7]=this._outerRimFactor,t[e+8]=1;const n=3*s+1,r=127===s?1:n+3,a=15*s;i[a]=n,i[a+1]=n+1,i[a+2]=r+1,i[a+3]=r+1,i[a+4]=r,i[a+5]=n,i[a+6]=n+1,i[a+7]=n+2,i[a+8]=r+2,i[a+9]=r+2,i[a+10]=r+1,i[a+11]=n+1,i[a+12]=n,i[a+13]=r,i[a+14]=0}const n=Mi.createBuffer(i.length),r=n.position;for(let s=0;s<i.length;++s){const e=3*i[s];r.set(s,0,t[e]),r.set(s,1,t[e+1]),r.set(s,2,t[e+2])}return new oi.Z(e,nt.D,{geometry:(0,ri.U)(Mi)},{geometry:ci.g.createVertex(e,st._U.STATIC_DRAW,n.buffer)})}_computeScreenRimWidth(e,t,i,n){return(0,Ge.g)(Ti,n.center,n.v2),(0,Ge.h)(Ai,Ti,this._outerRimFactor),(0,At.t5)(Ci,t,Ti,i),(0,fi.Cv)(Ti,Ci,e.projectionMatrix,e.viewport,Ti),(0,fi.Cv)(Ai,Ci,e.projectionMatrix,e.viewport,Ai),(0,Ge.q)(Ti,Ai)/e.height}}function xi(e,t,i,n,r){const s=(0,Ge.l)(e),a=n*Math.sqrt(s*s-n*n)/s,o=Math.sqrt(n*n-a*a),l=r.v1,c=r.v2;return(0,Ge.h)(r.center,e,o/s),(0,Ge.b)(l,e,t),(0,Ge.p)(l)<1&&(0,Ge.b)(l,e,i),(0,Ge.h)(l,l,a/(0,Ge.l)(l)),(0,Ge.b)(c,l,e),(0,Ge.h)(c,c,a/(0,Ge.l)(c)),a}const Ci=(0,Mt.vt)(),Ti=(0,P.vt)(),Ai=(0,P.vt)();const Mi=(0,si.BP)().vec3f(li.r.POSITION);var Si=i(91417),Pi=i(19451),Ri=i(28080);class Ei extends et.Y{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}}class Oi extends it.w{initializeProgram(e){return new rt.B(e.rctx,Oi.shader.get().build(this.configuration),Di)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}Oi.shader=new tt.$(Ri.P,(()=>i.e(79104).then(i.bind(i,79104))));const Di=new Map([[li.r.POSITION,0],[li.r.INSTANCEFEATUREATTRIBUTE,1]]);var Ii=i(90376),Li=i(72085);let Ni=class extends T.A{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new Ei,this._animation=new Li.a,this._updatingTracking=new Pi.U,this._passParameters.time=0,this._passParameters.radius=(0,We.tO)(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=(0,p.Gz)(this._snowTechniqueCached),this._rainTechniqueCached=(0,p.Gz)(this._rainTechniqueCached),this._vao=(0,p.WD)(this._vao),this._instanceIdBuffer=(0,p.WD)(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(null==this._rainTechniqueCached){const e=new Ii.a;e.type=Ii.C.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(Oi,e)}return this._rainTechniqueCached}get _snowTechnique(){if(null==this._snowTechniqueCached){const e=new Ii.a;e.type=Ii.C.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(Oi,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,i){const n="rainy"===i?this._rainTechnique:this._snowTechnique;if(!n.compiled)return void this.context.requestRender();const r=e.rctx;if(this._ensureResources(r),null==n||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0)return;t=t<.5?(0,_e.Cc)(0,.35,2*t):(0,_e.Cc)(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*(0,Si.y)(this._animation.time)%1e5;const s=r.bindTechnique(n,e.bindParameters,this._passParameters);r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),(0,di.yu)(r,Di,this._instanceIdBuffer,Vi,0),r.drawArraysInstanced(st.WR.TRIANGLES,0,3,this._numParticles*t),(0,di.Hi)(r,Di,this._instanceIdBuffer,Vi)}_ensureResources(e){null==this._vao&&(this._vao=this._createVertexArrayObject(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return ci.g.createVertex(e,st._U.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new oi.Z(e,Di,{geometry:(0,ri.U)(Fi)},{geometry:ci.g.createVertex(e,st._U.STATIC_DRAW,t)})}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ni.prototype,"context",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ni.prototype,"view",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ni.prototype,"updating",null),(0,n._)([(0,b.MZ)()],Ni.prototype,"_updatingTracking",void 0),Ni=(0,n._)([(0,x.$)("esri.views.3d.environment.Precipitation")],Ni);const Fi=(0,si.BP)().vec3f(li.r.POSITION),Vi=(0,ri.U)((0,si.BP)().f32(li.r.INSTANCEFEATUREATTRIBUTE),1);var Hi=i(28899),Ui=i(21594);class zi extends et.Y{constructor(){super(...arguments),this.modelMatrix=(0,Mt.vt)()}}class qi extends it.w{constructor(e){super(e,new ct.K,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,qi.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}qi.shader=new tt.$(Ui.S,(()=>i.e(66922).then(i.bind(i,66922))));let Gi=class extends T.A{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return null!=this._loadDataTask&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._passParameters=new zi,this._updatingTracking=new Pi.U}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=(0,p.DC)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,p.Gz)(this._technique),this._vao=(0,p.WD)(this._vao),Qi=null}render(e){const{rctx:t}=e;if(this._ensureResources(t),null==this._technique||null==this._vao)return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(st.WR.POINTS,0,this._numPoints)}_ensureResources(e){if(null!=this._technique||null==Qi)return;this._technique=new qi({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Qi.byteLength/Zi;const t=new Float32Array(Qi,0,2*this._numPoints),i=new Uint8Array(Qi,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(e=>this._update(e)),g.initial)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),n=(0,At.C)(this._passParameters.modelMatrix,Wi);(0,At.Qr)(n,n,-i*Math.PI),(0,At.lw)(n,ki,n),(0,At.Qr)(n,n,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,n){const r=ji.createBuffer(n),s=r.position,a=r.color,o=r.size;for(let l=0;l<n;l++){const e=t[2*l],n=t[2*l+1];s.set(l,0,-Math.cos(e)*Math.sin(n)),s.set(l,1,-Math.sin(e)*Math.sin(n)),s.set(l,2,-Math.cos(n));const r=this._unpackUint8Attributes(i[l]),c=this._hexToRGB(Bi[r[1]]);a.set(l,0,255*c[0]),a.set(l,1,255*c[1]),a.set(l,2,255*c[2]),a.set(l,3,255),o.set(l,r[0])}return new oi.Z(e,nt.D,{geometry:(0,ri.U)(ji)},{geometry:ci.g.createVertex(e,st._U.STATIC_DRAW,r.buffer)})}_createLoadDataTask(){if(null!=Qi)return null;const e=(0,oe.UT)((async e=>{const{data:t}=await(0,Hi.N)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),Qi=t}));return e.promise.catch((e=>{(0,_.zf)(e)||u.A.getLogger(this).error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new l.A("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Zi;if(t%1!=0||t>5e4||t<5e3)throw new l.A("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Gi.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Gi.prototype,"requestRender",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Gi.prototype,"updating",null),(0,n._)([(0,b.MZ)()],Gi.prototype,"_loadDataTask",void 0),(0,n._)([(0,b.MZ)()],Gi.prototype,"_updatingTracking",void 0),Gi=(0,n._)([(0,x.$)("esri.views.3d.environment.Stars")],Gi);const Bi=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],ki=(0,Mt.fA)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Wi=(0,Mt.fA)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Zi=9,ji=(0,si.BP)().vec3f(li.r.POSITION).vec4u8(li.r.COLOR).f32(li.r.SIZE);let Qi=null;var Xi,Yi,$i=i(38205),Ki=i(77730);!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(Xi||(Xi={}));let Ji=Yi=class extends $i.RW{constructor(e){super(e),this.produces=new Map([[Ki.N.ENVIRONMENT_OPAQUE,()=>!(null===this._atmosphere&&null===this._stars)],[Ki.N.ENVIRONMENT_TRANSPARENT,()=>!(null===this._atmosphere)]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new en,this._newWeatherParameters=new en,this._fadedWeatherParameters=new en,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var e;this.removeHandles(),this.uninitializeRenderContext(),null!=(null===(e=this.view)||void 0===e?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return null!=this.atmosphere?this.atmosphere.type:qe.None}consumes(){return this._atmosphereType===qe.Realistic?$i.B7:$i.qo}updateAnimation(e){return null!=this._precipitation&&this._precipitation.update(e)}get updating(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}get weatherVisible(){return(0,Ge.l)(this.view.state.camera.eye)-(0,We.tO)(this.view.spatialReference).radius<=Xt.ni}get usedMemory(){var e,t;return null!==(e=null===(t=this._clouds)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}get _stars(){var e,t;const i=this.view,n=null!==(e=null===(t=i.environment)||void 0===t?void 0:t.starsEnabled)&&void 0!==e&&e,r=this._get("_stars");return n&&null!=this._context?null!=r?r:new Gi({view:i,requestRender:()=>this._setNeedsRender()}):((0,p.pR)(r),null)}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return(0,p.pR)(e),null;const t=this.view,i=this._context;return null!=e&&e.context===i?e:((0,p.pR)(e),new Ni({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return(0,p.pR)(e),null;if(null!=e)return e;const t=this.view,i=this._context;return(0,p.pR)(e),new Bt({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return(0,p.pR)(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,n=(0,We.tO)(this.view.spatialReference).radius;return null!=e&&e.viewingMode===t&&e.planetRadius===n?e:((0,p.pR)(e),new wt({rctx:i,viewingMode:t,planetRadius:n,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return(0,p.pR)(e),null;if(null!=e)return e;const t=this.view,i=this._context,n=this._context.renderContext.rctx,r=this.view.state.viewingMode;return new Yt({context:i,view:t,rctx:n,viewingMode:r})}get weatherEnabled(){var e;return!(null===(e=this.view)||void 0===e||null===(e=e.environmentManager)||void 0===e||!e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._context=e;const t=()=>this._setNeedsRender();this.addHandles([(0,g.watch)((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled})),(e=>this._updateAtmosphere(e)),g.syncAndInitial),(0,g.watch)((()=>this._stars),t),(0,g.watch)((()=>this._precipitation),t),(0,g.watch)((()=>this._clouds),(()=>this._updateWeather()),g.initial),(0,g.watch)((()=>this._fog),(()=>this._updateFogHaze()),g.initial),(0,g.watch)((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),g.sync),(0,g.watch)((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),g.syncAndInitial)])}uninitializeRenderContext(){this._context=null,this._atmosphere=(0,p.pR)(this._atmosphere),this._set("_stars",(0,p.pR)(this._stars)),this._set("_precipitation",(0,p.pR)(this._precipitation)),this._set("_clouds",(0,p.pR)(this._clouds)),this._set("_cloudsComposition",(0,p.pR)(this._cloudsComposition)),this._set("_fog",(0,p.pR)(this._fog))}prepareRender(e){var t;e.bindParameters.cloudsFade.data=(0,Ct.q9)(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=(null===(t=e.bindParameters.cloudsFade.data)||void 0===t?void 0:t.cubeMap)&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===Ct.c2.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}renderNode(e){var t,i,n;switch(e.bindParameters.slot){case Ki.N.ENVIRONMENT_OPAQUE:null!=this._stars&&this._stars.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,null===(t=this.view)||void 0===t||null===(t=t._stage)||void 0===t||null===(t=t.renderer)||void 0===t?void 0:t.fullResolutionAtmosphere),null!=this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&null!=this._context&&null!=(null===(i=e.bindParameters.cloudsFade.data)||void 0===i?void 0:i.cubeMap)&&this._context.requestRender());break;case Ki.N.ENVIRONMENT_TRANSPARENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,null===(n=this.view)||void 0===n||null===(n=n._stage)||void 0===n||null===(n=n.renderer)||void 0===n?void 0:n.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}updateLightSources(e,t,i,n){if(null!=this._context){const r=this._context.renderContext;r.bindParameters.oldLighting.copyFrom(r.bindParameters.lighting),r.bindParameters.newLighting.noonFactor=t,r.bindParameters.newLighting.globalFactor=i,r.bindParameters.newLighting.set(e),n===Xi.Faded||r.bindParameters.weatherFading?r.bindParameters.fadeLighting(0):r.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeatherFading(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(this._updateLighting(e),this._updateFogAtmoshpere(e))}_updateLighting(e){e.cloudsFade.fadeMode!==Rt.OQ.CROSS_FADE&&e.cloudsFade.fadeMode!==Rt.OQ.FADE_IN?e.fadeLighting(0):e.fadeLighting(e.cloudsFade.fadeFactor)}_updateFogAtmoshpere(e){e.cloudsFade.fadeMode!==Rt.OQ.CROSS_FADE&&e.cloudsFade.fadeMode!==Rt.OQ.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:i}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(i,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(Et.n[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){null!=this._context&&this._context.requestRender()}_updateFogHaze(){var e,t;const i=this._weatherUpdateParameters;if(null==this._fog||null==i||null==this._context)return;const n=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),i.type){case"foggy":this._newWeatherParameters.fog.strength=(0,_e.Cc)(3e-5,.005,i.weatherAdjustment**3),(0,Ge.c)(this._newWeatherParameters.fog.color,nn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=(0,_e.Cc)(4e-6,2e-4,(null!==(e=i.effect)&&void 0!==e?e:0)**3),(0,Ge.c)(this._newWeatherParameters.fog.color,tn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=(0,_e.Cc)(4e-6,2e-4,(null!==(t=i.effect)&&void 0!==t?t:0)**3),(0,Ge.c)(this._newWeatherParameters.fog.color,nn),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}n.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(t!==qe.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=(0,p.pR)(this._atmosphere);const e=this._getAtmosphereClass(t);e&&(this._atmosphere=new e(this.view,this._context))}}else this._atmosphere=(0,p.pR)(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(e){switch(e){case qe.Realistic:return vt;case qe.Local:return ui;case qe.Mars:return wi;default:case qe.None:return null}}_selectAtmosphereType(e){const{enabled:t,viewingMode:i}=e;return!t||(0,ke.KQ)(this.view.spatialReference)?qe.None:i===te.RT.Local?qe.Local:null!=this._context&&vt.isSupported(this._context)&&(0,ke.B3)(this.view.spatialReference)?qe.Realistic:(0,ke.q8)(this.view.spatialReference)?qe.Mars:qe.None}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:e=>{rn=Yi.prototype._getAtmosphereClass,Yi.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{Yi.prototype._getAtmosphereClass=rn}}}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ji.prototype,"view",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"atmosphere",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_atmosphereType",null),(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],Ji.prototype,"updating",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"weatherVisible",null),(0,n._)([(0,b.MZ)()],Ji.prototype,"_context",void 0),(0,n._)([(0,b.MZ)()],Ji.prototype,"_atmosphere",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_stars",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_precipitation",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_clouds",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_cloudsComposition",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_fog",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"weatherEnabled",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_precipitationEnabled",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ji.prototype,"_weatherUpdateParameters",null),Ji=Yi=(0,n._)([(0,x.$)("esri.views.3d.environment.EnvironmentRenderer")],Ji);class en{constructor(){this.fog=new $t,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,(0,Ge.c)(this.fog.color,e.fog.color)}lerp(e,t,i){this.fog.amount=(0,_e.Cc)(e.fog.amount,t.fog.amount,i),this.hazeAmount=(0,_e.Cc)(e.hazeAmount,t.hazeAmount,i),this.fog.strength=(0,_e.Cc)(e.fog.strength,t.fog.strength,i),(0,Ge.m)(this.fog.color,e.fog.color,t.fog.color,i)}}const tn=(0,P.fA)(.5,.5,.5),nn=(0,P.fA)(1.5,1.5,1.5);let rn;var sn=i(3136),an=i(30338),on=i(71011);let ln=class extends B.A.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandlesKey="viewHandles",this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new on.Qx,this._ambientLight=new on.$p,this._moonLight=new on._y,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&(null===(e=this._renderer)||void 0===e||!e.updating))}get weatherEnabled(){var e,t;return(null===(e=this._view)||void 0===e?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&(null===(t=this._view)||void 0===t||null===(t=t.state)||void 0===t?void 0:t.viewingMode)===te.RT.Global&&(0,ke.B3)(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&(null===(e=this._renderer)||void 0===e?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Ji({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([(0,g.watch)((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),g.sync),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),g.sync),(0,g.watch)((()=>e.stationary),(()=>this._interactingStationaryHandler())),(0,g.watch)((()=>e.environment.lighting.directShadowsEnabled),t,g.sync),(0,g.watch)((()=>e.qualitySettings.ambientOcclusion),t,g.sync),(0,g.watch)((()=>e.qualitySettings.reflections),t,g.sync),(0,g.watch)((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),g.sync),(0,g.watch)((()=>e.environment.weather.type),(()=>this._updateLighting(null,Xi.Faded)),g.sync),(0,g.watch)((()=>this.weatherEnabled),(()=>this._updateLighting(null,Xi.Faded)),g.sync),(0,g.watch)((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),g.syncAndInitial),(0,g.watch)((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),g.syncAndInitial),(0,g.watch)((()=>e.state.camera),i,g.syncAndInitial),(0,g.watch)((()=>this.disableQueries),i)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,p.pR)(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==(null===e||void 0===e?void 0:e.type)&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==(null===t||void 0===t?void 0:t.type)){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!(0,O.canProjectToWGS84ComparableLonLat)(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),null!=this._referencePosWGS84Comparable){const e=(0,sn.aE)(this._referencePosWGS84Comparable,un);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){var i,n,r;const s=(0,ke.B3)(this._view.spatialReference);if(s&&!(0,O.canProjectToWGS84ComparableLonLat)(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;const a=e.position;return null==this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable=(0,P.vt)()),s?(0,Be.W)(a,this._referencePosWGS84Comparable):(0,Ge.s)(this._referencePosWGS84Comparable,null!==(i=a.longitude)&&void 0!==i?i:0,null!==(n=a.latitude)&&void 0!==n?n:0,null!==(r=a.z)&&void 0!==r?r:0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){var t;const i=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(i))&&this._requestReferencePositionUpdate(i,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(null!==(t=i.z)&&void 0!==t?t:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Xi.Immediate;const i=this._view;e=e||("virtual"===i.environment.lighting.type?null:i.environment.lighting.date);const n=this._referencePosWGS84Comparable,r=n?cn:hn,s=this.weatherVisible?i.environment.weather.type:"disabled";null!=n?(0,an.$8)(e,n,i.state.viewingMode,s,i.state.camera,r):"virtual"===i.environment.lighting.type&&(0,an.qI)(i.state.camera,i.state.viewingMode,r.direct.directionToLightSource);const a=this._mainLight,o=r.direct;(0,Ge.h)(a.intensity,o.color,o.intensity*Math.PI),(0,Ge.c)(a.direction,o.directionToLightSource),a.specularStrength=r.specularStrength,a.environmentStrength=r.environmentStrength;const l=this._ambientLight;(0,Ge.h)(l.intensity,r.ambient.color,r.ambient.intensity);const c=this._moonLight;(0,Ge.m)(c.intensity,pn,mn,r.globalFactor);const h=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));(0,Ge.h)(c.intensity,c.intensity,h),(0,Ge.c)(c.direction,o.directionToLightSource),this._renderer.updateLightSources([a,l,c],r.noonFactor,r.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=dn;i.setTime((t||this._view.environment.lighting.date).getTime());const n=(0,sn.aE)(e,un);if(null==n)return!1;let r=this._view.environment.lighting.positionTimezoneInfo;if(r.autoUpdated){if(r.hours===n.hours&&r.minutes===n.minutes&&r.seconds===n.seconds)return!1}else r=n;const s=i.getUTCHours()-(n.hours-r.hours),a=i.getUTCMinutes()-(n.minutes-r.minutes),o=i.getUTCSeconds()-(n.seconds-r.seconds);return i.setUTCHours(s),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,n)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=null==this._referencePosWGS84Comparable||(0,an.Md)(this._referencePosWGS84Comparable[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=(0,_.Pl)(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=(0,_.Pl)(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){var i;const e=(null!==(i=this._referencePosMapCoords.z)&&void 0!==i?i:0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],ln.prototype,"updating",null),(0,n._)([(0,b.MZ)()],ln.prototype,"disableQueries",void 0),(0,n._)([(0,b.MZ)()],ln.prototype,"_disableWeather",void 0),(0,n._)([(0,b.MZ)()],ln.prototype,"weatherEnabled",null),(0,n._)([(0,b.MZ)()],ln.prototype,"weatherVisible",null),(0,n._)([(0,b.MZ)()],ln.prototype,"referencePositionWGS84Comparable",null),(0,n._)([(0,b.MZ)()],ln.prototype,"_renderer",void 0),(0,n._)([(0,b.MZ)()],ln.prototype,"_referencePosWGS84Comparable",void 0),ln=(0,n._)([(0,x.$)("esri.views.3d.environment.SceneViewEnvironmentManager")],ln);const cn=new an.uf,hn=new an.uf,dn=new Date,un={hours:0,minutes:0,seconds:0},pn=(0,P.fA)(.22,.22,.33),mn=(0,P.fA)(.22,.22,.22);var _n,gn,fn,vn=i(93582),yn=i(95925);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(_n||(_n={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(gn||(gn={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(fn||(fn={}));class bn{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_n.ALL,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:gn.NONE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:fn.TUMBLE;this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=n,this.interactionDirection=r,this.tiltMode=s}}function wn(e,t){return 0!=(e&t)}function xn(e,t,i,n,r,s){0!==e&&(i?(s.min=Math.min(s.min,t),s.max=Math.max(s.max,t)):null!=n?(s.min-=Math.max(0,(t-s.min)*(1-n)),s.max+=Math.max(0,(t-s.max)*(1-n))):r&&(s.min-=Math.max(0,t-s.min-r),s.max+=Math.max(0,t-s.max-r)))}const Cn=new bn(_n.NONE);function Tn(e,t,i,n){return t=t||e.viewForward,(0,Ge.c)(n,t),(0,Ge.h)(n,n,Math.sign((0,Ge.k)(t,i))),n}var An=i(70335);function Mn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Cn;if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==gn.TUMBLE||!wn(t.selection,_n.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const n=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,Sn);!function(e,t,i){const n=t.interactionType;if(n===gn.NONE)return;const{min:r,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=n===gn.TUMBLE||n===gn.ZOOM,c=Mn(e,a),h=0===c?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=r,i.max=s,xn(c,h,l,o,.05*h,i)}(e,i,n);const r=e.renderCoordsHelper.getAltitude(t.eye),s=(0,_e.qE)(r,n.min,n.max)-r;return Math.abs(s)<=1e-6?0:s}const Sn={min:0,max:0},Pn=(0,P.vt)(),Rn=(0,P.vt)(),En=(0,P.vt)(),On=(0,P.vt)();function Dn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Cn;if(!e.state.isLocal)return 0;const n=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||n===1/0)return 0;Ln.min=0,Ln.max=n,function(e,t,i){const n=t.interactionType;if(n===gn.NONE)return;const{min:r,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=n===gn.ZOOM||n===gn.PAN,c=Dn(e,a),h=0===c?0:In(e,a);i.min=r,i.max=s,xn(c,h,l,o,.05*h,i)}(e,i,Ln);const r=In(e,t),s=Ln.max-r;return s>=-1e-6?0:s}function In(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?(0,Ge.q)(t.eye,i.renderLocation):0}const Ln={min:0,max:0},Nn=(0,P.vt)(),Fn=(0,P.vt)(),Vn=(0,P.vt)(),Hn=(0,P.vt)(),Un=(0,P.vt)();var zn,qn=i(84687);function Gn(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:zn.EYE;const n=e.state.constraints;if(!n.collision.enabled)return!1;const r=(0,qn.Rt)(e,t.eye),s=e.renderCoordsHelper.getAltitude(t.eye),a=r+n.collision.elevationMargin;if(s>=a)return!1;const o=(0,Ge.l)(t.eye);if((0,Ge.f)(Bn,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(kn,a,t.eye),i===zn.EYE_AND_CENTER)t.center=(0,Ge.g)(Bn,t.eye,Bn);else if(i===zn.EYE_AND_CENTER_SCALE){const e=(o-s+a)/o;t.center=(0,Ge.h)(Bn,t.center,e)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(zn||(zn={}));const Bn=(0,P.vt)(),kn=(0,P.vt)();function Wn(e,t,i){e.worldUpAtPosition(t,Zn),(0,Ge.f)(jn,i,t);const n=(0,Ge.l)(jn);return 0===n?0:(0,_e.XM)((0,Ge.k)(jn,Zn)/n)}const Zn=(0,P.vt)(),jn=(0,P.vt)();function Qn(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Cn,r=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;const s=t.distance,a=e.state.constraints.tilt(s,ir);return function(e,t,i){if(t.interactionType===gn.NONE)return;const{interactionStartCamera:n,interactionFactor:r}=t;if(!n)return;const{min:s,max:a}=i,o=Qn(e,n,Cn,t),l=0===o?0:Wn(e.renderCoordsHelper,n.center,n.eye);i.min=s,i.max=a,t.interactionType===gn.TUMBLE?(wn(t.selection,_n.ALTITUDE)&&$n(e,n,i),xn(o,l,!0,r,tr,i)):xn(o,l,!1,r,tr,i)}(e,i,a),n.interactionType===gn.TUMBLE&&wn(n.selection,_n.ALTITUDE)&&$n(e,n.interactionStartCamera,a),i.tiltMode===fn.LOOK_AROUND||n.tiltMode===fn.LOOK_AROUND?function(e,t,i,n){switch(n&&(n.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,n){const r=function(e,t,i){const n=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=n+(0,We.tO)(e.spatialReference).radius,s=e.renderCoordsHelper.intersectManifold(t.ray,n,er);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,null!=s?(i.eyeCenterDistance=(0,Ge.q)(t.eye,s),i.tiltAtCenter=Wn(e.renderCoordsHelper,s,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Wn(e.renderCoordsHelper,t.center,t.eye):((0,vn.e)((0,vn.h)(vn.t,r),t.ray,er),i.eyeCenterDistance=(0,Ge.q)(t.eye,er),i.tiltAtCenter=(0,_e.XM)(-(0,Ge.k)(t.viewForward,(0,Ge.n)(er,er)))),i.radius=r,i.eyeRadius=(0,Ge.l)(t.eye),i.constraints=e.state.constraints,i}(e,t,nr),s=(0,_e.qE)(r.tiltAtCenter,i.min,i.max);if(!Xn(r.tiltAtCenter-s))return 0;let a,o;return r.centerIsOnSurface?(a=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:n}=e;let r=n,s=t.clampTilt(i,n);const a=Yn(e,s);if(t.clampTilt(a,n)===s)return s;let o=0;for(;o<10&&Xn(s-r);){const i=(r+s)/2,n=Yn(e,i);Xn(t.clampTilt(n,i)-i)?r=i:s=i,o++}return s}(r),o=function(e,t){const i=(0,_e.YN)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),n=(0,_e.YN)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-n:n-i}(r,a)):(a=r.constraints.clampTilt(r.eyeCenterDistance,r.tiltAtCenter),n&&a<Math.PI/2&&(n.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(r,a)),n&&(n.eyeCenterDistance=Yn(r,a)),o}(e,t,i,n);case"local":return function(e,t,i,n){const r=Wn(e.renderCoordsHelper,t.center,t.eye),s=(0,_e.qE)(r,i.min,i.max),a=r-s;if(!Xn(a))return 0;if(n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.cos(s);Math.abs(a)>1e-4?n.eyeCenterDistance=r/a:n.eyeCenterDistance=t.distance}return a}(e,t,i,n)}}(e,t,a,r):function(e,t,i){const n=Wn(e.renderCoordsHelper,t.center,t.eye),r=n-(0,_e.qE)(n,i.min,i.max);return Xn(r)?r:0}(e,t,a)}function Xn(e){return Math.abs(e)>1e-9}function Yn(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-(0,_e.qE)(t,0,Math.PI),n=(0,_e.YN)(e.radius/e.eyeRadius*Math.sin(i)),r=Math.PI-i-n,s=Math.sin(r)/Math.sin(i);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-n,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return s*e.eyeRadius}function $n(e,t,i){const n=e.state.constraints;if(e.state.isLocal||!n.altitude||!t)return;const r=(0,Ge.p)(t.center),s=Math.sqrt(r),a=t.distance,o=(0,We.tO)(e.spatialReference).radius,l=n.altitude.min+o,c=n.altitude.max+o,h=(l*l-a*a-r)/(-2*s*a),d=(c*c-a*a-r)/(-2*s*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,_e.XM)(d),i.max)),i.max=Math.min(i.max,Math.PI-(0,_e.XM)(h))}const Kn=(0,P.vt)(),Jn=(0,Mt.vt)(),er=(0,P.vt)(),tr=(0,_e.kU)(5),ir={min:0,max:0},nr={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},rr={eyeCenterDistance:0,requiresTwoSteps:!1},sr=e=>e*e,ar=e=>1-sr(1-e),or=e=>e*e*e,lr=e=>1-or(1-e),cr=e=>e<.5?or(2*e)/2:(lr(2*(e-.5))+1)/2,hr=e=>e*e*e*e,dr=e=>1-hr(1-e),ur=e=>e*e*e*e*e,pr=e=>1-ur(1-e),mr=e=>1-Math.cos(e*Math.PI/2),_r=e=>1-mr(1-e),gr=e=>2**(10*(e-1)),fr=e=>1-gr(1-e),vr=e=>-(Math.sqrt(1-e*e)-1),yr=e=>1-vr(1-e);function br(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return n=>n<i?e*n*n:t*n-t+1}function wr(e,t){return(i,n)=>i<t?t*e(i/t,n):1-e((1-i)/(1-t),n)*(1-t)}const xr=wr(br(1),1),Cr=wr(br(1),0),Tr=wr(br(1),.5),Ar=wr(br(2),1),Mr=wr(br(2),0),Sr=wr(br(2),.5),Pr=wr(br(3),1),Rr=wr(br(3),0),Er=wr(br(3),.5),Or=wr(br(4),1),Dr=wr(br(4),0),Ir=wr(br(4),.5),Lr={linear:e=>e,"in-quad":sr,"out-quad":ar,"in-out-quad":e=>e<.5?sr(2*e)/2:(ar(2*(e-.5))+1)/2,"in-coast-quad":xr,"out-coast-quad":Cr,"in-out-coast-quad":Tr,"in-cubic":or,"out-cubic":lr,"in-out-cubic":cr,"in-coast-cubic":Ar,"out-coast-cubic":Mr,"in-out-coast-cubic":Sr,"in-quart":hr,"out-quart":dr,"in-out-quart":e=>e<.5?hr(2*e)/2:(dr(2*(e-.5))+1)/2,"in-coast-quart":Pr,"out-coast-quart":Rr,"in-out-coast-quart":Er,"in-quint":ur,"out-quint":pr,"in-out-quint":e=>e<.5?ur(2*e)/2:(pr(2*(e-.5))+1)/2,"in-coast-quint":Or,"out-coast-quint":Dr,"in-out-coast-quint":Ir,"in-sine":mr,"out-sine":_r,"in-out-sine":e=>e<.5?mr(2*e)/2:(_r(2*(e-.5))+1)/2,"in-expo":gr,"out-expo":fr,"in-out-expo":e=>e<.5?gr(2*e)/2:(fr(2*(e-.5))+1)/2,"in-circ":vr,"out-circ":yr,"in-out-circ":e=>e<.5?vr(2*e)/2:(yr(2*(e-.5))+1)/2};function Nr(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Hr,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;n!==t&&n.copyFrom(t),n.computeUp(e.state.viewingMode);let r=!1;for(let o=0;o<Ur;o++){let t=0;for(const s of Vr)if(wn(i.selection,s.type)){const a=Math.abs(s.error(e,n,i));s.apply(e,n,i)&&(r=!0,t+=a)}if(0===t)break}const s=wn(i.selection,_n.COLLISION),a=function(e,t){switch(e){case gn.PAN:return zn.EYE_AND_CENTER;case gn.ASCEND:return t.state.isGlobal?zn.EYE_AND_CENTER_SCALE:zn.EYE_AND_CENTER;default:return zn.EYE}}(i.interactionType,e);return s&&Gn(e,n,a)&&(r=!0),r&&n.computeUp(e.state.viewingMode),r}function Fr(e){const t=Math.min(1,e/150);return cr(t)}const Vr=[{type:_n.TILT,error:function(e,t,i){return Qn(e,t,i)*t.distance},apply:function e(t,i,n){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];rr.eyeCenterDistance=0,rr.requiresTwoSteps=!1;const s=Qn(t,i,n,Cn,rr);if(0===s)return!1;switch((0,At.$0)(Jn,-s,i.viewRight),n.tiltMode){case fn.LOOK_AROUND:(0,Ge.e)(Kn,i.viewForward,Jn),(0,Ge.h)(Kn,Kn,rr.eyeCenterDistance),i.center=(0,Ge.g)(er,i.eye,Kn);break;case fn.TUMBLE:(0,Ge.f)(Kn,i.center,i.eye),(0,Ge.e)(Kn,Kn,Jn),i.eye=(0,Ge.f)(er,i.center,Kn);break;default:(0,Pe.Xb)(n.tiltMode)}return i.up=(0,Ge.e)(er,i.up,Jn),!rr.requiresTwoSteps||!r||e(t,i,n,!1)}},{type:_n.ALTITUDE,error:Mn,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Cn;const n=Mn(e,t,i);if(0===n)return!1;const r=e.renderCoordsHelper,s=r.getAltitude(t.eye)+n,a=Tn(t,i.interactionDirection,function(e,t,i,n){return e.renderCoordsHelper.worldUpAtPosition(t.eye,n),(0,Ge.h)(n,n,i),n}(e,t,Math.sign(n),Rn),Pn),o=(0,Ge.c)(En,t.viewForward),l=r.intersectInfiniteManifold((0,yn.LV)(t.eye,a),s,On);return t.eye=null!=l?l:r.setAltitude(On,s,t.eye),t.center=(0,An.Rg)(On,t.eye,o,t.center),!0}},{type:_n.DISTANCE,error:Dn,apply:function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Cn;const n=Dn(e,t,i);if(0===n)return!1;const r=e.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const s=In(e,t)+n,a=(0,Ge.c)(Nn,t.eye),o=Tn(t,i.interactionDirection,function(e,t,i){return(0,Ge.E)(i,e.eye,t)}(t,r.renderLocation,Hn),Vn);if(!(0,vn.i)((0,vn.k)(r.renderLocation,s),(0,yn.LV)(t.eye,o),Un))return!1;t.eye=Un;const l=(0,Ge.f)(Fn,t.eye,a);t.center=(0,Ge.g)(Un,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,Un);return null!=h&&(t.center=h),!0}}],Hr=new bn,Ur=5;var zr=i(44680);class qr{constructor(e){this.viewingMode=e,this.center=(0,P.vt)(),this.pitch=0,this.yaw=0,this.distance=0,this.direction=(0,P.o8)(Xr),this.fov=55,this.size=1}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===te.RT.Global){const i=((0,Ge.l)(this.center)+(0,Ge.l)(e.center))/2;t.pan=(0,fe.g7)(this.center,e.center)*i}else t.pan=(0,Ge.q)(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const n=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,n),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){this.viewingMode===te.RT.Global?(0,fe.nu)(e.center,t.center,i.pan,this.center):(0,Ge.m)(this.center,e.center,t.center,i.pan),this.distance=isFinite(t.distance)?(0,_e.Cc)(e.distance,t.distance,i.zoom):e.distance,this.pitch=(0,_e.Cc)(e.pitch,t.pitch,i.rotate);let n=e.yaw;const r=t.yaw;Math.abs(r-n)>=Math.PI&&(n+=2*(n<r?1:-1)*Math.PI),this.yaw=(0,_e.Cc)(n,r,i.rotate)}copyFrom(e){(0,Ge.c)(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,(0,Ge.c)(this.direction,e.direction),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,$r);(0,Ge.c)(this.center,e.center),(0,Ge.f)(Wr,e.center,e.eye),(0,Ge.t)(Wr,Wr,t),(0,Ge.t)(Zr,e.up,t),this.distance=(0,Ge.l)(Wr),0!==this.distance&&(Wr[0]/=this.distance,Wr[1]/=this.distance,Wr[2]/=this.distance),this.pitch=this._eyeUpToPitch(Wr),this.yaw=function(e,t){const i=jr;return Math.abs(t[2])<.5?((0,Ge.c)(i,t),e[2]>0&&(0,Ge.h)(i,i,-1)):(0,Ge.c)(i,e),(0,Ge.b)(Br,i,Qr),(0,Ge.n)(Br,Br),(0,fe.g7)(Yr,Br,Qr)}(Wr,Zr),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,$r);(0,Tt.mg)(t,t),this._axisAngleVec3(Yr,this.pitch-Math.PI/2,Xr,Wr),this._axisAngleVec3(Qr,this.yaw,Wr,Wr),this._axisAngleVec3(Yr,this.pitch-Math.PI/2,Qr,Zr),this._axisAngleVec3(Qr,this.yaw,Zr,Zr),(0,Ge.h)(Wr,Wr,this.distance),(0,Ge.t)(Wr,Wr,t),(0,Ge.t)(Zr,Zr,t),e.center=this.center,e.eye=(0,Ge.f)(Wr,this.center,Wr),e.up=Zr}_axisAngleVec3(e,t,i,n){const r=Math.cos(t),s=Math.sin(t);return(0,Ge.h)(Gr,i,r),(0,Ge.b)(Br,e,i),(0,Ge.h)(Br,Br,s),(0,Ge.h)(kr,e,(1-r)*(0,Ge.k)(e,i)),(0,Ge.g)(n,(0,Ge.g)(n,Gr,Br),kr)}_lookAtOrientation(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,zr.vt)();return this._upAtLookAt(e,kr),(0,Ge.b)(Gr,this.direction,kr),(0,Ge.n)(Gr,Gr),0===Gr[0]&&0===Gr[1]&&0===Gr[2]&&(0,Ge.c)(Gr,Yr),(0,Ge.b)(Br,kr,Gr),(0,Ge.n)(Br,Br),t[0]=Gr[0],t[1]=Br[0],t[2]=kr[0],t[3]=Gr[1],t[4]=Br[1],t[5]=kr[1],t[6]=Gr[2],t[7]=Br[2],t[8]=kr[2],t}_upAtLookAt(e,t){return this.viewingMode===te.RT.Local?(0,Ge.c)(t,Qr):(0,Ge.n)(t,e)}_eyeUpToPitch(e){return Math.PI-(0,fe.g7)(Qr,e)}}const Gr=(0,P.vt)(),Br=(0,P.vt)(),kr=(0,P.vt)(),Wr=(0,P.vt)(),Zr=(0,P.vt)(),jr=(0,P.vt)(),Qr=P.Cb,Xr=P.JP,Yr=P.Cw,$r=(0,zr.vt)();var Kr=i(46034);const Jr=2,es=(0,Si.l5)(500),ts=(0,Si.l5)(8e3);class is{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:Jr},this.source=e(),this.target=e()}clone(){const e=new is(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:Jr,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}let ns=class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>(0,Si.Kp)(e+t.time)),(0,Si.Kp)(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,n=0;const r=this.definition;for(let s=0;s<this.segments.length;s++){const a=this.segments[s],o=a.definition;if(e<=a.time||s===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(a,0===a.time?0:e/a.time,t),r.hasPan&&!isNaN(t.pan)&&isFinite(r.compared.pan)?t.pan=(i+o.compared.pan*t.pan)/r.compared.pan:t.pan=1,r.hasRotate&&!isNaN(t.rotate)&&isFinite(r.compared.rotate)?t.rotate=(n+o.compared.rotate*t.rotate)/r.compared.rotate:t.rotate=1,r.hasZoom&&!isNaN(t.zoom)&&isFinite(o.compared.targetZoom)){const e=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,i=this.segments[0].definition.compared.sourceZoom,n=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(e-i)/(n-i)}else t.zoom=1;return t}e-=a.time,i+=o.compared.pan,n+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}};class rs{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,n=t.targetZoom;this._zoomSign=i>n?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const r=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(n))/2;this._rotatePixels=t.rotate*r}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:n,hasRotate:r}=this.definition;let s=0,a=0;i&&(n&&(s=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),r&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&n&&r){const e=s+a+s*a;this._zoomPixelFlow=s*a/e*o,this._panPixelFlow=a/e*o,this._rotatePixelFlow=s/e*o}else if(i&&n){const e=1+s;this._zoomPixelFlow=s/e*o,this._panPixelFlow=1/e*o}else if(i&&r){const e=1+a;this._zoomPixelFlow=a/e*o,this._rotatePixelFlow=1/e*o}else if(n&&r){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else n?this._panPixelFlow=o:i?this._zoomPixelFlow=o:r&&(this._rotatePixelFlow=o);this._time=r?this.rotateTime:i?this.zoomTime:n?this.panTime:(0,Si.Kp)(0)}get rotateTime(){return this.definition.hasRotate?(0,Si.Kp)(this._rotatePixels/this._rotatePixelFlow):(0,Si.Kp)(0)}get zoomTime(){return this.definition.hasZoom?(0,Si.Kp)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,Si.Kp)(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,Si.Kp)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,Si.Kp)(this._panPixelsAtSource/this._panPixelFlow)}return(0,Si.Kp)(0)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),n=this._interpolateComponentsPan(e),r=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=n,t.rotate=r):t={zoom:i,pan:n,rotate:r},t}}function ss(e,t,i){const n=t-e.compared.sourceZoom,r=e.halfWindowPanAtZoom(n);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+r)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*r)}function as(e,t,i){const n=1/t,r=Math.log(e.compared.sourceZoom*n),s=1/e.desiredPixelFlow,a=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*s*a*l*c-e.halfWindowSize*r*s*a*l+e.halfWindowSize*r*s*a*c/(o*o)}function os(e,t,i){const n=t-e.compared.sourceZoom,r=1/n,s=1/t,a=Math.log(e.compared.sourceZoom*s),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(n))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*(-2*r*s*o+2*r*a+2*s-2*a*o/(n*n)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function ls(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function cs(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function hs(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function ds(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function us(e,t,i){const n=Math.log(t/e.compared.targetZoom),r=1/e.desiredPixelFlow,s=1/Math.LN2,a=-t+e.compared.targetZoom,o=1/a,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*n*r*s*o+e.halfWindowSize*n*r*s*l/(a*a)+e.halfWindowSize*r*s*o*l/t}function ps(e,t,i){const n=t-e.compared.targetZoom,r=1/n,s=1/t,a=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*(-2*r*s*o-2*r*a+2*s+2*a*o/(n*n)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function ms(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function _s(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function gs(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function fs(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),n=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return n<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,n):n}(e,t);const n={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},r=0===n.ascensionFactor,s=0===n.descensionFactor,a=r?ls:ss,o=r?cs:as,l=r?hs:os,c=s?ms:ds,h=s?_s:us,d=s?gs:ps,u=t=>a(e,t,n)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,n)+c(e,t,n),p=t=>o(e,t,n)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,n)+h(e,t,n),m=t=>l(e,t,n)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,n)+d(e,t,n);let _=u(i);const g=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,n=e.halfWindowPanAtZoom(i),r=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*n);return e.compared.sourceZoom<=e.compared.targetZoom?r*(t-n):r*(t+n)}(e);let f;const v=t.maximumIterations||20,y=null!=t.maximumDistance?t.maximumDistance:1/0;for(f=0;f<v;f++){const t=1e-6,n=(p(i)+t)/m(i);if(isNaN(n)||i>=y&&n<0){if(!isFinite(y))return null;i=y,_=u(i);break}if(i-=n,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const r=u(i);if(Math.abs(r-_)/_<=.005)break;_=r}return _>.7*g||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}class vs extends ns{constructor(e,t){super(),this._preallocSegments=[new rs,new rs,new rs],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;null!==t&&void 0!==t&&t.apex&&(i=fs(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,null===t||void 0===t?void 0:t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=ar(i.zoom):e===this._descensionSegment&&(i.zoom=sr(i.zoom)),i}_updateWithApex(e,t){var i;const[n,r,s]=this._preallocSegments,a=null!==(i=null===t||void 0===t?void 0:t.ascensionFactor)&&void 0!==i?i:.5,o=Math.min(1-a,null!=(null===t||void 0===t?void 0:t.ascensionFactor)&&null!=t.descensionFactor?t.descensionFactor:.5),l=1-a-o;n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.targetZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._ascensionSegment=n,this.segments.push(n),l>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*l,r.definition.compared.rotate=this.definition.compared.rotate*l,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*o,s.definition.compared.rotate=this.definition.compared.rotate*o,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const ys={zoom:0,pan:0,rotate:0};let bs=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=(0,Si.l5)(0),this.definition=new is(e),this.path=new vs}update(e,t,i){var n;this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings((0,Si.gr)(isFinite(this.path.time)?this.path.time:(0,Si.Kp)(0)),i),this._easing=null!==(n=i.easing)&&void 0!==n?n:this._time>=1e3?Tr:fr}cameraAt(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,ys);return t.interpolate(this.definition.source,this.definition.target,i),t}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=(0,Si.l5)(e/i));const n=null!=t.minDuration?t.minDuration:es/i,r=null!=t.maxDuration?t.maxDuration:ts/i;return(0,Si.l5)(Math.min(Math.max(n,e),r))}};class ws{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=(0,Si.l5)(0),this._animation=new bs((()=>new qr(e))),this._current=new qr(e)}update(e,t,i){const{source:n,target:r}=this._animation.definition,s=(0,Ge.f)(xs,t.center,e.center),a=(0,Ge.l)(s);a>=1e-5?(s[0]/=a,s[1]/=a,s[2]/=a):(s[0]=0,s[1]=1,s[0]=0),(0,Ge.c)(n.direction,s),(0,Ge.c)(r.direction,s),n.copyFromRenderCamera(e),r.copyFromRenderCamera(t),this._current.copyFrom(n),this._animation.update(n,r,i),this.currentTime=(0,Si.l5)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Kr.i,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=(0,Si.l5)(this.currentTime+(0,Si.gr)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const xs=(0,P.vt)();var Cs;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(Cs||(Cs={}));let Ts=class extends T.A{constructor(e){super(e),this.state=Cs.Ready}get active(){return this.state===Cs.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Cs.Stopped,!0)}finishController(){this.state=Cs.Finished}get steppingFinished(){return!1}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ts.prototype,"view",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ts.prototype,"active",null),(0,n._)([(0,b.MZ)()],Ts.prototype,"state",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ts.prototype,"isInteractive",null),Ts=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.CameraController")],Ts);let As=class extends Ts{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,_.NK)()),this._asyncResult=null),this.state===Cs.Finished||this.state===Cs.Stopped?((0,p.Lw)(e),this.state===Cs.Finished?e.resolve():e.reject((0,_.NK)())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Cs.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){null==this.viewAnimation||this.state!==Cs.Ready&&this.state!==Cs.Running||(this.viewAnimation.state===ee.A.State.FINISHED?this.finish():this.viewAnimation.state===ee.A.State.STOPPED&&(this.state=Cs.Stopped))}onControllerEnd(){null==this.viewAnimation||this.viewAnimation.done||(this.state===Cs.Finished?this.viewAnimation.finish():this.state===Cs.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Cs.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,_.NK)()))}finish(){this.finishController()}};As=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.AnimationController")],As);var Ms=i(29808);let Ss=class extends As{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new ws(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ee.A}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);Ps.copyFrom(this.view.state.camera);const n=(0,Ms.hz)(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Ps.ray,n,Rs)&&(Ps.center=Rs),this.animation.update(Ps,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?Lr[e.easing]:e.easing}}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ss.prototype,"mode",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ss.prototype,"isInteractive",null),Ss=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.PointToPointAnimationController")],Ss);const Ps=new Kr.i,Rs=(0,P.vt)();var Es=i(73582),Os=i(60008),Ds=i(4336),Is=i(96190),Ls=i(75762);function Ns(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Us;return[e[0],e[1],e[2],e[3]]}function Fs(e,t){return Vs(e[0],e[1],e[2],t,Ls.Km.get())}function Vs(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ns();return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r}function Hs(e,t,i){return(0,Ge.b)(i,e,t),(0,Ge.n)(i,i),i[3]=(0,Is.g7)(e,t),i}const Us=[0,0,1,0];(0,Ds.vt)(),(0,Ds.vt)();var zs=i(13927),qs=i(37431);function Gs(e,t,i,n){const r=(0,qs.vr)(t,i,Bs);return(0,vn.i)(e,r,n)}const Bs=(0,yn.vt)();var ks,Ws=i(97974);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(ks||(ks={}));const Zs=[1,3e8],js=1508e5,Qs={exclude:new Set([Ws.fo])};function Xs(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Ys(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function $s(e,t,i){const n=(0,At.$0)(Ls.Rc.get(),i[3],i);null==n||(0,At.t2)(n,Mt.zK)||((0,Ge.f)(Ga,e.eye,t),(0,Ge.e)(Ga,Ga,n),e.eye=(0,Ge.g)(Ga,Ga,t),(0,Ge.f)(Ga,e.center,t),(0,Ge.e)(Ga,Ga,n),e.center=(0,Ge.g)(Ga,Ga,t),e.up=(0,Ge.e)(Ga,e.up,n))}function Ks(e,t,i,n){return(0,zs.Ui)(e,(0,qs.vr)(t,i,ja),n)}function Js(e,t,i,n){const r=Ls.rq.get();let s=1-i;(0,Ge.f)(r,t,e.eye);const a=(0,Ge.l)(r);let o=a*(1-s);s>=0&&o<n&&(o=n,s=-(o-a)/a),Math.abs(a-o)<1e-6||((0,Ge.h)(r,r,s),e.eye=(0,Ge.g)(Ga,e.eye,r),e.center=(0,Ge.m)(Ga,e.center,t,s))}function ea(e,t,i){t.getScreenCenter(ta),Gs(e,t,ta,Ga)&&(t.center=Ga);const n=t.distance,r=n*i;if(Math.abs(n-r)<1e-6)return;const s=(0,Ge.h)(Ls.rq.get(),t.viewForward,r);t.eye=(0,Ge.f)(Ga,t.center,s)}const ta=(0,v.gs)();function ia(e,t){(0,Ge.s)(t,0,0,0);for(const i of e)(0,Ge.g)(t,t,i);(0,Ge.h)(t,t,1/e.length)}function na(e,t,i,n){return Math.sin(e/(0,Ge.l)(t))*(i+n.radius)}function ra(e,t,i,n){return na(Math.PI/2,t,i,n)+(e-Math.PI/2)}var sa;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(sa||(sa={}));const aa=3e4,oa=(0,_e.kU)(16),la={Pole:.95,Angle:(0,_e.kU)(18),Tilt:45},ca=(0,_e.kU)(80);function ha(e,t,i,n,r,s){const a=(0,P.vt)(),o=(0,vn.c)();let l=!0,c=!0;return e.intersectScreen(i,a,s)?o[3]=(0,Ge.l)(a):(c=!1,t.aboveGround&&r!==ks.Ellipsoid?o[3]=Math.max((0,Ge.l)(t.center),.9*n.radius):o[3]=(0,Ge.l)(t.eye)-t.relativeElevation,r===ks.Silhouette?ma(o,t,i,a):l=Gs(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function da(e,t,i){return(0,Ge.l)(e.eye)-i.radius>aa?sa.Horizontal:((0,qs.vr)(e,t,Qa),-Math.sign(e.relativeElevation)*(.5*Math.PI+(0,Is.g7)(e.eye,Qa.direction))<oa?sa.Vertical:sa.Horizontal)}function ua(e,t,i){(0,Ge.f)(pa,i,t),e.eye=(0,Ge.f)(Ga,e.eye,pa),e.center=(0,Ge.f)(Ga,e.center,pa)}const pa=(0,P.vt)();function ma(e,t,i,n){const r=(0,qs.vr)(t,i,ja);return null!=r&&((0,vn.e)(e,r,_a),(0,vn.i)(e,r,n)?!((0,Ge.a)(_a,r.origin)<(0,Ge.a)(n,r.origin))||((0,Ge.c)(n,_a),!1):((0,Ge.f)(ga,t.eye,t.center),(0,Ge.n)(ga,ga),(0,zs.UB)(ga,-(0,Ge.k)((0,Ge.n)(ga,ga),_a),fa),(0,zs.Ui)(fa,r,n),!1))}const _a=(0,P.vt)(),ga=(0,P.vt)(),fa=(0,zs.vt)();function va(e,t,i,n,r,s){let a=0;if((0,Ge.b)(Wa,e,t),(0,Ge.f)(Ba,e,t),(0,Ge.l)(e)<=r||!n.aboveGround){(0,Ge.b)(i,Ba,n.eye);const o=(0,Ge.k)(e,t)/((0,Ge.l)(e)*(0,Ge.l)(t));if(o<.9999)a=(0,_e.XM)(o);else{const i=(0,Ge.l)((0,Ge.b)((0,P.vt)(),e,t))/((0,Ge.l)(e)*(0,Ge.l)(t));a=(0,_e.YN)(i)}const l=Math.cos((0,_e.qE)(Es.wf.normalize((0,_e.kU)(s)),0,ca));a=-a-Math.max(0,(0,Ge.l)(t)-r)/(l*r)}else(0,Ge.f)(ya,n.eye,n.center),(0,Ge.b)(i,Ba,ya),a=-(0,Ge.l)(Ba)/r;return(0,Ge.n)(i,i),(0,Ge.h)(i,i,(0,Ge.l)(Wa)),a}const ya=(0,P.vt)();function ba(e,t,i,n){let r,s;const a=Math.cos((0,_e.qE)(Es.wf.normalize((0,_e.kU)(n)),0,ca));return r=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):(0,_e.XM)(t/i),s=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):(0,_e.XM)(e/i),(s-r)*i}function wa(e,t,i,n,r,s,a,o,l,c){(0,Ge.b)(Wa,e,t),(0,F.U9)(s.up,s.eye,Oa,Da,Ia),(0,F.U9)([0,0,1],s.eye,Pa,Ra,Ea),(0,Ge.c)(i,Ra),(0,Ge.c)(n,Pa),(0,Ge.n)(i,i),(0,Ge.h)(i,i,(0,Ge.l)(Wa)),(0,F.PX)(e,(0,Ge.n)(Da,Da),(0,Ge.n)(Ia,Ia),(0,Ge.n)(Oa,Oa),La),(0,F.PX)(t,Da,Ia,Oa,Na),function(e,t,i,n,r,s,a,o,l,c){const h=ba(e[2],t[2],s[3],o),d=l?ba(e[0],t[0],s[3],180):t[0]-e[0],u=Math.sin(a)*d-Math.cos(a)*h,p=Math.cos(a)*d+Math.sin(a)*h;(0,Ge.n)(Ga,r);const m=l?u/Math.sqrt(Math.abs(s[3]**2-(0,Ge.k)(i,Ga)**2)):u/s[3],_=p/Math.sqrt(Math.abs(s[3]**2-(0,Ge.k)(i,n)**2));(0,Qe.hZ)(c,m,_)}(La,Na,e,Pa,Ra,a,o,l,c,r)}function xa(e,t,i,n,r,s,a){(0,At.$0)(Ha,r,n),(0,At.$0)(Ua,a,s),(0,At.lw)(za,Ha,Ua),(0,Ge.f)(t,e,i),(0,Ge.e)(t,t,za),(0,Ge.g)(t,t,i)}function Ca(e,t,i,n,r,s){(0,At.$0)(Ha,n,i),(0,At.$0)(Ua,s,r),(0,At.lw)(za,Ha,Ua),(0,Ge.f)(Ga,e.eye,t),(0,Ge.e)(Ga,Ga,za),e.eye=(0,Ge.g)(Ga,Ga,t),(0,Ge.f)(Ga,e.center,t),(0,Ge.e)(Ga,Ga,za),e.center=(0,Ge.g)(Ga,Ga,t),(0,Ge.f)(Ga,e.up,t),(0,Ge.e)(Ga,Ga,za),e.up=(0,Ge.g)(Ga,Ga,t)}function Ta(e,t,i,n,r,s){return(Math.abs(n)>Math.PI-la.Angle||Math.abs(n)<la.Angle)&&(Math.abs(e[2])<i*la.Pole||Math.abs(t)>i)&&s.aboveGround&&r<la.Tilt}function Aa(e,t,i,n,r,s){if(s)Hs(i,n,Va),$s(t,(0,vn.g)(e),Va);else{const s=va(i,n,Za,t,e[3],r);$s(t,(0,vn.g)(e),Fs(Za,s))}}function Ma(e,t,i,n,r,s,a){const o=a?20:1;let l,c;(0,Ge.c)(qa,n),ka.copyFrom(t);for(let h=0;h<o&&(0,Ge.a)(i,qa)>1e-12&&(l=(0,Ge.a)(i,qa),wa(i,qa,Ra,Pa,Fa,ka,e,r,s,a),Ca(ka,(0,vn.g)(e),Pa,Fa[1],Ra,Fa[0]),xa(qa,qa,(0,vn.g)(e),Pa,Fa[1],Ra,Fa[0]),c=(0,Ge.a)(i,qa),c<l||0===h);h++)t.copyFrom(ka)}function Sa(e,t,i,n,r,s,a,o,l){Ta(e.center,(0,Ge.k)(e.up,e.center),(0,Ge.l)(e.center),-Es.wf.normalize((0,_e.kU)(s)),a,t)?function(e,t,i,n,r,s){const{eye:a}=e;(0,F.U9)([0,0,1],a,Pa,Ra,Ea);const o=t.translation[0]*i.pan,l="zoom"===r.mode?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-(0,Ge.k)(e.center,Pa)**2/(0,Ge.l)(e.center)**2)),.5),h=(Math.sin(s)*l+Math.cos(s)*o)/c,d=-Math.cos(s)*l+Math.sin(s)*o;switch((0,At.e$)(n.pan.matrix,n.pan.matrix,h,Pa),n.pan.enabled=!0,r.mode){case"pan":(0,At.e$)(n.pan.matrix,n.pan.matrix,d,Ra),n.pan.enabled=!0;break;case"zoom":n.zoom=-t.translation[1]*i.zoom}}(t,i,n,o,l,-Es.wf.normalize((0,_e.kU)(r))):function(e,t,i,n,r){const{eye:s,viewRight:a}=e,o=(0,Ge.b)(Ls.rq.get(),a,s),l=t.translation[0]*i.pan;switch(0!==l&&((0,At.e$)(n.pan.matrix,n.pan.matrix,-l,o),n.pan.enabled=!0),r.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,At.e$)(n.pan.matrix,n.pan.matrix,e,a),n.pan.enabled=!0);break}case"zoom":n.zoom=-t.translation[1]*i.zoom}}(t,i,n,o,l)}const Pa=(0,P.vt)(),Ra=(0,P.vt)(),Ea=(0,P.vt)(),Oa=(0,P.vt)(),Da=(0,P.vt)(),Ia=(0,P.vt)(),La=(0,P.vt)(),Na=(0,P.vt)(),Fa=(0,Ke.vt)(),Va=Ns(),Ha=(0,Mt.vt)(),Ua=(0,Mt.vt)(),za=(0,Mt.vt)(),qa=(0,P.vt)(),Ga=(0,P.vt)(),Ba=(0,P.vt)(),ka=new Kr.i,Wa=(0,P.vt)(),Za=(0,P.vt)(),ja={origin:(0,P.vt)(),direction:(0,P.vt)()},Qa={origin:(0,P.vt)(),direction:(0,P.vt)()};let Xa=class extends Ss{constructor(){super(...arguments),this._zoomLocation=(0,P.vt)(),this._tmpCamera=new Kr.i,this._tmpViewDir=(0,P.vt)(),this._tmpRayDir={origin:(0,P.vt)(),direction:(0,P.vt)()},this._targetOnSphere=(0,P.vt)(),this._tmpCenter=(0,P.vt)(),this._beginCamera=new Kr.i,this._constraintOptions=new bn(_n.ALL_EXCEPT_COLLISION,gn.ZOOM,null,this._beginCamera),this._sphere=(0,vn.c)()}initialize(){this._intersector=(0,Ms.hz)(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let n=!1,r=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Qs:{})&&(n=e>0,r=!0),this._tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Ge.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,r),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Si.l5)(600),easing:fr}}_updateCamera(e,t,i,n,r){const s=da(e,n,(0,We.tO)(this.view.spatialReference)),a=Math.abs(this.view.camera.position.z);(0,Ge.n)($a,e.eye),(0,Ge.h)($a,$a,-1),(0,qs.vr)(e,n,this._tmpRayDir),(0,Ge.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=(0,_e.qE)(Math.min(8,1/Math.abs((0,Ge.k)($a,this._tmpRayDir.direction)))*a,200,js);if(s===sa.Horizontal){let r=.6**t;this._sphere[3]=(0,Ge.l)(i),(0,Ge.f)(this._tmpViewDir,e.center,e.eye);const s=Math.min((0,Ge.l)(this._tmpViewDir),o);let a=s*r;if(r<=1&&a<4&&(a=4,r=a/s),Math.abs(s-a)<1e-6)return;const l=(0,Ge.l)(e.center);if(this._sphere[3]!==l){const t=this._sphere[3]+r*(l-this._sphere[3]);e.center=(0,Ge.h)(Ya,e.center,t/l)}(0,Ge.h)(this._tmpViewDir,this._tmpViewDir,-r),e.eye=(0,Ge.g)(Ya,e.center,this._tmpViewDir),Nr(this.view,e,this._constraintOptions),(0,Ge.a)(i,e.center)>1e-12&&Gs(this._sphere,e,n,this._targetOnSphere)&&function(e,t,i,n,r,s,a){Ta(i,(0,Ge.k)(t.up,i),e[3],-Es.wf.normalize((0,_e.kU)(r)),s,t)?Ma(e,t,i,n,-Es.wf.normalize((0,_e.kU)(r)),s,a):Aa(e,t,i,n,s,a)}(this._sphere,e,i,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let s=.6**Math.abs(t);const a=t>0?1:-1;(0,Ge.f)(this._tmpViewDir,i,e.eye);const l=(0,Ge.l)(this._tmpViewDir),c=this.view._stage.renderView.getMinimalDepthForArea(null,n[0],n[1],this.view.state.camera,60);let h=null!=c?c:o;h=r&&t>0?Math.min(h,l):h,(0,Ge.h)(this._tmpRayDir.direction,this._tmpRayDir.direction,h),(0,Ge.g)(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=h*s;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,s=d/h),Math.abs(h-d)<1e-6)return;(0,Ge.h)(this._tmpRayDir.direction,this._tmpRayDir.direction,a*(1-s)),e.eye=(0,Ge.g)(Ya,e.eye,this._tmpRayDir.direction),e.center=(0,Ge.g)(Ya,e.center,this._tmpRayDir.direction)}Gn(this.view,e)}};Xa=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.global.ZoomStepController")],Xa);const Ya=(0,P.vt)(),$a=(0,P.vt)();var Ka=i(60704);let Ja=class extends Ss{constructor(){super(...arguments),this._zoomLocation=(0,P.vt)(),this._tmpCamera=new Kr.i,this._tmpRayDir=(0,P.vt)(),this._tmpCenter=(0,P.vt)(),this._beginCamera=new Kr.i,this._constraintOptions=new bn(_n.ALL,gn.ZOOM,null,this._beginCamera)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const n=(0,Ms.hz)(this.view.state.viewingMode);let r=!1;e>0?(r=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?Qs:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Ge.c)(this._zoomLocation,this._tmpCamera.center);const s=.6**e;let a=this.view._stage.renderView.getMinimalDepthForArea((0,Ka.ds)(this.view),t[0],t[1],this.view.state.camera,60);(0,Ge.f)(io,this._tmpCamera.eye,this._zoomLocation),(0,Ge.n)(io,io);const o=(0,_e.qE)(Math.min(8,1/Math.abs((0,Ge.k)(to,io)))*Math.abs(this.view.camera.position.z),200,js);if(a=null!=a?a:o,a){const e=(0,P.vt)();(0,Ge.f)(e,this._zoomLocation,this._tmpCamera.eye),(a<(0,Ge.l)(e)||!r)&&((0,Ge.n)(e,e),(0,Ge.g)(this._zoomLocation,this._tmpCamera.eye,(0,Ge.h)(e,e,a)))}this._updateCamera(this._tmpCamera,s,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Si.l5)(600),easing:fr}}_updateCamera(e,t,i){(0,Ge.f)(this._tmpRayDir,i,e.eye);const n=(0,Ge.l)(this._tmpRayDir);let r=n*t;const s=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==r&&(s&&r<a&&(r=a,t=r/n),Math.abs(n-r)<1e-6||((0,Ge.h)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Ge.f)(eo,i,this._tmpRayDir),e.center=(0,Ge.m)(eo,e.center,i,1-t),Nr(this.view,e,this._constraintOptions)))}};Ja=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.local.ZoomStepController")],Ja);const eo=(0,P.vt)(),to=(0,P.fA)(0,0,1),io=(0,P.vt)();var no=i(89196),ro=i(76913);class so extends no.l{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if((0,ro.j)(t,"primary")){const i=this._view.state.isGlobal?new Xa({view:this._view,mode:"animation"}):new Ja({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),(0,v.gs)(t.x,t.y)),e.stopPropagation()}}}var ao=i(76797),oo=i(13904),lo=i(31633);class co{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,We.tO)(t),this._unitInMeters=(0,lo.GA)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,n,r){var s;r||(r={near:0,far:0});let a=e[2]*this._unitInMeters;const o=a,l=a-n,c=null===(s=this._elevationProvider)||void 0===s?void 0:s.visibleElevationBounds;c&&(a=l>=0?o-this._unitInMeters*c.min:this._unitInMeters*c.max-o);const h={x:(i=null!=i?i:new ao.A({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},d=Math.max(h.x,h.y,h.z);(0,Ge.f)(vo,t,e),fo[0]=vo[0]>0?i.xmax:i.xmin,fo[1]=vo[1]>0?i.ymax:i.ymin,fo[2]=vo[2]>0?d/2:-d/2,(0,Ge.f)(fo,fo,e),(0,Ge.n)(vo,vo);const u=1.1*(0,Ge.k)(fo,vo)*this._unitInMeters,p=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),m=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),_=m*_o*this._unitInMeters,g=m*go*this._unitInMeters,f=(0,_e.qE)((a-g)/(_-g),0,1)**3,v=Math.min((0,_e.Cc)(p,u,f),p)*Math.max(Math.log(Math.abs(l)),1);return uo(Math.min(v,Math.max(34064e4,d))/this._unitInMeters,po,this._unitInMeters,r)}}class ho{constructor(e){this._referenceEllipsoid=(0,We.tO)(e)}compute(e,t,i,n,r){r||(r={near:0,far:0});const s=(0,Ge.l)(e),a=s-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,n),l=Math.abs(a-n),c=Math.max(l,Math.abs(a)),h=Math.sqrt(c*(c+2*o)),d=s+this._referenceEllipsoid.radius;return uo(1.2*(0,_e.Cc)(h,d,(0,$e.GF)(c)),(0,_e.qE)(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,r)}}function uo(e,t,i,n){const r=mo/i;return e/t>r?(n.far=e,n.near=n.far/t):(n.near=r,n.far=n.near*t),n}const po=2e4,mo=2,_o=.001,go=1e-4,fo=(0,P.vt)(),vo=(0,P.vt)();let yo=class extends T.A{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&(0,qn.HD)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>Gn(this.view,e,zn.EYE_AND_CENTER)))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],yo.prototype,"view",void 0),yo=(0,n._)([(0,x.$)("esri.views.3d.state.ElevationCollisionConstraint")],yo);let bo=class extends T.A{constructor(e){super(e),this.nearFarHeuristic=function(e,t,i){return e===te.RT.Global?new ho(i):new co(t,i)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([(0,g.watch)((()=>{var e,t;return[null===(e=this.view.constraints)||void 0===e||null===(e=e.clipDistance)||void 0===e?void 0:e.near,null===(t=this.view.constraints)||void 0===t||null===(t=t.clipDistance)||void 0===t?void 0:t.far]}),(()=>this._clipDistanceNearFarChanged())),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.clipDistance)||void 0===e?void 0:e.mode}),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e))),(0,g.watch)((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),g.sync),(0,g.watch)((()=>{var e,t;return[null===(e=this.view.constraints)||void 0===e||null===(e=e.altitude)||void 0===e?void 0:e.min,null===(t=this.view.constraints)||void 0===t||null===(t=t.altitude)||void 0===t?void 0:t.max]}),(()=>this._updateAltitude()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.tilt)||void 0===e?void 0:e.max}),(()=>this._updateTiltMax()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.constraints)||void 0===e||null===(e=e.tilt)||void 0===e?void 0:e.mode}),(()=>this._updateTilt()),g.sync),(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(()=>this._updateTiltAutoMax()),g.sync),(0,g.watch)((()=>{var e,t;return[null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type,null===(t=this.view.state)||void 0===t||null===(t=t.constraints)||void 0===t||null===(t=t.collision)||void 0===t?void 0:t.enabled]}),(()=>this._updateCollision()),g.sync)]),this.view.state.isLocal&&this.addHandles((0,g.watch)((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),g.initial)),this._updateNearFar(),this.view.state.viewingMode!==te.RT.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new yo({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var e;const t=null===(e=this.view.constraints)||void 0===e?void 0:e.clipDistance;t&&"auto"!==t.mode&&this.view.state.updateCamera((e=>this._updateCameraNearFarManual(e,t)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,(0,qn.Rt)(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e;const t=null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e||null===(e=e.navigationConstraint)||void 0===e?void 0:e.type,i=!t||"stay-above"===t,n=this.view.state.constraints.collision;if(i!==n.enabled){n.enabled=i,i&&this._reapplyConstraints(_n.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==te.RT.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,_e.kU)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,_e.KJ)(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,n=3*t/Math.atan(i.camera.fov/2);n!==i.constraints.distance&&(i.constraints.distance=n)}_reapplyConstraints(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_n.ALL;this.view.state.updateCamera((t=>Nr(this.view,t,new bn(e,gn.NONE,null))))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],bo.prototype,"view",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],bo.prototype,"surfaceCollisionConstraint",void 0),bo=(0,n._)([(0,x.$)("esri.views.3d.state.ConstraintsManager")],bo);var wo=i(61985);let xo=class extends Ts{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Cs.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||(0,qn.HD)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),Gn(this.view,e,zn.EYE_AND_CENTER)||this.constraintEnabled||(this.state=Cs.Stopped)}))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],xo.prototype,"desiredCamera",null),xo=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],xo);var Co=i(38987);class To{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this.options.signal&&(0,_.u7)(this.options.signal,(()=>{this.abort()})),this._abortController=i,this.waitForReady()}))}resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject((0,_.NK)())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await(0,g.whenOnce)((()=>this.view.ready),this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}async createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null;try{const e=await(0,Co.vt)(this.view,this.target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this.options.animate){if(null==this._animationController)return;this.startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}catch(e){this.reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this.target instanceof s.A&&this.target.camera||this.target instanceof r.A),i=e.camera;if(null==i)return null;if(!this.view.stateManager.isCompatible(i)){var n;const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=null===(n=this.view.spatialReference)||void 0===n?void 0:n.wkid;return this.reject(new l.A("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: ".concat(r,", view: ").concat(s,")"),{camera:i})),null}const a=(0,G.Cz)(this.view,i);return null==a?(this.reject(new l.A("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this.reject(new l.A("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let n;e.isFullySpecified?(n=new xo({view:this.view,desiredCamera:e.camera}),Gn(this.view,e.camera,zn.EYE_AND_CENTER)):Nr(this.view,e.camera),t.begin(e.camera,this.options);const r=e=>{if(null!=this.view.state)switch(t.state){case Cs.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case Cs.Ready:case Cs.Rejected:case Cs.Running:case Cs.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;n&&(i&&i.active?i instanceof Ss&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=n):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===Cs.Finished&&(this.view.state.cameraController=n))}),(e=>r(e))),t.asyncResult={resolve:()=>r(),reject:e=>r(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return i instanceof Ss&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new Ss({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(null!=t&&t.stop(),this.reject(new l.A("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}var Ao=i(48606),Mo=i(71118),So=i(98476);let Po=class extends T.A{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=Ho,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?Ho:0}},this._propertiesPool=new Ao.M({frustum:wo.P},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Ro}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([(0,g.on)((()=>this.view.state.events),"before-camera-change",(e=>e&&this._updateElevation(e))),(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),((e,t)=>this._cameraChangedHandler(e,t)),g.sync)]),(0,g.when)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.camera}),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([(0,f.mg)({prepare:()=>this._prepareFrame()}),(0,g.watch)((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(Fo)})),(0,g.on)((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=(0,G.dl)(this.view,this.view.state.camera,Io);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,i;this._updatePropertyBeforeReady("camera",e)||(null!==(t=this.view.elevationProvider)&&void 0!==t&&t.enableCache(!0),this.setStateCamera((0,G.Cz)(this.view,e),{applyConstraints:!1})||u.A.getLogger(this).error("#camera=","Invalid camera",e),null===(i=this.view.elevationProvider)||void 0===i||i.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=(0,G.dl)(this.view,this.view.state.contentCamera,Io);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=(0,G.Cz)(this.view,e);null!=t?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(Vo),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,n=(0,P.ci)(this.view.state.camera.center),r=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,g.watch)((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(Vo),this.test.contentCameraResetState.clear())})),(0,g.watch)((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r))})),(0,g.watch)((()=>this.view.state.camera),(e=>{const t=(0,Ge.a)(n,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=r)}))],Vo),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():u.A.getLogger(this).error("#center=","Invalid center",e):u.A.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):u.A.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=(0,G.w1)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#extent=","Invalid extent",e):u.A.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):u.A.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var e;const t=this.view.map;return t&&"initialViewProperties"in t?null===(e=t.initialViewProperties)||void 0===e?void 0:e.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return(0,G.Fj)(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,n=this._get("padding"),r=Math.round(t[Kr.z.TOP]/i),s=Math.round(t[Kr.z.RIGHT]/i),a=Math.round(t[Kr.z.BOTTOM]/i),o=Math.round(t[Kr.z.LEFT]/i);return null!=n&&n.top===r&&n.right===s&&n.bottom===a&&n.left===o?n:{top:r,right:s,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,No),this.view.state.updateCamera((e=>e.padding=No)))}_paddingToArray(e,t,i){e?(0,Xe.s)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Xe.s)(i,0,0,0,0);for(let n=0;n<4;n++)i[n]=Math.round(i[n]*t)}get screenCenter(){const e=this.padding;return(0,v.tc)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?(0,Co.Qq)(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||u.A.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{var t;const i=null!=e.camera?e.camera.position:e.targetGeometry,n=null!=i&&i.spatialReference;u.A.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(n?n.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e)}else u.A.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?(0,G.J9)(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||u.A.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var e;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const t=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),i=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:t)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*i),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*i);const n=null===(e=this.view._stage.renderView.renderingContext)||void 0===e?void 0:e.parameters.maxTextureSize;return n&&(0,Vt.T)(this._tmpCanvasSize,n),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:i,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return null!==(e=null===(t=this.view)||void 0===t||null===(t=t._stage)||void 0===t?void 0:t.renderer.isFeatureEnabled(Mo.n.PhysicalPixelRendering))&&void 0!==e&&e}get _usePhysicalPixelRenderingAny(){var e;const t=null===(e=this.view)||void 0===e||null===(e=e._stage)||void 0===e?void 0:e.renderer;return t&&(t.isFeatureEnabled(Mo.n.PhysicalPixelRendering,So.M.IDLE)||t.isFeatureEnabled(Mo.n.PhysicalPixelRendering,So.M.INTERACTING)||t.isFeatureEnabled(Mo.n.PhysicalPixelRendering,So.M.ANIMATING))}preinit(e){var t,i;return!(this._isOverridden("center")&&!(0,O.isLoadedOrLoadFor)(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!(0,O.isLoadedOrLoadFor)(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!(0,O.isLoadedOrLoadFor)(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||(0,O.isLoadedOrLoadFor)(null===(t=this.viewpoint.targetGeometry)||void 0===t?void 0:t.spatialReference,e)&&(0,O.isLoadedOrLoadFor)(null===(i=this.viewpoint.camera)||void 0===i||null===(i=i.position)||void 0===i?void 0:i.spatialReference,e))}init(){this._constraintsManager=new bo({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===te.RT.Local&&this.addHandles((0,g.when)((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(Fo),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),Fo)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Fo),this._constraintsManager=(0,p.pR)(this._constraintsManager))}async goTo(e,t){const i={animate:!0,...t};return null!=this._gotoOperation&&this._gotoOperation.abort(i.animate),this._gotoOperation=new To(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera((0,qn.bZ)(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=null===t||void 0===t?void 0:t.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:n}of Oo){const r=e.has(i),s=this._isOverridden(i);!r&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(r||s)&&n.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof r.A)return void this.setStateCamera((0,G.Cz)(this.view,e),{applyConstraints:!1});if(e instanceof s.A){if(e.targetGeometry instanceof ao.A){const t=(0,G.wI)(this.view,e.targetGeometry,0,.5,G.AO.LOCKED);return void(null!=t&&this.setStateCamera((0,G.Cz)(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=(0,G.wI)(this.view,e,0,.5,G.AO.LOCKED);null!=t&&this.setStateCamera((0,G.Cz)(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Eo.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof s.A?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof r.A?this.isCompatible(e.position):e.spatialReference&&!(0,O.requiresLoad)(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Do;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Lo;const{heading:n,tilt:r}=this._getPreservingHeadingTilt(),s=(0,G.rW)(this.view,n,r,e,t,G.AO.ADJUST);return null==s?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),n=(0,G.wI)(this.view,e,t,i,G.AO.ADJUST,Io);return n?(0,G.Cz)(this.view,n):null}_scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,n=t.location.latitude,r=(0,G.tv)(this.view,e,n);return this._centerPointAtDistanceToCamera(i,r)}_zoomToCamera(e){return this._scaleToCamera((0,G.XM)(this.view,e))}_viewpointToCamera(e){return(0,G.Cz)(this.view,(0,Co.on)(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&Nr(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new xo({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(Lo.copyFrom(e),Lo.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,No),Lo.padding=No),Lo.fullWidth=i.width,Lo.fullHeight=i.height,Lo.pixelRatio=i.pixelRatio,this.view.state.camera=Lo),this._updateViewState()}}_updateElevation(e){var t,i,n;const r=null===(t=this.view.basemapTerrain)||void 0===t?void 0:t.spatialReference,s=null!==(i=null===(n=this.view.renderCoordsHelper)||void 0===n?void 0:n.getAltitude(e.eye))&&void 0!==i?i:0,a=r?(0,qn.Rt)(this.view,e.eye):0;e.relativeElevation=s-a}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=So.M.ANIMATING:this.view.interacting?this.view.state.mode=So.M.INTERACTING:(this.view.state.mode===So.M.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=So.M.INTERACTING:this.view.state.mode=So.M.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};(0,n._)([(0,b.MZ)({type:r.A,dependsOn:["view.state.camera","ready"]})],Po.prototype,"camera",null),(0,n._)([(0,b.MZ)({type:r.A,dependsOn:["view.state.contentCamera","ready"]})],Po.prototype,"contentCamera",null),(0,n._)([(0,b.MZ)({type:oo.A})],Po.prototype,"center",null),(0,n._)([(0,b.MZ)({type:ao.A})],Po.prototype,"extent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"frustum",null),(0,n._)([(0,b.MZ)()],Po.prototype,"_constraintsManager",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"constraintsManager",null),(0,n._)([(0,b.MZ)()],Po.prototype,"_initialViewpoint",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"hasInitialView",null),(0,n._)([(0,b.MZ)({readOnly:!0,type:Boolean})],Po.prototype,"ready",void 0),(0,n._)([(0,b.MZ)({type:Number})],Po.prototype,"scale",null),(0,n._)([(0,b.MZ)()],Po.prototype,"padding",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"screenCenter",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Po.prototype,"view",void 0),(0,n._)([(0,b.MZ)({type:s.A})],Po.prototype,"viewpoint",null),(0,n._)([(0,b.MZ)({type:Number})],Po.prototype,"zoom",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"_rasterPixelRatio",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"_usePhysicalPixelRendering",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Po.prototype,"_usePhysicalPixelRenderingAny",null),(0,n._)([(0,b.MZ)()],Po.prototype,"_windowDevicePixelRatio",void 0),(0,n._)([(0,b.MZ)()],Po.prototype,"_devicePixelRatioOverride",void 0),Po=(0,n._)([(0,x.$)("esri.views.3d.state.ViewStateManager")],Po);class Ro{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const Eo=new Set(["camera","viewpoint","extent","scale","center","zoom"]),Oo=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Do={heading:0,tilt:0},Io=new r.A,Lo=new Kr.i,No=(0,Ye.vt)(),Fo="pending-initial-view",Vo="content-camera-reset",Ho=300;let Uo=class extends Ts{constructor(){super(...arguments),this.startCamera=new Kr.i,this.currentCamera=new Kr.i,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<100}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=Cs.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout((()=>this.notifyChange("isInteractive")),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var zo;(0,n._)([(0,b.MZ)({readOnly:!0})],Uo.prototype,"isInteractive",null),(0,n._)([(0,b.MZ)()],Uo.prototype,"_lastInteraction",void 0),Uo=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.InteractiveController")],Uo),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(zo||(zo={}));let qo=class extends Uo{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=zo.CENTER,this._rotScale=0,this._lastPoint=(0,Ke.vt)(),this._tmpWorldUp=(0,P.vt)(),this._tmpViewDir=(0,P.vt)(),this._tmpRotCurPoint=(0,Ke.vt)(),this._tmpTransf=(0,Mt.vt)(),this._tmpAxis=(0,P.vt)(),this._tmpPivotPoint=(0,P.vt)(),this._pivotPos=(0,P.vt)(),this._constraintOptions=new bn(_n.ALL,gn.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===zo.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case zo.EYE:(0,Ge.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=gn.LOOK_AROUND,this._constraintOptions.tiltMode=fn.LOOK_AROUND,this._constraintOptions.selection=_n.NONE;break;case zo.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?Qs:{});t||(0,Ge.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=gn.TUMBLE,this._constraintOptions.tiltMode=fn.TUMBLE,this._constraintOptions.selection=_n.ALL&~_n.DISTANCE;break}}Xs(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){var i,n;const r=this.startCamera,s=(0,P.vt)();(0,Ge.f)(s,this._pivotPos,r.eye);const a=(0,Ge.l)(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,Bo);let l=Math.max(Math.min(5,1/Math.abs((0,Ge.k)(Bo,r.viewForward)))*o,10);t&&(l=Math.min(a,l));const c=(0,We.tO)(this.view.spatialReference),h=(0,v.gs)(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),d=da(this.startCamera,h,c);let u=this.view._stage.renderView.getMinimalDepthForArea((0,Ka.ds)(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,225,90),p=this.view._stage.renderView.getMinimalDepthForArea((0,Ka.ds)(this.view),e[0],e[1],r,90);null==u&&null==p||(u=null!==(i=null!==(n=u)&&void 0!==n?n:p)&&void 0!==i?i:0,p=null==p||d===sa.Horizontal?u:p,l=u>p?p:u,l=t?Math.min(l,a):l),(0,Ge.n)(s,s),(0,Ge.c)(this._pivotPos,(0,Ge.g)(this._tmpPivotPoint,r.eye,(0,Ge.h)(this._tmpPivotPoint,s,l)))}update(e){if(this.active){switch(this.pivot){case zo.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case zo.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Nr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,n){this.view.renderCoordsHelper.worldUpAtPosition(n,this._tmpWorldUp),Xs(e,t,this._tmpRotCurPoint);let r=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,s=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Ge.f)(this._tmpViewDir,i,n);const a=(0,Ge.l)(this._tmpViewDir),o=(0,_e.XM)((0,Ge.k)(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===zo.EYE){r*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;r=e-Math.max(-t,Math.min(t,e+r))}return r=(0,_e.qE)(r+o,be.min,be.max)-o,(0,Ge.b)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===zo.CENTER&&(s=-s),(0,At.$0)(this._tmpTransf,s,this._tmpWorldUp),(0,At.e$)(this._tmpTransf,this._tmpTransf,r,this._tmpAxis),(0,Ge.e)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Ge.e)(Go,e.up,this._tmpTransf),(0,Ge.g)(Go,n,this._tmpViewDir),(0,Qe.C)(this._lastPoint,this._tmpRotCurPoint),Go}};(0,n._)([(0,b.MZ)()],qo.prototype,"pivot",void 0),qo=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.RotateController")],qo);const Go=(0,P.vt)(),Bo=(0,P.vt)();class ko extends no.l{constructor(e,t,i,n){super(!0),this._view=e,this.pointerAction=t,this._pivot=i,this.registerIncoming("drag",n,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,ro.c)(e.data,this.pointerAction))return;const i=(0,v.gs)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new qo({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let Wo=class extends Uo{constructor(){super(...arguments),this._pickPoint=(0,P.vt)(),this._tmpP0=(0,Ke.vt)(),this._panAxisAngle=Ns(),this._tmpRayDir=(0,P.vt)(),this._tmpRayDirPick=(0,P.vt)(),this._targetOnSphere=(0,P.vt)(),this._navMode=sa.Horizontal,this._tmpRay={origin:(0,P.vt)(),direction:(0,P.vt)()},this.dragBeginPoint=(0,v.gs)(),this._normalizedAnchorPoint=(0,Ke.vt)(),this._constraintOptions=new bn(_n.ALL_EXCEPT_COLLISION,gn.ZOOM,0,this.startCamera),this._sphere=(0,vn.c)(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){var t;if(!this.active)return;(0,Qe.C)(this.dragBeginPoint,e),Xs(this.startCamera,e,this._normalizedAnchorPoint);const i=(0,We.tO)(this.view.spatialReference),n=ha(this._intersectionHelper,this.startCamera,e,i,ks.Ellipsoid,0===this.view.map.ground.opacity?Qs:{});if(this._navMode=da(this.startCamera,e,i),this._navMode===sa.Horizontal)this._hasPickPoint=!!n.scenePickPoint,this._pickPoint=null!==(t=n.scenePickPoint)&&void 0!==t?t:this._pickPoint,this._sphere=n.sphere;else{let t;(0,qs.vr)(this.startCamera,e,this._tmpRay),(0,Ge.n)(this._tmpRay.direction,this._tmpRay.direction),null!=n.scenePickPoint&&((0,Ge.f)(this._tmpRayDirPick,this.startCamera.eye,n.scenePickPoint),t=(0,Ge.l)(this._tmpRayDirPick));const i=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,jo);let r=(0,_e.qE)(Math.min(30,1/Math.abs((0,Ge.k)(jo,this._tmpRay.direction)))*i,Zs[0],Zs[1]);const s=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);r=null!=s?s:r,r=null!=t?Math.min(r,t):r,this._hasPickPoint=!0,(0,Ge.h)(this._tmpRay.direction,this._tmpRay.direction,r),(0,Ge.g)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===sa.Horizontal){(0,Ge.f)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,Ge.l)(this._tmpRayDir);Xs(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let n=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&n<r&&(n=r),Math.abs(t-n)<1e-6)return;if(this._hasPickPoint&&n<t){const e=1-(1-n/t)*(1-this._sphere[3]/(0,Ge.l)(this.currentCamera.center));this.currentCamera.center=(0,Ge.h)(Zo,this.currentCamera.center,e)}(0,Ge.h)(this._tmpRayDir,this._tmpRayDir,-n/t),this.currentCamera.eye=(0,Ge.g)(Zo,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Fr((0,Qe.Io)(this.dragBeginPoint,e)),Nr(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(ma(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Hs(this._pickPoint,this._targetOnSphere,this._panAxisAngle),$s(this.currentCamera,(0,vn.g)(this._sphere),this._panAxisAngle))}else{const t=(0,Ge.l)(this._tmpRay.direction);Xs(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let n=t*2**i;const r=this.view.state.constraints.minimumPoiDistance;if(i<0&&n<r&&(n=r),Math.abs(t-n)<1e-6)return;(0,Ge.h)(this._tmpRayDir,this._tmpRay.direction,1-n/t),this.currentCamera.eye=(0,Ge.g)(Zo,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Ge.g)(Zo,this.currentCamera.center,this._tmpRayDir)}Gn(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};Wo=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.global.ZoomController")],Wo);const Zo=(0,P.vt)(),jo=(0,P.vt)();let Qo=class extends Uo{constructor(){super(...arguments),this._tmpP=(0,P.vt)(),this._tmpDir=(0,P.vt)(),this._tmpN=(0,P.vt)(),this._tmpP0=(0,Ke.vt)(),this._tmpPoi=(0,P.vt)(),this._tmpRayDir=(0,P.vt)(),this.dragBeginPoint=(0,v.gs)(),this._normalizedAnchorPoint=(0,Ke.vt)(),this._constraintOptions=new bn(_n.ALL,gn.ZOOM,0,this.startCamera,(0,P.vt)()),this._plane=(0,zs.vt)()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;(0,Qe.C)(this.dragBeginPoint,e),Xs(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?Qs:{});(0,Ge.f)(this._tmpDir,this._tmpP,this.startCamera.eye);const i=(0,Ge.l)(this._tmpDir);(0,Ge.n)(this._tmpDir,this._tmpDir);const n=Math.abs(this.view.camera.position.z);let r=(0,_e.qE)(Math.min(30,1/Math.abs((0,Ge.k)(Yo,this._tmpDir)))*n,Zs[0],Zs[1]);const s=this.view._stage.renderView.getMinimalDepthForArea((0,Ka.ds)(this.view),e[0],e[1],this.view.state.camera,80);r=null!=s?s:r,r=t?Math.min(r,i):r,(0,Ge.h)(this._tmpDir,this._tmpDir,r),(0,Ge.g)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Ge.f)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Ge.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Ge.F)(this._tmpN,this._tmpN),(0,zs.O_)(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.active)return;(function(e,t,i,n){return(0,zs.Ui)(e,(0,qs.Z4)(t,i,ja),n)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,Ge.c)(this._tmpPoi,this.currentCamera.center),Xs(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,Qe.C)(this._normalizedAnchorPoint,this._tmpP0),(0,Ge.f)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=(0,Ge.l)(this._tmpRayDir);let n=i*(1-t);this._constraintOptions.interactionDirection&&((0,Ge.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Ge.h)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const r=this.view.state.constraints.minimumPoiDistance;t>=0&&n<r&&(n=r,t=-(n-i)/i),Math.abs(i-n)<1e-6||((0,Ge.h)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Ge.g)(Xo,this.currentCamera.eye,this._tmpRayDir),(0,Ge.m)(Xo,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Xo[2]=Math.max(this.startCamera.center[2],Xo[2]):Xo[2]=Math.min(this.startCamera.center[2],Xo[2]),this.currentCamera.center=Xo,this._constraintOptions.interactionFactor=Fr((0,Qe.Io)(this.dragBeginPoint,e)),Nr(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};Qo=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.local.ZoomController")],Qo);const Xo=(0,P.vt)(),Yo=(0,P.fA)(0,0,1);class $o extends no.l{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!(0,ro.c)(e.data,this.pointerAction))return;const i=(0,v.gs)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Wo({view:this._view}):this._cameraController=new Qo({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}var Ko=i(71372),Jo=i(34170);let el=class extends Uo{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Kr.i,this._headingStart=0,this._constraintOptions=new bn(_n.ALL,gn.NONE,0,new Kr.i,null,fn.LOOK_AROUND)}handleEventGamepad(e){const t=(0,Jo.f4)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,Jo.IK)(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,(0,Jo.UM)(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=(0,Jo.UM)(this._keysButtonState,this._transformation);(0,Jo.IK)(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),null!==(i=this._constraintOptions.interactionStartCamera)&&void 0!==i&&i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,ll),this._applyDisabledMovementTypes(ll),this._applyPan(ll.pan),this._applyRotate(ll.rotate),this._applyZoom(ll.zoom),this._applyAscend(ll.ascend),this._constraintOptions.interactionType=gn.NONE,this._constraintOptions.selection=_n.COLLISION,Nr(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,Ge.f)(cl,t.center,t.eye),(0,Ge.e)(cl,cl,e.matrix),t.center=(0,Ge.g)(cl,cl,t.eye),t.up=(0,Ge.e)(cl,t.up,e.matrix),this._constraintOptions.interactionType=gn.LOOK_AROUND,this._constraintOptions.selection=_n.ALL_EXCEPT_COLLISION,Nr(this.view,t,this._constraintOptions)}_applyPan(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,Ge.e)(cl,t.eye,e.matrix),t.center=(0,Ge.e)(cl,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Ge.e)(cl,t.up,e.matrix)),this._constraintOptions.interactionType=gn.PAN,this._constraintOptions.selection=_n.ALL,Nr(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Ge.g)(cl,this.currentCamera.eye,(0,Ge.h)(Ls.rq.get(),t,e)),(0,Ge.c)(hl,t),(0,Ge.F)(hl,hl),this._constraintOptions.interactionDirection=hl,this._constraintOptions.interactionType=gn.ZOOM,this._constraintOptions.selection=_n.ALL_EXCEPT_COLLISION,Nr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Ls.rq.get());if(this._constraintOptions.interactionDirection=(0,Ge.c)(hl,t),this.view.state.isGlobal){const t=(0,Ge.l)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,Ge.h)(cl,this.currentCamera.eye,i),this.currentCamera.center=(0,Ge.h)(cl,this.currentCamera.center,i)}else{const i=(0,Ge.h)(Ls.rq.get(),t,e);this.currentCamera.eye=(0,Ge.g)(cl,this.currentCamera.eye,i),this.currentCamera.center=(0,Ge.g)(cl,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=gn.ASCEND,this._constraintOptions.selection=_n.COLLISION,Nr(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=_n.ALL_EXCEPT_COLLISION,Nr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,At.D_)(e.pan.matrix),e.rotate.enabled=!1,(0,At.D_)(e.rotate.matrix)}(i);const n=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(n,t,i):this._calculateControlTransformationGlobal(n,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,cl)}_calculateControlTransformationLocal(e,t,i){const{viewRight:n,viewForward:r}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Ge.s)(Ls.rq.get(),r[0],r[1],0);(0,Ge.n)(o,o);const l=s.translation[0]*e.pan;if(0!==l){const e=(0,Ge.h)(Ls.rq.get(),n,l);(0,At.Tl)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-s.translation[1]*e.pan;if(0!==t){const e=(0,Ge.h)(Ls.rq.get(),o,t);(0,At.Tl)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=s.zoom*e.zoom;break}case"zoom":i.zoom=(-s.translation[1]+s.zoom)*e.zoom;break;default:(0,Pe.Xb)(a.mode)}const c=s.translation[2]*e.ascend;i.ascend=c;const h=-s.heading*e.rotate;0!==h&&((0,At.e$)(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Ls.rq.get())),i.rotate.enabled=!0);const d=s.tilt*e.rotate,u=Wn(this.view.renderCoordsHelper,t.center,t.eye),p=(0,_e.qE)(u+d,be.min,be.max)-u;p&&((0,At.e$)(i.rotate.matrix,i.rotate.matrix,p,n),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:n,viewRight:r}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Ge.b)(Ls.rq.get(),r,n);(0,Ge.n)(o,o),(0,Ge.F)(o,o),Sa(this.startCamera,t,s,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(ll.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=s.translation[2]*e.ascend;i.ascend=c;const h=-s.heading*e.rotate;0!==h&&((0,At.e$)(i.rotate.matrix,i.rotate.matrix,h,this._tmpCamera.eye),i.rotate.enabled=!0);const d=s.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&((0,At.e$)(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=s.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const n=(0,We.tO)(this.view.spatialReference),r=na(be.min,t.origin,i,n);let s=0,a=0;const o=Ls.rq.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){s=na(Wn(this.view.renderCoordsHelper,o,t.origin),t.origin,i,n),a=na(be.max,t.origin,i,n)}else{(0,vn.e)((0,vn.h)(vn.t,i+n.radius),t,o);s=ra(Math.PI+(0,Is.g7)(t.direction,o),t.origin,i,n),a=ra(be.max,t.origin,i,n)}return(0,_e.qE)(s+e,r,a)-s}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:n}=this.view,r=n.getAltitude(e),s=t+Math.abs(r-t);return n.setAltitude(i,s,e),s}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:n}=this.view.state,{direction:r}=(0,G.ZC)(this.view,t,0,il,dl),s=i.intersectManifoldClosestSilhouette((0,yn.LV)(t,r),e,Ls.rq.get()),a=(0,Ge.q)(t,s),o=i.intersectManifoldClosestSilhouette((0,yn.LV)(t,(0,Ge.E)(Ls.rq.get(),t,n.center)),e,Ls.rq.get()),l=(0,Ge.q)(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:n,isGlobal:r}=i,s=t.intersectManifoldClosestSilhouette(n.ray,this._filteredSurfaceElevation,Ls.rq.get());if(r){const t=(0,Ge.f)(Ls.rq.get(),e,s),i=(0,Ge.l)(t);(0,Ge.h)(t,t,1/i);const n=(0,Ge.n)(Ls.rq.get(),e),r=(0,_e.XM)((0,Ge.k)(n,t));return i*Math.sin(Math.min(nl,r))}{const i=(0,Ge.c)(Ls.rq.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),(0,Ge.q)(s,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:sl}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+(0,We.tO)(this.view.spatialReference).radius,{camera:n,isGlobal:r}=this.view.state,s=Ls.rq.get(),a=this._getPointAbsoluteSurfaceElevation(n.eye,t,s),o=this._clampedDistanceToSurface(t,s),l=n.width/2,c=rl*n.width,h=rl*n.width,d=o*Math.tan(.5*n.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(s),m=a-t;return{pan:(r?u:d)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*m-m),zoom:2**(c*e/l)*o-o,rotate:(0,_e.qE)(p*h,al,ol)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,At.D_)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,At.D_)(e.rotate.matrix))}static activatesFor(e,t){const i=(0,Jo.f4)(t,e.navigation.gamepad,tl);return!("end"===t.action||(0,Jo.IK)(i))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],el.prototype,"gamepadDevice",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],el.prototype,"disableMovements",void 0),el=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.GamepadKeyboardController")],el);const tl={translation:[0,0,0],heading:0,tilt:0,zoom:0},il=80,nl=(0,_e.kU)(il),rl=.75,sl=5,al=(0,_e.kU)(30),ol=(0,_e.kU)(80),ll={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Mt.vt)()},rotate:{enabled:!1,matrix:(0,Mt.vt)()}},cl=(0,P.vt)(),hl=(0,P.vt)(),dl=(0,Ko.N)();class ul extends no.l{constructor(e){super(!0),this._view=e,this._watchHandles=new je.A,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([(0,g.watch)((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),g.initial),(0,g.watch)((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||el.activatesFor(this._view,e.data)){if(!i){const t=new el({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t)&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var pl,ml=i(20292);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(pl||(pl={}));class _l extends no.l{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:te.RT.Local},this._keyToNumber={[t.left]:pl.LEFT,[t.right]:pl.RIGHT,[t.forward]:pl.FORWARD,[t.backward]:pl.BACKWARD,[t.up]:pl.UP,[t.down]:pl.DOWN,[t.headingLeft]:pl.HEADINGLEFT,[t.headingRight]:pl.HEADINGRIGHT,[t.tiltUp]:pl.TILTUP,[t.tiltDown]:pl.TILTDOWN,[t.zoomIn]:pl.ZOOMIN,[t.zoomOut]:pl.ZOOMOUT},this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=(0,ml.e)((e=>e?null:this._handleStop()))}onUninstall(){var e;null!==(e=this._visibilityHandle)&&void 0!==e&&e.remove(),this._handleStop()}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new el({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleStop(){var e;(null===(e=this._cameraControllerKeyboard)||void 0===e?void 0:e.active)&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class gl extends no.l{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,(e=>this._handleMouseWheel(e)))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Xa({view:this._view,mode:"interaction"}):new Ja({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,(0,v.gs)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class fl{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let vl=class extends As{constructor(){super(...arguments),this._beginCamera=new Kr.i,this._elapsedTimeSec=0,this.constraintOptions=new bn(_n.ALL,gn.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ee.A}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Nr(this.view,t,this.constraintOptions)}};vl=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.MomentumController")],vl);let yl=class extends vl{constructor(e){super(e),this.interactionType=gn.PAN,this._tmpPan=(0,P.vt)()}momentumStep(e,t){const i=this.momentum.value(e);(0,Ge.h)(this._tmpPan,this.momentum.direction,i),t.eye=(0,Ge.f)(bl,t.eye,this._tmpPan),t.center=(0,Ge.f)(bl,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};(0,n._)([(0,b.MZ)({constructOnly:!0})],yl.prototype,"momentum",void 0),yl=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],yl);const bl=(0,P.vt)(),wl=(0,P.vt)(),xl=(0,P.vt)();let Cl=class extends vl{constructor(e){super(e),this.interactionType=gn.PAN}momentumStep(e,t){const i=this.momentum.value1(e),n=this.momentum.value2(e);(0,Ge.c)(xl,t.eye),(0,Ge.n)(xl,xl),(0,Ge.b)(this.momentum.axis2,xl,this.momentum.axis1),Ca(t,wl,this.momentum.axis1,i,this.momentum.axis2,n)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Cl.prototype,"momentum",void 0),Cl=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Cl);let Tl=class extends vl{set center(e){this._set("center",(0,P.o8)(e))}set axis(e){this._set("axis",(0,P.o8)(e))}constructor(e){super(e),this.interactionType=gn.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);$s(t,this.center,Fs(this.axis,i))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Tl.prototype,"momentum",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Tl.prototype,"center",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Tl.prototype,"axis",null),Tl=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.MomentumController")],Tl);let Al=class extends vl{set zoomCenter(e){this._set("zoomCenter",(0,P.o8)(e))}constructor(e){super(e),this.interactionType=gn.ZOOM,this.constraintOptions.interactionDirection=(0,P.vt)()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;(0,Ge.c)(i,t.eye);const n=this.momentum.valueDelta(0,e);Js(t,this.zoomCenter,n,this.view.state.constraints.minimumPoiDistance),(0,Ge.E)(i,t.eye,i)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Al.prototype,"momentum",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Al.prototype,"zoomCenter",null),Al=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Al);let Ml=class extends vl{set screenCenter(e){this._set("screenCenter",(0,v.gs)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,P.o8)(e))}constructor(e){super(e),this.interactionType=gn.ZOOM,this.radius=0,this._tmpSceneCenter=(0,P.vt)(),this._tmpZoomAxisAngle=Ns(),this._sphere=(0,vn.c)()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);ea(this._sphere,t,i),this.constraintOptions.interactionType=gn.ZOOM,Nr(this.view,t,this.constraintOptions),ma(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Hs(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),$s(t,(0,vn.g)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=gn.PAN}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ml.prototype,"momentum",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ml.prototype,"screenCenter",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ml.prototype,"sceneCenter",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ml.prototype,"radius",void 0),Ml=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Ml);var Sl=i(95395),Pl=i(65353);class Rl{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}var El=i(92e3);const Ol=1e-5;class Dl extends El.t{constructor(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;super(e,t,i),this._angularVelocity1=n,this.axis1=r,this.angularVelocity2=s,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Il{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,P.vt)(),this._tmpAxis2=(0,P.vt)(),this._tmpAngles=(0,Ke.vt)(),this._time=new Pl.S(.3),this._screen=[new Pl.S(.4),new Pl.S(.4)],this._angle1=new Rl(.6),this._angle2=new Rl(.6),this._axis1=(0,P.vt)(),this._axis2=(0,P.vt)(),this._lastScene=(0,P.vt)()}addMomentumDirectRotation(e,t,i,n,r,s){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=va(this._lastScene,t,this._tmpAxis2,n,r,s);this._angle2.update(0),(0,Ge.p)(this._tmpAxis2)<Ol?e=0:(0,Ge.n)(this._axis1,this._tmpAxis2),this._angle1.update(e),(0,Ge.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,n,r,s,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;wa(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,r,s,a,!1),(0,Ge.p)(this._tmpAxis2)<Ol?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Ge.n)(this._axis1,this._tmpAxis1),(0,Ge.n)(this._axis2,this._tmpAxis2)),(0,Ge.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,r=null==i||null==n?0:i/n;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}createMomentum(e,t,i){const n=this._time.filteredDelta,r=this._angle1.filteredValue,s=this._angle2.filteredValue,a=null==n||null==s?0:s/n;return new Dl(e,t,i,null==n||null==r?0:r/n,this._axis1,a,this._axis2)}}var Ll=i(31158),Nl=i(13121);let Fl=class extends Uo{constructor(){super(...arguments),this._smoothRotation=new fl(.05),this._rotationAxis=(0,P.vt)(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=(0,zs.vt)(),this._beginRadius=0,this._smoothScaling=new fl(.05),this._zoomCenterScreen=(0,v.gs)(),this._zoomMomentumEstimator=new Nl.y,this._rotationMomentumEstimator=new Ll.H,this._panSphericalMomentumEstimator=new Il,this._panPlanarMomentumEstimator=new Sl.O,this._adjustedSphere=(0,vn.c)(),this._tmp3d=(0,P.vt)(),this._tmpScreenPointArray=(0,v.gs)(),this._beginScreenPoint=(0,v.gs)(),this._beginScenePoint=(0,P.vt)(),this._screenPickPoint=(0,v.gs)(),this._scenePickPoint=(0,P.vt)(),this._mode=sa.Horizontal,this._sphere=(0,vn.c)(),this._pointerCount=0,this._tmpInteractionDirection=(0,P.vt)(),this._beginCamera=new Kr.i,this._constraintOptions=new bn(_n.ALL,gn.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-Es.wf.normalize((0,_e.kU)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,v.WA)(e.center,this._screenPickPoint),(0,Qe.C)(this._beginScreenPoint,this._screenPickPoint);const t=(0,We.tO)(this.view.spatialReference),i=ha(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,ks.Silhouette,0===this.view.map.ground.opacity?Qs:{});null!=i.scenePickPoint&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,(0,Ge.c)(this._beginScenePoint,this._scenePickPoint),this._mode=da(this.startCamera,this._screenPickPoint,t),this._mode===sa.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._mode===sa.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===sa.Horizontal?new Ml({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Al({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Tl({view:this.view,momentum:i,center:(0,vn.g)(this._sphere),axis:this._rotationAxis});if(this._mode===sa.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Cl({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new yl({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=(0,Ge.F)(this._tmp3d,this.startCamera.viewForward);(0,zs.O_)(this._scenePickPoint,i,this._panningPlane);const n=(0,v.gs)(this._screenPickPoint[0],0),r=(0,P.vt)(),s=(0,Ge.l)(this.startCamera.eye);this._adjustedSphere[3]=s<this._sphere[3]?s-100:this._sphere[3],ma(this._adjustedSphere,this.startCamera,n,r);const a=(0,v.r_)();this.startCamera.projectToRenderScreen(r,a);const o=(0,P.vt)(),l=(0,P.vt)(),c=(0,P.vt)();(0,Ge.f)(o,this._scenePickPoint,this.currentCamera.eye);const h=(0,Ge.l)(o);(0,Ge.n)(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=u?u:d;p=t?Math.min(p,h):p,(0,Ge.c)(c,(0,Ge.g)(l,this.currentCamera.eye,(0,Ge.h)(l,o,p))),this._panningPlane[3]=-(0,Ge.k)((0,zs.Qj)(this._panningPlane),c),this.startCamera.center=(0,Ge.g)(l,this.startCamera.eye,(0,Ge.h)(l,this.startCamera.viewForward,p));const m=(0,v.WA)(e.center,this._tmpScreenPointArray);Ks(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),ea(this._sphere,this.currentCamera,this._smoothScaling.value),(0,v.WA)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=gn.ZOOM,this._constraintOptions.interactionFactor=Fr(e.radius-this._beginRadius),Nr(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=(0,v.WA)(e.center,this._tmpScreenPointArray);ma(this._sphere,this.currentCamera,t,this._tmp3d),Ta(this._beginScenePoint,(0,Ge.k)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Ma(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Aa(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=gn.PAN,this._constraintOptions.interactionFactor=Fr((0,Qe.Io)(this._screenPickPoint,t)),Nr(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){(0,Ge.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Ge.F)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+Ys(e.angle-t),n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(i);const r=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(r,.001*e.timestamp),$s(this.currentCamera,(0,vn.g)(this._sphere),Fs(this._rotationAxis,r)),this._constraintOptions.interactionType=gn.TUMBLE,this._constraintOptions.interactionFactor=Fr(e.radius*i),Nr(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=(0,v.WA)(e.center,this._tmpScreenPointArray);Ks(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(ua(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=gn.PAN,this._constraintOptions.interactionFactor=Fr((0,Qe.Io)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Nr(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Js(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=gn.ZOOM,this._constraintOptions.interactionFactor=Fr(e.radius-this._beginRadius),Nr(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){(0,Ge.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Ge.F)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=Ys(i);const n=t+i,r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(n);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),$s(this.currentCamera,(0,vn.g)(this._sphere),Fs(this._rotationAxis,s)),this._constraintOptions.interactionType=gn.TUMBLE,this._constraintOptions.interactionFactor=Fr(e.radius*s),Nr(this.view,this.currentCamera,this._constraintOptions)}};Fl=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.global.PinchAndPanController")],Fl);const Vl=(0,P.fA)(0,0,1),Hl=16/180*Math.PI;let Ul=class extends Uo{constructor(){super(...arguments),this._rotationValueSmooth=new fl(.05),this._scalingValueSmooth=new fl(.05),this._planeHorizontal=(0,zs.vt)(),this._planeVertical=(0,zs.vt)(),this._rotationMomentumEstimator=new Ll.H,this._panMomentumEstimator=new Sl.O(300,12,.9),this._zoomMomentumEstimator=new Nl.y,this._beginRadius=0,this._beginCenter=(0,P.vt)(),this._beginAngle=0,this._tmpPoints=[],this._panMode=sa.Horizontal,this._beginCenterScreen=(0,v.gs)(),this._tmpCentroid3d=(0,P.vt)(),this._tmpCentroid2d=(0,v.gs)(),this._tmp2d=(0,v.gs)(),this._pointerCount=0,this._beginCamera=new Kr.i,this._constraintOptions=new bn(_n.ALL,gn.NONE,0,this._beginCamera)}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,v.WA)(e.center,this._beginCenterScreen),(0,zs.UB)(Vl,0,this._planeHorizontal);const i=(0,P.vt)(),n=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,0===this.view.map.ground.opacity?Qs:{}),r=(0,P.vt)();(0,Ge.F)(r,this.startCamera.viewForward);const s=(0,P.vt)();(0,Ge.c)(s,Vl);const a=(0,Ge.k)(r,s),o=(0,_e.YN)(a<0?-a:a);this._panMode=o>=Hl?sa.Horizontal:sa.Vertical;const l=Math.min(5,1/Math.abs((0,Ge.k)(s,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,zs.mP)(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||(0,zs.ze)(this._planeHorizontal,this._planeHorizontal);const c=(0,P.vt)(),h=(0,P.vt)(),d=(0,P.vt)();(0,Ge.f)(c,i,this.currentCamera.eye);const u=(0,Ge.l)(c);if((0,Ge.n)(c,c),this._panMode===sa.Vertical){(0,Ge.h)(s,s,a),(0,Ge.f)((0,zs.Qj)(this._planeVertical),r,s),(0,Ge.n)((0,zs.Qj)(this._planeVertical),(0,zs.Qj)(this._planeVertical)),(0,zs.mP)(this._planeVertical,this._planeVertical,i);const t=this.view._stage.renderView.getMinimalDepthForArea((0,Ka.ds)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let o=null!=t?t:l;o=n?Math.min(o,u):o,(0,Ge.c)(d,(0,Ge.g)(h,this.currentCamera.eye,(0,Ge.h)(h,c,o))),this._planeVertical[3]=-(0,Ge.k)((0,zs.Qj)(this._planeVertical),d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),ia(this._tmpPoints,this._beginCenter)}else{const t=n?u:l;(0,Ge.c)(d,(0,Ge.g)(h,this.currentCamera.eye,(0,Ge.h)(h,c,t))),this._planeHorizontal[3]=-(0,Ge.k)((0,zs.Qj)(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),ia(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._panMode===sa.Horizontal?this._planeHorizontal:this._planeVertical,n=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),Js(this.currentCamera,n,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=gn.ZOOM,this._constraintOptions.interactionFactor=Fr(Math.abs(e.radius-this._beginRadius)),Nr(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),ia(this._tmpPoints,this._tmpCentroid3d),(0,v.WA)(e.center,this._tmpCentroid2d),ua(this.currentCamera,n,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=gn.PAN,this._constraintOptions.interactionFactor=Fr((0,Qe.Io)(this._beginCenterScreen,this._tmpCentroid2d)),Nr(this.view,this.currentCamera,this._constraintOptions),t){const t=n,i=this._rotationValueSmooth.value,r=i+Ys(e.angle-i),s=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=s,this._rotationValueSmooth.update(r);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=(0,zs.Qj)(this._planeHorizontal);$s(this.currentCamera,t,Fs(o,a)),this._constraintOptions.interactionType=gn.TUMBLE,this._constraintOptions.interactionFactor=Fr(Math.abs(e.radius*a)),Nr(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Al({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Tl({view:this.view,momentum:i,center:this._beginCenter,axis:(0,zs.Qj)(this._planeHorizontal)});const n=this._panMomentumEstimator.evaluateMomentum();return n?new yl({view:this.view,momentum:n}):null}_computePlanePoints(e,t,i,n){n.length=e.size;const r=this._tmp2d;let s=0;return e.forEach((e=>{r[0]=e.x,r[1]=e.y,void 0===n[s]&&(n[s]=(0,P.vt)()),Ks(t,i,r,n[s]),s+=1})),n}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Ul=(0,n._)([(0,x.$)("esri.views.3d.state.controllers.local.PinchAndPanController")],Ul);class zl extends no.l{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!(0,ro.c)(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Fl({view:this._view}):new Ul({view:this._view})}}class ql extends no.l{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Gl extends no.l{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class Bl extends Gl{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class kl extends Gl{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Wl extends no.l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){var t,i,n;const r=this._invert?-1:1,s=(0,v.gs)(0,e.data.delta*r);switch(e.data.action){case"begin":null!==(t=this._cameraController)&&void 0!==t&&t.end(),this._cameraController=new qo({view:this._view,pivot:zo.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(s);break;case"update":null===(i=this._cameraController)||void 0===i||i.update(s);break;case"end":null!==(n=this._cameraController)&&void 0!==n&&n.end(),this._cameraController=null}}}var Zl=i(82827),jl=i(57308),Ql=i(24158),Xl=i(62234),Yl=i(14168),$l=i(30735),Kl=i(51648),Jl=i(88029);class ec extends no.l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new Jl.w({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,n=1/0,r=-1/0,s=1/0;for(const{x:m,y:_}of t.pointers.values())i=Math.max(i,m),n=Math.min(n,m),r=Math.max(r,_),s=Math.min(s,_);let a=-1/0,o=1/0,l=-1/0,c=1/0;for(const{x:m,y:_}of e.pointers.values())a=Math.max(a,m),o=Math.min(o,m),l=Math.max(l,_),c=Math.min(c,_);const h=i-n,d=r-s,u=a-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-h)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,n)=>{const r=t.pointers.get(n);i=Math.min(i,Math.abs(e.y-r.y))})),i>=this._threshold}}let tc=class extends T.A{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){var e;return!(null===(e=this._inputManager)||void 0===e||!e.updating)}get latestPointerType(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerType}get latestPointerLocation(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerLocation}get multiTouchActive(){var e,t;return null!==(e=null===(t=this._inputManager)||void 0===t?void 0:t.multiTouchActive)&&void 0!==e&&e}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=(0,p.pR)(this._inputManager)}connect(){const e=this.view;this._source=new Zl.S(this.view.surface,e.input);const t=[new Yl.T,new $l.e,new Kl.P,new Xl.X(this.view.navigation),new ec],i=new jl.e({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Ql.B],jl.o.INTERNAL),this._modeDragPan=new zl(e,"primary"),this._modeDragRotate=new ko(e,"secondary",zo.CENTER),this._modeDragZoom=new $o(e,"tertiary");const n="b",r={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},s="n",a="p";i.installHandlers("navigation",[new ql(e),new so(e),new ul(e),new _l(e,r),new gl(e),new kl(e,a),new Bl(e,s),new ko(e,"primary",zo.EYE,[n]),new ko(e,"secondary",zo.CENTER,[n]),new zl(e,"tertiary",[n]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Wl(e)],jl.o.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this.addHandles((0,g.watch)((()=>{var e;return null===(e=this.view.navigation)||void 0===e?void 0:e.browserTouchPanEnabled}),(e=>{this._source.browserTouchPanningEnabled=!e}),g.initial))}isModifierKeyDown(e){var t,i;return null!==(t=null===(i=this._inputManager)||void 0===i?void 0:i.isModifierKeyDown(e))&&void 0!==t&&t}_updateMode(){var e;const t=this.mode,i=this.primaryDragAction,n=null===(e=ic.get(t))||void 0===e?void 0:e.get(i);n&&(this._modeDragPan&&(this._modeDragPan.pointerAction=n.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=n.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=n.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};(0,n._)([(0,b.MZ)()],tc.prototype,"view",void 0),(0,n._)([(0,b.MZ)({value:"pan"})],tc.prototype,"primaryDragAction",null),(0,n._)([(0,b.MZ)({value:"default"})],tc.prototype,"mode",null),(0,n._)([(0,b.MZ)({readOnly:!0})],tc.prototype,"updating",null),(0,n._)([(0,b.MZ)()],tc.prototype,"latestPointerType",null),(0,n._)([(0,b.MZ)()],tc.prototype,"latestPointerLocation",null),(0,n._)([(0,b.MZ)()],tc.prototype,"multiTouchActive",null),(0,n._)([(0,b.MZ)()],tc.prototype,"_inputManager",void 0),tc=(0,n._)([(0,x.$)("esri.views.3d.input.SceneInputManager")],tc);const ic=new Map,nc=new Map,rc=new Map;nc.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),nc.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),rc.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),rc.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),ic.set("default",nc),ic.set("pro",rc);const sc=tc;var ac=i(87663),oc=i(30015),lc=i(22955);let cc,hc,dc=!1,uc=!1,pc=!1,mc=!1,_c=null;function gc(e){pc=lc.b.DECONFLICTOR_SHOW_VISIBLE,mc=lc.b.DECONFLICTOR_SHOW_INVISIBLE,dc=pc||mc,uc=lc.b.DECONFLICTOR_SHOW_GRID,_c=null,dc||uc?_c=()=>function(e){null==cc&&(cc=document.createElement("canvas"),cc.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(cc));const{state:t}=e,{camera:i,pixelRatio:n}=t,{width:r,height:s}=i,a=r*n,o=s*n;cc.setAttribute("width","".concat(a,"px")),cc.setAttribute("height","".concat(o,"px")),cc.setAttribute("style","position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:".concat(r,"px;height:").concat(s,"px")),hc=cc.getContext("2d"),hc.clearRect(0,0,r,s),hc.font="12px Arial"}(e):cc&&(cc.parentElement.removeChild(cc),cc=null)}function fc(){_c&&(_c(),_c=null)}function vc(e,t,i,n,r){fc();const s=cc.height,a=hc;a.beginPath(),a.lineWidth=1,a.strokeStyle=r,a.moveTo(e,s-i),a.lineTo(t,s-i),a.stroke(),a.lineTo(t,s-n),a.stroke(),a.lineTo(t,s-i),a.stroke(),a.lineTo(e,s-i),a.stroke(),a.lineTo(e,s-i),a.stroke(),a.closePath()}function yc(e,t){dc&&(t&&pc||!t&&mc)&&vc(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var bc=i(89422),wc=i(12028),xc=i(84248),Cc=i(96791);const Tc=(0,P.vt)(),Ac=(0,Ye.vt)(),Mc=(0,Ye.vt)(),Sc=(0,P.vt)(),Pc=(0,Mt.vt)(),Rc=(0,vn.c)(),Ec=(0,yn.vt)(),Oc=(0,P.vt)(),Dc=(0,L.vt)();class Ic{constructor(){this.aabr=(0,L.vt)(),this.distance=0,this.culled=!1,this.visible=!1}}class Lc{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var Nc;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(Nc||(Nc={}));class Fc{constructor(){this.camera=new Kr.i,this.slicePlane=(0,N.a)(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),(0,N.c)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Vc=class extends T.A{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new Fc,this._state=Nc.Idle,this._active=new Map,this._visible=new Map,this._iterators=new zc,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==Nc.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Nc.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case Nc.Idle:this._startUpdate(),e.madeProgress();case Nc.Process:if(this._state=Nc.Process,!this._processActiveGraphics(e))return;case Nc.Sort:if(this._state=Nc.Sort,!this._sortVisibleGraphics(e))return;case Nc.Deconflict:if(this._state=Nc.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if(!uc||!hc)return;fc();const i=hc;let n=0;for(let r=0;r<e.accBinsNumX;r++)for(let t=0;t<e.accBinsNumY;t++){const s=e.accBins[r][e.accBinsNumY-1-t];n+=s.length;const a=r*e.accBinsSizeX,o=(r+1)*e.accBinsSizeX,l=t*e.accBinsSizeY,c=(t+1)*e.accBinsSizeY;i.fillText(s.length.toFixed(),a+5,l+15),vc(a,o,l,c,"blue")}i.fillText("total totalShownLabels: "+n,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)})(this,this._visible),this._state=Nc.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){var t;if(null==e||"object3d"!==e.type)return!1;const i=e.stageObject;if(1!==(null!==(t=null===i||void 0===i?void 0:i.geometries.length)&&void 0!==t?t:0))return!1;const n=null===i||void 0===i?void 0:i.geometries[0];return(null===n||void 0===n?void 0:n.material)instanceof xc.R}_startUpdate(){gc(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new Ic,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,bc.Z.DECONFLICTION,!0)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=(0,At.Qw)(Pc,this._viewState.camera.projectionMatrix),n="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0?Rc:null;let r=0;for(null!=n&&((0,Ge.e)((0,vn.g)(n),P.uY,this._viewState.camera.viewMatrix),n[3]=(0,We.tO)(this.view.spatialReference).radius,r=(0,vn.d)(n,P.uY));!e.done;){e.madeProgress();const s=t.next();if(!0===s.done)return this._resetActiveGraphicsIterator(),!0;const a=s.value,o=null===a||void 0===a?void 0:a.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(a,i,n,r),o.culled?this._visible.delete(a.graphics3DGraphic.graphic.uid):this._visible.set(a.graphics3DGraphic.graphic.uid,a))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===bc.u.LABEL;for(;!e.done;){e.madeProgress();const n=t.next();if(!0===n.done)return this._resetVisibleGraphicsIterator(),!0;const r=n.value,s=r.info[this.visibilityGroup];if(!s||s.culled){this._setGraphicVisibility(r,!1);continue}const a=r.graphics3DGraphic,o=!i||a.isVisible();s.visible=o&&!this._isConflicted(r),s.visible&&this._addToBins(r),this._setGraphicVisibility(r,s.visible),yc(s,s.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=Hc(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=Hc(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,n)=>{var r;const s=t.pushNew();s.id=n,s.visible=e.graphics3DGraphic.getVisibilityFlag(i,bc.Z.DECONFLICTION);const a=null===(r=e.info)||void 0===r?void 0:r[i];s.prio=e.graphics3DGraphic.deconflictionPriority,s.distance=a?a.distance:Number.MAX_VALUE})),yield;const n=t.iterableSort(((e,t)=>e.prio!==t.prio?t.prio-e.prio:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?e.visible?-1:1:e.id-t.id));for(let r=n.next();!r.done;r=n.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,n){const r=e.graphics3DGraphic;if(r.destroyed)return;const s=e.info[this.visibilityGroup];if(!r.isVisible(bc.u.GRAPHIC,bc.Z.DECONFLICTION))return void(s.culled=!0);const a=this.getGraphicsLayers(r);(0,L.Ie)(s.aabr);let o=null;for(const l of a){if(!this.layerSupportsDeconfliction(l))continue;const r=l.stageObject.geometries[0].material;if(null==o&&(o=Gc,this._getProjectionInfo(l,t,o),o.isOutsideScreen||this._isCulledBySlice(e,Tc)||null!=i&&this._isCulledByHorizon(o,i,n)))return void(s.culled=!0);this._expandBoundingRect(s,l,r,o)}null==o?s.culled=!0:(s.distance=o.distance,s.culled=!1)}_getProjectionInfo(e,t,i){const n=this._viewState.camera,r=e.stageObject,s=r.geometries[0],a=s.material,o=(0,vn.g)(r.boundingVolumeWorldSpace.bounds);(0,Ge.e)(Tc,o,n.viewMatrix);const l=s.attributes,c=l.get(li.r.NORMAL).data,h=l.get(li.r.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Tc,c,r.transformation,h,n,i.scaleInfo,Tc),(0,Xe.s)(Ac,Tc[0],Tc[1],Tc[2],1),(0,Xe.t)(Mc,Ac,n.projectionMatrix),(0,Ge.h)(i.positionNDC,Mc,1/Mc[3]),a.applyShaderOffsetsNDC(i.positionNDC,h,n,i.positionNDC,Sc),i.distanceWithoutPolygonOffset=n.depthNDCToWorld(Sc[2]),i.distance=Sc[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:n.depthNDCToWorld(i.positionNDC[2]),(0,Xe.s)(Mc,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,Xe.t)(Ac,Mc,t),(0,Xe.b)(Ac,Ac,1/Ac[3]),(0,Ge.s)(i.positionView,Tc[0],Tc[1],Tc[2])}_isCulledByHorizon(e,t,i){return(0,Ge.c)(Ec.direction,e.positionView),(0,Ge.s)(Ec.origin,0,0,0),!!(0,vn.i)(t,Ec,Oc)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,N.e)(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,n){let{positionNDC:r,scaleInfo:s}=n;const a=this._viewState.camera,o=t.getScreenSize(qc);(0,wc.MD)(o,s.factor,o),o[0]*=a.pixelRatio,o[1]*=a.pixelRatio;const l=(0,L.cY)(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,Dc),(0,_e.Cc)(0,a.fullWidth,.5+.5*r[0]),(0,_e.Cc)(0,a.fullHeight,.5+.5*r[1])),c=this.marginFactor;if(0!==c){const e=c*Math.min((0,L.VL)(l),(0,L.uJ)(l));l[0]-=e,l[1]-=e,l[2]+=e,l[3]+=e}(0,L.fT)(e.aabr,l,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];let n=!0;for(let r=Math.floor(i.aabr[0]/this._accBinsSizeX);r<=Math.floor(i.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let e=Math.floor(i.aabr[1]/this._accBinsSizeY);e<=Math.floor(i.aabr[3]/this._accBinsSizeY);e++){if(e<0||e>=this._accBinsNumY)continue;n=!1;const s=this._accBins[r][e];for(let e=0;e<s.length;e++){const n=s.data[e],r=n.info[this.visibilityGroup];if(r&&r.visible&&n.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,L.HY)(r.aabr,i.aabr)))return!0}}return n}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new oc.A)}}else for(let i=0;i<this._accBinsNumX;i++)for(let e=0;e<this._accBinsNumY;e++)this._accBins[i][e].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),n=Math.floor(t.aabr[2]/this._accBinsSizeX),r=Math.floor(t.aabr[1]/this._accBinsSizeY),s=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let a=i;a<=n;a++)if(!(a<0||a>=this._accBinsNumX))for(let t=r;t<=s;t++)t<0||t>=this._accBinsNumY||this._accBins[a][t].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,bc.Z.DECONFLICTION,t),this.visibilityGroup===bc.u.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*Hc(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}(0,n._)([(0,b.MZ)({constructOnly:!0})],Vc.prototype,"view",void 0),(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],Vc.prototype,"updating",null),Vc=(0,n._)([(0,x.$)("esri.views.3d.layers.graphics.Deconflictor")],Vc);class Uc{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class zc{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.active=e,this.visible=t,this.sort=i,this.sortArray=new oc.A({allocator:e=>e||new Uc})}}const qc=(0,Ke.vt)();const Gc=new class{constructor(){this.positionView=(0,P.vt)(),this.positionNDC=(0,P.vt)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Cc.D}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let Bc=class extends Vc{constructor(e){super(e),this.visibilityGroup=bc.u.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Gt.G;const t=performance.now();if(e.state!==So.M.IDLE&&t-this._lastDeconfliction<2e3)return Gt.G;super.runTask(e),this.state===Nc.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Bc.prototype,"parent",void 0),Bc=(0,n._)([(0,x.$)("esri.views.3d.layers.graphics.LabelDeconflictor")],Bc);let kc=class extends Vc{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=bc.u.GRAPHIC,this._marginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.camera}),(()=>{this._updateViewState(),this.setDirty()})),(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity}),((e,t)=>{1!==e&&1!==t||this.setDirty()})),(0,g.watch)((()=>{var e;return null===(e=this.view)||void 0===e?void 0:e.slicePlane}),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),g.initial)]),this._frameTask=this.view.resourceController.scheduler.registerTask(qt.W6.GRAPHICS_DECONFLICTOR,this),this._labels=new Bc({view:this.view,parent:this})}destroy(){this._labels=(0,p.pR)(this._labels),this._frameTask=(0,p.xt)(this._frameTask)}get marginFactor(){return this._marginFactor}set marginFactor(e){this._marginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&Wc(e));t.setVisibilityFlag(bc.u.GRAPHIC,bc.Z.DECONFLICTION,i)}_updateViewState(){var e;(null===(e=this.view)||void 0===e?void 0:e.state)&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;null!=e&&(0,N.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){(0,ac.Bs)(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const n=i.graphic.uid,r=new Lc(i,e.symbolCreationContext.slicePlaneEnabled);t.set(n,r),Wc(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r)}_removeGraphic(e,t){const i=t.graphic.uid,n=e.get(i);n&&(this.removeFromActiveGraphics(n),this._labels.removeFromActiveGraphics(n),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Wc(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(bc.u.GRAPHIC,bc.Z.DECONFLICTION,!0)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(null===t||void 0===t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function Wc(e){const t=e.layer;return!(null===t||void 0===t||!t.featureReduction||"selection"!==t.featureReduction.type)}kc=(0,n._)([(0,x.$)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],kc);var Zc=i(6918),jc=i(90632),Qc=i(33836),Xc=i(4763),Yc=i(45097),$c=i(3789),Kc=i(45308),Jc=i(482);var eh=i(53574);class th{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustumBoundingSphereCenter=(0,P.vt)(),this._frustumBoundingSphereRadius=0,this._frustum=new wo.P(e),this._extendedFrustum=new wo.P(e),this._intersector=new eh.O({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===te.RT.Global&&e.lij[0]>=ih&&e.lij[0]<nh,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==Qc.b.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const t=wo.P.nearFarLineIndices,i=e.mutablePoints;for(const n of t){const[e,t]=n,r=i[e],s=i[t];(0,Ge.f)(oh,s,r),(0,Ge.h)(oh,oh,sh),(0,Ge.g)(i[t],r,oh)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let t=Qc.b.INVISIBLE;const i=this._cache.get(e.id);if(null!=i)return i;const n=hh.acquire();e.getChildren(n);for(const r of n){const e=this.calculate(r);if(e!==Qc.b.INVISIBLE&&(t=e,e===Qc.b.VISIBLE_ON_SURFACE))break}return hh.release(n),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const i=this._cache.get(e.id);if(null!=i)return i;const n=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,n),n}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===te.RT.Global&&e.lij[0]<rh?this._calculateSingleTileVisibilitySided(e,!1)===Qc.b.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===te.RT.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Oh;(0,Ge.n)(i,e.direction);const n=e.points,r=Dh;(0,Ge.z)(r,n[4],t);const s=.5*(0,Ge.k)(r,r)/(0,Ge.k)(i,r),a=this._frustumBoundingSphereCenter;(0,Ge.r)(a,t,i,s);const o=1+s;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,i=e.extent,n=this._renderCoordsHelper.spatialReference,r=bh;if(r[0]=i[0],r[1]=i[1],r[2]=0,r[3]=i[2],r[4]=i[3],r[5]=0,!(0,Kc.projectBuffer)(r,t,0,r,n,0,2))return!1;const s=wh;(0,Ge.s)(s[0],r[0],r[1],0),(0,Ge.s)(s[1],r[3],r[1],0),(0,Ge.s)(s[2],r[3],r[4],0),(0,Ge.s)(s[3],r[0],r[4],0);const a=xh;(0,Ge.s)(a,.5*(r[0]+r[3]),.5*(r[1]+r[4]),.5*(r[2]+r[5]));const o=Ch;(0,Ge.s)(o,0,0,1);const l=.5*(0,Ge.o)(s[0],s[2]),c=this._frustum,h=this._frustumBoundingSphereRadius,d=this._frustumBoundingSphereCenter,u=Lh;(0,Ge.z)(u,d,a);const p=(0,Ge.k)(o,u),m=Ih;if((0,Ge.r)(m,a,o,p),(0,Ge.o)(m,d)>l+h)return!1;const _=yh,g=p+h,f=p-h;for(let v=0;v<4;++v)(0,Ge.r)(_[v],s[v],o,g),(0,Ge.r)(_[v+4],s[v],o,f);return!gh(c.planes,_,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,i=e.extent,n=this._renderCoordsHelper.spatialReference;if(e.lij[0]<fh)return!0;const r=wh,s=.5*(i[0]+i[2]);if((0,Ge.s)(r[0],i[0],i[1],0),(0,Ge.s)(r[1],i[2],i[1],0),(0,Ge.s)(r[2],i[2],i[3],0),(0,Ge.s)(r[3],i[0],i[3],0),(0,Ge.s)(r[4],s,i[1],0),(0,Ge.s)(r[5],s,i[3],0),!function(e,t,i,n,r,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const o=(0,Jc.jd)(t,r,Jc.N9);if(null==o)return!1;if(o===Jc.pO){if(e===n&&i===s)return!0;const t=i+a;for(let r=i,a=s;r<t;++r,++a)(0,Ge.c)(n[a],e[r]);return!0}const l=i+a;for(let c=i,h=s;c<l;++c,++h)o(e[c],0,n[h],0);return!0}(r,t,0,r,n,0,6))return!1;const a=r[0][2]>0,o=r[3][2]<0,l=a||o,c=(0,We.tO)(n).radius;if(l){const e=(0,P.fA)(0,0,1),t=Ah;dh(t,e,r[0]);const i=Mh;if(dh(i,e,r[1]),a){const n=Th,s=r[4],a=Sh;dh(a,s,e),dh(n,a,s);const o=r[0];(0,Ge.b)(o,t,n),ph(o,c);const l=r[1];(0,Ge.b)(l,i,n),ph(l,c)}else if(o){const n=Th,s=r[5],a=Sh;dh(a,s,e),dh(n,s,a);const o=r[3];(0,Ge.b)(o,n,t),ph(o,c);const l=r[2];(0,Ge.b)(l,n,i),ph(l,c)}}const h=xh;{const e=Uh;(0,Ge.z)(e,r[3],r[0]),(0,Ge.n)(e,e);const t=zh;(0,Ge.g)(t,r[0],r[3]),(0,Ge.h)(t,t,.5);const i=-(0,Ge.k)(t,e),n=qh,s=Gh;(0,Ge.g)(n,r[0],r[1]),(0,Ge.h)(n,n,.5),(0,Ge.g)(s,r[2],r[3]),(0,Ge.h)(s,s,.5);const a=Bh;(0,Ge.z)(a,s,n),(0,Ge.n)(a,a);const o=-(i+(0,Ge.k)(e,n))/(0,Ge.k)(e,a);(0,Ge.r)(h,n,a,o),ph(h,c)}const d=this._frustumBoundingSphereRadius,u=this._frustumBoundingSphereCenter,p=this._frustum,m=p.planes;if(r.some((e=>p.intersectsPoint(e))))return!0;if(p.intersectsPoint(h))return!0;const _=Ph;(0,Ge.n)(_,h);const g=Fh;(0,Ge.z)(g,u,Nh);const f=(0,Ge.k)(g,_);if(f<-d)return!1;const v=Eh;(0,Ge.n)(v,r[0]);const y=(0,Ge.k)(v,_);if(y<=0)return!0;const b=Rh;(0,Ge.h)(b,_,f);const w=(0,Ge.o)(b,u),x=t.isWGS84,C=e.lij,T=x&&C[2]===2**C[0]-1,A=x&&0===C[2],M=A?Jh:T?$h:Xh,S=A?ed:T?Kh:Yh,R=p.points;{const e=r,t=td,i=kh,n=Wh,s=Nh;for(const r of M){const a=e[r];if(uh(i,e[(r+1)%4],a),uh(n,s,a),dh(t,n,i),vh(t,R,1))return!1}}let E=null;if(f<2*d){const e=2.5*d;if(w>y*e+d)return!1;const t=Hh,i=e/y;for(let n=0;n<4;++n)(0,Ge.h)(t[n],r[n],i/c);(0,Ge.s)(t[4],0,0,0),E=t}else{const e=(f+d)/y,t=(f-d)/y,i=Vh;for(let n=0;n<4;++n){const s=r[n];(0,Ge.h)(i[n+4],s,t/c),(0,Ge.h)(i[n],s,e/c)}E=i}if(gh(m,E,E.length))return!1;const O=p.lines,D=Zh,I=jh;for(const P of S){(0,Ge.n)(D,r[P]);for(const e of O)if((0,Ge.n)(I,e.direction),nd(I,D,E,R))return!1}return!0}_calculateSingleTileVisibilitySided(e,t){if(this._isTileVisibleInFrustum(e)){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const i=(0,We.tO)(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._frustum,i,!0)?Qc.b.VISIBLE_ON_SURFACE:Qc.b.VISIBLE_WHEN_EXTENDED}return Qc.b.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,oh);this._aboveGround||(0,Ge.F)(t,t);const i=(0,_e.XM)(-(0,Ge.k)(t,e.viewForward));if(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum)return;const n=this._extendedFrustumParameters(),r=this._extendedFrustum.mutablePoints;for(let s=0;s<4;s++){const e=n.pointIndices[s],t=r[e],i=this._renderCoordsHelper.getAltitude(t);if(n.needsAltitudeAdjustment(i)){switch(this._renderCoordsHelper.worldUpAtPosition(t,oh),e){case Xc.J7.FAR_BOTTOM_LEFT:case Xc.J7.FAR_TOP_LEFT:case Xc.J7.NEAR_BOTTOM_LEFT:case Xc.J7.NEAR_TOP_LEFT:(0,zs.jb)(this._extendedFrustum.planes[Xc.FB.LEFT],oh,oh);break;case Xc.J7.FAR_BOTTOM_RIGHT:case Xc.J7.FAR_TOP_RIGHT:case Xc.J7.NEAR_BOTTOM_RIGHT:case Xc.J7.NEAR_TOP_RIGHT:(0,zs.jb)(this._extendedFrustum.planes[Xc.FB.RIGHT],oh,oh)}(0,Ge.h)(oh,oh,n.direction),this._renderCoordsHelper.intersectInfiniteManifold((0,yn.LV)(t,oh),n.zWithMargin,t)}}if(this._extendedFrustum.updatePoints(r),(0,zs.Cr)(r[Xc.J7.NEAR_BOTTOM_LEFT],r[Xc.J7.NEAR_BOTTOM_RIGHT],r[Xc.J7.NEAR_TOP_RIGHT],lh),(0,zs.Cr)(r[Xc.J7.NEAR_BOTTOM_RIGHT],r[Xc.J7.NEAR_TOP_RIGHT],r[Xc.J7.NEAR_TOP_LEFT],ch),(0,Ge.k)((0,zs.Qj)(lh),(0,zs.Qj)(ch))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[Xc.J7.NEAR_BOTTOM_LEFT],e[Xc.J7.NEAR_BOTTOM_RIGHT]]=[e[Xc.J7.NEAR_BOTTOM_RIGHT],e[Xc.J7.NEAR_BOTTOM_LEFT]]:[e[Xc.J7.NEAR_TOP_LEFT],e[Xc.J7.NEAR_TOP_RIGHT]]=[e[Xc.J7.NEAR_TOP_RIGHT],e[Xc.J7.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-ah;return{zWithMargin:e,pointIndices:wo.P.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+ah;return{zWithMargin:e,pointIndices:wo.P.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const ih=2,nh=6,rh=12,sh=.95,ah=1,oh=(0,P.vt)(),lh=(0,zs.vt)(),ch=(0,zs.vt)(),hh=new $c.A(Array,(e=>{4!==e.length&&(e[0]=new Qc.J,e[1]=new Qc.J,e[2]=new Qc.J,e[3]=new Qc.J)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));function dh(e,t,i){return(0,Ge.b)(e,t,i),(0,Ge.n)(e,e),e}function uh(e,t,i){return(0,Ge.z)(e,t,i),(0,Ge.n)(e,e),e}function ph(e,t){return(0,Ge.h)(e,e,t/(0,Ge.H)(e)),e}const mh=[Xc.FB.LEFT,Xc.FB.RIGHT,Xc.FB.BOTTOM,Xc.FB.TOP,Xc.FB.FAR];function _h(e,t,i){for(let n=0;n<i;++n)if((0,zs.mN)(e,t[n])<0)return!1;return!0}function gh(e,t,i){for(const n of mh)if(_h(e[n],t,i))return!0;return!1}const fh=3;function vh(e,t,i){for(const n of t)if((0,Ge.k)(n,e)<i)return!1;return!0}const yh=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],bh=[0,0,0,0,0,0],wh=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],xh=(0,P.vt)(),Ch=(0,P.vt)(),Th=(0,P.vt)(),Ah=(0,P.vt)(),Mh=(0,P.vt)(),Sh=(0,P.vt)(),Ph=(0,P.vt)(),Rh=(0,P.vt)(),Eh=(0,P.vt)(),Oh=(0,P.vt)(),Dh=(0,P.vt)(),Ih=(0,P.vt)(),Lh=(0,P.vt)(),Nh=(0,P.fA)(0,0,0),Fh=(0,P.vt)(),Vh=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],Hh=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],Uh=(0,P.vt)(),zh=(0,P.vt)(),qh=(0,P.vt)(),Gh=(0,P.vt)(),Bh=(0,P.vt)(),kh=(0,P.vt)(),Wh=(0,P.vt)(),Zh=(0,P.vt)(),jh=(0,P.vt)(),Qh=(0,P.vt)(),Xh=[0,1,2,3],Yh=[0,1,2,3],$h=[0,1,3],Kh=[0,1,3],Jh=[1,2,3],ed=[1,2,3],td=(0,P.vt)();const id=[0,0];function nd(e,t,i,n){const r=Qh;dh(r,e,t);const s=id;return function(e,t,i){let n=1/0,r=-1/0;for(const s of i){const e=(0,Ge.k)(t,s);n=Math.min(n,e),r=Math.max(r,e)}e[0]=n,e[1]=r}(s,r,i),function(e,t,i,n){let r=1/0,s=-1/0;for(const a of n){const n=(0,Ge.k)(i,a);if(r=Math.min(r,n),s=Math.max(s,n),r<=t&&s>=e)return!1}return!0}(s[0],s[1],r,n)}class rd{constructor(e){this._camera=new Kr.i,this._focusOnMap=[0,0],this._screenRect=(0,L.vt)(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new th(e.renderCoordsHelper)}begin(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,(0,L.fA)(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=(0,L.Io)(e.extent,this._focusOnMap),e.measures.visibility!==Qc.b.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=sd,i=1<<t,n=e.measures.screenRect;(0,L.Ie)(n);let r=0;const s=e.lij,a=s[0],o=a+t,l=s[1]<<t,c=s[2]<<t,h=this._tileSizeWithBias(e),d=h*h,u=this._camera,{frustum:p,viewport:m}=u;if(this._renderCoordsHelper.viewingMode===te.RT.Local||a>fh){const t=ld;this._tilingScheme.getExtent(s[0],s[1],s[2],t);const i=od,n=md,r=(0,L.Ie)();for(let e=0;e<4;++e)this._toRenderCoords(t,_d[e][0],_d[e][1],n[e]),u.projectToScreen(n[e],i[e]),(0,L.tK)(r,i[e]);const a=gh(p,n,4),o=r[0]>m[2]||r[1]>m[3]||r[2]<m[0]||r[3]<m[1];if(a||o)return void(e.measures.shouldSplit=!1)}for(let _=0;_<i;_++)for(let t=0;t<i;t++)if(r+=this._computeScreenArea(o,l+_,c+t,n),r>d)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===Qc.b.VISIBLE_WHEN_EXTENDED?this._tileSize*ad:this._tileSize}_computeScreenArea(e,t,i,n){this._tilingScheme.ensureMaxLod(e);const r=ld;this._tilingScheme.getExtent(e,t,i,r);const s=hd;return this._toRenderCoords(r,0,3,s[0]),this._toRenderCoords(r,2,3,s[1]),this._toRenderCoords(r,2,1,s[2]),this._toRenderCoords(r,0,1,s[3]),this._computeTriangleScreenArea([s[0],s[1],s[2]],n)+this._computeTriangleScreenArea([s[2],s[1],s[3]],n)}_computeTriangleScreenArea(e,t){const i=this._camera.frustum[Xc.FB.NEAR];let n=0,r=-1,s=-1;for(let a=0;a<3;++a)(0,zs.mN)(i,e[a])>0?(n++,-1===r&&(r=a)):-1===s&&(s=a);if(0===n)return this._computeTriangleScreenAreaInside(e,t);if(1===n){const n=ud,s=(r+1)%3,a=(r+2)%3,o=r;(0,Ge.c)(n[0],e[s]),(0,Ge.c)(n[1],e[a]),pd(n[2],e[a],e[o],i);const l=this._computeTriangleScreenAreaInside(n,t);return pd(n[1],e[s],e[o],i),l+this._computeTriangleScreenAreaInside(n,t)}if(2===n){const n=ud,r=s;(0,Ge.c)(n[0],e[r]);const a=(s+1)%3,o=(s+2)%3;return pd(n[1],e[r],e[a],i),pd(n[2],e[r],e[o],i),this._computeTriangleScreenAreaInside(n,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let i=0;i<3;i++)this._camera.projectToRenderScreen(e[i],dd),this._camera.renderToScreen(dd,od[i]),(0,L.fT)(t,od[i],t);return(0,Yc.Fm)(od[0],od[1],od[2])}_toRenderCoords(e,t,i,n){return cd[0]=e[t],cd[1]=e[i],cd[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(cd,this._tilingScheme.spatialReference,n),n}}const sd=2,ad=5,od=[(0,v.gs)(),(0,v.gs)(),(0,v.gs)(),(0,v.gs)()],ld=(0,L.vt)(),cd=(0,P.vt)(),hd=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],dd=(0,v.r_)(),ud=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)()];function pd(e,t,i,n){const r=(0,zs.mN)(n,t),s=(0,zs.mN)(n,i),a=Math.abs(s-r);(0,Ge.h)(e,t,Math.abs(s)/a),(0,Ge.r)(e,e,i,Math.abs(r)/a)}const md=[(0,P.vt)(),(0,P.vt)(),(0,P.vt)(),(0,P.vt)()],_d=[[0,3],[2,3],[2,1],[0,1]];var gd=i(42136);let fd=class extends T.A{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void u.A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,L.vt)();return(0,gd.k)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new a.A,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new oc.A}initialize(){this.addHandles([(0,g.watch)((()=>[this.tilingScheme,this.tileSize]),(()=>this._reset()),g.sync),(0,g.watch)((()=>{var e,t,i;return[this.tileSize,null===(e=this.cameraOnSurface)||void 0===e?void 0:e.location,this.tilingScheme,null===(t=this.viewState)||void 0===t?void 0:t.contentCamera,null===(i=this.focus)||void 0===i?void 0:i.location]}),(()=>this._setDirty()),g.syncAndInitial)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(qt.W6.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=(0,p.xt)(this._frameWorker)}addClient(){const e=(0,jc.c)();return this._clients.add(e),1===this._clients.size&&this._setDirty(),(0,h.hA)((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(qt.Bb))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=qt.W6.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=qt.W6.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){var e;if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new rd({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const t=this.viewState.contentCamera;this._tileMeasurements.begin(t,this.focus.location,null!==(e=this.cameraOnSurface.location.z)&&void 0!==e?e:0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map((t=>new Qc.J(t[0],t[1],t[2],e)))}_purgeHorizonTiles(e){if(e.sort(((e,t)=>{const i=e.measures.screenRect,n=t.measures.screenRect;return i[1]+i[3]-(n[1]+n[3])})),!(e.length>bd))return e.toArray();(0,L.Ie)(vd);for(let t=0;t<e.length;t++)if((0,L.fT)(vd,e.data[t].measures.screenRect,vd),(0,L.uJ)(vd)>yd)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!(0,L.HY)(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==Qc.b.INVISIBLE&&(i.measures.shouldSplit?(t.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const n of this.tiles.items)n.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===Qc.b.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"scheduler",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"tilingSchemeOwner",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"cameraOnSurface",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"focus",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"viewState",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fd.prototype,"terrain",void 0),(0,n._)([(0,b.MZ)()],fd.prototype,"tiles",void 0),(0,n._)([(0,b.MZ)()],fd.prototype,"tileSize",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],fd.prototype,"tilingScheme",null),(0,n._)([(0,b.MZ)()],fd.prototype,"filterExtent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],fd.prototype,"_filterExtentRect",null),(0,n._)([(0,b.MZ)({readOnly:!0})],fd.prototype,"_rootTileIds",null),(0,n._)([(0,b.MZ)({value:!1})],fd.prototype,"suspended",null),(0,n._)([(0,b.MZ)({readOnly:!0})],fd.prototype,"updating",null),fd=(0,n._)([(0,x.$)("esri.views.3d.layers.support.FeatureTileTree3D")],fd);const vd=(0,L.vt)(),yd=10,bd=50;var wd=i(68452);let xd=class extends T.A{constructor(){super(...arguments),this._propertiesPool=new Ao.M({camera:Kr.i},this),this._lastSeenCameraProjectionValues=new Kr.i,this.mode=So.M.ANIMATING,this._cssCamera=new Kr.i,this._camera=new Kr.i,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new B.A,this.viewingMode=te.RT.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new ve({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Ao.M({camera:Kr.i},this)}destroy(){var e;this.cameraController=null,null!==(e=this._propertiesPool)&&void 0!==e&&e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===te.RT.Global){const e=(0,We.tO)(this.spatialReference).radius;this.camera=new Kr.i({eye:(0,P.fA)(4*e,0,0),center:(0,P.fA)(e,0,0),up:(0,P.fA)(0,0,1)})}else this.camera=new Kr.i({eye:(0,P.fA)(0,0,100),center:(0,P.fA)(0,0,0),up:(0,P.fA)(0,1,0)})}get animation(){return this.cameraController instanceof As&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:n}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/n),e.width=Math.round(i/n),e}get camera(){return this._camera}set camera(e){e!==Td&&Td.copyFrom(e),Td.computeUp(this.viewingMode),this.events.emit("before-camera-change",Td);const t=this._camera;if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Td)&&(this._lastSeenCameraProjectionValues.copyFrom(Td),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Td)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Td),this._cameraChanged=!t.almostEquals(Td),this._cameraChanged)){const e=(0,wd.rs)((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===So.M.IDLE}get updating(){return this.mode!==So.M.IDLE}get contentCamera(){var e;return null!==(e=this._contentCamera)&&void 0!==e?e:this.camera}set contentCamera(e){this._contentCamera=null!=e?e.clone():null}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===te.RT.Global}get isLocal(){return this.viewingMode===te.RT.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?(null!==(t=this.cameraController)&&void 0!==t&&t.destroy(),e&&(this.removeHandles(Ad),this.addHandles((0,g.when)((()=>e.state===Cs.Finished||e.state===Cs.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Ad),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Cs.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==Cs.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Td.copyFrom(this._get("camera")),e(Td),this.camera=Td,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Kr.z.TOP]!==t.padding[Kr.z.TOP]||e.padding[Kr.z.RIGHT]!==t.padding[Kr.z.RIGHT]||e.padding[Kr.z.BOTTOM]!==t.padding[Kr.z.BOTTOM]||e.padding[Kr.z.LEFT]!==t.padding[Kr.z.LEFT]}};(0,n._)([(0,b.MZ)()],xd.prototype,"mode",void 0),(0,n._)([(0,b.MZ)({readOnly:!0,type:ee.A})],xd.prototype,"animation",null),(0,n._)([(0,b.MZ)({type:Kr.i})],xd.prototype,"cssCamera",null),(0,n._)([(0,b.MZ)()],xd.prototype,"_cssCamera",void 0),(0,n._)([(0,b.MZ)({type:Kr.i})],xd.prototype,"camera",null),(0,n._)([(0,b.MZ)()],xd.prototype,"_camera",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"pixelRatio",null),(0,n._)([(0,b.MZ)()],xd.prototype,"rasterPixelRatio",void 0),(0,n._)([(0,b.MZ)()],xd.prototype,"contentPixelRatio",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"alignPixelEnabled",null),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"updating",null),(0,n._)([(0,b.MZ)({})],xd.prototype,"_contentCamera",void 0),(0,n._)([(0,b.MZ)({type:Kr.i})],xd.prototype,"contentCamera",null),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"fixedContentCamera",null),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"constraints",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"events",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"isGlobal",null),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"isLocal",null),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"viewingMode",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],xd.prototype,"spatialReference",void 0),(0,n._)([(0,b.MZ)()],xd.prototype,"navigating",null),(0,n._)([(0,b.MZ)()],xd.prototype,"stationary",null),(0,n._)([(0,b.MZ)()],xd.prototype,"_cameraChanged",void 0),(0,n._)([(0,b.MZ)()],xd.prototype,"cameraController",null),xd=(0,n._)([(0,x.$)("esri.views.3d.state.ViewState")],xd);const Cd=xd,Td=new Kr.i,Ad="ViewStateHandles";var Md=i(12482),Sd=i(88220),Pd=i(3112),Rd=i(46571);class Ed{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new oc.A,this._tolerance=Ms.TH,this._tmpRay=(0,yn.vt)(),this._tmpRegion=(0,L.vt)(),this._validateHUDIntersector=(0,Ms.hz)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Nd(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Nd(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,n){return t.options.selectionMode=!1,t.options.store=Pd.oH.MIN,this.computeIntersection(e,t,n),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(zd,i,n),zd[0]+=.0466,zd[1]-=.0123,(0,qs.dk)(e,zd,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const n=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(n,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const n=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,Rd.i3)(n)&&n.intersector!==Pd.dz.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ms.TH;this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===Pd.dz.TERRAIN?1:t.type===Pd.dz.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===Pd.dz.TERRAIN?1:t.type===Pd.dz.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return(0,qs.Z4)(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==te.RT.Local||null==e||(0,Ge.g)(t,e.origin,(0,Ge.n)(Ls.rq.get(),e.direction)),!1}intersectElevationFromScreen(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,n)}_intersectElevation(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null==e)return null;const r=this._view,{renderCoordsHelper:s}=r,a=(0,lo.G9)(r.spatialReference),o=null!=t?t.mode:"absolute-height",l=(0,Md.M7)(t)/a,c=("on-the-ground"!==o?l+i:0)*a/s.unitInMeters,{camera:h}=r.state;if("absolute-height"===o){const t=null===s||void 0===s?void 0:s.getAltitude(h.eye),i=(0,Ge.k)((0,Ge.n)(Hd,e.direction),s.worldUpAtPosition(h.eye,Ud));if(t<c&&i<0||t>=c&&i>0)return null;if(s.intersectInfiniteManifold(e,c,Hd)){var d;const e=(0,Sd.zC)(r,Hd);return null!==(d=e.z)&&void 0!==d||(e.z=0),e.z-=l,e}return null}const u=(0,v.sc)(Ls.rq.get());h.projectToRenderScreen(e.origin,u);const p=new Fd(null,this._forEachLayer),{slicePlane:m}=r,_=null!=m?(0,Rd.Q5)(m):null,g=(0,Ms.hz)(this.viewingMode);g.options.store=Pd.oH.MIN,g.options.verticalOffset=c;const f=e.origin,y=(0,Ge.g)(Ls.rq.get(),f,e.direction);g.reset(f,y,h),g.point=u;const b=n?"type"in n&&"graphics"===n.type?e=>e.layerUid!==n.uid:e=>e.graphicUid!==n.uid:null;switch(o){case"relative-to-scene":{const e=e=>(!b||b(e))&&!!e.lastValidElevationBB;g.intersect(p.layers,u,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===Pd.dz.I3S||e.type===Pd.dz.TERRAIN||e.type===Pd.dz.TILES3D){const t=e.slicePlaneEnabled?_:null;e.intersect(g,t,g.rayBegin,g.rayEnd,u)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?_:null;e.intersect(g,t,g.rayBegin,g.rayEnd,u)}}))}if(g.results.min.getIntersectionPoint(Hd)){const e=(0,Sd.zC)(r,Hd);return e.z=i,e}return null}computeIntersection(e,t,i,n){if(null==e)return;const r=this._view.state.camera,s=(0,v.sc)(Ls.rq.get());r.projectToRenderScreen(e.origin,s);const a=new Fd(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const o=e.origin,l=(0,Ge.g)(Ls.rq.get(),e.origin,e.direction);t.reset(o,l,r),t.intersect(a.layers,s,this._tolerance);const c=this._view.slicePlane,h=null!=c?(0,Rd.Q5)(c):null;t.intersect(a.sliceableLayers,s,this._tolerance,h);const d=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerUid,r=Array.isArray(i),c=r?i:[i];r&&(t.options.filteredLayerUids=[]);let u=!1;for(const n of c)a.filterLayerUid(n)?u=!0:r&&t.options.filteredLayerUids.push(n);if(t.options.isFiltered=!u,e.isGround&&d||!t.options.isFiltered){const i=e.slicePlaneEnabled?h:null;e.intersect(t,i,o,l,s,n)}}));const u=Ls.rq.get(),p=this._view.basemapTerrain;if(i&&i.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(u)){var m,_;const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,n=Ls.rq.get();this._view.renderCoordsHelper.fromRenderCoords(u,n,p.spatialReference),n[2]=null!==(m=null===(_=this._view.elevationProvider)||void 0===_?void 0:_.getElevation(u[0],u[1],u[2],i,"ground"))&&void 0!==m?m:0,e.intersect(t,n,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;(0,L.C)(this._tmpRegion,L.qv);const i=this._view.state.camera,n=[],r=this._tmpRegion,s=e=>{const t=new Id(e);i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),n.push(t),(0,L.tK)(r,t.screenPoint)};e.sortResults(t.all),null!=t.min.dist&&s(t.min);for(const g of t.all)t.min.target.object!==g.target.object&&t.max.target.object!==g.target.object&&s(g);if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&s(t.max),!n.length)return;r[0]===r[2]&&(r[2]+=1),r[1]===r[3]&&(r[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,r[0]-Od),c=Math.max(0,r[1]-Od),h=Math.min((0,L.VL)(r)+2*Od,a-l),d=Math.min((0,L.uJ)(r)+2*Od,o-c);if(h<=0||d<=0)return;const u=new Uint8Array(h*d*4);this._view._stage.renderer.readHUDVisibility(l,c,h,d,u);let p=!0;const m=null==e.results.max.dist;let _=0;for(const g of n)for(const t of Dd){const i=4*(Math.min(g.screenPoint[0]+t[0],a)-r[0]+(Math.min(g.screenPoint[1]+t[1],o)-r[1])*h);if(!(i<0||i>=u.length)&&u[i]){p&&(e.results.min.copy(g.result),p=!1),m&&e.results.max.copy(g.result),e.options.store===Pd.oH.ALL&&e.results.all.splice(_++,0,g.result);break}}}}const Od=1,Dd=(()=>{const e=[],t=Od;for(let i=-t;i<=t;i++)for(let n=-t;n<=t;n++)e.push([n+t,i+t]);return e})();class Id{constructor(e){this.result=e,this.screenPoint=(0,v.r_)()}}let Ld;function Nd(e){return Ld&&Ld.viewingMode===e||(Ld=(0,Ms.hz)(e)),Ld}class Fd{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=null===e||void 0===e?void 0:e.include,this.exclude=null===e||void 0===e?void 0:e.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function Vd(e){return"object"==typeof e&&"intersect"in e}const Hd=(0,P.vt)(),Ud=(0,P.vt)(),zd=(0,v.r_)();var qd=i(94683),Gd=i(95225);let Bd=class extends(B.A.EventedMixin(T.A)){get spatialReference(){var e;return null===(e=this.view)||void 0===e||null===(e=e.basemapTerrain)||void 0===e?void 0:e.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=(0,p.pR)(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,n,r){if(this._cacheEnabled&&null!=this.lastElevationQuery){const s=this.lastElevationQuery;if(e===s.x&&t===s.y&&i===s.z&&(0,ke.aI)(n,s.spatialReference)&&r===s.queryContext)return s.result}let s=null;return s=kd(s,this._im,e,t,i,n,r),null==s&&(s=kd(s,this._ground,e,t,i,n,r)),"scene"===r&&(s=kd(s,this._scene,e,t,i,n,r)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:n,queryContext:r,result:s}),s}getSphereElevationBounds(e,t,i){const n=new Gd.H;function r(r){for(const s of r)if(s.getSphereElevationBounds){const r=s.getSphereElevationBounds(e,t,i);null!=r&&n.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}}return r(this._ground),r(this._im),"scene"===i&&r(this._scene),n}getRootElevationBounds(){const e=new Gd.H;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;const o=this._getElevationQuery(n);try{const l=await o.queryElevation(e,t,s,a);return"scene"===r?kd(l,this._scene,e,t,i,n,r):l}catch(ve){return(0,_.QP)(ve),this.getElevation(e,t,i,n,r)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.view.spatialReference;const t=this._cachedQuery;if(null!=t&&(0,ke.aI)(e,t.spatialReference))return t;null===t||void 0===t||t.destroy({completeTasks:!0});const{wkid:i,wkt:n,wkt2:r,latestWkid:s}=e,a=new qd.I(this.view.resourceController.scheduler,new k.A({wkid:i,wkt:n,wkt2:r,latestWkid:s}),(()=>{var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function kd(e,t,i,n,r,s,a){for(const o of t){const t=o.getElevation(i,n,r,s,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}(0,n._)([(0,b.MZ)({constructOnly:!0})],Bd.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],Bd.prototype,"spatialReference",null),Bd=(0,n._)([(0,x.$)("esri.views.3d.support.CombinedElevationProvider")],Bd);class Wd{static isValidProfile(e){return e in Wd.profiles}static getDefaultProfile(){return(0,d.A)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=Wd.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;const n=t.sceneService.object,r=i.sceneService.object;n.lodFactor=r.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}}Wd.test={reset(){const e=jd();for(const t of Object.keys(e))Wd.profiles[t]=e[t]}};const Zd={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function jd(){const e=!!(0,d.A)("esri-mobile"),t=!!(0,d.A)("ios"),i=(0,Si.l5)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,reduceTileLevelDifferences:!0},fadeDuration:(0,Si.l5)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Zd.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!(0,d.A)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+Zd.GalaxyS20:750+Zd.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!(0,d.A)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+Zd.SurfacePro7:1500+Zd.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=jd()}(Wd||(Wd={}));const Qd=Wd;var Xd=i(80935),Yd=i(69539);const $d=new Yd.A([0,255,255]),Kd=new Yd.A([0,0,0]);let Jd=class extends T.A{constructor(){super(...arguments),this.color=$d.clone(),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=Kd.clone(),this.shadowDifference=.2}};(0,n._)([(0,b.MZ)({type:Yd.A})],Jd.prototype,"color",void 0),(0,n._)([(0,b.MZ)({type:Yd.A})],Jd.prototype,"haloColor",void 0),(0,n._)([(0,b.MZ)()],Jd.prototype,"haloOpacity",void 0),(0,n._)([(0,b.MZ)()],Jd.prototype,"fillOpacity",void 0),(0,n._)([(0,b.MZ)()],Jd.prototype,"shadowOpacity",void 0),(0,n._)([(0,b.MZ)({type:Yd.A})],Jd.prototype,"shadowColor",void 0),(0,n._)([(0,b.MZ)()],Jd.prototype,"shadowDifference",void 0),Jd=(0,n._)([(0,x.$)("esri.views.3d.support.HighlightOptions")],Jd);const eu=Jd;var tu,iu=i(39483),nu=i(71334),ru=i(70414);class su{constructor(e,t){this.spatialReference=t,this.unitInMeters=(0,lo.GA)(this.spatialReference,(0,We.tO)(this.spatialReference).metersPerDegree);const i=e&&"portalItem"in e?e.portalItem:void 0;this._geometryServiceURLPromise=(0,iu.getGeometryServiceURL)(i).catch((()=>{throw new l.A("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(e){const t=await this._geometryServiceURLPromise;let i,n=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],n=!1);const r=i.map((e=>e instanceof oo.A?e:new oo.A(e,this.spatialReference))),s=new ru.A({geometries:r,outSpatialReference:k.A.WGS84}),a=(await(0,nu.C)(t,s)).map((e=>"point"===e.type?[e.x,e.y]:void 0)).filter((e=>!!e));return n?a:a[0]}}!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(tu||(tu={}));const au=[tu.ELEVATION,tu.MAP];var ou=i(53787);async function lu(e,t){var i;const{results:n,ground:r}=await(0,ou.oZ)(e,t),s=(!r.layer||!(0,H.Eq)(r.layer.type))&&r.mapPoint,a=[],o=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),l=s?function(e,t){const i=new Set,n=[];for(let s=e.basemapTerrain.numLayers(tu.MAP)-1;s>=0;s--){const t=e.basemapTerrain.layerViewByIndex(s,tu.MAP);i.add(t.layer.uid),n.push(t)}const r=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:s}of r){const e=t.get(s);e&&(i.add(s),n.push(e))}return n.reverse(),{layerUids:i,layerViews:n}}(e,o):cu;let c=0,h=0;const d=()=>{const e=l.layerViews[h];s&&e&&"fetchPopupFeaturesAtLocation"in e&&a.push({mapPoint:r.mapPoint,layerView:e}),++h};let u=null;for(;c<n.length||h<l.layerViews.length;){var p,m,_;const t=n[c];if(t&&"graphic"!==t.type)++c;else if("scene"!==(null===t||void 0===t||null===(p=t.layer)||void 0===p?void 0:p.type)||(null===t||void 0===t||null===(m=t.layer)||void 0===m?void 0:m.parent)!==(null===e||void 0===e||null===(_=e.map)||void 0===_?void 0:_.basemap))if(t){var g,f,v,y;const e=null===(g=t.layer)||void 0===g?void 0:g.uid,i=l.layerUids.has(e)&&t.distance===r.distance,n=o.get(null===(f=t.layer)||void 0===f?void 0:f.uid);if(null!==(v=u)&&void 0!==v||(u=t.mapPoint),h<l.layerViews.length&&(i||(null!==(y=t.distance)&&void 0!==y?y:0)>r.distance)&&l.layerViews[h]!==n){d();continue}a.push({graphic:t.graphic,layerView:n}),++c}else d();else++c}return null!==(i=u)&&void 0!==i||(u=r.mapPoint),{hits:a,location:u}}const cu={layerUids:new Set,layerViews:[]};let hu=class extends T.A{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};(0,n._)([(0,b.MZ)()],hu.prototype,"minTotalNumberOfFeatures",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"maxTotalNumberOfFeatures",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"maxNumberOfDrawCalls",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"maxTotalNumberOfVertices",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"snapshotAvailable",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"polygonLodFactor",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"polylineLodFactor",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"skipHighSymbolLods",void 0),(0,n._)([(0,b.MZ)()],hu.prototype,"uncompressedTextureDownsamplingEnabled",void 0),hu=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],hu);let du=class extends T.A{constructor(){super(...arguments),this.lodFactor=1}};(0,n._)([(0,b.MZ)()],du.prototype,"lodFactor",void 0),du=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],du);let uu=class extends T.A{constructor(){super(...arguments),this.object=new du,this.point=new du,this.integratedMesh=new du,this.pointCloud=new du,this.uncompressedTextureDownsamplingEnabled=!1}};(0,n._)([(0,b.MZ)({type:du})],uu.prototype,"object",void 0),(0,n._)([(0,b.MZ)({type:du})],uu.prototype,"point",void 0),(0,n._)([(0,b.MZ)({type:du})],uu.prototype,"integratedMesh",void 0),(0,n._)([(0,b.MZ)({type:du})],uu.prototype,"pointCloud",void 0),(0,n._)([(0,b.MZ)()],uu.prototype,"uncompressedTextureDownsamplingEnabled",void 0),uu=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],uu);let pu=class extends T.A{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.reduceTileLevelDifferences=!0}};(0,n._)([(0,b.MZ)()],pu.prototype,"lodBias",void 0),(0,n._)([(0,b.MZ)()],pu.prototype,"angledSplitBias",void 0),(0,n._)([(0,b.MZ)()],pu.prototype,"vtlContentZoom",void 0),(0,n._)([(0,b.MZ)()],pu.prototype,"reduceTileLevelDifferences",void 0),pu=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],pu);let mu=class extends T.A{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};(0,n._)([(0,b.MZ)()],mu.prototype,"pixelRatio",void 0),(0,n._)([(0,b.MZ)()],mu.prototype,"maxTotalNumberOfFeatures",void 0),mu=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.HeatmapSettings")],mu);let _u=class extends T.A{constructor(){super(...arguments),this.graphics3D=new hu,this.sceneService=new uu,this.tiledSurface=new pu,this.heatmap=new mu,this.fadeDuration=(0,Si.l5)(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};(0,n._)([(0,b.MZ)({type:hu})],_u.prototype,"graphics3D",void 0),(0,n._)([(0,b.MZ)({type:uu})],_u.prototype,"sceneService",void 0),(0,n._)([(0,b.MZ)({type:pu})],_u.prototype,"tiledSurface",void 0),(0,n._)([(0,b.MZ)({type:mu})],_u.prototype,"heatmap",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"fadeDuration",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"antialiasingEnabled",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"physicallyBasedRenderingEnabled",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"highQualityTransparency",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"highResolutionAtmosphere",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"reflections",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"ambientOcclusion",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"memoryLimit",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"additionalCacheMemory",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"frameRate",void 0),(0,n._)([(0,b.MZ)()],_u.prototype,"maximumPixelRatio",void 0),_u=(0,n._)([(0,x.$)("esri.views.3d.support.QualitySettings.QualitySettings")],_u);const gu=_u;var fu=i(74487),vu=i(75540),yu=i(5729),bu=i(69495),wu=i(83450);let xu=class extends T.A{constructor(){super(...arguments),this.updating=!1}};(0,n._)([(0,b.MZ)({readOnly:!0})],xu.prototype,"updating",void 0),xu=(0,n._)([(0,x.$)("esri.views.3d.support.ResourceControllerMain")],xu);let Cu=class extends xu{constructor(){super(...arguments),this._immediateTask=qt.nu,this._normalTask=qt.nu,this._updatingObjects=(0,vu.v)([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=(0,qt.mj)(),this._memoryController=(0,bu.w)(this.view),this._streamDataLoader=new wu.gi,this._streamDataLoader.setup(yu.u1,yu.U0,this._scheduler),this.addHandles([(0,g.watch)((()=>{var e;return null===(e=this.view.state)||void 0===e?void 0:e.mode}),(e=>{null!=e&&(this._scheduler.state=e)}),g.sync),(0,g.watch)((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=(0,f.mg)({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(qt.W6.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(qt.W6.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,p.xt)(this._frameTask),this._streamDataLoader=(0,p.pR)(this._streamDataLoader),this._memoryController=(0,p.pR)(this._memoryController),this._scheduler=(0,p.pR)(this._scheduler),this.view=null}get updating(){var e,t,i,n;return!!(null!==(e=this._memoryController)&&void 0!==e&&e.updating||null!==(t=this._streamDataLoader)&&void 0!==t&&t.updating||null!==(i=this._immediateTask)&&void 0!==i&&i.updating)||(null===(n=this._updatingObjects)||void 0===n?void 0:n.value.some((e=>e.updating)))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,n,r)=>t.request(i,n,e,r),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],(0,h.hA)((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,Si.y)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};(0,n._)([(0,b.MZ)()],Cu.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_scheduler",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_memoryController",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_streamDataLoader",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_immediateTask",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_normalTask",void 0),(0,n._)([(0,b.MZ)()],Cu.prototype,"_updatingObjects",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Cu.prototype,"updating",null),Cu=(0,n._)([(0,x.$)("esri.views.3d.support.ResourceControllerImpl")],Cu);var Tu=i(55877),Au=i(65768);class Mu{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}class Su{constructor(e){var t,i,n,r;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=e.resourceController){var s;const t=e.resourceController.memoryController;this.totalMemory=(null!==(s=t.maxMemory)&&void 0!==s?s:0)*Tu.u.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=null!==(t=null===(i=e.basemapTerrain)||void 0===i?void 0:i.usedMemory)&&void 0!==t?t:0,this.edgesMemory=null!==(n=e._stage.renderer.usedMemory.edges)&&void 0!==n?n:0,this.fboMemory=null!==(r=e._stage.renderer.usedMemory.fbos)&&void 0!==r?r:0,e.allLayerViews.items.forEach((e=>{(0,Au.T)(e)&&this.layerPerformanceInfos.push(new Mu(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}var Pu=i(18690),Ru=i(11109),Eu=i(56516),Ou=i(14766);class Du{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const n=i?"gltfPBR:".concat(e):"gltf:".concat(e),r=this._gltfMemCache.get(n);return null!=r?Promise.resolve(r):this._loadOnce(this._gltfLoading,this._gltfMemCache,n,(t=>(0,Eu.y)(new Ru.R(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i="wosr:".concat(e,":").concat(t.disableTextures),n=this._wosrMemCache.get(i);return null!=n?Promise.resolve(n):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,(t=>(0,Ou.Hh)(e,t)),t)}async _loadOnce(e,t,i,n,r){(0,_.Te)(r);const s=(0,_.u7)(r,(()=>this._abortLoad(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:n({...r,signal:t.signal})},e.set(i,a)}try{const n=await a.promise;return t.put(i,n,n.size),e.delete(i),(0,_.Te)(r),n}finally{(0,p.xt)(s)}}_abortLoad(e,t){const i=e.get(t);null!=i&&--i.refCount>0||(e.delete(t),null!=i&&i.abortController.abort())}}var Iu=i(90534);let Lu=class extends T.A{constructor(e,t){var i;super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=null!==(i=null===t||void 0===t?void 0:t.registerTask(qt.W6.TEXTURE_UNLOAD))&&void 0!==i?i:qt.nu}normalizeCtorArgs(){return{}}destroy(){var e,t,i;super.destroy(),null!==(e=this._frameTask)&&void 0!==e&&e.remove(),null!==(t=this._textureRequests)&&void 0!==t&&t.forEach((e=>this._releaseTextureRequest(e))),null===(i=this._textureRequests)||void 0===i||i.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let n=this._textureRequests.get(i);if(!n){const e=new Fu;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.add(e.texture)),this._textureRequests.set(i,e),n=e}return n.referenceCount++,new Nu(i,n.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn("TextureCollection: texture doesn't exist: '".concat(e,"'"))}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){var t;if(!this._textureRequests)return;const i=this._textureRequests.get(e);!i||i.referenceCount>0||(null!==(t=i.texture)&&void 0!==t&&t.unload(),this._releaseTextureRequest(i),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?null===(t=this._stage)||void 0===t||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!=t?"".concat(e,".").concat(t,"px"):e}};(0,n._)([(0,b.MZ)()],Lu.prototype,"_frameTask",void 0),(0,n._)([(0,b.MZ)()],Lu.prototype,"updating",null),Lu=(0,n._)([(0,x.$)("esri.views.3d.support.TextureCollection")],Lu);class Nu{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class Fu{constructor(){this.referenceCount=0}}var Vu=i(96897);class Hu extends Lu{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){(0,_.Te)(i);const n=null===i||void 0===i?void 0:i.signal,r=this.makeUid(e,t);let s=this._textureRequests.get(r);if(!s){const i=new AbortController,n=this._streamDataRequester.request(e,"image",{uid:r,signal:i.signal});s=new Fu,s.abortController=i;const a=s;this._textureRequests.set(r,s),s.textureAsync=n.then((async i=>{const n=this._createTexture(e,i,t);return a.texture=n,a.abortController=null,await n.load(this._stage.renderView.renderingContext),this._stage.add(n),new Nu(r,n,(()=>this._release(r)))}),(e=>{throw a.abortController=null,e}))}s.referenceCount++;try{return await(0,_.qr)(s.textureAsync,n)}catch(a){throw this._release(r),a}}_createTexture(e,t,i){const n={width:t.width,height:t.height,wrap:{s:st.pF.CLAMP_TO_EDGE,t:st.pF.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,Iu.XJ)(e)){var r;if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}(null===(r=this._stage.renderView)||void 0===r?void 0:r.renderingContext.driverTest.svgPremultipliesAlpha.result)&&(n.preMultiplyAlpha=!1)}return new Vu.g(t,n)}}class Uu{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(yu.sK.SYMBOLOGY),this.objectResourceCache=new Du(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new Hu(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=(0,We.tO)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,wc.mt)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,wc.M4)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return(0,h.hA)();this._graphicsOwners.push(e);const t=(0,g.watch)((()=>{var t;return null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled}),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),(0,h.hA)((()=>{t.remove(),(0,Pu.Xy)(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>{var t;return!0===(null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled)}));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new je.A;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([(0,g.watch)((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,g.sync),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=(0,p.pR)(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;zu.distance=e.centerOnSurfaceInfrequent.distance,zu.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(zu),this.screenSizePerspectiveSettingsLabels.update(zu),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}const zu={distance:0,fovY:0};var qu=i(39356),Gu=(i(95444),i(37471)),Bu=i(27796),ku=i(21405);class Wu{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this.graphics=e,this._symbol=new Gu.A({symbolLayers:new a.A([new Bu.A({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new ku.A({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(null==t)return;this.hide();const i=new oo.A({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new qu.A({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){null!=this._graphic&&(this.graphics.remove(this._graphic),this._graphic=null)}}let Zu=class extends T.A{constructor(e){super(e)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Zu.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Zu.prototype,"surface",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Zu.prototype,"state",void 0),Zu=(0,n._)([(0,x.$)("esri.views.3d.support.PointOfInterest")],Zu);const ju=Array;let Qu=class extends Zu{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Ao.M({location:oo.A,renderLocation:ju},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=(0,P.vt)(),this._tmpPoint=new oo.A}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles((0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.layers}),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=(0,Ge.q)(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,G.Fj)(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var e,t;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),null===(e=this.map)||void 0===e||!e.ground)return this._updateSurfaceAltitude(0),Gt.G;const i=this.state.spatialReference;this._tmpPoint.spatialReference=i,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const n=(null!==(t=this._tmpPoint.z)&&void 0!==t?t:0)>Yu&&this.renderCoordsHelper.viewingMode===te.RT.Global&&(i.isWGS84||i.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:n?$u:0}).then((e=>{var t;return this._updateSurfaceAltitude(null!==(t=e.geometry.z)&&void 0!==t?t:0)})).catch((e=>{(0,_.zf)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null})),this._pendingElevationQueryController=r,Gt.G}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Xu,this._estimatedSurfaceAltitude,this._camera.eye),(0,Ge.j)(this._get("renderLocation"),Xu)||(this._set("renderLocation",(0,Ge.c)(this._propertiesPool.get("renderLocation"),Xu)),this.notifyChange("renderLocation"))}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Qu.prototype,"scheduler",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Qu.prototype,"cache",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Qu.prototype,"task",void 0),(0,n._)([(0,b.MZ)()],Qu.prototype,"location",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],Qu.prototype,"map",void 0),(0,n._)([(0,b.MZ)()],Qu.prototype,"renderLocation",void 0),(0,n._)([(0,b.MZ)()],Qu.prototype,"scale",null),(0,n._)([(0,b.MZ)()],Qu.prototype,"updating",null),Qu=(0,n._)([(0,x.$)("esri.views.3d.support.CameraOnSurface")],Qu);const Xu=(0,P.vt)(),Yu=1e5,$u=1e6,Ku=Array;let Ju=class extends Zu{constructor(e){super(e),this._propertiesPool=new Ao.M({location:oo.A,renderLocation:Ku},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,P.vt)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=(0,p.xt)(this._frameWorker),this._propertiesPool=(0,p.pR)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Gt.G}_updateRenderLocation(){const e=tp;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const n=ip;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,n)&&((0,Ge.c)(e,n),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Ge.q)(this._camera.eye,e):((0,Ge.h)(e,this._camera.viewForward,this._get("distance")),(0,Ge.g)(e,e,this._camera.eye)),(0,Ge.j)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Ge.c)(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const n=(0,We.tO)(this.renderCoordsHelper.spatialReference).radius,r=n+e,s=(0,Ge.p)(i.eye),a=s<r*r,o=(0,Ge.q)(i.eye,t);if(a&&o>n/4){const e=r-Math.sqrt(s);return(0,Ge.h)(t,i.viewForward,e),(0,Ge.g)(t,t,i.eye),!0}}else{var n,r;const e=null!==(n=this.surface)&&void 0!==n&&n.ready?this.surface.extent:null;null!=e&&(0,D.S)(e,null===(r=this.surface)||void 0===r?void 0:r.spatialReference,np,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,_e.qE)(t[0],np[0],np[2]),t[1]=(0,_e.qE)(t[1],np[1],np[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(lc.b.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,n=(0,Ge.q)(i,e),r=(0,Ge.q)(i,t);if(Math.abs(r-n)/n>ep)return!0}return!1}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Ju.prototype,"scheduler",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ju.prototype,"task",void 0),(0,n._)([(0,b.MZ)()],Ju.prototype,"distance",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Ju.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Ju.prototype,"location",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Ju.prototype,"renderLocation",void 0),(0,n._)([(0,b.MZ)()],Ju.prototype,"updating",void 0),Ju=(0,n._)([(0,x.$)("esri.views.3d.support.CenterOnSurface")],Ju);const ep=.05,tp=(0,P.vt)(),ip=(0,P.vt)(),np=(0,L.vt)();class rp{constructor(e){this._handles=new je.A,this.events=new B.A,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=(0,p.pR)(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this._handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this._handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",sp)}}const sp={},ap=Array;let op=class extends Zu{constructor(e){super(e),this._propertiesPool=new Ao.M({location:oo.A,renderLocation:ap},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([(0,g.watch)((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),(0,g.watch)((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(qt.W6.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=(0,p.pR)(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,n=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,lp);const r=Math.max(0,(Math.acos((0,Ge.k)(lp,n.viewForward))-.5*Math.PI)*(n.aboveGround?1:-1));if(Number.isNaN(r)){if(!e||!(0,Ge.G)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,Ge.c)(e,t),this._set("renderLocation",e)}return Gt.G}const s=1-(0,_e.qE)(r/(.5*Math.PI),0,1),a=s*s*s;this._calculateScreenHorizontalEdgeOnSurface(hp);const o=this._propertiesPool.get("renderLocation");return(0,Ge.m)(o,t,hp,a),e&&(0,Ge.G)(e,o)||this._set("renderLocation",o),Gt.G}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter((0,v.r_)());if(i[1]=t.aboveGround?t.padding[Kr.z.BOTTOM]:t.fullHeight-t.padding[Kr.z.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const n=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,cp)){(0,Ge.f)(cp,cp,t.eye);const i=(0,Ge.n)(cp,cp);if(this.renderCoordsHelper.intersectInfiniteManifold((0,yn.LV)(t.eye,i),n,e))return e}return this.renderCoordsHelper.setAltitude(e,n,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,n._)([(0,b.MZ)()],op.prototype,"_dirty",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],op.prototype,"scheduler",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],op.prototype,"centerOnSurface",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],op.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,n._)([(0,b.MZ)()],op.prototype,"updating",null),(0,n._)([(0,b.MZ)()],op.prototype,"location",null),(0,n._)([(0,b.MZ)()],op.prototype,"renderLocation",void 0),(0,n._)([(0,b.MZ)()],op.prototype,"worldUnitsPerContentPixel",null),op=(0,n._)([(0,x.$)("esri.views.3d.support.pointsOfInterest.Focus")],op);const lp=(0,P.vt)(),cp=(0,P.vt)(),hp=(0,P.vt)();let dp=class extends T.A{get surface(){var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=(0,P.vt)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([(0,g.watch)((()=>{var e,t;return[null===(e=this.surfaceView)||void 0===e?void 0:e.spatialReference,null===(t=this.surfaceView)||void 0===t?void 0:t.extent]}),(()=>this._update())),(0,g.on)((()=>{var e;return null===(e=this.surface)||void 0===e?void 0:e.layers}),"change",(()=>this._update()))]),this._update())}_update(){var e;if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==(null===(e=this.surfaceView)||void 0===e?void 0:e.extent)||null==this.surfaceView.spatialReference)return void this._set("location",null);const t=(0,L.gX)(this.surfaceView.extent),i=new oo.A({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(i,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{(0,_.zf)(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",i)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],dp.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],dp.prototype,"cache",void 0),(0,n._)([(0,b.MZ)()],dp.prototype,"surface",null),(0,n._)([(0,b.MZ)()],dp.prototype,"surfaceView",null),(0,n._)([(0,b.MZ)({readOnly:!0})],dp.prototype,"location",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],dp.prototype,"renderLocation",null),dp=(0,n._)([(0,x.$)("esri.views.3d.terrain.StableSurfaceCenter")],dp);let up=class extends T.A{constructor(e){super(e),this._tileGeometryUpdateExtent=(0,L.Ie)(),this._tileGeometryUpdateSpatialReference=null,this.events=new B.A,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(qt.W6.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",pp),(0,L.Ie)(this._tileGeometryUpdateExtent),this._set("updating",!1),Gt.G):Gt.G}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,L.fT)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,n=gp,r=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,mp,t),this.renderCoordsHelper.fromRenderCoords(r.renderLocation,_p,t),mp[0]<_p[0]?(n[0]=mp[0],n[2]=_p[0]):(n[0]=_p[0],n[2]=mp[0]),mp[1]<_p[1]?(n[1]=mp[1],n[3]=_p[1]):(n[1]=_p[1],n[3]=mp[1]),(0,L.HY)(n,e)}};(0,n._)([(0,b.MZ)({constructOnly:!0})],up.prototype,"state",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],up.prototype,"centerOnSurfaces",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],up.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],up.prototype,"scheduler",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],up.prototype,"surface",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],up.prototype,"updating",void 0),up=(0,n._)([(0,x.$)("esri.views.3d.support.SurfaceGeometryUpdates")],up);const pp={},mp=(0,P.vt)(),_p=(0,P.vt)(),gp=(0,L.Ie)();let fp=class extends T.A{constructor(e){super(e),this.renderPointOfView=(0,P.vt)(),this._pois=new Array,this._debugCenters=new Map,this._tmpRay=(0,yn.vt)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Ao.M({renderPointOfView:vp},this)}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:n,map:r}=this.view;this._surfaceIntersector=(0,Ms.hz)(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Pd.oH.MIN,this._contentIntersector=(0,Ms.hz)(t.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.elevationQueryCache,l={state:t,scheduler:a,surface:i,renderCoordsHelper:n};this._set("centerOnSurfaceInfrequent",new Ju({...l,task:qt.W6.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new Ju({...l,task:qt.W6.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new Ju({...l,task:qt.W6.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Qu({...l,cache:o,task:qt.W6.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new up({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new rp({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:n})),this._set("surfaceOrigin",new dp({cache:o,view:this.view})),this._set("focus",new op({state:t,scheduler:a,surface:i,renderCoordsHelper:n,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Wu(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Wu(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Wu(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Wu(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new Wu(c,"green","Focus")),this.addHandles([(0,g.watch)((()=>t.contentCamera),(e=>this._cameraChanged(e)),g.sync),(0,g.watch)((()=>i.extent),(()=>this._updateCenterPointsOfInterest())),(0,g.when)((()=>!i.updating),(()=>this._updateCenterPointsOfInterest()),g.sync),(0,g.on)((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),(0,g.on)((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),(0,g.when)((()=>lc.b.SHOW_POI),(e=>this._setDebug(e)),g.initial)]),this._cameraChanged(this.view.state.contentCamera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!((null===(e=this.surfaceGeometryUpdates)||void 0===e||!e.updating)&&!this._pois.some((e=>e.updating)))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,yp,wp)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(yp):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,Ge.g)(yp,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(yp)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(yp)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const n=(0,qs.dk)(t,e,bp);if(null==n)return null;const r=n.origin,s=(0,Ge.g)(yp,n.origin,n.direction);return this._surfaceIntersector.resetWithRay(n,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,s),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,Ge.j)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Ge.c)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this.removeHandles("debug");for(const t of this._pois)this.addHandles((0,g.watch)((()=>t.renderLocation),(e=>{var i;return null===(i=this._debugCenters.get(t))||void 0===i?void 0:i.show(e,t.renderCoordsHelper.spatialReference)}),g.initial),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};(0,n._)([(0,b.MZ)()],fp.prototype,"centerOnContent",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"centerOnSurfaceFrequent",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"centerOnSurfaceInfrequent",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"cameraOnSurface",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"focus",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"renderPointOfView",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"surfaceOrigin",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"contentGeometryUpdates",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"surfaceGeometryUpdates",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],fp.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],fp.prototype,"updating",null),fp=(0,n._)([(0,x.$)("esri.views.3d.support.PointsOfInterest")],fp);const vp=Array,yp=(0,P.vt)(),bp=(0,yn.vt)(),wp={exclude:new Set([Ws.fo])};var xp=i(73763),Cp=i(23859),Tp=i(14487),Ap=i(21617),Mp=i(71630),Sp=i(2052),Pp=i(60883),Rp=i(542),Ep=i(15255),Op=i(93938);class Dp{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}var Ip=i(60586);class Lp{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new Ip.Q(i,t)}computeMinMaxValue(e,t,i,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;const r=e-this.level;if(r<=0)return n;const s=2**r;if(Math.floor(t/s)!==this.i||Math.floor(i/s)!==this.j)return n;let a=1/0,o=-1/0;const l=this.samplerData.data.width,c=this.samplerData.data.values,h=.5*j.Gm;let d=(l-1)/s,u=(i-this.j*s)*d,p=(t-this.i*s)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,r=c[i],s=c[i+1],a=c[i+l],o=c[i+l+1];if(r+s+a+o<h){const i=u-e,l=p-t,c=(0,fe.BI)(r,s,a,o,i,l),h=(0,fe.BI)(r,s,a,o,i+d,l),m=(0,fe.BI)(r,s,a,o,i,l+d),_=(0,fe.BI)(r,s,a,o,i+d,l+d);return n.min=Math.min(c,h,m,_),n.max=Math.max(c,h,m,_),n}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let m=u;m<=u+d;m++)for(let e=p;e<=p+d;e++){const t=c[m+e*l];t<h?(a=Math.min(a,t),o=Math.max(o,t)):n.hasNoDataValues=!0}return n.min=a,n.max=o,n}}const Np=.5*j.Gm;function Fp(e,t,i){if(null==i)return null;for(const n of i){if(!n)continue;const i=n.safeWidth;let r=(0,_e.qE)(n.dy*(n.y1-t),0,i),s=(0,_e.qE)(n.dx*(e-n.x0),0,i);const a=Math.floor(r),o=Math.floor(s),l=n.data.width,c=a*l+o,h=n.data.values,d=h[c],u=h[c+1],p=c+l,m=h[p],_=h[p+1];if(d+m+u+_<Np){r-=a,s-=o;const e=d+(u-d)*s;return e+(m+(_-m)*s-e)*r}}return null}var Vp=i(4225);let Hp=class extends T.A{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if((0,H.If)(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=qp(i.fullExtent,this.viewSpatialReference);null!=t&&e.push((0,L.VY)(t))}})),e}};(0,n._)([(0,b.MZ)({readOnly:!0})],Hp.prototype,"layerViewsExtent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Hp.prototype,"tiledLayersExtent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Hp.prototype,"stencilEnabledExtents",null),(0,n._)([(0,b.MZ)()],Hp.prototype,"viewSpatialReference",void 0),(0,n._)([(0,b.MZ)()],Hp.prototype,"tilingScheme",void 0),(0,n._)([(0,b.MZ)()],Hp.prototype,"defaultTiledLayersExtent",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Hp.prototype,"layers",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Hp.prototype,"layerViews",void 0),Hp=(0,n._)([(0,x.$)("esri.views.3d.terrain.ExtentHelper")],Hp);let Up=class extends Hp{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?j.Qz:j.yt}};Up=(0,n._)([(0,x.$)("esri.views.3d.terrain.ExtentHelperGlobal")],Up);let zp=class extends Hp{_computeLayerViewsExtent(){const e=(0,L.Ie)(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const n=i.layer;if(i.isResolved()&&("graphics"!==n.type||!n.internal)){const n=qp("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);(0,L.fT)(e,n,e)}}));const i=(0,L.vQ)(e)?e:null,n=this._get("layerViewsExtent");return(0,L.aI)(i,n)?n:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=(0,L.Ie)();this.layers.forEach((n=>{if(n.loaded&&(0,H.qK)(n)){const r=(0,Vp.Uo)(n,t,te.RT.Local);if(null==r)return;const{tileInfo:s,fullExtent:a}=r;null!=s&&null!=a&&((0,Vp.Ci)(n)||e.compatibleWith(s)&&a.spatialReference.equals(e.spatialReference))&&(0,L.fT)(i,a,i)}})),(0,L.fT)(i,this.defaultTiledLayersExtent,i);const n=(0,L.vQ)(i)?i:null,r=this._get("tiledLayersExtent");return(0,L.aI)(n,r)?r:n}};function qp(e,t){return null==e||e.spatialReference.equals(t)?e:(0,O.projectWithoutEngine)(e,e.spatialReference,t)}zp=(0,n._)([(0,x.$)("esri.views.3d.terrain.ExtentHelperLocal")],zp);var Gp=i(19539),Bp=i(45417),kp=i(33169),Wp=i(83490),Zp=i(75507),jp=i(45463),Qp=i(76044);function Xp(){var e;const t=null===(e=globalThis.require)||void 0===e?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)i.includes(".glsl")&&delete t[i]}}const Yp=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let $p,Kp=class extends T.A{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=(0,d.A)("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new kp.or({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=(0,Ms.hz)(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,g.watch)((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(t=>{var i;return null===(i=e._stage)||void 0===i?void 0:i.renderer.setParameters({hasOverlayWater:t})})),this.renderer.events.on("content-changed",t),(0,g.watch)((()=>e.state.camera.pixelRatio),t),(0,g.watch)((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),(0,g.watch)((()=>{var t,i;return[null===(t=e.pointsOfInterest)||void 0===t?void 0:t.renderPointOfView,null===(i=e.pointsOfInterest)||void 0===i||null===(i=i.centerOnSurfaceFrequent)||void 0===i?void 0:i.location]}),(()=>this.setPlacementDirty())),(0,g.watch)((()=>{var t,i;return[null===(t=e.state)||void 0===t?void 0:t.pixelRatio,null===(i=e.state)||void 0===i?void 0:i.contentPixelRatio]}),(()=>this.setPlacementDirty()),g.sync),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(qt.W6.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(qt.Bb,e.camera,Wp.C7.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(Wp.C7.BACKGROUND,e)}))]),e._stage.renderer.renderOverlay=e=>this._renderOverlay(e)}destroy(){var e;null!==(e=this.view)&&void 0!==e&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),$p&&($p.hide(),$p=null),this.renderer=(0,p.pR)(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||lc.b.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,We.tO)(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(Wp.C7.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Es.hr(-20037508.342787,20037508.342787):new Es.hr(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const n=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),n}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,Qp.B)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Wp.C7.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return Gt.G;const n=this._computeOverlayResolution(t);this._computeOverlayExtents(t,n,tm),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,tm.stretch);const r=this._updateOverlay(Gp.vr.INNER,tm.inner,n,1*tm.pixelRatioAdjustment,tm.mapUnitsPerPixel),s=(0,L.VL)(tm.inner)/(0,L.VL)(tm.outer),a=this._updateOverlay(Gp.vr.OUTER,tm.outer,n,s*tm.pixelRatioAdjustment,tm.mapUnitsPerPixel);r!==sm.EXTENT&&a!==sm.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(i)),r===sm.NONE&&a===sm.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,n=e.fullHeight/e.pixelRatio*t,r=Math.ceil(1.5*Math.max(i,n));return Math.min((0,mt.Mv)(r),this._maxResolution)}_updateOverlay(e,t,i,n,r){if(0===this.renderer.overlays.length)return sm.NONE;const s=this.renderer.overlays[e],a=s.mapUnitsPerPixel;if(s.mapUnitsPerPixel=r,s.pixelRatio=n,function(e,t){const i=1e-5,n=lc.b.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=n&&Math.abs(t[1]-e[1])<=n&&Math.abs(t[2]-e[2])<=n&&Math.abs(t[3]-e[3])<=n}(t,s.extent)&&i===s.resolution)return a===r?sm.NONE:sm.RERENDER_ONLY;(0,L.C)(s.extent,t),s.resolution=i;const o=(0,L.gX)(s.extent);return s.renderLocalOrigin=(0,Zp.f)(o[0],o[1],0,"OV_"+this._latestOriginId++),sm.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Gp.vr.INNER],n=this.renderer.overlays[Gp.vr.OUTER],r=e.extent;this._rectInsideRect(i.extent,r)||this._rectanglesOverlap(r,i.extent)||this._rectanglesOverlap(r,n.extent)?(this._setTileOverlayData(r,Gp.vr.INNER,t),this._setTileOverlayData(r,Gp.vr.OUTER,t)):(this._clearTileOverlayData(Gp.vr.INNER,t),this._clearTileOverlayData(Gp.vr.OUTER,t))}else this._clearTileOverlayData(Gp.vr.INNER,t),this._clearTileOverlayData(Gp.vr.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[Gp.vr.INNER],n=this.renderer.overlays[Gp.vr.OUTER],r=this._pointIsInExtent(e,i.extent)?i:n;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const n=this.renderer.overlays[t].extent,r=(0,L.VL)(n),s=(0,L.uJ)(n);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(n[0],a);const t=this._longitudeCyclical.minimalMonotonic(n[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,(0,L.VL)(e)/r,(0,L.uJ)(e)/s),i.setOffset(t,(a-n[0])/r,(e[1]-n[1])/s)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){Xp(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(qt.Bb)}_dispatchAnimationUpdate(e){const t=(0,Si.l5)(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=(0,Si.l5)(t/this.surface.view._stage.renderer.animationTimeDilation),n=new jp.sP(this.view.state.camera,i,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(n)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,n){const r=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,rm,t,i);if(null==r)return!1;const s=r.origin,a=(0,Ge.g)(em,r.origin,r.direction);return this._groundIntersector.reset(s,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,s,a),this._groundIntersector.results.min.getIntersectionPoint(n)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const n=.55,r=this.view.renderCoordsHelper.getAltitude(e.eye),s=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=(0,_e.qE)(s.estimatedSurfaceAltitude,e.aboveGround?-1/0:r+a,e.aboveGround?r-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=em;(0,vn.e)((0,vn.h)(vn.t,(0,We.tO)(this.view.spatialReference).radius+o),(0,yn.LV)(e.eye,e.viewForward),t),(0,Ge.f)(t,t,e.eye);const r=Es.wf.normalize((0,Is.EJ)(e.viewForward,t,e.viewRight))/e.fovY+.5,s=r<=0||r>=1?.5:n;i=l?s*r:r+s*(1-r)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),r=Math.tan(t),s=(0,Ye.fA)(0,r,1,0),a=(0,Xe.t)(s,s,e.projectionMatrix)[1],o=(0,_e.qE)(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*n:1-(1-o)*n}return!!this._intersectGroundFromView(e,.5,i,t)&&(0,Ge.w)(t,e.eye)<s.distance*s.distance}_computeOverlayExtents(e,t,i){const n=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,r=(0,P.vt)();this._findHorizonBasedPointOfInterest(e,r)||(0,Ge.c)(r,n),lc.b.OVERLAY_SHOW_CENTER?(null==$p&&($p=new Wu(this.view.graphics,"red")),$p.show(r,this._renderSR)):null!=$p&&$p.hide();const s=Math.max(.1,(0,Ge.q)(e.eye,r)),a=Wn(this.view.renderCoordsHelper,n,e.eye);this._overlaySREqualsRenderSR||(0,Tp.F)(r,this._renderSR,r,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference&&this._spatialReference.isGeographic,c=l&&this._spatialReference?1/(0,We.tO)(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,d=e.perScreenPixelRatio/h*s*c;i.mapUnitsPerPixel=d/this._worldToPCSRatio,i.stretch=this._overlayStretch;let u=t*d/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(u/=Math.cos((0,Bp.jg)(r[1])),m=o[3]):(p=!0,u/=(0,We.tO)(this._spatialReference).metersPerDegree,m=90),u>=m&&(u=m,r[1]=0,this._spatialReference.isWebMercator&&(r[0]=0)));let _=1;p&&(_=1/Math.max(.2,Math.cos(Math.abs((0,_e.kU)(r[1])))),u*_>180&&(_=180/u),i.mapUnitsPerPixel*=_);const g=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/g)*g);const f=u*_,v=.5*t/(32*f),y=.5*t/(32*u);r[0]=Math.round(r[0]*v)/v,r[1]=Math.round(r[1]*y)/y;const b=i.inner;b[0]=r[0]-f,b[1]=r[1]-u,b[2]=r[0]+f,b[3]=r[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const w=i.outer;if(6*f>(0,L.VL)(o))(0,L.C)(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=b[0]-f,w[1]=b[1]-u,w[2]=b[2]+f,w[3]=b[3]+u;else{(0,Tp.F)(e.eye,this._renderSR,em,this._spatialReference),(0,Qe.Re)(Jp,r,em);let t=-Math.atan2(Jp[1],Jp[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,Xe.b)(Jp,Yp[i],2*u),Jp[0]*=_,Jp[2]*=_,(0,Xe.f)(w,b,Jp)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=(0,L.E$)(b,o,im),t=(0,L.E$)(w,o,nm);(0,L.gR)(e,t)&&(w[2]=w[0],w[3]=w[1])}const x=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,x),i.pixelRatioAdjustment=i.mapUnitsPerPixel/x}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const n=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),n!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(Wp.C7.UPDATE),i?(this.surface.requestRender(e),e===Wp.C7.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Wp.C7.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,L.HY)(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,L.gR)(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,n=e.y;return i>t[0]&&i<t[2]&&n>t[1]&&n<t[3]}_shiftExtentToFitBounds(e,t,i){let n=0,r=0;e[0]<-t?n=e[0]+t:e[2]>t&&(n=t-e[2]),e[1]<-i?r=e[1]+i:e[3]>i&&(r=i-e[3]),(0,L.cY)(e,n,r)}get test(){return{renderer:this.renderer,update:()=>this.runTask(qt.Bb)}}};(0,n._)([(0,b.MZ)()],Kp.prototype,"_spatialReference",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Kp.prototype,"running",null),(0,n._)([(0,b.MZ)()],Kp.prototype,"_placementDirty",void 0),(0,n._)([(0,b.MZ)()],Kp.prototype,"_contentUpdated",void 0),(0,n._)([(0,b.MZ)()],Kp.prototype,"_isSpherical",null),(0,n._)([(0,b.MZ)()],Kp.prototype,"_worldToPCSRatio",null),(0,n._)([(0,b.MZ)()],Kp.prototype,"renderer",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Kp.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Kp.prototype,"surface",void 0),(0,n._)([(0,b.MZ)()],Kp.prototype,"suspended",null),(0,n._)([(0,b.MZ)()],Kp.prototype,"updating",null),(0,n._)([(0,b.MZ)({type:Boolean})],Kp.prototype,"rendersOccludedDraped",null),Kp=(0,n._)([(0,x.$)("esri.views.3d.terrain.OverlayManager")],Kp);const Jp=(0,Ye.vt)(),em=(0,P.vt)(),tm=new class{constructor(){this.inner=(0,L.vt)(),this.outer=(0,L.vt)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},im=(0,L.vt)(),nm=(0,L.vt)(),rm=(0,yn.vt)();var sm;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(sm||(sm={}));var am=i(42294),om=i(71728),lm=i(25672);class cm{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,am.Ie)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=(0,p.Gz)(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,(0,am.Ie)(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,n){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,n),t),(0,Ge.g)(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:n,typedBufferStride:r}=this.vertexAttributes.normalCompressed;(0,lm.Tz)(t,n,this.getEdgeAttributeIndex(e,i),r)}setEdgeNormalFromValues(e,t,i,n,r){this._setNormal(this.getEdgeAttributeIndex(e,t),i,n,r)}setEdgeVertexFromValuesRawPositionUV(e,t,i,n,r,s,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,n,r),this._setUV(o,s,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,n,r,s,a,o,l,c){const h=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(h,i,n,r),this._setUV(h,s,a),this._setNormal(h,o,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,n){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;(0,lm.aT)(r,e,t,i,n,s)}_setUV(e,t,i){dm(this.vertexAttributes.uv0,e,t,i)}getEdgeAttributeIndex(e,t){return(0,Vp.GH)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}const hm=16384;function dm(e,t,i,n){e.setValues(t,i*hm,n*hm)}class um{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}class pm{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,p.pR)(this._current),this._next=(0,p.pR)(this._next),this._waiting=(0,p.pR)(this._waiting),this._delayed=(0,p.pR)(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=pm.test.fadeMoment;if(null!=this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,mm.Immediate),this._delayed=null)),null!=this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,n=this._next.type!==Gp.ZY.FADING,r=e-this._fadeStart>=t;(i||n||r)&&((0,p.pR)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=pm.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:mm.Immediate;this._delayed=(0,p.pR)(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=pm.test.fadeMoment||performance.now();return t!==mm.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&((0,p.pR)(this._waiting),this._waiting=e))}get _fadeDuration(){return null==this._waiting?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var mm;pm.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(mm||(mm={}));var _m=i(53494),gm=i(9902);class fm{get updating(){return!!this._tileRequested}init(e,t,i,n){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=n,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const r=this._findAncestorWithData();this._setUpsampleTile(r)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Gp.ZY.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),n=(0,Vp.BU)(i),{minLevel:r,maxLevel:s}=i.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?gm.D_:()=>!0;let c=this.tile;const h=c.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=null!=u?u.tile.level:-1,m=null!=u&&p-h>=a,_=null===n||void 0===n?void 0:n.tilemapCache,g="vector-tile-3d"===i.type?i.schemaHelper:null;for(;c&&l(c,n,!1)&&c.level>=r;){var f;const i=c.level,n=h-i,l=c.layerInfo[t][e];if(l.data&&n>=a){(!m||i>p)&&this._setUpsampleTile(c),l.dataInvalidated&&(d=c);break}const u=null!==(f=null===g||void 0===g?void 0:g.getLevelRowColumn(c.lij))&&void 0!==f?f:c.lij;if("unavailable"!==(null===_||void 0===_?void 0:_.getAvailability(u[0],u[1],c.lij[2]))&&i<=s&&!l.data&&!l.dataMissing&&((!d||c.level===r||i%j.EY==0||h-d.level<a)&&(d=c),n>=o))break;c=c.parent}if(null!=d&&h-d.level<a)if(u)d=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),d=i.layerInfo[t][e].dataInvalidated?i:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let n=this.tile;n;n=n.parent)if(n.hasLayerData(this._layerIdx,this._layerClass)){if(e-n.level>=t)return n;i=n}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Gp.ZY.FADING,t)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const vm=new Error("Abstract method called on TileAgent"),ym=new class extends fm{get _desiredMinLevelDelta(){throw vm}get _progressiveLevelModulo(){throw vm}dispose(){}};class bm extends fm{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return(0,j.SC)(this.tile.level)-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class wm extends fm{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return j.EY}}var xm=i(94070);class Cm{constructor(){this.waitingAgents=new oc.A,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=Tm.acquire();return t._init(e),t}release(){this.dispose(),Am.delete(this),Tm.release(this)}dispose(){this.loadingAgent=(0,p.WD)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,Vp.Mm)(this._data)}static prune(){Tm.prune(0)}_init(e){this.waitingAgents.clear(),this._data=(0,Vp.Mm)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,p.DC)(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){null!=this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),(0,gm.vx)(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){(0,Vp.Mm)(this._data),this._data=e}}const Tm=new $c.A(Cm,null,(()=>{})),Am=new Map;class Mm{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,0===this._refCount)if(this._cache){const e="".concat(this._texture.descriptor.width," ").concat(this._texture.descriptor.pixelFormat);this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}}var Sm;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(Sm||(Sm={}));class Pm{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,L.vt)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,L.vt)(),this.centerAtSeaLevel=(0,P.vt)(),this._center=[(0,P.vt)(),(0,vn.c)(),(0,P.vt)()],this.up=(0,P.TS)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,P.vt)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}static prune(){Om.prune(0),Dm.prune(0),Cm.prune()}get _isCached(){return!this.isLeaf&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return"".concat(this._lij[0],"/").concat(this._lij[1],"/").concat(this._lij[2])}get edgeLen(){return this._edgeLen}get radius(){return this._center[Lm.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){var e;this._dirty=!1;const t=this.parent,i=null!==(e=null===t||void 0===t?void 0:t.frustumVisibility)&&void 0!==e?e:om.Z.INTERSECTS;this._frustumVisibility=i===om.Z.INSIDE?om.Z.INSIDE:i===om.Z.OUTSIDE?om.Z.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const n=this._frustumVisibility!==om.Z.OUTSIDE&&this._intersectsClippingArea;n!==this._visible&&(this._visible=n,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,n,r){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=(0,We.tO)(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e,t,i,this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Lm.MIDDLE][3]=0,this.elevationLevel=e,n&&!Number.isNaN(n.elevationBoundsMin)?(this._elevationBoundsMin=n.elevationBoundsMin,this._elevationBoundsMax=n.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=n,this.unsetChildren(),this._surface=r,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const s of au){const e=r.numLayers(s),t=this.layerInfo[s];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=Cm.acquire(this._surface.upsampleInfoPool),s===tu.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,j.Me)}dispose(){(0,Vp.bk)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of au){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[tu.MAP].reduce(((e,t)=>e+(t instanceof Rp.c?t.usedMemory/t.referenced:0)),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){var e,t;if(null!=this._usedMemory)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;let i=0;for(const{data:r}of this.layerInfo[tu.MAP])r instanceof Rp.c?i+=this._getTerrainDataMemory(r):this._mapTileMemoryInternal+=this._getTerrainDataMemory(r);const n=this._cpuImageMemorySize;for(const r of this.layerInfo[tu.ELEVATION])this._usedMemory+=r.data?n:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=null!==(e=null===(t=this.renderData.texture)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+i),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return null!==i&&void 0!==i&&i.data?e===tu.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===tu.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof Mm?e.texture.usedMemory:e instanceof HTMLImageElement||e instanceof wu.yh?this._cpuImageMemorySize:e instanceof xm.S?e.memoryUsage:e instanceof Rp.c?e.usedMemory/e.referenced:0}updateScreenDepth(e){const t=this._center[Lm.MIDDLE],i=e,n=t[0],r=t[1],s=t[2],a=i[2]*n+i[6]*r+i[10]*s+i[14];this.screenDepth=a<0?0:a/(i[3]*n+i[7]*r+i[11]*s+i[15])}shouldSplit(e,t,i){if(!this.visible)return Sm.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===om.Z.OUTSIDE))return Sm.NONE;const n=this.level;(0,Ge.f)(zm,(0,vn.g)(this._center[Lm.MIDDLE]),t);let r=(0,Ge.p)(zm),s=zm,a=(0,vn.g)(this._center[Lm.MIDDLE]);(0,Ge.f)(qm,this._center[Lm.TOP],t);const o=(0,Ge.p)(qm);o<r&&(r=o,s=qm,a=this._center[Lm.TOP]),(0,Ge.f)(Gm,this._center[Lm.BOTTOM],t);const l=(0,Ge.p)(Gm);if(l<r&&(r=l,s=Gm,a=this._center[Lm.BOTTOM]),this._edgeLen2>r&&n<e.maxLod)return Sm.SPLIT;const c=Math.sqrt(r),h=e.fovX*c*2,d=this._edgeLen/h,u=()=>{if(n<e.maxLod)return this.elevationLevel=n,Sm.NONE;const t=n+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==this.elevationLevel?(this.elevationLevel=t,Sm.ELEVATION):Sm.NONE},p=null!=i?i-n:1/0;if(p<=.5)return u();const m=(0,Ge.k)(this.up,zm),_=this._elevationBoundsMax-this._elevationBoundsMin,g=_/this.edgeLen;if(e.aboveGround&&m>0&&g<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-g>0)return Sm.NONE;const f=null!=i?3-Math.min(p,2):1;if(d*f<e.relativeWidthLimit||n>=e.maxLod)return u();if(n<7)return Sm.SPLIT;(0,Ge.h)(Bm,this.up,m),(0,Ge.f)(Bm,Bm,s);const v=(0,Ge.p)(Bm);if(v<=this.radius*this.radius)return Sm.SPLIT;(0,Ge.h)(Bm,Bm,this.radius/Math.sqrt(v)),(0,Ge.g)(Bm,Bm,a),(0,Ge.f)(Bm,t,Bm);const y=Math.min(1,(Math.abs((0,Ge.k)(Bm,this.up))+.5*_+this._curvatureHeight)/(0,Ge.l)(Bm)),b=.1/e.angledSplitBias,w=e.fovY*c*2;return y*(this._edgeLen/w*f)<b*e.relativeHeightLimit?Sm.NONE:Sm.SPLIT}setChildren(e,t,i,n){(0,Vp.bk)(!!(e&&t&&i&&n),"Null child passed");const r=this._children;return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e,t;return null!==(e=null===(t=this.renderData)||void 0===t?void 0:t.hasGeometry)&&void 0!==e&&e}load(){this.refMapData();for(const e of au)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const t of au){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==ym&&(Em(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(Sm.GEOMETRY),this.resetPendingUpdate(Sm.TEXTURE_NOFADING),this.resetPendingUpdate(Sm.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[tu.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==ym&&(Em(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,L.aI)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const n=i&&this._isWithinClippingArea,r=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||n||r||this.setPendingUpdate(Sm.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(null===i||void 0===i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of au){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==ym&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(Sm.SPLIT)||e!==tu.ELEVATION&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===Sm.SPLIT||e===Sm.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const n=this.layerInfo[t][e];if(n.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(i),n.data&&!n.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const r=n.data&&"type"in n.data&&"vector-tile"===n.data.type;return i.dataArrived(this,r),!0}if(n.requestPromise)return!0;(0,p.DC)(n.requestAbort),n.requestAbort=new AbortController;const r=this._surface.requestTileData(this,e,t,n.requestAbort);if(!r)return n.requestAbort=null,!1;const s=()=>{n.requestPromise===r&&(n.requestPromise=null,n.requestAbort=null)};return n.requestPromise=r,r.then(s,s),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return(0,Ge.p)((0,Ge.f)(Bm,(0,vn.g)(this._center[Lm.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const n=this.layerInfo[t][e],r=n.waitingAgents,s=null!=r.removeUnordered(i);(0,Vp.bk)(s,"agent has not requested this piece of map data"),r.length<1&&(n.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const n=null!=i&&"type"in i&&"vector-tile"===i.type,r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this,n))),r.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,i){i.notInTilemap||console.error("Tile ".concat(this._lij.toString()," layer ").concat(t,"/").concat(e," error ").concat(i));const n=this.layerInfo[t][e];n.dataMissing=!0,n.waitingAgents.forAll((e=>e.dataMissing())),n.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case tu.MAP:return this._updateTexture(t);case tu.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===Gp.ZY.FADING?Sm.TEXTURE_NOFADING:Sm.TEXTURE_FADING),this.setPendingUpdate(e===Gp.ZY.FADING?Sm.TEXTURE_FADING:Sm.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(Sm.GEOMETRY);for(const e of this.layerInfo[tu.ELEVATION])e.pendingUpdates|=Sm.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,n=-1/0;const r=this.layerInfo[tu.ELEVATION];let s=!0;for(const a of r)null!=a.elevationBounds&&(i=Math.min(i,a.elevationBounds.min),n=Math.max(n,a.elevationBounds.max),a.elevationBounds.hasNoDataValues||(s=!1));s&&(i=Math.min(i,0),n=Math.max(n,0)),e===i&&t===n||(this._elevationBoundsMin=i,this._elevationBoundsMax=n,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),n=this._center;(0,Ge.h)(Bm,this.up,i),(0,Ge.g)((0,vn.g)(n[Lm.MIDDLE]),this.centerAtSeaLevel,Bm),(0,Ge.h)(Bm,this.up,e),(0,Ge.g)(n[Lm.TOP],this.centerAtSeaLevel,Bm),(0,Ge.h)(Bm,this.up,t),(0,Ge.g)(n[Lm.BOTTOM],this.centerAtSeaLevel,Bm)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[tu.ELEVATION][e],n=(0,j.SC)(this.level),r=Math.max(this.elevationLevel-n,0),s=i.elevationBounds;if(null!=s&&s.level>=t&&s.level<=r)return;const a=this._surface.layerViewByIndex(e,tu.ELEVATION),o=(0,Vp.BU)(a);if(!(0,gm.D_)(this,o,!1))return;const l=Im;let c=!1;const h=i.data;if(h&&h.level<=r){const e=i.data;l.min=e.samplerData.data.minValue,l.max=e.samplerData.data.maxValue,l.hasNoDataValues=e.samplerData.data.hasNoDataValues,l.level=this.level,c=!0}else{let t,i,s=0;for(let a=this._parent;a&&(!i||s<n)&&(s=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[tu.ELEVATION][e].data,!(!i&&t&&a.level<=r));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=i.level,c=!0))}c&&(null==i.elevationBounds&&(i.elevationBounds=new Dp),i.elevationBounds.copyFrom(l))}modifyLayers(e,t,i){const n=this.layerInfo[i];for(const a of n)a.loadingAgent&&a.loadingAgent!==ym&&(Em(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<n.length;++a)void 0===e[a]&&n[a].release();const r=new Array(...n),s=t.length;n.length=s;for(let a=0;a<s;a++){const e=t[a];n[a]=e>-1?r[e]:Cm.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Gp.ZY.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===ym&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of au){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==ym&&(i.loadingAgent.setSuspension(t),i.loadingAgent===ym&&this.updateRenderData(e,Gp.ZY.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==ym&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=ym,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||(0,H.jZ)(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let a=e;a<t;++a){var n,r,s;const e=this._surface.layerViewByIndex(a,i);if((0,Vp.KE)(e)&&"normal"!==(null===e||void 0===e||null===(n=e.layer)||void 0===n?void 0:n.blendMode)||(0,H.jZ)(null===e||void 0===e||null===(r=e.layer)||void 0===r?void 0:r.parent)&&this._hasBlendableAncestor(null===e||void 0===e||null===(s=e.layer)||void 0===s?void 0:s.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const n=this._isSuspended(t);for(let r=e;r<i.length;++r){const s=i[r];let a=!1;const o=this._surface.layerViewByIndex(r,t),l=(0,Vp.BU)(o);if(s.loadingAgent?(0,gm.D_)(this,l,!1)?(s.loadingAgent!==ym&&s.loadingAgent.setSuspension(n),s.loadingAgent!==ym&&(a=s.loadingAgent.update())):s.dispose():(0,gm.D_)(this,l,!1)&&(s.loadingAgent=Rm(this,r,t,n),a=s.loadingAgent.startLoading(),a?s.loadingAgent===ym&&this.setPendingUpdate(Sm.GEOMETRY):(Em(s.loadingAgent),s.loadingAgent=ym)),s.loadingAgent===ym&&this.updateRenderData(t,Gp.ZY.FADING),!this._hasBlendModes(e,i.length,t)&&a&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,(0,j.SC)(this.level)-t),n=(0,_e.qE)(1+(this.maxTesselation>>i),2,this.maxTesselation+1),r=this.getDefaultVerticesPerSide();return Math.max(n,r)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const n of i)if(Nm(n,e)){let i=n,r=e[0]-i.level-1;for(;r>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>r&1,n=e[2]>>r&1;i=i.children[2*t+n],r--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,n=this.getNeighborLIJ(i,e);return n?Fm(i,n)?t(this)?this:null:this._findLIJ(n,t):null}findCorner(e,t){const i=e===om.N.NORTH_EAST?1:e===om.N.NORTH_WEST?0:e===om.N.SOUTH_WEST?2:3;let n=this;for(;n.children[0]&&(!t||!t(n));)n=n.children[i];return n}findNeighborCornerTileExact(e,t){var i;return(null===(i=this.findNeighborTile(e,(e=>t(e)||e.level===this.level)))||void 0===i?void 0:i.findCorner((0,Vp.jj)(e),t))||null}forAllSubtreeOnSide(e,t){const i=e===om.N.NORTH?[0,1]:e===om.N.NORTH_EAST?[1]:e===om.N.EAST?[1,3]:e===om.N.SOUTH_EAST?[3]:e===om.N.SOUTH?[2,3]:e===om.N.SOUTH_WEST?[2]:e===om.N.WEST?[0,2]:[0],n=e=>{const r=e.children;!t(e)&&r[0]&&i.forEach((e=>n(r[e])))};n(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if((0,Vp.GH)(!Vp.L8||i>=0),0===i)return 0;const n=2**i,r=1==(1&e),s=r?0:1,a=t.lij[s+1]*n,o=this._lij[s+1],l=o-a,c=r?n-1-l:l;return Vp.L8&&((0,Vp.GH)(a<=o&&o<a+n),(0,Vp.GH)(0<=c&&c<n)),c}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.isLoaded;Vp.Rz.forEach((t=>{const n=this.findNeighborTile(t,i);null!=n&&n!==this&&n.forAllSubtreeOnSide((0,Vp.JM)(t),(i=>!!i.isLoaded&&(e(i,t),!0)))})),Vp.XQ.forEach((t=>{var n;const r=null===(n=this.findNeighborTile(t,i))||void 0===n?void 0:n.findCorner((0,Vp.jj)(t),(e=>e.isLoaded));(0,Vp.GH)(!r||Vm(this,r,t)),(null===r||void 0===r?void 0:r.isLoaded)&&e(r,t)}))}getNeighborLIJ(e,t){const i=(0,Vp.uK)(t)?-1:(0,Vp.mJ)(t)?1:0,n=(0,Vp.Ec)(t)?-1:(0,Vp.sZ)(t)?1:0,r=[e[0],e[1]+i,e[2]+n];return r[1]<0?null:this.surface.isGlobal?this.wrapLIJ(r):r[2]<0?null:r}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return 0===this._lij[2]}get isNorthEnd(){return 0===this._lij[1]}get isSouthEnd(){var e;const t=this.surface.extent,i=null!==(e=null===t||void 0===t?void 0:t[1])&&void 0!==e?e:null;return null!=i&&this.extent[1]+(0,_m.FD)()>=i}checkGeometryWaterproofness(){var e;Vp.NR&&((0,Vp.GH)(this.isLoaded),null===(e=this.renderData)||void 0===e||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,n=.25*(t[2]-t[0]);if((0,Vp.uK)(e)&&t[3]+n>=i[3])return!1;if((0,Vp.mJ)(e)&&t[1]-n<=i[1])return!1;const r=this.surface.isGlobal;return!(!r&&(0,Vp.Ec)(e)&&t[0]-n<=i[0])&&!(!r&&(0,Vp.sZ)(e)&&t[2]+n>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;(0,Ge.c)(this._lastPOI,e);const i=this._center[Lm.MIDDLE],n=e[0]-i[0],r=e[1]-i[1],s=e[2]-i[2];this.distanceToPOI=n*n+r*r+s*s}}function Rm(e,t,i,n){const r=i===tu.ELEVATION?Dm.acquire():Om.acquire();return r.init(e,t,i,n),r}function Em(e){e.dispose(),e instanceof bm?Dm.release(e):e instanceof wm&&Om.release(e)}const Om=new $c.A(wm),Dm=new $c.A(bm),Im=new Dp;var Lm;function Nm(e,t){const i=e.lij,n=t[0]-i[0];return!(n<0)&&t[1]>>n===i[1]&&t[2]>>n===i[2]}function Fm(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Vm(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?Hm(e,t,i):Hm(t,e,(0,Vp.jj)(i)))}function Hm(e,t,i){(0,Vp.GH)(e.level>=t.level);const n=(0,Vp.hL)(i),r=(0,Vp.HF)(i),s=e.extent,a=t.extent,o=[n?s[0]:s[2],r?s[3]:s[1]],l=[n?a[2]:a[0],r?a[1]:a[3]],c=1e-5*(s[2]-s[0]),h=(0,Vp.yL)(o[0],l[0],c)||e.surface.isGlobal&&(0,Vp.yL)(o[0],-l[0],c),d=(0,Vp.yL)(o[1],l[1],c);if(h&&d)return!0;if(e.level===t.level)return(0,Vp.GH)(!1),!1;if(!h&&!d)return(0,Vp.GH)(!1),!1;const u=h?Um(a[1],a[3],s[1],s[3],c):Um(a[0],a[2],s[0],s[2],c);return(0,Vp.GH)(u),u}function Um(e,t,i,n,r){return e-r<=i&&i<=n&&n<=t+r}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(Lm||(Lm={}));const zm=(0,P.vt)(),qm=(0,P.vt)(),Gm=(0,P.vt)(),Bm=(0,P.vt)();class km{constructor(){this._scales=(0,Ye.fA)(-1,-1,-1,-1),this._offsets=(0,Ye.fA)(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var Wm=i(43074),Zm=i(96643);class jm extends it.w{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===te.RT.Global}initializeProgram(e){return new rt.B(e.rctx,jm.shader.get().build(this.configuration),Qm)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,i=t.backfaceCullingEnabled&&!t.renderOccluded;return(0,at.Ey)({blending:t.renderOccluded?(0,at.ox)(st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA):null,culling:i?at.PI:null,depthTest:t.renderOccluded?null:{func:st.MT.LESS},depthWrite:t.renderOccluded?null:at.kn,colorWrite:at.wE,stencilTest:e?(0,Zm.Rv)(Wp.dd.IntegratedMeshMaskExcluded):null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}jm.shader=new tt.$(Wm.a,(()=>i.e(45674).then(i.bind(i,45674))));const Qm=new Map([[li.r.POSITION,0],[li.r.UV0,1],[li.r.NORMALCOMPRESSED,2]]);class Xm{constructor(){this.geometry=new cm,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new pm((()=>this.tile.surface.fadeDuration)),this.overlay=new km,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new um,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Vp.L8&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)(0,Vp.GH)(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var i;const n=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!n.surface.isGlobal){const t=n.surface.extent;if(null!=t&&(0===e&&n.extent[3]>t[3]||1===e&&n.extent[2]>t[2]||2===e&&n.extent[1]<t[1]||3===e&&n.extent[0]<t[0]))return r}const s=n.level,a=Vp.Rz[e];if(!t)return(0,Vp.GH)(null==(null===(i=n.surface)||void 0===i?void 0:i.rootTiles)||n.surface.updatingRootTiles||!n.shouldHaveNeighbor(a)),r;if(t.isLoaded){const i=t,n=i.renderData.geometryState,a=s-i.level;if((0,Vp.GH)(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}(0,Vp.GH)(!t.isLeaf);let o=r;return t.forAllSubtreeOnSide((0,Vp.JM)(a),(e=>e===n||(e.isLoaded?(o=Math.max(o,2**(e.level-s)),!0):((0,Vp.GH)(!e.isLeaf),!1)))),o}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.isLoaded||t.level===e.level)&&(null===t||void 0===t?void 0:t.intersectsClippingArea),n=t.edgePeerNeighbors,r=t.edgePeerNeighborSamplerVersions;for(let l=0;l<4;++l){var s,a;const o=e.findNeighborTile(Vp.Rz[l],i),c=r_(e,o),h=null!==(s=null===c||void 0===c||null===(a=c.renderData)||void 0===a?void 0:a.geometryState.samplerDataVersion)&&void 0!==s?s:-1,d=n[l],u=c!==r_(e,d),p=r[l]!==h;Vp.L8&&o&&((0,Vp.GH)(e.level>=o.level),(0,Vp.GH)(e.level-o.level<=j.nU)),n[l]=o,(u||p)&&(r[l]=h,this._markEdgeDirty(l));const m=t.edgeResolutions[l],_=this._calculateEdgeResolution(l,o);(0,Vp.GH)((0,_e.r6)(_)),(0,Vp.GH)(_>=1),t.edgeResolutions[l]=_,m!==_&&this._markEdgeResolutionDirty(l)}for(let l=0;l<4;++l){const r=e.findNeighborTile(Vp.XQ[l],i);t.cornerPeerNeighbors[l]=r;const s=r_(e,n[l]),a=r_(e,n[(l+1)%4]),c=r_(e,r);n_[l]=c,n_[(l+1)%4]=a,n_[(l+2)%4]=e,n_[(l+3)%4]=s,(0,Vp.GH)(n_.some((t=>(null===t||void 0===t?void 0:t.isLoaded)||t===e)));const h=n_.reduce(((e,t)=>{var i;return Math.min(e,null!==(i=null===t||void 0===t?void 0:t.level)&&void 0!==i?i:1/0)}),1/0);n_.forEach(((e,t)=>{e&&(null===e||void 0===e?void 0:e.level)>h&&(n_[t]=null)})),(0,Vp.GH)(n_.some((t=>(null===t||void 0===t?void 0:t.isLoaded)||t===e)));const d=t.cornerNeighborCornerTiles,u=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){var o;const t=n_[e],i=null!==(o=null===t||void 0===t?void 0:t.renderData.geometryState.samplerDataVersion)&&void 0!==o?o:-1,n=4*l+e,r=d[n]!==t,s=!r&&u[n]!==i;(r||s)&&(d[n]=t,u[n]=i,this._markCornerDirty(l))}Vp.L8&&(0,Vp.GH)(u_.some((t=>{var i;return(null===(i=d[4*l+t])||void 0===i?void 0:i.isLoaded)||d[4*l+t]===e})))}Vp.L8&&(0,Vp.GH)(this.geometryState.edgeResolutions.every((e=>e>0)));for(let l=0;l<4;++l)n_[l]=null}_updateGeometry(e){var t;if(!this.tile.intersectsClippingArea)return;Vp.L8&&(0,Vp.GH)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:i,_vao:n,geometry:r,geometryState:s}=this,a=!n||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=0!==this.dirtyEdgeResolutions,l=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),c=a||o&&l>(null!==(t=null===r||void 0===r?void 0:r.maxEdgeVertexCount)&&void 0!==t?t:0),h=!c&&o,d=!h&&(0!==this.dirtyEdges||o),u=!d&&0!==this.dirtyCorners;c?(this.releaseGeometry(),this._createGeometry(e)):h?i.updateEdgeElevationsAndResolutions():d||u?i.updateEdgeElevations():u?i.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,p.WD)(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i){const n=t?st.Ab.RGBA:st.Ab.RGB;return null==this._texture||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===n||this.releaseTexture(),null==this._texture&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){null!=this._texture&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}get numVerticesPerSideChanged(){return 0!=(this._modifiedFlags&s_)}get samplerDataChanged(){return 0!=(this._modifiedFlags&a_)}get clippingAreaChanged(){return 0!=(this._modifiedFlags&o_)}get wireframeChanged(){return 0!=(this._modifiedFlags&l_)}get dirtyEdges(){return this._modifiedFlags>>c_&15}get dirtyCorners(){return this._modifiedFlags>>h_&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>d_&15}_markCornerDirty(e){const t=1<<e<<h_;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<c_;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<d_;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<h_|15<<c_|15<<d_}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),n=Math.max(i,5);let r=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(r=null);const s=this.geometryState;let a=!1;s.numVerticesPerSide!==n&&(this._modifiedFlags|=1,s.numVerticesPerSide=n,s.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,s.samplerData=e.samplerData,s.samplerDataVersion++,a=!0),(0,Pu.aI)(s.clippingArea,r)||(this._modifiedFlags=4,s.clippingArea=r,a=!0);const o=t.surface.wireframe;return s.wireframe!==o&&(this._modifiedFlags=8,s.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,n=e.gl;this._vao=new oi.Z(e,Qm,{geometry:(0,ri.U)(t.layout)},{geometry:ci.g.createVertex(e,n.STATIC_DRAW,t.buffer)},ci.g.createIndex(e,n.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:mm.Immediate;null!=e&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[tu.ELEVATION],i=t.length,n=new Array(i);let r=0,s=0,a=!1;for(let c=0;c<i;c++){const i=t[c];if(null!=i.upsampleInfo){const t=i.upsampleInfo.tile,o=t.layerInfo[tu.ELEVATION][c].data,l=o&&o.samplerData;e&&e[r]===l||(a=!0),n[r++]=l,s=Math.max(s,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(c,tu.ELEVATION);if((0,gm.D_)(this.tile,t.layer,!1)){const t=i.data;e&&e[r]===t.samplerData||(a=!0),n[r++]=t.samplerData,s=this.tile.level}}}null!=e&&e.length!==r&&(a=!0);const o=r>0,l=o?n:null;return o&&(n.length=r),{changed:a,samplerData:l,maxTileLevel:s}}get estimatedGeometryMemoryUsage(){var e,t,i,n,r,s;const a=null!==(e=null===(t=this.intersectionData)||void 0===t?void 0:t.estimatedMemoryUsage)&&void 0!==e?e:0;return(null!==(i=null===(n=this.geometry.indices)||void 0===n?void 0:n.byteLength)&&void 0!==i?i:0)+(null!==(r=null===(s=this.geometry.vertexAttributes)||void 0===s?void 0:s.byteLength)&&void 0!==r?r:0)+a}get texture(){return this._texture}get test(){return{hasTexture:null!=this._texture}}checkGeometryWaterproofness(){if(!Vp.L8)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||0===e.level)return void(0,Vp.GH)(null===e||void 0===e?void 0:e.isLoaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=Vp.Rz.map(((i,n)=>null!=t&&(n<2?-1:1)*(e.extent[3-n]-t[3-n])<0)),n=e.level;(0,Vp.GH)(0===this.dirtyCorners),(0,Vp.GH)(0===this.dirtyEdges),(0,Vp.GH)(0===this.dirtyEdgeResolutions),(0,Vp.GH)(!this.numVerticesPerSideChanged),(0,Vp.GH)(!this.samplerDataChanged),(0,Vp.GH)(!this.clippingAreaChanged),(0,Vp.GH)(!this.wireframeChanged);const r=Vp.XQ.map((t=>{var i;return null!==(i=e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.isLoaded||t.level===e.level)))&&void 0!==i?i:null})).map((e=>null!==e&&void 0!==e&&e.intersectsClippingArea?e:null)),s=this.geometryState;for(let a=0;a<4;++a){const t=s.cornerPeerNeighbors[a],i=r[a];(0,Vp.GH)(i===t,"Tile[".concat(e.lij,"].corner[").concat(a,"] out of date: cur=[").concat(null===t||void 0===t?void 0:t.lij,"] exp=[").concat(null===i||void 0===i?void 0:i.lij,"]"))}Vp.Rz.forEach(((t,r)=>{if(i[r])return;const s=e.findNeighborTile(t,(e=>(e.level===n||(null===e||void 0===e?void 0:e.isLoaded))&&(null===e||void 0===e?void 0:e.intersectsClippingArea)));if(!s){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void(0,Vp.GH)(!i)}(0,Vp.GH)(s.isLoaded||s.level===e.level),(0,Vp.GH)(s===this.geometryState.edgePeerNeighbors[r]);const a=n-s.level;if(!s.isLoaded)return(0,Vp.GH)(!s.isLeaf),void(0,Vp.GH)(0===a);const o=s.renderData;(0,Vp.GH)(function(e,t,i){if(null==e||null==t)return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&i===om.N.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&i===om.N.WEST)return!0}const n=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(i){case om.N.NORTH:return(0,Vp.yL)(e.extent[3],t.extent[1],n);case om.N.SOUTH:return(0,Vp.yL)(e.extent[1],t.extent[3],n);case om.N.EAST:return(0,Vp.yL)(e.extent[2],t.extent[0],n)||(0,Vp.yL)(e.extent[2],-t.extent[0],n);case om.N.WEST:return(0,Vp.yL)(e.extent[0],t.extent[2],n)||(0,Vp.yL)(e.extent[0],-t.extent[2],n)}}(e,s,t)),(0,Vp.GH)(a>=0);const l=2**a;if(a<0)return void(0,Vp.GH)(!1);const c=e.renderData,h=c.geometry,d=c.localOrigin,u=h.getEdgeCount(r),p=h.numVerticesPerSide-1,m=o.geometry;if(!m)return void(0,Vp.GH)(!1);const _=o.localOrigin,g=this.geometryState.edgePeerNeighbors[r];if(null!==g&&void 0!==g&&g.isLoaded){const e=g.renderData;(0,Vp.GH)(c.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion),(0,Vp.GH)(this.geometryState.edgePeerNeighborSamplerVersions[r]===e.geometryState.samplerDataVersion)}const f=(r+2)%4,v=m.getEdgeCount(f),y=u-1,b=v-1;(0,Vp.GH)(y*l===b,"Tile[".concat(e.lij,"]:e").concat(r,",res=").concat(y," edgeRes mismatch with Neighbor[").concat(s.lij,"]:e").concat(f,",res=").concat(b," (expected:").concat(y*l,")"));const w=e.extent,x=t===om.N.NORTH||t===om.N.SOUTH,C=v-1,T=C>>a,A=u-1;if(T<1)return void(0,Vp.GH)(1===A);(0,Vp.GH)(T===A),(0,Vp.GH)((0,_e.r6)(T));const M=m.numVerticesPerSide-1;(0,Vp.GH)(a>0||T===Math.max(M,p));const S=e.getNeighborEdgeStartVertexIndex(r,s);(0,Vp.GH)(0<=S&&S<l);const R=S*T;(0,Vp.GH)(0<=R&&R<=C-T);let E=0,O=R;h.getEdgeVertexPosition(r,Ym,d,0),h.getEdgeVertexPosition(r,$m,d,u-1);const D=(0,Ge.q)(Ym,$m),I=Math.max(i_,1e-4*D);for(let i=0;i<=T;++i){h.getEdgeVertexPosition(r,Ym,d,E),m.getEdgeVertexPosition(f,$m,_,O);const n=i/T,a=x?w[0]+n*(w[2]-w[0]):t===om.N.WEST?w[0]:w[2],l=x?t===om.N.SOUTH?w[1]:w[3]:w[1]+n*(w[3]-w[1]),p=e.surface.extent;if(null==p||(0,L.Rj)(p,a,l)){const t=(0,Ge.o)(Ym,$m),i=(0,Ge.H)(Ym)-ge.$O.radius,n=(0,Ge.H)($m)-ge.$O.radius,g=t<I;if(!g){console.warn("Tile edge vertex position mismatch: between [".concat(e.lij,"].edge").concat(r,"[").concat(E,"/").concat(u,"] and [").concat(s.lij,"].edge").concat(f,"[").concat(O,"/").concat(v,"]")),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const y=(0,P.vt)();(0,Ge.f)(y,c.localOrigin,o.localOrigin),(0,Ge.H)(y)>0&&console.warn("   localOrigins: ".concat(c.localOrigin," vs ").concat(o.localOrigin," d=").concat((0,Ge.H)(y)," [").concat(y,"]")),(()=>{const t=(0,P.o8)(Ym),i=(0,P.o8)($m);e.updateEdgeElevations(),s.updateEdgeElevations(),h.getEdgeVertexPosition(r,Ym,d,E),m.getEdgeVertexPosition(f,$m,_,O);const n=(0,P.vt)();(0,Ge.z)(n,Ym,t),(0,Ge.H)(n)>0&&console.warn("  XXX Tile[".concat(e.lij,"] edge out of date: ").concat(t," vs ").concat(Ym," d=").concat((0,Ge.H)(n)," [").concat(n,"]")),(0,Ge.z)(n,$m,i),(0,Ge.H)(n)>0&&console.warn("  XXX Neighbor[".concat(s.lij,"] edge out of date: ").concat(i," vs ").concat($m," d=").concat((0,Ge.H)(n)," [").concat(n,"]"))})();const b=h.getEdgeCount(r),w=m.getEdgeCount(v);(0,Vp.GH)(g,"Mismatch in tile [".concat(e.lij,"].edge[").concat(r,"][").concat(E,"/").concat(b,"] vs neighbor [").concat(s.lij,"].edge[").concat(f,"][").concat(O,"/").concat(w,"] ").concat((0,Vp.hC)(Ym)," vs ").concat((0,Vp.hC)($m),"  dist=").concat(t," h(t|n|d)=").concat(i,"|").concat(n,"|").concat(n-i))}h.getEdgeNormal(r,Km,E),m.getEdgeNormal(f,Jm,O),(0,Ge.n)(e_,Km),(0,Ge.n)(t_,Jm);const y=(0,Ge.k)(e_,t_),b=1-y<.01||e===s;if(!b){const t=(0,P.vt)();(0,Ge.z)(t,Km,Jm);const i=()=>"Mismatch in tile edge normal ".concat((0,Vp.xl)(e.lij)," (").concat(E,"/").concat(u-1,") edge ").concat(r," vs neighbor ").concat((0,Vp.xl)(s.lij),"  (").concat(O,"/").concat(v-1,") nedge ").concat(f," :").concat((0,Vp.hC)(Km)," vs ").concat((0,Vp.hC)(Jm),"  dot = ").concat(y," : ").concat((0,Vp.hC)(t));console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),s.updateEdgeElevations();const t=(0,P.vt)(),i=(0,P.vt)();h.getEdgeNormal(r,t,E),m.getEdgeNormal(f,i,O),(0,Ge.G)(Km,t)||console.warn("Missing update in tile normal: ",(0,Vp.hC)(Km)," => ",(0,Vp.hC)(t)),(0,Ge.G)(Jm,i)||console.warn("Missing update in neighbor normal: ",(0,Vp.hC)(Jm)," => ",(0,Vp.hC)(i))}(0,Vp.GH)(b,i())}}E+=1,O+=1}}))}}const Ym=(0,P.vt)(),$m=(0,P.vt)(),Km=(0,P.vt)(),Jm=(0,P.vt)(),e_=(0,P.vt)(),t_=(0,P.vt)(),i_=1,n_=[null,null,null,null];function r_(e,t){return null!==t&&void 0!==t&&t.isLoaded||t===e?t:null}const s_=1,a_=2,o_=4,l_=8,c_=4,h_=8,d_=12,u_=[0,1,2,3],p_=65536;function m_(e,t){const{tile:i,geometry:n,geometryState:r}=e,{extentInRadians:s,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:h}=r,d=c-1,u=(c-2)**2,p=o&&(t===Gp.JG.HAS_SOUTH_POLE||t===Gp.JG.HAS_BOTH_POLES),m=o&&(t===Gp.JG.HAS_NORTH_POLE||t===Gp.JG.HAS_BOTH_POLES),_=((p?1:0)+(m?1:0))*Z_*c,g=B_(r),f=u+_+4*g,v=l.tileGeometryCache.acquire(f);n.numVerticesPerSide=c,n.vertexAttributes=v,n.maxEdgeVertexCount=g;const{boundingBox:y}=n;(0,am.Ie)(y);const b=y_(e);F_.update(d,s,b),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:n,localOrigin:r}=e,{numVerticesPerSide:s,samplerData:a}=n,o=s-2,l=s-1,{vertexAttributes:c,boundingBox:h}=i,d=c.position,u=c.uv0,{typedBuffer:p,typedBufferStride:m}=c.normalCompressed,{extent:_}=t,g=_[0],f=_[2],v=_[1],y=_[3],b=t.ellipsoid.radius,w=r[0],x=r[1],C=r[2],T=d.typedBuffer,A=d.typedBufferStride,M=1/l;let S=0;if(1<=o){const e=M,t=v*(1-e)+y*e,i=F_.sinLatLUT[1],n=F_.cosLatLUT[1];for(let r=1;r<=o;r++){const s=r*M,o=g*(1-s)+f*s,l=F_.sinLonLUT[r],c=F_.cosLonLUT[r],d=b+Fp(o,t,a),p=d*c*n-w,m=d*l*n-x,_=d*i-C;G_(p,m,_,h);const v=(r-1)*A;T[v]=p,T[v+1]=m,T[v+2]=_,dm(u,r-1,s,e)}}for(let P=1;P<=o;P++){const e=P*M,t=v*(1-e)+y*e,i=F_.sinLatLUT[P],n=F_.cosLatLUT[P],r=P+1,s=r*M,c=v*(1-s)+y*s,d=F_.sinLatLUT[r],_=F_.cosLatLUT[r],R=F_.sinLonLUT[0],E=F_.cosLonLUT[0],O=b+Fp(g,t,a);let D=E*n*O-w,I=R*n*O-x,L=i*O-C;const N=S*A;let F=T[N],V=T[N+1],H=T[N+2];for(let y=1;y<=o;y++){const e=y*M,r=g*(1-e)+f*e,R=F_.sinLonLUT[y],E=F_.cosLonLUT[y];let O=0,N=0,U=0;if(y<o){const e=(S+1)*A;O=T[e],N=T[e+1],U=T[e+2]}else{const e=F_.sinLonLUT[l],r=F_.cosLonLUT[l],s=b+Fp(f,t,a);O=r*n*s-w,N=e*n*s-x,U=i*s-C}const z=D,q=I,G=L;D=F,I=V,L=H,F=O,V=N,H=U;const B=O-z,k=N-q,W=U-G;let Z=0,j=0,Q=0;if(P>1){const e=(S-o)*A;Z=T[e],j=T[e+1],Q=T[e+2]}else{const e=F_.sinLatLUT[0],t=F_.cosLatLUT[0],i=b+Fp(r,v,a);Z=E*t*i-w,j=R*t*i-x,Q=e*i-C}const X=b+Fp(r,c,a),Y=E*_*X-w,$=R*_*X-x,K=d*X-C;if(P<o){const t=S+o,i=t*A;T[i]=Y,T[i+1]=$,T[i+2]=K,G_(Y,$,K,h),dm(u,t,e,s)}const J=Z-Y,ee=j-$,te=Q-K;let ie=E*n,ne=R*n,re=i;re*re<.999&&(ie=W*ee-k*te,ne=B*te-W*J,re=k*J-B*ee);const se=1/Math.sqrt(ie*ie+ne*ne+re*re);(0,lm.aT)(p,S,ie*se,ne*se,re*se,m),++S}}}(e),n.poleVerticesStartIndex=u;const w=function(e,t,i){const{tile:n,localOrigin:r,geometry:s}=e,{extent:a,ellipsoid:o}=n,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:d}=s,u=c-1,p=r[0],m=r[1],_=r[2],g=o.radius,f=a[1],v=a[3],y=[];let b=d;const w=(e,t)=>{const i=t*c;G_(-p,-m,e*g-_,l),y.push({connectedRowOffset:i,connectedOuterEdgeOffset:1===e?0:2,rowOffset:b,latitudeResolution:Z_});const n=v_(-1===e?f:v,g),r=e*Math.PI/2-n,s=.99*(1===e?1:-1),a=g+0,{position:o,uv0:d}=h,{typedBuffer:w,typedBufferStride:x}=h.normalCompressed;for(let c=1;c<=Z_;++c){const e=n+r*(c/Z_),t=Math.cos(e),i=Math.sin(e);for(let n=0;n<=u;n++){const e=n/u,r=F_.sinLonLUT[n],c=F_.cosLonLUT[n]*t,h=r*t,g=i,f=c*a-p,v=h*a-m,y=g*a-_;G_(f,v,y,l),o.setValues(b,f,v,y),dm(d,b,e,s),(0,lm.aT)(w,b,c,h,g,x),++b}}};return t&&w(-1,0),i&&w(1,u),y}(e,p,m);n.edgeVerticesStartIndex=u+_,P_(e),__(e),A_(n,w,h),e.intersectionData=null}function __(e){e.tile.intersectsClippingArea&&(f_(e),g_(e))}function g_(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{geometry:i,geometryState:n,tile:r,localOrigin:s}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=r,h=c.radius,d=l[0],u=l[2],p=l[1],m=l[3],{samplerData:_}=n,g=o[0],f=o[2],v=o[1],y=o[3],b=y_(e),{boundingBox:w,vertexAttributes:x}=i,C=s[0],T=s[1],A=s[2],M=x.position,S=M.typedBuffer,P=M.typedBufferStride,R=x.uv0;for(let E=0;E<4;++E){const s=1===E||3===E,l=n.edgeResolutions[E];(0,Vp.GH)((0,_e.r6)(l));const c=l+1,x=r_(r,n.edgePeerNeighbors[E]);if(U_(r,x,E)){E_(e,E,x);continue}const M=null!=x;(0,Vp.GH)(!M||x.level===r.level),(0,Vp.GH)(!M||(0,gm.lR)(r,x)<=0);const O=null===x||void 0===x?void 0:x.renderData,D=null===O||void 0===O?void 0:O.geometryState;if(Vp.L8){const e=r.surface;if(!x&&e&&!e.updatingRootTiles){const t=Vp.Rz[E],i=r.findNeighborTile(t,(e=>e.isLoaded||e.isLeaf||e.level===r.level));i?i.intersectsClippingArea&&((0,Vp.GH)(!i.isLoaded),(0,Vp.GH)(!i.isLeaf),(0,Vp.GH)(i.level===a)):(0,Vp.GH)(null==(null===e||void 0===e?void 0:e.rootTiles)||!r.shouldHaveNeighbor(t))}}const I=1===E?o[2]:o[0],L=null===x||void 0===x?void 0:x.extent,N=L&&s?1===E?L[0]:L[2]:I,F=0===E?o[3]:o[1],V=1===E?1:0,H=0===E?1:0,U=1===E?u:d,z=0===E?m:p,q=Math.sin(U),G=Math.cos(U),B=Math.sin(z),k=Math.cos(z),W=null===D||void 0===D?void 0:D.samplerData,Z=M?(e,t,i)=>.5*(Fp(e,t,_)+Fp(i,t,W)):(e,t,i)=>Fp(e,t,_),j=i.outerEdgesOffsetAndLength[2*E+0],Q=t&&c>3?c-3:1,X=null!=_&&_.some((e=>null!=e)),Y=null!=W&&W.some((e=>null!=e)),$=X||Y,K=1/l,J=j;(0,Vp.GH)(!L||(0,Vp.yL)(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===E?-1:3===E?1:0,t=0===E?-1:2===E?1:0,n=(o[2]-o[0])*K,r=e*n,a=t*n,l=s?e*((u-d)*K):0,p=s?0:t*K,m=H,x=s?U+l:U,O=s?Math.sin(x):q,D=s?Math.cos(x):G,L=s?U-l:U,j=s?Math.sin(L):q,X=s?Math.cos(L):G,Y=s?z:b(m+p),ee=s?B:Math.sin(Y),te=s?k:Math.cos(Y),ie=s?z:b(m-p),ne=s?B:Math.sin(ie),re=s?k:Math.cos(ie);let se=0,ae=0,oe=0;{const e=0*K,t=s?I:g*(1-e)+f*e,i=s?N:t,n=s?v*(1-e)+y*e:F,r=s?U:d*(1-e)+u*e,a=s?q:Math.sin(r),o=s?G:Math.cos(r),l=s?b(e):z,c=s?Math.sin(l):B,p=s?Math.cos(l):k,m=h+Z(t,n,i);se=o*p*m,ae=a*p*m,oe=c*m}let le=0,ce=0,he=0;{const e=1*K,t=s?I:g*(1-e)+f*e,i=s?N:t,n=s?v*(1-e)+y*e:F,r=s?U:d*(1-e)+u*e,a=s?q:Math.sin(r),o=s?G:Math.cos(r),l=s?b(e):z,c=s?Math.sin(l):B,p=s?Math.cos(l):k,m=h+Z(t,n,i);le=o*p*m,ce=a*p*m,he=c*m}for(let o=1;o<c-1;o+=Q){let e=0,t=0,n=0;{const i=(o+1)*K,r=s?I:g*(1-i)+f*i,a=s?N:r,l=s?v*(1-i)+y*i:F,c=s?U:d*(1-i)+u*i,p=s?q:Math.sin(c),m=s?G:Math.cos(c),_=s?b(i):z,w=s?Math.sin(_):B,x=s?Math.cos(_):k,C=h+Z(r,l,a);e=m*x*C,t=p*x*C,n=w*C}const l=e,c=t,p=n,m=le,x=ce,L=he;le=l,ce=c,he=p;{const e=J+o,t=e*P,i=m-C,n=x-T,r=L-A;S[t]=i,S[t+1]=n,S[t+2]=r,G_(i,n,r,w);const a=o*K;dm(R,e,s?V:a,s?a:H)}const Q=se,Y=ae,ie=oe;se=m,ae=x,oe=L;const de=m,ue=x,pe=L,me=1/Math.sqrt(de*de+ue*ue+pe*pe),_e=pe*me;let ge=0,fe=0,ve=0;if($&&_e*_e<.999){let e=0,t=0,i=0;{const n=0===E?-1:1;e=n*(l-Q),t=n*(c-Y),i=n*(p-ie)}{const n=o*K,l=s?I:g*(1-n)+f*n,c=s?N:l,p=s?v*(1-n)+y*n:F,m=s?U:d*(1-n)+u*n,w=s?q:Math.sin(m),x=s?G:Math.cos(m),C=s?b(n):z,T=s?Math.sin(C):B,A=s?Math.cos(C):k;let S=de,P=ue,R=pe;if(M){const e=h+Fp(c-r,p-a,W),t=s?A:re;S=(s?X:x)*t*e,P=(s?j:w)*t*e,R=(s?T:ne)*e}{const n=h+Fp(l+r,p+a,_),o=s?A:te,c=(s?D:x)*o*n,d=(s?O:w)*o*n,u=(s?T:ee)*n;M||(S=2*de-c,P=2*ue-d,R=2*pe-u);const m=3===E?-1:1,g=m*(S-c),f=m*(P-d),v=m*(R-u);ge=i*f-t*v,fe=e*v-i*g,ve=t*g-e*f;const y=1/Math.sqrt(ge*ge+fe*fe+ve*ve);ge*=y,fe*=y,ve*=y}}}else ge=de*me,fe=ue*me,ve=pe*me;i.setEdgeNormalFromValues(E,o,ge,fe,ve)}})()}}function f_(e){O_(e)}function v_(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function y_(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius;return t=>function(e,t,i,n){return v_(e*(1-n)+t*n,i)}(e[1],e[3],i,t)}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function b_(e,t){const{tile:i,geometryState:n,geometry:r}=e,{extent:s,surface:a}=i,{wireframe:o}=n,l=s[0],c=s[1],h=s[2]-l,d=s[3]-c,{numVerticesPerSide:u,clippingArea:p}=n,m=null!=p?Math.max(0,(p[0]-l)/h):0,_=null!=p?Math.max(0,(p[1]-c)/d):0,g=null!=p?Math.min(1,(p[2]-l)/h):1,f=null!=p?Math.min(1,(p[3]-c)/d):1,v=(u-2)**2,y=B_(n),b=v+4*y,w=a.renderer.tileGeometryCache.acquire(b),{boundingBox:x}=r;(0,am.Ie)(x),r.numVerticesPerSide=u,r.vertexAttributes=w,r.maxEdgeVertexCount=y,r.minu=m,r.minv=_,r.maxu=g,r.maxv=f,function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:n,localOrigin:r}=e,{samplerData:s,clippingArea:a,numVerticesPerSide:o}=n,{surface:l,extent:c,ellipsoid:h}=t,{isWebMercatorOnPlateCarree:d}=l,u=null!=a?a:V_,p=c[0],m=c[1],_=c[2],g=c[3],f=Math.max(p,u[0]),v=Math.min(_,u[2]),y=Math.max(m,u[1]),b=Math.min(g,u[3]),w=h.radius,x=t.horizontalScale,C=o-1,T=o-2,{minu:A,minv:M,maxu:S,maxv:P,boundingBox:R,vertexAttributes:E}=i,O=E.position,D=E.uv0,{typedBuffer:I,typedBufferStride:L}=E.normalCompressed,N=r[0],F=r[1],V=r[2],H=O.typedBuffer,U=O.typedBufferStride;let z=0;const q=(0,_e.qE)(m,y,b),G=d?(Math.PI/2-2*Math.atan(Math.exp(-q/w)))*w:q*x,B=1/C,k=(0,_e.qE)(m*(1-B)+g*B,y,b);let W=G,Z=d?(Math.PI/2-2*Math.atan(Math.exp(-k/w)))*w:k*x;for(let j=1;j<=T;j++){const e=j/C,t=(0,_e.qE)(m*(1-e)+g*e,y,b),i=(0,_e.qE)(e,M,P),n=Z,r=(j-1)/C,a=(0,_e.qE)(m*(1-r)+g*r,y,b),o=W,l=(j+1)/C,c=(0,_e.qE)(m*(1-l)+g*l,y,b),h=d?(Math.PI/2-2*Math.atan(Math.exp(-c/w)))*w:c*x,u=(0,_e.qE)(l,M,P);W=Z,Z=h;const E=(0,_e.qE)(p,f,v);let O=E*x,q=Fp(E,t,s);const G=1/C,B=(0,_e.qE)(G,A,S),k=(0,_e.qE)(p*(1-B)+_*B,f,v);let Q=B,X=k,Y=k*x,$=Fp(k,t,s);if(1===j){const e=Y-N,t=W-F,n=$-V,r=0*U;H[r]=e,H[r+1]=t,H[r+2]=n,G_(e,t,n,R);dm(D,z,(0,_e.qE)(G,A,S),i)}for(let d=1;d<=T;d++){const e=Y,r=$,l=(d+1)/C,m=(0,_e.qE)(l,A,S),g=(0,_e.qE)(p*(1-l)+_*l,f,v),y=X;X=g;{const e=z+1,r=e*U;if(1===j||d===T){const a=g*x,o=Fp(g,t,s);if(1===j&&d<T){const t=a-N,s=n-F,l=o-V;H[r]=t,H[r+1]=s,H[r+2]=l,G_(t,s,l,R),dm(D,e,m,i)}Y=a,$=o}else Y=H[r]+N,$=H[r+2]+V}const b=Y,w=$,M=O,P=q;O=e,q=r;const E=(z-T)*U,G=1===j?Fp(y,a,s):H[E+2]+V,B=Fp(y,c,s);if(j<T){const t=z+T,i=t*U,n=e-N,r=h-F,s=B-V;H[i]=n,H[i+1]=r,H[i+2]=s,G_(n,r,s,R);const a=Q;Q=m,dm(D,t,a,u)}{const e=b-M,t=o-h,i=t*(w-P),n=e*(G-B),r=-t*e,s=i*i+n*n+r*r;if(0===s)(0,lm.aT)(I,z,0,0,1,L);else{const e=1/Math.sqrt(s);(0,lm.aT)(I,z,i*e,n*e,r*e,L)}}++z}}}(e),r.edgeVerticesStartIndex=v,P_(e),w_(e),A_(r,[],o),e.intersectionData=null}function w_(e,t){e.tile.intersectsClippingArea&&(C_(e),x_(e,!1))}function x_(e,t){const{geometry:i,geometryState:n,tile:r,localOrigin:s}=e,{surface:a,extent:o}=r,{clippingArea:l,samplerData:c}=n,h=null!=l?l:V_,d=o[0],u=o[2],p=o[1],m=o[3],_=[m>h[3],u>h[2],p<h[1],d<h[0]],g=r.horizontalScale,f=T_(a.isWebMercatorOnPlateCarree,r.ellipsoid.radius,g),{minu:v,minv:y,maxu:b,maxv:w,boundingBox:x}=i,C=Math.max(d,h[0]),T=Math.min(u,h[2]),A=Math.max(p,h[1]),M=Math.min(m,h[3]),S=s[0],P=s[1],R=s[2];for(let E=0;E<4;++E){const s=1===E||3===E,o=n.edgeResolutions[E];(0,Vp.GH)((0,_e.r6)(o));const l=o+1,h=_[E],O=r_(r,n.edgePeerNeighbors[E]);if(!h&&U_(r,O,E)){E_(e,E,O);continue}const D=null!=O&&!h,I=null===O||void 0===O?void 0:O.renderData,L=null===I||void 0===I?void 0:I.geometryState;if(Vp.L8&&((0,Vp.GH)(!D||O.level===r.level),(0,Vp.GH)(!D||(0,gm.lR)(r,O)<=0),r&&!O&&!a.updatingRootTiles)){const e=Vp.Rz[E],t=r.findNeighborTile(e,(e=>e.isLoaded||e.isLeaf||e.level===r.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&((0,Vp.GH)(!t.isLoaded),(0,Vp.GH)(!t.isLeaf),(0,Vp.GH)(t.level===r.level)):(0,Vp.GH)(null==(null===a||void 0===a?void 0:a.rootTiles)||!r.shouldHaveNeighbor(e)))}const N=(0,_e.qE)(1===E?u:d,C,T),F=(0,_e.qE)(0===E?m:p,A,M),V=null===L||void 0===L?void 0:L.samplerData,H=t&&l>3?l-3:1,U=(0,_e.qE)(1===E?1:0,v,b),z=(0,_e.qE)(0===E?1:0,y,w),q=D?(e,t)=>.5*(Fp(e,t,V)+Fp(e,t,c)):(e,t)=>Fp(e,t,c),G=(u-d)/o,B=s?1===E?G:-G:0,k=s?0:0===E?G:-G,W=-B,Z=-k;let j=0,Q=0,X=0;{const e=0/o,t=s?N:(0,_e.qE)(d*(1-e)+u*e,C,T),i=s?(0,_e.qE)(p*(1-e)+m*e,A,M):F,n=q(t,i);j=t*g,Q=f(i),X=n}let Y=0,$=0,K=0;{const e=1/o,t=s?N:(0,_e.qE)(d*(1-e)+u*e,C,T),i=s?(0,_e.qE)(p*(1-e)+m*e,A,M):F,n=q(t,i);Y=t*g,$=f(i),K=n}for(let e=1;e<l-1;e+=H){const t=e/o,n=Y,r=$,a=K;{const o=s?U:(0,_e.qE)(t,v,b),l=s?(0,_e.qE)(t,y,w):z,c=n-S,h=r-P,d=a-R;G_(n,h,d,x),i.setEdgeVertexFromValuesRawPositionUV(E,e,c,h,d,o,l)}{const t=(e+1)/o,i=s?N:(0,_e.qE)(d*(1-t)+u*t,C,T),n=s?(0,_e.qE)(p*(1-t)+m*t,A,M):F,r=q(i,n);Y=i*g,$=f(n),K=r}const l=Y,h=K,_=j,O=Q,I=X;j=n,Q=r,X=a;let L=0,H=0,G=0;if(s){const e=$-r,i=h-a,s=O-r,o=I-a,l=(0,_e.qE)(p*(1-t)+m*t,A,M),d=N+W,u=d*g-n,_=Fp(d,l,c)-a,f=3===E?-1:1;if(L=f*(-s+e)*_,H=f*u*(-o+i),G=-f*u*(-s+e),D){const t=N+B,r=t*g-n;L=(-s+e)*(_-(Fp(t,l,V)-a)),H=(u-r)*(-o+i),G=-(u-r)*(-s+e)}}else{const e=l-n,i=h-a,s=_-n,o=I-a,p=(0,_e.qE)(d*(1-t)+u*t,C,T),m=F+Z,g=Fp(p,m,c)-a,v=f(m)-r,y=2===E?-1:1;if(L=y*v*(-o+i),H=y*(-s+e)*g,G=-y*v*(-s+e),D){const t=p,n=F+k,l=f(n)-r;L=(-v+l)*(-o+i),H=(-s+e)*(-g+(Fp(t,n,V)-a)),G=-(-v+l)*(-s+e)}}const J=1/Math.sqrt(L*L+H*H+G*G);i.setEdgeNormalFromValues(E,e,L*J,H*J,G*J)}}}function C_(e,t){O_(e)}function T_(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function A_(e,t,i){const{numVerticesPerSide:n,vertexAttributes:r,maxEdgeVertexCount:s}=e,a=n-1,o=r.count,l=2*(n-3)*(n-3),c=4*(a+s-3),h=u_.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),d=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),u=3*(i?2:1),p=(l+c+d)*u,m=o>=p_?new Uint32Array(p):new Uint16Array(p);for(let _=0;_<p;++_)m[_]=0;e.indices=m,e.indexCount=(l+h+d)*u,e.poleIndicesStartIndex=l*u,e.edgeIndicesStartIndex=(l+d)*u,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:n}=e,{position:r}=n,{typedBuffer:s,typedBufferStride:a}=r,o=i-2;let l=0;for(let c=0;c<i-3;++c){const e=c*o;for(let n=0;n<i-3;++n){const i=c*o+n,r=i+1,h=r+o,d=h-1,u=e+n,p=u+1,m=p+o;k_(u,p,m,m-1,a,s)?(W_(t,l,i,r,h),l+=6,W_(t,l,h,d,i)):(W_(t,l,i,r,d),l+=6,W_(t,l,d,h,r)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:n,poleIndicesStartIndex:r}=e,s=n-1;let a=r;for(const o of t){const t=o.connectedOuterEdgeOffset;let r=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<o.latitudeResolution;++e){const t=0===e?o.rowOffset:r+n;for(let n=0;n<s;n++)W_(i,a,r,r+1,t+n),a+=6,e<o.latitudeResolution-1&&(W_(i,a,r+1,t+n+1,t+n),a+=6),r+=l;r=t,l=1}}}(e,t),S_(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:n}=e,{position:r}=n,{typedBuffer:s,typedBufferStride:a}=r,o=t-2,l=t-3,c=0,h=t-3;let d=0;for(let u=0;u<l;++u){const e=u*o;for(let t=c;t<h;++t){const n=e+t,r=n+1,l=r+o,c=l-1;k_(n,r,l,c,a,s)?(i[d]=n,i[d+1]=r,i[d+2]=l,i[d+3]=l,i[d+4]=c,i[d+5]=n):(i[d]=n,i[d+1]=r,i[d+2]=c,i[d+3]=c,i[d+4]=r,i[d+5]=l),d+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:n,poleIndicesStartIndex:r}=e,s=i-1;let a=r;for(const o of t){let t=e.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),r=1;for(let e=0;e<o.latitudeResolution;++e){const l=0===e?o.rowOffset:t+i;for(let i=0;i<s;i++){const s=l+i;n[a]=t,n[a+1]=t+1,n[a+2]=s,e<o.latitudeResolution-1?(n[a+3]=t+1,n[a+4]=s+1,n[a+5]=s,a+=6):a+=3,t+=r}t=l,r=1}}}(e,t),M_(e))}function M_(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:n}=e,r=i-1,s=r-2;let a=n;for(let o=0;o<4;++o){const i=q_[o];let n=0,l=0;const c=e.getEdgeCount(o),h=i.count;(0,Vp.GH)(h===r-1);const d=1===o||2===o,u=d?1:2,p=d?2:1,m=e.getEdgeFirstVertexIndex(o),_=1,g=i.vertex0Index,f=i.stride;for(;n<c-1||l<h-1;){const e=g+l*f,i=m+n*_,o=n<c-1,d=l<h-1,v=o&&(!d||(o?0+r*(n+.5)/(c-1):0)<=(d?1+s*(l+.5)/(h-1):0));v?++n:++l;const y=v?i+_:e+f;t[a]=e,t[a+u]=i,t[a+p]=y,a+=3}}e.indexCount=a}function S_(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:n}=e,r=i-1,s=r-2;let a=n;for(let o=0;o<4;++o){const i=q_[o];let n=0,l=0;const c=e.getEdgeCount(o),h=i.count;(0,Vp.GH)(h===r-1);const d=1===o||2===o,u=d?1:3,p=d?3:1,m=e.getEdgeFirstVertexIndex(o),_=1,g=i.vertex0Index,f=i.stride;for(;n<c-1||l<h-1;){const e=g+l*f,i=m+n*_,o=n<c-1,d=l<h-1,v=o&&(!d||(o?0+r*(n+.5)/(c-1):0)<=(d?1+s*(l+.5)/(h-1):0));v?++n:++l;const y=v?i+_:e+f;t[a]=e,t[a+u]=i,t[a+u+1]=i,t[a+p]=y,t[a+p+1]=y,t[a+5]=e,a+=6}}e.indexCount=a}function P_(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:n}=i,{numVerticesPerSide:r,edgeVerticesStartIndex:s}=t,a=r-2;let o=s;for(let l=0;l<4;++l){{const e=0===l||2===l,t=(0===l?a-1:0)*a+(1===l?a-1:0),i=(e?0:1)*a+(e?1:0),n=q_[l];n.vertex0Index=t,n.stride=i,n.count=a}{const e=n[l]+1;t.outerEdgesOffsetAndLength[2*l+0]=o,t.outerEdgesOffsetAndLength[2*l+1]=e,o+=e}}}function R_(e){P_(e),e.geometryState.wireframe?S_(e.geometry):M_(e.geometry)}function E_(e,t,i){const n=(t+2)%4,{geometryState:r,geometry:s,tile:a,localOrigin:o}=e,l=a.level-i.level,c=1===t||3===t,h=r.edgeResolutions[t];(0,Vp.GH)((0,_e.r6)(h));const d=h+1,{boundingBox:u,minu:p,minv:m,maxu:_,maxv:g,vertexAttributes:f}=s,v=(0,_e.qE)(1===t?1:0,p,_),y=(0,_e.qE)(0===t?1:0,m,g),b=i.renderData,w=b.geometryState,x=b.geometry,C=x.getEdgeCount(n),T=a.getNeighborEdgeStartVertexIndex(t,i)*h,A=h*2**l;(0,Vp.GH)(w.edgeResolutions[n]===A),(0,Vp.GH)(C-1===A);const M=b.localOrigin[0]-o[0],S=b.localOrigin[1]-o[1],P=b.localOrigin[2]-o[2],R=s.getEdgeFirstVertexIndex(t),E=f.position,O=E.typedBuffer,D=E.typedBufferStride,I=f.normalCompressed,L=I.typedBuffer,N=I.typedBufferStride,F=f.uv0,V=x.vertexAttributes,H=x.getEdgeFirstVertexIndex(n),U=V.position.typedBuffer,z=V.position.typedBufferStride,q=V.normalCompressed.typedBuffer,G=V.normalCompressed.typedBufferStride;for(let B=1;B<d-1;++B){const e=R+B,t=H+(T+B),i=e*D,n=t*z,r=U[n]+M,s=U[n+1]+S,a=U[n+2]+P;O[i]=r,O[i+1]=s,O[i+2]=a,G_(r,s,a,u);const o=e*N,l=t*G;L[o]=q[l],L[o+1]=q[l+1];const d=B/h;dm(F,e,c?v:(0,_e.qE)(d,p,_),c?(0,_e.qE)(d,m,g):y)}}function O_(e){var t;const{geometry:i,geometryState:n,localOrigin:r,tile:s}=e,{clippingArea:a,samplerData:o}=n,{minu:l,minv:c,maxu:h,maxv:d,boundingBox:u,vertexAttributes:p}=i,{surface:m,ellipsoid:_,extent:g,extentInRadians:f,horizontalScale:v}=s,y="local"===(null===(t=m.view)||void 0===t?void 0:t.viewingMode),b=_.radius;let w=0,x=0,C=0;const T=y?(()=>{const e=a,t=null!=e&&(g[3]>e[3]||g[2]>e[2]||g[1]<e[1]||g[0]<e[0]),i=T_(m.isWebMercatorOnPlateCarree,b,v);return(n,r,s)=>{const a=0===n?g[0]:g[2],o=0===r?g[1]:g[3],l=t?(0,_e.qE)(a,e[0],e[2]):a,c=t?(0,_e.qE)(o,e[1],e[3]):o,h=s;w=l*v,x=i(c),C=h}})():(e,t,i)=>{const n=f[0===t?1:3],r=f[0===e?0:2],s=Math.cos(n),a=Math.sin(n),o=Math.sin(r),l=Math.cos(r),c=b+i;w=l*s*c,x=o*s*c,C=a*c};let A=0,M=0,S=0,P=0,R=0,E=0,O=0,D=0,I=0;const L=y&&m.isWebMercatorOnPlateCarree,N=(e,t,i,n,r)=>{let s=0,a=0,o=0;if(y){const e=t*v,r=L?(Math.PI/2-2*Math.atan(Math.exp(-i/b)))*b:i*v;s=e-w,a=r-x,o=n-C}else{const r=y_(e),l=e.tile,c=l.extent,h=l.extentInRadians,d=(t-c[0])/(c[2]-c[0]),u=(i-c[1])/(c[3]-c[1]),p=h[0]*(1-d)+h[2]*d,m=r(u),_=Math.cos(m),g=Math.sin(m),f=Math.sin(p),v=Math.cos(p),y=b+n;s=v*_*y-w,a=f*_*y-x,o=g*y-C}switch(r){case 0:O+=s,D+=a,I+=o;break;case 1:P-=s,R-=a,E-=o;break;case 2:O-=s,D-=a,I-=o;break;case 3:P+=s,R+=a,E+=o}},F=null!==a&&void 0!==a?a:V_,V=g[0],H=g[2],U=g[1],z=g[3],q=[z>F[3],H>F[2],U<F[1],V<F[0]],G=Math.max(V,F[0]),B=Math.min(H,F[2]),k=Math.max(U,F[1]),W=Math.min(z,F[3]),Z=e=>Math.max(F[0],Math.min(F[2],e)),j=e=>Math.max(F[1],Math.min(F[3],e)),Q=e=>{const t=n.cornerNeighborCornerTiles;A=0,M=0,S=1,P=0,R=0,E=0,O=0,D=0,I=0;let i=1/0;for(let n=0;n<4;++n){var r;const s=t[4*e+n];i=Math.min(i,null!==(r=null===s||void 0===s?void 0:s.level)&&void 0!==r?r:1/0)}for(let n=0;n<4;++n){const r=t[4*e+n];H_[n]=(null===r||void 0===r?void 0:r.level)===i?r:null}let s=1,a=0;for(let n=0;n<4;++n){const e=H_[n];e&&(s=Math.max(s,null===e||void 0===e?void 0:e.renderData.geometryState.numVerticesPerSide),a=e.extent[2]-e.extent[0])}const o=a,l=s;(0,Vp.GH)(l>1);const c=o/l;for(let n=0;n<4;++n){const e=H_[(n+3)%4],t=H_[n%4];if(!e&&!t)continue;const i=0===n?1:1===n?2:2===n?3:0,r=0===n?2:1===n?3:2===n?0:1;if(e&&t){const s=N_[n][0]*c,a=N_[n][1]*c,o=e.extent,l=Z(o[0===i||1===i?2:0]+s),h=j(o[0===i||3===i?3:1]+a),d=t.extent,u=Z(d[0===r||1===r?2:0]+s),p=j(d[0===r||3===r?3:1]+a),m=e.renderData,_=t.renderData,g=Fp(l,h,m.geometryState.samplerData),f=Fp(u,p,_.geometryState.samplerData);N(m,l,h,.5*(g+f),n)}else{const s=null!==e&&void 0!==e?e:t,a=e?i:r,o=s.extent,l=N_[n],h=Z(o[0===a||1===a?2:0]+l[0]*c),d=j(o[0===a||3===a?3:1]+l[1]*c),u=s.renderData,p=Fp(h,d,u.geometryState.samplerData);N(u,h,d,p,n)}}if(!y){const e=Math.sqrt(w*w+x*x+C*C);A=w/e,M=x/e,S=C/e}if(y||S*S<.999){const e=Math.sqrt(P*P+R*R+E*E);P/=e,R/=e,E/=e;const t=Math.sqrt(O*O+D*D+I*I);O/=t,D/=t,I/=t,A=E*D-R*I,M=P*I-E*O,S=R*O-P*D;const i=1/Math.sqrt(A*A+M*M+S*S);A*=i,M*=i,S*=i}},X=n.cornerNeighborCornerTiles;for(let Y=0;Y<4;++Y){const e=Y,t=(Y+1)%4,a=0===Y||1===Y?1:0,m=0===Y||3===Y?1:0,_=(0,_e.qE)(a,l,h),g=(0,_e.qE)(m,c,d),f=i.getEdgeFirstVertexIndex(e),v=i.getEdgeCount(e),y=0===Y||3===Y?v-1:0,b=i.getEdgeFirstVertexIndex(t),P=i.getEdgeCount(t),R=0===Y||1===Y?P-1:0;let E=-1;for(let i=0;i<4;++i){const e=X[4*Y+i],t=X[4*Y+E];e&&(-1===E||(0,gm.lR)(t,e)>0)&&(E=i)}const O=E,D=X[4*Y+O];if(D!==s){const e=s.level-D.level,t=2**e,i=[D.lij[0]+e,D.lij[1]*t,D.lij[2]*t],a=[i[1]+t===s.lij[1],0===Y&&(1===O||0===O&&D!==X[4*Y+3])||1===Y&&(0===O||1===O&&D!==X[4*Y+2]),i[1]===s.lij[1]+1,2===Y&&(3===O||2===O&&D!==X[4*Y+1])||3===Y&&(2===O||3===O&&D!==X[4*Y+0])],o=a.reduce(((e,t)=>e+(t?1:0)),0);(0,Vp.GH)(1===o||2===o);let l=-1,c=-1;const h=D.renderData;if(1===o){const e=a.findIndex((e=>e));(0,Vp.GH)(0<=e&&e<=3),l=(e+2)%4;const t=n.edgeResolutions[e];c=s.getNeighborEdgeStartVertexIndex(e,D)*t+t*(0===e&&0===Y||1===e&&0===Y||2===e&&1===Y||3===e&&3===Y?1:0)}else{(0,Vp.GH)(a[1]||a[3]),l=a[1]?3:1;const e=h.geometryState.edgeResolutions[l];c=0===Y||3===Y?0:e}const d=h.geometry;{const e=f+y,t=b+R,i=d.getEdgeFirstVertexIndex(l)+c,n=d.vertexAttributes,s=h.localOrigin;{const a=n.position,o=a.typedBuffer,l=i*a.typedBufferStride,c=o[l]+s[0]-r[0],h=o[l+1]+s[1]-r[1],d=o[l+2]+s[2]-r[2];G_(c,h,d,u);const m=p.position,_=m.typedBuffer;{const t=e*m.typedBufferStride;_[t]=c,_[t+1]=h,_[t+2]=d}{const e=t*m.typedBufferStride;_[e]=c,_[e+1]=h,_[e+2]=d}}const a=p.uv0;dm(a,e,_,g),dm(a,t,_,g);{const r=n.normalCompressed.typedBuffer,s=i*n.normalCompressed.typedBufferStride,a=p.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[s],o[t+1]=r[s+1]}{const e=t*a.typedBufferStride;o[e]=r[s],o[e+1]=r[s+1]}}}}else{let n;if(q[e]||q[t]){n=Fp((0,_e.qE)(V*(1-a)+H*a,G,B),(0,_e.qE)(U*(1-m)+z*m,k,W),o)}else n=D_(X,Y);T(a,m,n),Q(Y);const s=w-r[0],l=x-r[1],c=C-r[2];G_(s,l,c,u),i.setEdgeVertexFromValuesRawPositionUVNormal(e,y,s,l,c,_,g,A,M,S),i.setEdgeVertexFromValuesRawPositionUVNormal(t,R,s,l,c,_,g,A,M,S)}}for(let Y=0;Y<4;++Y)H_[Y]=null}function D_(e,t){const i=4*t,n=u_.reduce(((t,n)=>{var r,s;return Math.min(t,null!==(r=null===(s=e[i+n])||void 0===s?void 0:s.level)&&void 0!==r?r:1/0)}),1/0);Vp.L8&&((0,Vp.GH)(!e[i+0]||!e[i+2]||Vm(e[i+0],e[i+2],om.N.SOUTH_WEST)),(0,Vp.GH)(!e[i+1]||!e[i+3]||Vm(e[i+1],e[i+3],om.N.NORTH_WEST)));let r=0,s=0;for(let l=0;l<4;++l){const t=e[i+l];if(t&&t.level===n){var a;const e=0===l||1===l,i=0===l||3===l,n=t.extent;s+=Fp(n[e?0:2],n[i?1:3],null===(a=t.renderData)||void 0===a||null===(a=a.geometryState)||void 0===a?void 0:a.samplerData),r++}}const o=r?s/r:0;return(0,Vp.GH)(null!=o),o}function I_(e){const{vao:t,geometry:i}=e,{vertexAttributes:n,edgeVerticesStartIndex:r}=i,s=n.position.typedBuffer;t.vertexBuffers.geometry.setSubData(s,r,r,s.length)}function L_(e){const{vao:t,geometry:i}=e,{indices:n,indexCount:r,edgeIndicesStartIndex:s}=i;t.indexBuffer.setSubData(n,s,s,r)}const N_=[[0,1],[1,0],[0,-1],[-1,0]],F_=new class{constructor(){this.sinLonLUT=new Array(j.Me+1),this.cosLonLUT=new Array(j.Me+1),this.sinLatLUT=new Array(j.Me+1),this.cosLatLUT=new Array(j.Me+1)}update(e,t,i){const n=t[0],r=t[2];for(let s=0;s<=e;s++){const t=s/e,a=n*(1-t)+r*t;this.sinLonLUT[s]=Math.sin(a),this.cosLonLUT[s]=Math.cos(a);const o=i(t);this.sinLatLUT[s]=Math.sin(o),this.cosLatLUT[s]=Math.cos(o)}}},V_=(0,L.fA)(-1/0,-1/0,1/0,1/0),H_=[null,null,null,null];function U_(e,t,i){if(!t)return!1;const n=(0,gm.lR)(e,t);return n>0||0===n&&i>=2}class z_{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return(0,Vp.GH)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const q_=[new z_,new z_,new z_,new z_];function G_(e,t,i,n){e<n[0]?n[0]=e:e>n[3]&&(n[3]=e),t<n[1]?n[1]=t:t>n[4]&&(n[4]=t),i<n[2]?n[2]=i:i>n[5]&&(n[5]=i)}function B_(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,n=1+Math.max(...t);return Math.max(i,n)}function k_(e,t,i,n,r,s){const a=e*r,o=s[a],l=s[a+1],c=s[a+2],h=t*r,d=s[h],u=s[h+1],p=s[h+2],m=i*r,_=s[m],g=s[m+1],f=s[m+2],v=n*r,y=s[v],b=s[v+1],w=s[v+2];return(d-y)*(d-y)+(u-b)*(u-b)+(p-w)*(p-w)>(o-_)*(o-_)+(l-g)*(l-g)+(c-f)*(c-f)}function W_(e,t,i,n,r){e[t]=i,e[t+1]=n,e[t+2]=n,e[t+3]=r,e[t+4]=r,e[t+5]=i}const Z_=6;var j_=i(99362);class Q_ extends Pm{constructor(e,t,i,n,r){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=(0,L.vt)(),this._baseUsedMemory=900,this.init(e,t,i,n,r)}init(e,t,i,n,r){super.init(e,t,i,n,r);const s=r.view.renderSpatialReference,a=r.spatialReference,o=null!=s&&(0,ke.r1)(s)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=r,c=this._extentInRenderSR,h=this.extent;if(l){const e=(0,P.fA)(h[0],h[1],0);(0,Tp.F)(e,k.A.WebMercator,e,k.A.PlateCarree);const t=(0,P.fA)(h[2],h[3],0);(0,Tp.F)(t,k.A.WebMercator,t,k.A.PlateCarree),c[0]=e[0],c[1]=e[1],c[2]=t[0],c[3]=t[1]}else for(let d=0;d<4;++d)c[d]=h[d]*o;this.centerAtSeaLevel[0]=.5*(c[0]+c[2]),this.centerAtSeaLevel[1]=.5*(c[1]+c[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(c[2]-c[0],c[3]-c[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),n=Math.sqrt(t*t+i*i),r=.5*(this.elevationBoundsMax-this.elevationBoundsMin),s=Math.max(n,r);this._center[Lm.MIDDLE][3]=s}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),i=t[0],n=t[1],r=t[2],s=t[3],a=t[4],o=t[5];let l=!0;for(let c=0;c<6;c++){const t=e[c],h=t[0],d=t[1],u=t[2],p=t[3];if(h*(h>0?i:s)+d*(d>0?n:a)+u*(u>0?r:o)+p>=0)return om.Z.OUTSIDE;l=l&&h*(h<0?i:s)+d*(d<0?n:a)+u*(u<0?r:o)+p<=0}return l?om.Z.INSIDE:om.Z.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return(0,am.LV)(e[0],e[1],this.elevationBoundsMin,e[2],e[3],this.elevationBoundsMax)}intersectsRay(e,t,i,n){return X_[0]=1/t[0],X_[1]=1/t[1],X_[2]=1/t[2],(0,j_.d2)(this._aabb(),e,X_,i,n)}createGeometry(){b_(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){!function(e,t){e.tile.intersectsClippingArea&&(C_(e),x_(e,!0),I_(e),e.intersectionData=null)}(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){!function(e,t){e.tile.intersectsClippingArea&&(w_(e),I_(e),e.intersectionData=null)}(this.renderData,this._horizontalScaleFactor)}updateEdgeElevationsAndResolutions(){!function(e,t){e.tile.intersectsClippingArea&&(R_(e),w_(e),I_(e),L_(e),e.intersectionData=null)}(this.renderData,this._horizontalScaleFactor)}get horizontalScale(){return this._horizontalScaleFactor}}const X_=(0,P.vt)();var Y_=i(16475);class $_{constructor(){this.extent=(0,Ye.vt)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let K_=class extends T.A{constructor(){super(...arguments),this._queries=new oc.A({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new oc.A({initialSize:30}),this._queryPool=new $c.A($_)}queryVisibleLevelRange(e,t,i,n){const r=this._queryPool.acquire();(0,Xe.c)(r.extent,e),r.minLevel=null!==t&&void 0!==t?t:-Number.MAX_VALUE,r.maxLevel=null!==i&&void 0!==i?i:Number.MAX_VALUE,r.callback=n,this._queryQueue.push(r),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const n=this._queries.data[i],r=n.extent;t>=n.minLevel&&t<=n.maxLevel&&r[0]<=e.extent[2]&&r[2]>=e.extent[0]&&r[1]<=e.extent[3]&&r[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};(0,n._)([(0,b.MZ)()],K_.prototype,"updating",null),K_=(0,n._)([(0,x.$)("esri.views.3d.terrain.ScaleRangeQueries")],K_);var J_=i(44815);class eg extends Pm{constructor(e,t,i,n,r){super(),this._convexHull=new Array(24),this._boundingSphere=(0,vn.c)(),this._baseUsedMemory=1816,this.init(e,t,i,n,r)}init(e,t,i,n,r){super.init(e,t,i,n,r);const s=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],c=this.extentInRadians[3],h=(0,_e.Cc)(o,c,.5),d=(0,_e.Cc)(a,l,.5),u=0===e?0:Math.min(Math.abs(o),Math.abs(c));this._edgeLen=(l-a)*Math.cos(u)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),function(e,t,i,n){const r=Math.cos(i);e[0]=Math.cos(t)*r*n,e[1]=Math.sin(t)*r*n,e[2]=Math.sin(i)*n}(this.centerAtSeaLevel,d,h,this.ellipsoid.radius),(0,Ge.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])(0,Ge.s)((0,vn.g)(e[Lm.MIDDLE]),0,0,0),(0,Ge.s)(e[Lm.TOP],0,0,0),(0,Ge.s)(e[Lm.BOTTOM],0,0,0),e[Lm.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[Lm.MIDDLE],i=this.convexHull;let n=0;for(let e=0;e<8;++e)n=Math.max(n,ig((0,vn.g)(t),i,3*e));e[Lm.MIDDLE][3]=Math.sqrt(n)}}_calculateFrustumVisibilityStatus(e){if(!(0,Xc.m7)(e,this._boundingSphere))return om.Z.OUTSIDE;if(this.lij[0]<10)return om.Z.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let n=!0;for(let r=0;r<Xc.YH;r++){const s=r===Xc.FB.NEAR,a=e[r],o=a[0],l=a[1],c=a[2],h=a[3]-(s?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+c*t[i+2]+h<0){if(d=!0,!n)break}else n=!1}if(!d)return om.Z.OUTSIDE}return n?om.Z.INSIDE:om.Z.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){m_(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Vp.L8&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=(0,vn.g)(e),i=this.elevationBoundsMin,n=this.elevationBoundsMax,r=this.ellipsoid.radius,s=n;if(0===this.level)(0,Ge.s)(t,0,0,0),e[3]=r+s;else{const s=this.extentInRadians,a=.5*(s[0]+s[2]),o=s[1],l=s[3];rg(ag,a,o,r),rg(og,a,l,r),(0,Ge.g)(t,ag,og),(0,Ge.h)(t,t,(r+.5*(i+n))/(0,Ge.H)(t));const c=this.convexHull;let h=0;const d=(e,t)=>{const i=e[0]-c[3*t],n=e[1]-c[3*t+1],r=e[2]-c[3*t+2];return Math.sqrt(i*i+n*n+r*r)};for(let e=0;e<8;++e){const i=d(t,e);h=Math.max(h,i)}const u=h;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,n=this.elevationBoundsMax,r=this._getPatchType(),s=this.surface.isWebMercator,a=s&&r===Gp.JG.HAS_NORTH_POLE,o=s&&r===Gp.JG.HAS_SOUTH_POLE,l=o||a,c=Math.PI/2,h=e[0],d=e[2],u=o?-c:e[1],p=a?c:e[3],m=.5*(h+d),_=i,g=t+(l?Math.min(0,_-1):_),f=(e,t,i)=>rg(e,t,i,g),v=(0,P.vt)(),y=(0,P.vt)(),b=(0,P.vt)(),w=(0,P.vt)();f(v,h,u),f(y,h,p),f(b,d,p),f(w,d,u);const x=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};x(v,0),x(y,1),x(b,2),x(w,3);const C=n,T=t+(l?Math.max(0,C+1):C),A=(0,P.vt)(),M=(0,P.vt)(),S=(0,P.vt)();rg(M,m,p,g),rg(S,m,u,g),(0,Ge.g)(A,M,S),(0,Ge.n)(A,A);const R=(0,P.vt)(),E=(0,P.vt)(),O=(e,t)=>{(0,Ge.z)(E,e,t),(0,Ge.n)(E,E);const i=-(0,Ge.k)(e,R)/(0,Ge.k)(E,R);(0,Vp.GH)(i>=0),(0,Ge.h)(E,E,i),(0,Ge.g)(e,e,E)};if(2**this.lij[0]>2*this.lij[1]){const e=S,t=(0,P.vt)();(0,Ge.b)(t,sg,e),(0,Ge.n)(t,t),(0,Ge.b)(R,e,t),(0,Ge.n)(R,R),(0,Vp.GH)((0,Vp.yL)((0,Ge.k)(R,e)/(0,Ge.H)(e),0)),O(v,y),O(w,b),x(v,0),x(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=M,t=(0,P.vt)();(0,Ge.b)(t,sg,e),(0,Ge.n)(t,t),(0,Ge.b)(R,t,e),(0,Ge.n)(R,R),O(y,v),O(b,w),x(y,1),x(b,2)}const D=(e,t)=>{const i=T/(0,Ge.k)(t,A);for(let n=0;n<3;++n)this._convexHull[3*e+n]=t[n]*i};D(4,v),D(5,y),D(6,b),D(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?Gp.JG.HAS_BOTH_POLES:Gp.JG.HAS_NORTH_POLE:i?Gp.JG.HAS_SOUTH_POLE:Gp.JG.REGULAR}intersectsRay(e,t,i,n){const r=this._boundingSphere,s=r[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=r[0]-e[0],l=r[1]-e[1],c=r[2]-e[2],h=(o*t[0]+l*t[1]+c*t[2])/a,d=t[0]*h-o,u=t[1]*h-l,p=t[2]*h-c;return d*d+u*u+p*p<s*s}getDefaultVerticesPerSide(){return this.level<tg.length?tg[this.level]+1:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(f_(e),g_(e,!0),I_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(__(e),I_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(R_(e),__(e),I_(e),L_(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var e;if(!Vp.L8)return;if(this.level<=2)return;const t=this._boundingSphere,i=t[3],n=(0,vn.g)(t),r=(0,P.vt)(),s=this.ellipsoid.radius,a=this.elevationBoundsMin,o=this.elevationBoundsMax,l=s+a,c=this._center[Lm.MIDDLE][3],h=this.convexHull,d=(e,t)=>{for(let i=0;i<3;++i)e[i]=h[3*t+i]};{const e=(0,P.vt)(),t=(0,P.vt)(),i=(0,P.vt)(),n=(0,P.vt)(),r=(0,P.vt)(),s=(s,a,o,l)=>{d(t,s),d(i,a),d(n,o),(0,Ge.z)(t,t,i),(0,Ge.z)(n,n,i),(0,Ge.b)(e,t,n),(0,Ge.n)(e,e);const c=(0,Ge.k)(e,i);d(r,l);const h=(0,Ge.k)(e,r),u=Math.abs(h-c);(0,Vp.GH)((0,Vp.yL)(u,0),"Non coplanar ".concat(s,",").concat(a,",").concat(o,",").concat(l," diff = ").concat(u))};s(0,1,2,3),s(4,5,6,7),s(0,1,4,5),s(1,2,5,6),s(2,3,6,7),s(3,0,7,4)}const u=(0,J_.jh)(24),p=(0,P.vt)(),m=(0,P.vt)(),_=(0,P.vt)(),g=(0,P.vt)(),f=(e,t,i,n)=>{d(p,t),d(m,i),d(_,n),(0,Ge.z)(p,p,m),(0,Ge.n)(p,p),(0,Ge.z)(_,_,m),(0,Ge.n)(_,_),(0,Ge.b)(g,p,_),(0,Ge.n)(g,g);const r=(0,Ge.k)(g,m);((e,t,i)=>{const n=4*e;for(let r=0;r<3;++r)u[n+r]=t[r];u[n+3]=i})(e,g,r)};f(0,0,1,2),f(1,1,0,4),f(2,1,5,2),f(3,3,2,6),f(4,4,0,3),f(5,4,6,5);const v=(e,t,i,n)=>{const r=4*e;return u[r]*t+u[r+1]*i+u[r+2]*n-u[r+3]},y=(e,t,i,n)=>v(e,t,i,n)>=-1,b=(e,t)=>y(e,t[0],t[1],t[2]),w=2**this.lij[0]>2*this.lij[1],x=(e,t,r)=>Math.sqrt(ng(e,t,r,n[0],n[1],n[2]))<i,C=e=>x(e[0],e[1],e[2]),T=(e,t)=>x(e[t],e[t+1],e[t+2]),A=this.extentInRadians,M=.5*(A[0]+A[2]),S=A[1],R=A[3],E=(0,P.vt)(),O=(0,P.vt)();rg(E,M,R,l),rg(O,M,S,l);const D=w?"Upper":"Lower";let I=!0;for(let P=0;P<6;++P){for(let e=0;e<8;++e){const t=3*e,i=y(P,h[t],h[t+1],h[t+2]);I&&(I=i),(0,Vp.GH)(i,"Tile[".concat(this.lij,"] Convex hull point ").concat(e," outside of plane ").concat(P))}(0,Vp.GH)(b(P,O),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of plane ").concat(P)),(0,Vp.GH)(b(P,E),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of plane ").concat(P))}(0,Vp.GH)(I,"Not all convex hull points are inside  convex hull polyhedron"),(0,Vp.GH)(C(O),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of bounding sphere")),(0,Vp.GH)(C(E),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of bounding sphere"));for(let P=0;P<8;++P){const e=T(h,3*P);(0,Vp.GH)(e,"Tile[".concat(this.lij,"] Convex hull point ").concat(P," outside of bounding sphere"))}for(let P=0;P<6;++P)for(let e=0;e<8;++e){const t=3*e;y(P,h[t],h[t+1],h[t+2])||console.error("Tile[".concat(this.lij,"] Convex hull point ").concat(e," outside of plane ").concat(P))}const{extentInRadians:L}=this,N=Math.max(L[2]-L[0],L[3]-L[1]),F=Math.round(N*s),{renderData:V}=this;if(!V)return;const{geometry:H,geometryState:U,localOrigin:z}=V,q=null===(e=H.vertexAttributes)||void 0===e?void 0:e.position;if(!q)return;const G=(0,P.vt)(),B=H.numVerticesPerSide-2,{indices:k,indexCount:W,edgeVerticesStartIndex:Z,poleVerticesStartIndex:j}=H;if(!k)return;const Q=new Set;for(let P=0;P<W;++P){const e=k[P];if(Q.has(e))continue;Q.add(e);const t=e<j,l=e>=Z;let h=!1,d=-1;if(l){let t=Z;for(let i=0;i<4;++i){const n=U.edgeResolutions[i];if(e===t||e===t+n-1){h=!0;break}if(t+=n,e<t){d=i;break}}}const u=l?U.edgePeerNeighbors[d]:null,p=l&&u&&(0,gm.lR)(this,u)>0;q.getVec(e,r),(0,Ge.g)(G,r,z);const m=(0,Ge.H)(G)-s;let _=0,g=!1;const f=a-m,b=m-o,w=f>1,x=b>1,C=w||x,T=()=>{const i=t?"internal":l&&!h?"edge":h?"corner":"pole";return"Tile[".concat(this.lij,"].vertex[").concat(e,"]:").concat(i)+(w?"(below)":x?"(above)":"")+(p?"(Neighbor)":"")},A=(0,Ge.o)(G,n);if(A>=i+0){const e=A-i;C||(console.error("".concat(T()," is out of the bounding sphere by ").concat(e.toFixed(0)," / ").concat(i.toFixed(0),"[tol=").concat(0,"] h=").concat(m.toFixed(0)," / [").concat(a.toFixed(0),"..").concat(o.toFixed(0),"] (").concat((e/i).toFixed(0),")")),g=!0)}for(let n=0;n<6;++n)if(!y(n,G[0],G[1],G[2])){const t=v(n,G[0],G[1],G[2]),r=e%B,s=(e-r)/B;0===n&&f||5===n&&b||(console.error("".concat(T()," (").concat(r,",").concat(s,")|").concat(B,"] is out of the bounding trapezoid plane ").concat(n," h=").concat(Math.round(m)," / [").concat(Math.round(a),"..").concat(Math.round(o),"] dist=").concat(Math.round(t)," radii = ").concat(Math.round(i),"/").concat(Math.round(c),"} : maxL = ").concat(F)),++_)}if(g||_>0)break}}get convexHull(){return this._convexHull}}const tg=[128,64,64,32,16,8,8,4];function ig(e,t,i){return ng(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function ng(e,t,i,n,r,s){const a=n-e,o=r-t,l=s-i;return a*a+o*o+l*l}const rg=(e,t,i,n)=>{const r=Math.cos(t),s=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=n*a*r,e[1]=n*a*s,e[2]=n*o},sg=[0,0,1],ag=(0,P.vt)(),og=(0,P.vt)();let lg=class extends T.A{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};(0,n._)([(0,b.MZ)()],lg.prototype,"fovX",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"fovY",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"relativeWidthLimit",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"relativeHeightLimit",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"maxLod",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"angledSplitBias",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"aboveGround",void 0),(0,n._)([(0,b.MZ)()],lg.prototype,"frustum",void 0),lg=(0,n._)([(0,x.$)("esri.views.3d.terrain.SplitLimits")],lg);var cg=i(88105),hg=i(29898);const dg=(0,si.BP)().vec3f(li.r.POSITION).vec2i16(li.r.UV0).vec2i16(li.r.NORMALCOMPRESSED,{glNormalized:!0});class ug{constructor(e){this._storage=new Cp.I(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,n=function(e){return e.toString()}(t),r=i.pop(n);if(r)return r;const s=dg.createBuffer(t);return s.release=()=>i.put(n,s),s}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}var pg=i(32124);class mg extends ct.K{constructor(){super(...arguments),this.blendMode=pg.IU.Normal}}(0,n._)([(0,ct.W)({count:pg.IU.COUNT})],mg.prototype,"blendMode",void 0);var _g=i(79360);class gg extends mg{constructor(){super(...arguments),this.output=_g.xV.Composite,this.baseOpacityMode=_g.Qo.NotRequired,this.premultipliedSource=_g.gv.Off}}(0,n._)([(0,ct.W)({count:_g.xV.COUNT})],gg.prototype,"output",void 0),(0,n._)([(0,ct.W)({count:_g.Qo.COUNT})],gg.prototype,"baseOpacityMode",void 0),(0,n._)([(0,ct.W)()],gg.prototype,"premultipliedSource",void 0);var fg=i(25252),vg=i(28590);class yg extends fg.J{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=P.uY}}class bg extends it.w{initializeProgram(e){return new rt.B(e.rctx,bg.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.ox)(st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE})}}bg.shader=new tt.$(vg.B,(()=>i.e(54825).then(i.bind(i,54825))));class wg extends gg{constructor(){super(...arguments),this.background=vg.a.BelowLayer}}(0,n._)([(0,ct.W)()],wg.prototype,"background",void 0);class xg{constructor(e,t,i,n,r,s){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=(0,Ye.fA)(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=(0,P.fA)(n,r,s)}destroy(){this.texture.release()}}var Cg=i(72770),Tg=(i(40181),i(93453)),Ag=(i(15389),i(96345),i(71296)),Mg=i(76418),Sg=i(83337),Pg=i(30520);class Rg{constructor(){this._renderParams={reshuffleManager:new Pg.E,context:null,drawPhase:1,state:new Ag.A({viewpoint:new s.A({targetGeometry:new oo.A(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Sg.V(new Tg.A(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,i,n,r,s,a,o,l,c){const h=this._backgroundTile;this._updateRenderParameters(e,t,h,i,r,s,a,o,l,c),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,h,n)}renderContent(e,t,i,n,r,s,a,o,l,c,h,d){this._stencilSymbols(e,t,i,n,r,s,a,Math.round(1/o),l,c,h,d);let u=1;i.stencilRef=u++,e.setStencilFunction(st.MT.EQUAL,i.stencilRef,255),this._render(e,t,i,r,s,a,o,l,c,h,d),n.forAll((t=>{t.sourceLayerInfo.data.stencilRef=u++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,r,s,a,Math.round(1/o),t.offset,c,h,d)}))}_stencilSymbols(e,t,i,n,r,s,a,o,l,c,h,d){let u=1;i.stencilRef=u++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(st.eA.KEEP,st.eA.KEEP,st.eA.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(st.MT.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,r,s,a,o,l,c,h,d);for(const p of n.toArray()){const{sourceLod:t,offset:i,sourceLayerInfo:n}=p;n.data.stencilRef=u++,e.setStencilFunction(st.MT.ALWAYS,n.data.stencilRef,255),this._stencilTileSymbols(e,t,n.data,r,s,a,o,i,c,h,d)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,n,r,s,a,o,l,c,h){e.setStencilFunction(st.MT.EQUAL,i.stencilRef,255),this._render(e,t,i,n,r,s,a,o,l,c,h,Mg.Dc.SYMBOL)}_render(e,t,i,n,r,s,a,o,l,c,h,d){this._updateRenderParameters(e,t,i,n,s,a,o,l,c,h),this._renderParams.stencilSymbols=!1,n.drawTile(this._renderParams,i,r,d)}_stencilTileSymbols(e,t,i,n,r,s,a,o,l,c,h){this._updateRenderParameters(e,t,i,n,s,a,o,l,c,h),this._renderParams.stencilSymbols=!0,i.triangleCount=0,n.drawSymbols(this._renderParams,i,r)}_updateRenderParameters(e,t,i,n,r,s,a,o,l,c){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const h=t[0]-r.getLevelShift(t[0]),d=this._renderParams;d.context=e,d.painter=n,d.glyphMosaic=n.glyphMosaic,d.spriteMosaic=n.spriteMosaic,d.pixelRatio=l*c,d.displayLevel=h,d.requiredLevel=h;const u=r.getScale(t[0]),[p,m]=r.getOffset(t,s*u),_=.125*s*u/o,g=i.transforms.displayViewScreenMat3;g[0]=_,g[4]=-_,g[6]=-1-p-a[0]*s*2,g[7]=1+m+(1-a[1])*s*2-2,d.state.size[0]=o/c,d.state.size[1]=o/c,d.state.pixelRatio=c}}var Eg=i(745);class Og extends it.w{initializeProgram(e){return new rt.B(e.rctx,Og.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.ox)(st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE})}}Og.shader=new tt.$(Eg.R,(()=>i.e(64713).then(i.bind(i,64713))));class Dg extends gg{constructor(){super(...arguments),this.colorizerType=Cg.T.Stretch,this.stretchType=Cg.M.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}(0,n._)([(0,ct.W)({count:Cg.T.COUNT})],Dg.prototype,"colorizerType",void 0),(0,n._)([(0,ct.W)({count:Cg.M.COUNT})],Dg.prototype,"stretchType",void 0),(0,n._)([(0,ct.W)()],Dg.prototype,"applyColormap",void 0),(0,n._)([(0,ct.W)()],Dg.prototype,"requireBilinearWithNN",void 0);var Ig=i(88800);class Lg{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Vt.H(this._rctx,new Ht.R(e),new Ig.q(st.yQ.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}class Ng{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new Rg,this._bindParameters=new zt.k(null,null),this._blendLayersTechniqueConfig=new wg,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,pt.Q)(this._rctx,ut.u7)}dispose(){this._fbos.forEach(p.WD),this._fbos=null,this._vtFBO=(0,p.WD)(this._vtFBO),this._vaoQuad=(0,p.WD)(this._vaoQuad),this._vectorTileHelper=(0,p.WD)(this._vectorTileHelper),this._backgroundTechnique=(0,p.Gz)(this._backgroundTechnique),this._applyOpacityTechnique=(0,p.Gz)(this._applyOpacityTechnique),this._blendLayersTechnique=(0,p.Gz)(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:_g.gv.Off,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:vg.a.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=n,this._blendLayersTechniqueConfig.background=r,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(bg,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const i=this._getBlendLayersTechnique(pg.IU.Normal,t?_g.xV.ColorComposite:_g.xV.GridComposite,_g.Qo.NotRequired,_g.gv.Off,vg.a.Only),n=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(n)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(st.WR.TRIANGLE_STRIP,0,(0,di.mT)(this._vaoQuad,"geometry"))}drawGroup(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:_g.gv.On;t===_g.xV.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const s=e.baseOpacity<1?_g.Qo.Required:_g.Qo.NotRequired,a=this._getBlendLayersTechnique(n,t,s,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:_g.gv.Off;if(null==e.texture)return;const s=e.baseOpacity<1?_g.Qo.Required:_g.Qo.NotRequired;e.fboTexture=t===_g.xV.GroupBackgroundComposite||n===pg.IU.Normal&&s===_g.Qo.NotRequired&&r===_g.gv.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(n,t,s,r),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageryTileData(e,t,i,n,r){const s=r.sourceLayerInfo.data;if(!s.source)return;if(r.tile.surface.layerViewByIndex(r.layerIndex,tu.MAP).ensureSymbolizerParameters(s),!s.bind(this._rctx))return;const a=e.baseOpacity<1?_g.Qo.Required:_g.Qo.NotRequired;e.fboTexture=n===pg.IU.Normal&&a===_g.Qo.NotRequired?null:this.switch(i).colorTexture;const o=this._getRasterColorizerTechnique(s,t,n,a);s.opacity=e.opacity;const l=s.getUniforms();l.scale=r.scale,l.offset=r.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(o,null,l);this._render(c)}_getRasterColorizerTechnique(e,t,i,n){const r=e.symbolizerParameters,s=["stretch","lut","hillshade"].indexOf(r.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new Dg,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=n,this._rasterColorizerConfig.colorizerType=s,this._rasterColorizerConfig.applyColormap=!!r.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?Cg.M.Noop:Cg.M.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(Og,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,i,n,r,s,a,o){const l=this._rctx,c=r.sourceLayerInfo.data,h=r.tile.surface.layerViewByIndex(r.layerIndex,tu.MAP),d=e.baseOpacity<1?_g.Qo.Required:_g.Qo.NotRequired,p=d===_g.Qo.Required||e.opacity<1||n!==pg.IU.Normal||t!==_g.xV.Composite,m=p?_g.gv.On:_g.gv.Off,_=this._getBlendLayersTechnique(n,t,d,m);l.setPipelineState(_.getPipeline());let g=null,f=null;p?(f=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new Lg(this._rctx)),g=this._vtFBO.get(i),l.bindFramebuffer(g),this._clearCurrentFBO()):o&&l.clearSafe(st.hn.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(l,r.sourceLod,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/r.scale),r.offset,a,s,h.contentZoom),c&&this._vectorTileHelper.renderContent(l,r.sourceLod,c,r.vtlNeighborInfos,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/r.scale),r.offset,a,s,h.contentZoom)}catch(Wi){u.A.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",Wi)}return null==g||(l.bindFramebuffer(f),e.texture=g.colorTexture,e.offset=Ke.uY,e.scale=1,this.drawRasterData(e,t,i,n,m),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,hi.g.TEXTURE_UNIT_FOR_UPDATES),n=e.descriptor;t.gl.copyTexImage2D(st.Ap.TEXTURE_2D,0,n.pixelFormat,0,0,n.width,n.height,0),e.generateMipmap(),t.bindTexture(i,hi.g.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clearSafe(st.hn.COLOR_BUFFER_BIT|st.hn.DEPTH_BUFFER_BIT|st.hn.STENCIL_BUFFER_BIT)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(let n=this._fbos.length;n<=t;n++)this._fbos.push(new Lg(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class Fg{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}class Vg{constructor(e,t,i,n,r,s){this.start=e,this.end=t,this.blendMode=i,this.opacity=n,this.output=r,this.baseOpacity=s}}class Hg{constructor(e,t,i,n){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=n,this._passParameters=new yg,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new Ng(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=(0,p.WD)(this._composition),this._backgroundTexture=(0,p.Gz)(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,n=i.baseOpacity;let r=0,s=0,a=this.tileSize,o=!1,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;Bg.clear(),kg.length=0;const d=e.layerInfo[tu.MAP];let u=0,p=null;for(;u<d.length;u++){const t=i.layerViewByIndex(u,tu.MAP),m=t.layer.opacity,_=t.fullOpacity;if(l=l||(0,H.rz)(t.layer),(0,Vp.KE)(t)){let e="normal"!==t.layer.blendMode;if((0,H.jZ)(t.layer.parent)){const i=zg(t.layer.parent);null!=i&&""!==i&&(e=qg(t.layer.parent)||e)}e&&(h=e,o=!1)}if(0===m&&!h){d[u].pendingUpdates&=~(Sm.TEXTURE_NOFADING&Sm.TEXTURE_FADING);continue}++s;const g=(0,Vp.G3)(t),f=Ug(e,u,g);if(f){if(d[u].pendingUpdates&=~(Sm.TEXTURE_NOFADING&Sm.TEXTURE_FADING),(0,H.jZ)(t.layer.parent)){const e=zg(t.layer.parent);null!=e&&""!==e&&Gg(t.layer.parent,u)}g?a=Math.max(a,this.tileSize*c):1===n&&1===_&&(t.isOpaque||this._dataToTexture(f)&&f.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++r,null===p&&(p=u)}}const m=a/this.tileSize,_=this._ensureBackgroundTexture(this.tileSize);0!==r&&null!==p?1===r&&!h&&this._useLayerTexture(e,p)||this._composeMapLayers(e,t,u-1,l,a,m,!o||h,Bg,h):this._useBackgroundTexture(e,s,_,t!==Gp.ZY.FADING)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=Ke.uY,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useBackgroundTexture(e,t,i,n){const r=e.renderData,s=!n&&null!=r.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?mm.Delayed:mm.Immediate;r.setTextureReference(new xg(i,Gp.ZY.FADING,Zg,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,tu.MAP),n=(0,H.rz)(i.layer),r=n?e.surface.baseOpacity:1,s=n?1:e.surface.baseOpacity,a=i.fullOpacity,o=Ug(e,t,!1);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new xg(o.sourceLayerInfo.data,Gp.ZY.FADING,o,r,s,a)),!0)}_composeMapLayers(e,t,i,n,r,s,a,o,l){this._composition.ensureBuffer(r);const c=e.surface.baseOpacity;let h=!1,d=st.Cj.LINEAR_MIPMAP_LINEAR,u=!1,p=0;for(let f=i;f>=0;f--){const t=e.surface.layerViewByIndex(f,tu.MAP),i=(0,Vp.G3)(t),m=Ug(e,f,i),_=t.layer.opacity;if(!m||0===_&&!l)continue;const g=!(0,H.rz)(t.layer)&&!h;g&&(h=!0);let v=!1;o.forEach((e=>{e.start===f&&(e.output=n?_g.xV.Composite:a&&g?this.backgroundIsGrid?_g.xV.GridComposite:_g.xV.ColorComposite:_g.xV.Composite,e.baseOpacity=g?c:1,kg.push(e),this._composition.openGroup(r),v=!0)})),this._passParameters.baseOpacity=g&&!v&&c<1?c:1;const y=0===p,b=v?_g.xV.GroupBackgroundComposite:a&&y?this.backgroundIsGrid?_g.xV.GridComposite:_g.xV.ColorComposite:_g.xV.Composite,w=pg.wy[(0,Vp.KE)(t)?t.layer.blendMode:"normal"];for(this._passParameters.opacity=_,(0,Vp.cU)(m)?u=this._composition.drawVectorData(this._passParameters,b,r,w,m,s,this.tileSize,u):(0,Vp.fe)(m)?(this._composition.drawImageryTileData(this._passParameters,b,r,w,m),this._hasNearestInterpolation(m)&&(d=st.Cj.NEAREST)):this._dataToTexture(m)&&(this._passParameters.texture=m.sourceLayerInfo.data.texture,this._passParameters.offset=m.offset,this._passParameters.scale=m.scale,this._composition.drawRasterData(this._passParameters,b,r,w));kg.length>0&&kg[kg.length-1].end===f;){const e=kg.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Ke.uY,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,e.output,r,pg.wy[e.blendMode])}p++}const m=e.renderData,_=l||h&&c<1,g=m.ensureTexture(r,_,(()=>this._buildTexture(r,_,d)));this._composition.copyFBOToTexture(g),this._composition.unbind(),m.setTextureReference(new xg(g,t,Zg,h?1:c,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if((0,Vp.gF)(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return(0,Vp.E5)(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:st.Cj.LINEAR_MIPMAP_LINEAR;if(null==e)return null;const n=new Ht.R;n.wrapMode=st.pF.CLAMP_TO_EDGE,n.samplingMode=i,n.maxAnisotropy=this._maxAnisotropy,n.preMultiplyAlpha=!0,n.flipped=!0,n.hasMipmap=!0,t||(n.pixelFormat=st.Ab.RGB);const r=this._rctx;let s;if("number"==typeof e){n.width=n.height=e;const t="".concat(e," ").concat(n.pixelFormat);s=this._cache.pop(t),s?s.retain():s=new Mm(new hi.g(r,n),this._cache)}else if((0,wu.EM)(e)){n.isOpaque=e.isOpaque,n.isOpaque&&(n.pixelFormat=st.Ab.RGB);const t="".concat(e," ").concat(n.pixelFormat);s=this._cache.pop(t),s?(s.retain(),s.texture.setData(e.image)):s=new Mm(new hi.g(r,n,e.image),this._cache),e.release()}else try{n.width=e.width,n.height=e.height,s=new Mm(new hi.g(r,n,e))}catch(ve){s=new Mm((0,pt.T)(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=r.bindTexture(s.texture,hi.g.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(a,hi.g.TEXTURE_UNIT_FOR_UPDATES),s}get test(){return{backgroundTexture:this._backgroundTexture}}}function Ug(e,t,i){Wg.layerIndex=t,Wg.vtlNeighborInfos.clear();const n=e.layerInfo[tu.MAP][t];if((0,Qe.hZ)(Wg.offset,0,0),Wg.tile=e,Wg.scale=1,Wg.sourceLod=e.lij,Wg.sourceLayerInfo=n,Wg.isVTLBackground=i,n.data)return i&&e.forEachLoadedNeighbor(((i,r)=>{if(i.level!==e.level)return;const s=i.layerInfo[tu.MAP][t];if(!(0,Vp.Y4)(s)||n.data===s.data)return;const a=Wg.vtlNeighborInfos.pushNew();a.offset=jg[r],a.sourceLod=i.lij,a.sourceLayerInfo=s})),Wg;const r=n.upsampleInfo;if(r){const e=r.tile.layerInfo[tu.MAP][t];return Wg.tile=r.tile,(0,Qe.C)(Wg.offset,r.offset),Wg.scale=r.scale,Wg.sourceLod=r.tile.lij,Wg.sourceLayerInfo=e,Wg}return i?Wg:null}function zg(e){return e.uid}function qg(e){let t="normal"!==e.blendMode;return(0,H.jZ)(e.parent)&&(t=qg(e.parent)||t),t}function Gg(e,t){(0,H.jZ)(e.parent)&&Gg(e.parent,t);const i=zg(e);if(null!=i&&""!==i){const n=Bg.get(i);n?n.start=t:Bg.set(i,new Vg(t,t,e.blendMode,e.opacity,_g.xV.Composite,1))}}const Bg=new Map,kg=new Array,Wg=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new oc.A({allocator:e=>e||new Fg})}},Zg={offset:[0,0],scale:1},jg=new Array;jg[om.N.NORTH]=[0,-1],jg[om.N.NORTH_EAST]=[-1,-1],jg[om.N.EAST]=[-1,0],jg[om.N.SOUTH_EAST]=[-1,1],jg[om.N.SOUTH]=[0,1],jg[om.N.SOUTH_WEST]=[1,1],jg[om.N.WEST]=[1,0],jg[om.N.NORTH_WEST]=[1,-1];const Qg=1e-6;class Xg{constructor(e,t,i,n,r){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=n,this.rightStartIndex=r}}class Yg{constructor(e,t,i,n){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=n,this._rayDirection=(0,P.vt)(),this.bspNodeTree=new Array;const r=i-t,s=r<=ef?new Uint16Array(r):new Uint32Array(r);this.indices=s;for(let a=0;a<r;++a)s[a]=a;{const a=function(e,t,i,n,r){const s=i-t,a=new Float32Array(6*s);for(let o=0;o<s;++o){const i=3*(o+t),s=e[i]*r,l=e[i+1]*r,c=e[i+2]*r;for(let e=0;e<3;++e){const t=n[s+e],i=n[l+e],r=n[c+e];a[6*o+e]=Math.min(t,i,r),a[6*o+3+e]=Math.max(t,i,r)}}return a}(e,t,i,n.data,n.stride),o=(0,_e.qE)(Math.log2(r/40),2,10),l=(e,t,i)=>{const n=function(e,t,i,n){if(n<=i)return(0,am.fA)(NaN,NaN,NaN,NaN,NaN,NaN);{const n=6*e[i];for(let e=0;e<3;++e)Kg[e]=t[n+0+e],Jg[e]=t[n+3+e]}for(let r=i+1;r<n;++r){const i=6*e[r];for(let e=0;e<3;++e)Kg[e]=Math.min(Kg[e],t[i+0+e]),Jg[e]=Math.max(Jg[e],t[i+3+e])}return(0,am.fA)(Kg[0],Kg[1],Kg[2],Jg[0],Jg[1],Jg[2])}(s,a,e,t),r=t-e;if(r<=40){const i=new Xg(n,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:c,midValue:h}=function(e){const t=e[3]-e[0],i=e[4]-e[1],n=e[5]-e[2],r=t>i?t>n?0:i>n?1:2:i>n?1:n>t?2:0;return{axis:r,midValue:(e[r]+e[r+3])/2}}(n),d=function(e,t,i,n,r,s){let a=i,o=n;for(;a<o;){const i=e[a];t[6*i+r+3]<=s?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=n;l<o;){const i=e[o-1];t[6*i+r]>=s?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(s,a,e,t,c,h),u=(e,t)=>{if(i>o)return;const n=t-e;return n<40||n>=.8*r?void 0:l(e,t,i+1)},p=new Xg(n,c,h,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,r,0),this.triangleVertexIndices=function(e,t,i,n){const r=n-i;let s=0;for(let o=i;o<n;++o)for(let e=0;e<3;++e)s=Math.max(t[3*o+e],s);const a=s<=ef?new Uint16Array(3*r):new Uint32Array(3*r);for(let o=0;o<r;++o){const n=3*(e[o]+i);for(let e=0;e<3;++e){const i=t[n+e];a[3*o+e]=i}}return a}(s,e,t,i)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.triangleVertexIndices,n=this.positions.data,r=this.positions.stride,s=this._rayOrigin,a=s[0],o=s[1],l=s[2],c=this._rayDirection,h=c[0],d=c[1],u=c[2];for(let p=e,m=3*e;p<t;++p){const e=i[m]*r,t=n[e],s=n[e+1],c=n[e+2],_=i[m+1]*r,g=n[_],f=n[_+1],v=n[_+2],y=i[m+2]*r;m+=3;const b=g-t,w=f-s,x=v-c,C=n[y]-t,T=n[y+1]-s,A=n[y+2]-c,M=d*A-T*u,S=u*C-A*h,P=h*T-C*d,R=b*M+w*S+x*P;if(Math.abs(R)<=Number.EPSILON)continue;const E=a-t,O=o-s,D=l-c,I=E*M+O*S+D*P;if(R>0){if(I<0||I>R)continue}else if(I>0||I<R)continue;const L=O*x-w*D,N=D*b-x*E,F=E*w-b*O,V=h*L+d*N+u*F;if(R>0){if(V<0||I+V>R)continue}else if(V>0||I+V<R)continue;const H=(C*L+T*N+A*F)/R;if(H>=0){const e=this.indices[p]+this.firstTriangleIndex,t=(0,j_.ho)(b,w,x,C,T,A,$g);this._callback(H,t,e,!1)}}Yg.numFacesTested+=t-e}intersectRay(e,t,i){Yg.numFacesTested=0;const n=e,r=t,s=r[0]-n[0],a=r[1]-n[1],o=r[2]-n[2];if(s*s+a*a+o*o<Qg)return;this._rayOrigin=n;const l=this._rayDirection;l[0]=s,l[1]=a,l[2]=o;const c=this.triangleVertexIndices.length/3;this._callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,t,i){const n=this._rayOrigin,r=this._rayDirection;if(!function(e,t,i){const n=t,r=i;let s=0,a=1/0;for(let o=0;o<3;++o){{const t=e[o];if(n[o]<t){if(r[o]<=Qg)return!1;const e=(t-n[o])/r[o];s=Math.max(s,e)}else if(r[o]<=-1e-6){const e=(t-n[o])/r[o];a=Math.min(a,e)}if(s>a)return!1}{const t=e[o+3];if(n[o]>t){if(r[o]>=-1e-6)return!1;const e=(t-n[o])/r[o];s=Math.max(s,e)}else if(r[o]>=Qg){const e=(t-n[o])/r[o];a=Math.min(a,e)}if(s>a)return!1}}return!0}(e.aabb,n,r))return;const s=e.axis,a=e.d;if(n[s]<a||r[s]<0){const i=t,n=e.midStartIndex;if(i<n){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,n):this.intersectRayTriangleRange(i,n)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),n[s]>a||r[s]>0){const t=e.rightStartIndex,n=i;if(t<n){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,n):this.intersectRayTriangleRange(t,n)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}Yg.numFacesTested=0;const $g=(0,P.vt)(),Kg=[1/0,1/0,1/0],Jg=[-1/0,-1/0,-1/0];const ef=65535;var tf=i(34981),nf=i(38918),rf=i(50468),sf=i(16699),af=i(59046),of=i(97808),lf=i(26719),cf=i(12057),hf=i(92656);class df extends hf.E{constructor(){super(...arguments),this.output=tf.V.Color,this.overlayMode=cf.w9.Disabled,this.tileBlendInput=nf.k.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=lf.A9.Simplified}}(0,n._)([(0,ct.W)({count:tf.V.COUNT})],df.prototype,"output",void 0),(0,n._)([(0,ct.W)({count:cf.w9.COUNT})],df.prototype,"overlayMode",void 0),(0,n._)([(0,ct.W)({count:nf.k.COUNT})],df.prototype,"tileBlendInput",void 0),(0,n._)([(0,ct.W)()],df.prototype,"spherical",void 0),(0,n._)([(0,ct.W)()],df.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,n._)([(0,ct.W)()],df.prototype,"receiveShadows",void 0),(0,n._)([(0,ct.W)()],df.prototype,"hasSlicePlane",void 0),(0,n._)([(0,ct.W)()],df.prototype,"backfaceCullingEnabled",void 0),(0,n._)([(0,ct.W)()],df.prototype,"textureFadingEnabled",void 0),(0,n._)([(0,ct.W)()],df.prototype,"renderOccluded",void 0),(0,n._)([(0,ct.W)()],df.prototype,"hasScreenSpaceReflections",void 0),(0,n._)([(0,ct.W)()],df.prototype,"hasCloudsReflections",void 0),(0,n._)([(0,ct.W)()],df.prototype,"invisible",void 0),(0,n._)([(0,ct.W)()],df.prototype,"tileBorders",void 0),(0,n._)([(0,ct.W)()],df.prototype,"visualizeNormals",void 0),(0,n._)([(0,ct.W)()],df.prototype,"screenSizePerspective",void 0),(0,n._)([(0,ct.W)()],df.prototype,"receiveAmbientOcclusion",void 0),(0,n._)([(0,ct.W)({count:lf.A9.COUNT})],df.prototype,"pbrMode",void 0),(0,n._)([(0,ct.W)({constValue:af.W.Compressed})],df.prototype,"normalType",void 0),(0,n._)([(0,ct.W)({constValue:of.q.Compressed})],df.prototype,"textureCoordinateType",void 0),(0,n._)([(0,ct.W)({constValue:!1})],df.prototype,"highStepCount",void 0),(0,n._)([(0,ct.W)({constValue:!1})],df.prototype,"useCustomDTRExponentForWater",void 0),(0,n._)([(0,ct.W)({constValue:!1})],df.prototype,"useFillLights",void 0),(0,n._)([(0,ct.W)({constValue:!0})],df.prototype,"hasColorTexture",void 0);const uf=(0,am.vt)();var pf;!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(pf||(pf={}));let mf=class extends $i.Ot{get _isGlobal(){return this._stage.viewingMode===te.RT.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,n,r){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=n,this.type=Pd.dz.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new df,this._passParameters=new Wm.T,this._drawParameters=new sf.P,this._renderDataPool=new $c.A(Xm),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new gm.C2,this._transparencyState=pf.Opaque,this._castShadows=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=jp.m$.Occlude,this.produces=new Map([[Ki.N.OPAQUE_TERRAIN,()=>this._produces()],[Ki.N.TRANSPARENT_TERRAIN,()=>this._produces()],[Ki.N.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new Cp.I(((e,t)=>r.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new ug(r)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles((0,g.watch)((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?kp.O8:jp.m$.Occlude,this.setNeedsRender()}),g.sync))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?$i.B7:$i.qo}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===pf.TransparentWithDraped||e===pf.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return Ws.fo}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,Sm.TEXTURE_FADING)}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===Sm.TEXTURE_FADING?Gp.ZY.FADING:Gp.ZY.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[tu.ELEVATION])i.pendingUpdates&=~Sm.GEOMETRY;e.resetPendingUpdate(Sm.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return P.uY;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wp.C7.UPDATE;this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wp.C7.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wp.C7.UPDATE;this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new Hg(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=(0,pt.T)(this._rctx)}uninitializeRenderContext(){this._emptyTex=(0,p.WD)(this._emptyTex),this._tileRenderer=(0,p.WD)(this._tileRenderer)}intersect(e,t,i,n){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==pf.Opaque)return;const r=_f,s=gf;(0,Ge.f)(r,n,i),(0,Ge.s)(s,1/r[0],1/r[1],1/r[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=e.options.store===Pd.oH.MIN,h=!!e.results.ground.target,d=(0,Ws.dd)(e.verticalOffset),u=e.tolerance;let p,m=c&&null!=a.dist?a.dist:1/0;const _=h=>{const _=h.renderData;if(null===_||void 0===_||!_.vao)return;const g=_.geometry;(0,am.hZ)(uf,g.boundingBox);const f=_.localOrigin;null!=d&&(d.localOrigin=f,d.applyToAabb(uf));const v=uf;if(ff[0]=i[0]-f[0],ff[1]=i[1]-f[1],ff[2]=i[2]-f[2],!(0,j_.d2)(v,ff,s,u,m))return;const y=(e,t,i)=>{e.set(this.type,h,t,i,Mt.zK),m=c&&null!=a.dist?a.dist:1/0},b=(s,c)=>{if(null!=c&&s>=0&&(e.options.backfacesTerrain||(0,Ge.k)(c,r)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,n,s))){if((null==l.dist||s<l.dist)&&y(l,s,c),e.options.isFiltered)return;e.options.store===Pd.oH.ALL&&(null==p?(p=(0,Ms.G7)(e.ray),y(p,s,c),e.results.all.push(p)):s<p.dist&&y(p,s,c)),(null==a.dist||s<a.dist)&&y(a,s,c),e.options.store!==Pd.oH.MIN&&(null==o.dist||s>o.dist)&&y(o,s,c)}},w=vf;(0,Ge.f)(w,n,f);const{indices:x,indexCount:C}=g,T=g.vertexAttributes,A=T.getField(li.r.POSITION,cg.xs),M=new rf.K(A.typedBuffer,3,T.stride/4),S=C/3;if(!d&&S>200){const e=h.renderData;null==e.intersectionData&&(e.intersectionData=new Yg(x,0,S,M)),e.intersectionData.intersectRay(ff,w,b)}else(0,j_.Z$)(ff,w,0,S,x,M,null,d,b)},g=this._rootTiles;null!=g&&(()=>{const t=this._tileIterator;t.reset(g);const n=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||n&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(i,r,u,m)||h&&this._useStencilForTile(e)?t.skipSubtree():_(e)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const n of t){var i;null!=(null===(i=n.renderData)||void 0===i?void 0:i.textureReference)&&e.queriesForTile(n)}e.process(),t.madeProgress()}}prepareTechnique(e){const t=(0,d.A)("enable-feature:terrain-shadows")&&e.bindParameters.shadowMap.enabled;if(t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0),e.bindParameters.slot===Ki.N.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&kp.O8))return null}else{const t=this.transparency===pf.Opaque?Ki.N.OPAQUE_TERRAIN:Ki.N.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}if(this.transparency===pf.Empty)return null;switch(e.output){case tf.V.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=e.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=e.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=e.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(tf.V.Color,e.bindParameters.slot===Ki.N.OCCLUDED_TERRAIN);case tf.V.Shadow:case tf.V.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(tf.V.Shadow,!1)):null;case tf.V.LinearDepth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(tf.V.LinearDepth,!1);case tf.V.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(tf.V.Normal,!1);case tf.V.ObjectAndLayerIdColor:return this._updateTechnique(tf.V.ObjectAndLayerIdColor,!1);case tf.V.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(tf.V.Highlight,!1)):null}return null}renderNode(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case tf.V.Color:{const i=e.bindParameters.slot===Ki.N.OCCLUDED_TERRAIN?hg.A.Occluded:hg.A.Color;this._renderMaterialPass(e,t,i);break}case tf.V.LinearDepth:case tf.V.Normal:this._renderAuxiliaryPass(e,t,hg.A.Color,this._visiblePatchesByOrigin);break;case tf.V.Highlight:this._renderAuxiliaryPass(e,t,hg.A.Highlight,this._visiblePatchesByOrigin);break;case tf.V.Shadow:case tf.V.ShadowExcludeHighlight:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case tf.V.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,hg.A.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=Yd.A.toUnitRGBA(e);i=(0,P.fA)(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,Gp.ZY.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?nf.k.GridComposite:null!=t.backgroundColor?nf.k.ColorComposite:nf.k.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Y_.X.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)(0,gm.Ey)(this.renderOrder,i,t);e.sort(((e,t)=>(0,gm.Ri)(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){var t;null!==(t=e[0])&&void 0!==t&&t.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const n=i.localOrigin;if(this._castShadows){let t=this._allPatchesByOrigin.get(n);t||(t=[],this._allPatchesByOrigin.set(n,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let r=this._visiblePatchesByOrigin.get(n);r||(r=[],this._visiblePatchesByOrigin.set(n,r)),r.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,n){const r=e.rctx;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bindParameters,this._passParameters);const s=this._stencilEnabledLayerExtents.length>0;n.forEach((n=>{this._drawParameters.origin=n[0].renderData.localOrigin,t.program.bindDraw(this._drawParameters,e.bindParameters,this._passParameters);for(let r=0;r<n.length;r++)this._renderPatch(e,t,n[r],st.WR.TRIANGLES,s,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){var n;const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=(0,wc.mt)(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,l=i===hg.A.Occluded;l&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",P.uY),a.setUniform4fv("texOffsetAndScale",Ye.uY));const c=null!=(null===(n=this._tileRenderer)||void 0===n?void 0:n.backgroundColor)?this._tileRenderer.backgroundColor:P.uY;this._techniqueConfiguration.tileBlendInput===nf.k.ColorComposite&&a.setUniform3fv("backgroundColor",c);const h=this.wireframe?st.WR.LINES:st.WR.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const d=this._visiblePatchesByOrigin;for(const u of d.values()){const n=u[0].renderData.localOrigin;t.program.bindDraw(new sf.P(n),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const r of u){const n=r.renderData,s=n.textureReference;if(null!=s){if(!l){a.setUniform4fv("texOffsetAndScale",s.offsetAndScale),a.bindTexture("tex",s.texture.texture);const e=n.textureFadeFactor,t=e<1?n.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=t&&e<1?(a.setUniform1f("fadeFactor",e),a.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),a.setUniform3fv("nextTexOpacities",t.opacities),a.bindTexture("texNext",t.texture.texture)):a.setUniform1f("fadeFactor",1),n.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",s.opacities)}this._renderPatch(e,t,r,h,o,i),r.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,n,r,s){const a=i.renderData,o=a.vao,l=null===o||void 0===o?void 0:o.indexBuffer;if(!o||null==l)return void(Vp.L8&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const c=t.program;null==s||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),r&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const h=a.geometry.indexCount;e.rctx.bindVAO(o),c.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(n,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(jm,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};(0,n._)([(0,b.MZ)({readOnly:!0})],mf.prototype,"_isGlobal",null),(0,n._)([(0,b.MZ)()],mf.prototype,"renderOccludedFlags",void 0),(0,n._)([(0,b.MZ)({value:!1})],mf.prototype,"renderingDisabled",null),(0,n._)([(0,b.MZ)({value:!0})],mf.prototype,"visible",null),(0,n._)([(0,b.MZ)()],mf.prototype,"renderPatchBorders",null),(0,n._)([(0,b.MZ)()],mf.prototype,"visualizeNormals",null),(0,n._)([(0,b.MZ)()],mf.prototype,"cullBackFaces",null),(0,n._)([(0,b.MZ)({value:Y_.X.FRONT_TO_BACK})],mf.prototype,"renderOrder",null),(0,n._)([(0,b.MZ)()],mf.prototype,"wireframe",null),mf=(0,n._)([(0,x.$)("esri.views.3d.terrain.TerrainRenderer")],mf);const _f=(0,P.vt)(),gf=(0,P.vt)(),ff=(0,P.vt)(),vf=(0,P.vt)();class yf{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var bf=i(44527);let wf=class extends T.A{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),(0,g.watch)((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!(0,H.qK)(t)||t.isRejected())&&!(t.isFulfilled()&&!function(e,t,i){return null!=(0,Vp.Uo)(e,t,i)}(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!("vector-tile"===(null===t||void 0===t?void 0:t.type)||(0,Vp.Ci)(t))))),e)if(e.isResolved()){const t=(0,Vp.Uo)(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new bf.n(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===te.RT.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=bf.n.makeWebMercatorAuxiliarySphere(t):(0,O.canProjectToWGS84ComparableLonLat)(e.spatialReference)&&(e=bf.n.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,g.watch)((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===te.RT.Global){const e=this.extentHelper.viewSpatialReference,t=(0,O.canProjectToWGS84ComparableLonLat)(e)||(0,ke.q8)(e)||(0,ke.KQ)(e);e.isWebMercator?this.tilingScheme=bf.n.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=bf.n.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||(0,L.aI)(e,this.extent)||(this.tilingScheme=bf.n.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};(0,n._)([(0,b.MZ)()],wf.prototype,"tilingScheme",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],wf.prototype,"extent",void 0),(0,n._)([(0,b.MZ)({value:!1})],wf.prototype,"tilingSchemeLocked",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wf.prototype,"viewSpatialReference",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wf.prototype,"layers",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wf.prototype,"extentHelper",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],wf.prototype,"viewingMode",void 0),wf=(0,n._)([(0,x.$)("esri.views.3d.terrain.TilingSchemeLogic")],wf);class xf{constructor(){this.offset=(0,Ke.vt)(),this.scale=0,this.tile=null}init(e,t,i,n){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=n}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}var Cf;let Tf=Cf=class extends(B.A.EventedMixin(T.A)){constructor(e){var t,i,n;super(e),this._scaleRangeQueries=new K_,this._iteratorPool=new $c.A(gm.C2,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new gm.V$,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new yf,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=(0,P.vt)(),this._eyePosSurfaceSR=(0,P.vt)(),this._splitLimits=new lg,this._frustum=(0,Xc.vt)(),this._viewProjectionMatrix=(0,Mt.vt)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new Pi.U,this._frameTask=qt.nu,this._allTiles=new oc.A,this._upsampleInfoPool=new $c.A(xf),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=(0,L.vt)(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=k.A.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Dp(1/0,-1/0),this.rootTileElevationBounds=new Dp(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=(0,Jc.Ur)(),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new Kp({...e,surface:this}),this._isGlobal=!(null!==(t=e.view)&&void 0!==t&&null!==(t=t.state)&&void 0!==t&&t.isLocal),this._isGeographic=null!==(i=null===(n=this._spatialReference)||void 0===n?void 0:n.isGeographic)&&void 0!==i&&i,this._tileConstructor=this._isGlobal?eg:Q_}initialize(){const e=this.view,t=e.resourceController;this._lercDecoder=(0,Pp.b)(t);const n=t.memoryController;this._tileCache=new Cp.I(((e,t)=>n.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=n.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Mp.E(n.newCache("elevation-query"));const r=this.overlayManager;this._renderer=new mf(r.renderer,e._stage,this._allTiles,(0,We.tO)(e.spatialReference).radius,n),this.addHandles([(0,g.watch)((()=>r.renderer.isEmpty),(()=>this._evaluateTransparency())),(0,g.watch)((()=>this.renderer.visible),(e=>this.suspended=!e))],"overlayManager"),this.addHandles([(0,g.watch)((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?Gp.ZY.UNFADED:Gp.ZY.IMMEDIATE)}),g.syncAndInitial),(0,g.watch)((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?Gp.ZY.UNFADED:Gp.ZY.IMMEDIATE)),g.syncAndInitial),(0,g.watch)((()=>this.backgroundColor),((e,t)=>{(null===e||void 0===e?void 0:e.equals(t))||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),g.sync),(0,g.watch)((()=>this.snapLevel),(()=>this._viewChanged=!0),g.sync),(0,g.watch)((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),(0,g.watch)((()=>lc.b.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?i.e(12777).then(i.bind(i,12777)).then((t=>{let{TerrainTileTree3DDebugger:i}=t;!this._treeDebugger&&lc.b.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new i({view:e}))})):t||(this._treeDebugger=(0,p.pR)(this._treeDebugger))}),g.initial)]);const{spatialReference:s}=e;this._extentHelper=function(e,t){return e===te.RT.Global?new Up(t):new zp(t)}(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:s});const a=new xp.A({getCollections:()=>{var t;return null===(t=e.defaultsFromMap)||void 0===t||null===(t=t.mapCollections)||void 0===t?void 0:t.map((e=>{let{layers:t}=e;return t}))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),o=new wf({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(yu.sK.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(yu.sK.BASEMAP);const l=t.scheduler;this._frameTask=l.registerTask(qt.W6.TERRAIN_SURFACE,this),this.addHandles([(0,g.watch)((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),g.initial),(0,g.watch)((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),g.sync),(0,g.watch)((()=>this.extent),(()=>this._updateRootTiles()),g.initial),e.on("resize",(()=>this._viewChangeUpdate())),(0,g.watch)((()=>{const t=e.state;return[this._lodBias,this.lodSnapping,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),g.syncAndInitial),(0,g.watch)((()=>{var t;return null===(t=e.qualitySettings)||void 0===t?void 0:t.fadeDuration}),(e=>this._renderer.textureFadingEnabled=e>0),g.initial),(0,g.watch)((()=>{var t;return null===(t=e.qualitySettings)||void 0===t?void 0:t.physicallyBasedRenderingEnabled}),(e=>this._renderer.pbrMode=e?lf.A9.Simplified:lf.A9.Disabled),g.initial),(0,g.watch)((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),g.sync)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._lercDecoder=(0,p.Gz)(this._lercDecoder),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,p.pR)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,p.pR)(this.overlayManager)),this._tileCache=(0,p.pR)(this._tileCache),Pm.prune(),this._treeDebugger=(0,p.pR)(this._treeDebugger),this._renderer=(0,p.pR)(this._renderer),this._iteratorPool=(0,p.pR)(this._iteratorPool),this._upsampleMapCache=(0,p.pR)(this._upsampleMapCache),this._elevationQueryCache=(0,p.pR)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,p.pR)(this._extentHelper),this._upsampleInfoPool=(0,p.pR)(this._upsampleInfoPool),(0,Rp.D)(),Am.size>0&&(console.log("".concat(Am.size," live TilePerLayerInfo allocations:")),Am.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===Gp.iw.ON){var e;const t=this.view,i=this.tilingScheme,n=null===(e=t.pointsOfInterest)||void 0===e||null===(e=e.cameraOnSurface)||void 0===e?void 0:e.scale;if(i&&n){const e=t.state.contentCamera;let r=(0,G.gn)(t,e.eye,e.viewForward,e.up).tilt;r>90&&(r=180-r);const s=2*(r/90)**2,a=i.levelAtScale(n)-s,o=Math.min(a+t.qualitySettings.tiledSurface.lodBias,this._splitLimits.maxLod||1/0);return o<=0?null:o}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Gp.iw.ON:Gp.iw.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=(0,L.vt)(),n=(0,gd.k)(t,i,e)?i:null,r=this._get("extent");return(0,L.aI)(n,r)?r:n}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=(0,L.E$)(this.groundExtent,this._userClippingExtent,(0,L.vt)()),t=this._get("extent");return(0,L.aI)(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return null===(e=this.tilingSchemeLogic)||void 0===e?void 0:e.extent}get updating(){var e,t;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||null!==(e=this._watchUpdatingTracking)&&void 0!==e&&e.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||null!==(t=this.overlayManager)&&void 0!==t&&t.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var e,t;return null!==(e=null===(t=this.view)||void 0===t||null===(t=t.map)||void 0===t||null===(t=t.ground)||void 0===t?void 0:t.opacity)&&void 0!==e?e:1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){var e,t;return null!==(e=null===(t=this.tilingScheme)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:null}get backgroundColor(){var e;return null===(e=this.view)||void 0===e||null===(e=e.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){var e,t;return null!==(e=null===(t=this.tilingSchemeLogic)||void 0===t?void 0:t.tilingSchemeLocked)&&void 0!==e&&e}get wireframe(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===pf.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){var e;return null!==(e=this.view.qualitySettings.fadeDuration)&&void 0!==e?e:0}intersect(e,t,i,n){this._renderer.intersect(e,t,i,n)}getElevation(e,t,i,n){var r;const s=this._rootTiles;if(null===s||void 0===s||!s.length)return null;if(0===s[0].layerInfo[tu.ELEVATION].length)return null;let a=this._elevationProjectorCache.get(n);if(void 0===a&&(a=null!==(r=(0,Jc.jd)(n,this._spatialReference))&&void 0!==r?r:null,this._elevationProjectorCache.set(n,a)),null==a)return u.A.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const o=(0,Ge.s)(Mf,e,t,i);return a(o,0,o,0),Df(s,o[0],o[1])}getElevations(e,t,i){const n=this._rootTiles,r=n?n[0].layerInfo[tu.ELEVATION].length:0;if(null!==n&&void 0!==n&&n.length&&0!==r)for(let s=0;s<t;++s){const t=3*s;i(s,Df(n,e[t],e[t+1]))}else for(let s=0;s<t;++s)i(s,null)}getScale(e){if(!this.tilingScheme)return null;if(!(0,I.g)(e,Mf,this.spatialReference))return u.A.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const i of t)if(null!==i&&void 0!==i&&i.containsPoint(Mf)){let e=i;for(;e.children[0]&&!e.rendered;){const t=e.children[0].extent;let i=0;Mf[0]>t[2]&&(i+=1),Mf[1]<t[1]&&(i+=2),e=e.children[i]}return this._getLodBiasCorrectedScale(e.level)}return 1/0}_ensureSEBProject(e){var t;const i=this._sebProjectorMap.get(e);if(i)return i;const n=null!==(t=(0,Jc.jd)(e,this._tilingSchemeSpatialReference,this._sebProjectorCache))&&void 0!==t?t:null;return this._sebProjectorMap.set(e,n),n}getSphereElevationBounds(e,t){const i=this._ensureSEBProject(t);if(null==i)return u.A.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,vn.a)(e,Sf);const n=(0,vn.g)(Sf);i(n,0,n,0);const r=new Gd.H,s=this._rootTiles;if(null!=s){const e=[];for(const i of s)e.push(i);let t=0;for(;t<e.length;){const i=e[t];if(++t,!(0,L.m7)(i.extent,Sf))continue;const n=i.children;if(null==n[0]||i.rendered)r.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of n)e.push(t)}}return r}getRootElevationBounds(){return new Gd.H(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!(0,I.g)(e,(0,vn.g)(Sf),this.spatialReference))return u.A.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Sf[3]=t;let i=null;const n=e=>{if(e&&(0,L.m7)(e.extent,Sf)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)n(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},r=this._rootTiles;if(null!=r)for(const s of r)n(s);return i}queryVisibleScaleRange(e,t,i,n){const r=t?this.tilingScheme.levelAtScale(t):0,s=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,r+a,s+a,n)}_evaluateTransparency(){var e;const t=this.baseOpacity,i=this.overlayManager.renderer.isEmpty,n=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?i?pf.Empty:pf.TransparentWithDraped:t>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?pf.Opaque:pf.Semitransparent,s=n!==r;return s&&(this._renderer.transparency=r,null!==(e=this.view)&&void 0!==e&&null!==(e=e._stage)&&void 0!==e&&e.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){var e,t,i,n,r;const s=this.tilingSchemeLogic.tilingScheme;if(s===this.tilingScheme)return;(0,Vp.bk)(!!s,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!==(e=this.view)&&void 0!==e&&null!==(e=e.state)&&void 0!==e&&e.isLocal),this.tilingScheme&&this._removeAllTiles();const a=null!==(t=null===s||void 0===s?void 0:s.spatialReference)&&void 0!==t?t:k.A.WebMercator;this._spatialReference=a,this._isWebMercator=!(null===a||void 0===a||!a.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,ke.r1)(null===(i=this.view)||void 0===i?void 0:i.renderSpatialReference),this._isGeographic=null!==(n=null===a||void 0===a?void 0:a.isGeographic)&&void 0!==n&&n,this._set("tilingScheme",s),this._tilingSchemeSpatialReference=null===(r=this.tilingScheme)||void 0===r?void 0:r.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),s&&(this._updateTiledLayers(),this._renderer.setTileSize(s.pixelSize),this.overlayManager.setSpatialReference(s.spatialReference),this._updateRootTiles())}_acquireTile(e,t,i,n){const r=this._tileCache.pop(Cf._tileMemcacheKey);return r?(r.init(e,t,i,n,this),r):new this._tileConstructor(e,t,i,n,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=Pf;let n=t.rootTilesInExtent(e,i,5*j.SR);if(null!=this._rootTiles){if(n.length>j.SR)return void u.A.getLogger(this).warn(j.hB);const e=this._rootTiles.map((e=>e.lij)),t=(0,Pu.iv)(e,n,Fm);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>Fm(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,n.length>j.SR&&(u.A.getLogger(this).warn(j.P2),n=t.rootTilesInExtent(e,i,j.SR)),this._setRootTiles(n.map((e=>this._newRootTile(e))));(0,L.aI)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,L.vt)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.isLoaded&&e.intersectsClippingArea));e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(gm.lR);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Sm.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(Sm.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(Sm.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=(0,gm.kh)(e),i=this.visibleElevationBounds;let n=t?i.min:1/0,r=t?i.max:-1/0;const s=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(s)&&e.resetPendingUpdate(Sm.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(n=Math.min(e.elevationBoundsMin,n),r=Math.max(e.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(n)&&isFinite(r)&&(i.min!==n||i.max!==r)&&(this.visibleElevationBounds=new Dp(n,r))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((i=>{let{elevationBoundsMin:n,elevationBoundsMax:r}=i;e=Math.min(e,n),t=Math.max(t,r)}));const n=this.rootTileElevationBounds;n.min===e&&n.max===t||(this.rootTileElevationBounds=new Dp(e,t))}_updateViewDependentParameters(){var e;const{camera:t,contentCamera:i}=this.view.state,n=Math.tan(.5*i.fovX),r=Math.tan(.5*i.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=n,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/t.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/t.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,Xc.C)(null!==(e=this._splitLimits.frustum)&&void 0!==e?e:(0,Xc.vt)(),i.frustum):this._splitLimits.frustum=null,(0,Xc.C)(this._frustum,t.frustum),(0,At.lw)(this._viewProjectionMatrix,i.projectionMatrix,i.viewMatrix),(0,Ge.c)(this._eyePosRenderSR,i.eye),(0,Tp.F)(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[tu.MAP].some(Vp.G3)&&e.setPendingUpdate(Sm.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(Sm.TEXTURE_FADING)?Sm.TEXTURE_FADING:!!e.resetPendingUpdate(Sm.TEXTURE_NOFADING)&&Sm.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=Ef.extent;(0,L.Ie)(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>(0,L.fT)(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),Ef.spatialReference=this.spatialReference,this.emit("elevation-change",Ef),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Vp.L8&&this._checkTileInvariant(),!e.hasProgressed)return Gt.G}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if((0,Vp.bk)(t.rendered===t.isLeaf," rendered ".concat(t.rendered," != ").concat(t.isLeaf," leaf")),!t.isLeaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if((0,Vp.bk)(t.unmergableChildCount===i," Tile[".concat(t.lij.toString(),"] unmergeable child count mismatch: actual ").concat(t.unmergableChildCount," vs ").concat(i)),t.hasPendingUpdate(Sm.MERGE)){(0,Vp.bk)(!t.hasPendingUpdate(Sm.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)(0,Vp.bk)(e.isLeaf||e.hasPendingUpdate(Sm.MERGE),"Child of tile to merge must also merge")}}for(let n=0;n<4;++n){if(t.rendered){var i;const e=null===(i=t.renderData)||void 0===i?void 0:i.geometryState.edgePeerNeighbors[n];if(null!=e){{const i=t.level-e.level<=j.nU;i||(console.log("tile level delta [".concat(t.lij.toString(),"] vs [").concat(e.lij.toString(),"] > ").concat(j.nU,"  (edge[").concat(n,"])")),(0,Vp.bk)(i,"tile level delta [".concat(t.level,"] vs [").concat(e.level,"] > ").concat(j.nU)))}(0,Vp.bk)(t.level-e.level<=j.nU,"Max tile lod delta exceeded: [".concat(t.lij.toString(),"] vs [").concat(e.lij.toString(),"]"))}}const r=t.level-j.nU,s=e=>e.isLeaf||e.level===t.level,a=t.findNeighborTile(Vp.Rz[n],s);if(null!=a){if(t.isLeaf&&t.level>=j.nU){let i=a;for(;t.level-i.level<j.nU;)i=i.parent;if(!Fm([r,t.lij[1]>>j.nU,t.lij[2]>>j.nU],i.lij)){const n=e.get(i);(0,Vp.bk)(!n.has(t),"Cannot already have neighbor"),n.add(t)}}(0,Vp.bk)(a.rendered||a.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,Vp.bk)(t.level-a.level<=j.nU,"Tile level delta [".concat(t.level,"] vs [").concat(a.level,"] > ").concat(j.nU))}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,n=e.get(t);(0,Vp.bk)(i===n.size,"Tile[".concat(t.lij.toString(),"] merge-blocker mismatch: actual ").concat(i," vs ").concat(n.size))}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new If(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,n=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const s=this._viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(Sm.MERGE),l=o?Sm.MERGE:e.shouldSplit(n,r,i),c=l===Sm.SPLIT;e.isLeaf?Lf(e,c):t.pushAll(e.children),o?(e.resetPendingUpdate(Sm.SPLIT),e.isLeaf||e.setPendingUpdate(Sm.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(s)):c?(e.resetPendingUpdate(Sm.MERGE),e.isLeaf&&e.setPendingUpdate(Sm.SPLIT)):(e.resetPendingUpdate(Sm.SPLIT)&&e.updateAgentSuspension(),l===Sm.ELEVATION&&e.updateAgents(tu.ELEVATION),e.isLeaf||(e.setPendingUpdate(Sm.MERGE),e.resetPendingUpdate(Sm.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||((0,gm.jV)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){(0,Vp.GH)(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.isLoaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,n)=>{null===n||void 0===n||!n.isLoaded||!n.intersectsClippingArea||n.level<i.level||e.has(n)||(e.add(n),t.push(n),n.renderData.updateNeighborData())};t.sort(gm.lR);const n=t.length;for(let r=0;r<n;++r){const n=t[r];(0,Vp.GH)(n.isLoaded),(0,Vp.GH)(n.intersectsClippingArea);const s=n.renderData;s.updateNeighborData();const a=s.dirtyEdgeResolutions,o=s.geometryState,l=e=>{var t;const r=Vp.XQ[e];i(n,null===(t=o.cornerPeerNeighbors[e])||void 0===t?void 0:t.findCorner((0,Vp.jj)(r),(e=>e.isLoaded)))};for(let t=0;t<4;++t)if(a&1<<t){const r=s.geometryState.edgePeerNeighbors[t];r&&(null===r||void 0===r?void 0:r.level)>=n.level&&r.forAllSubtreeOnSide((0,Vp.JM)(Vp.Rz[t]),(t=>!(!t.isLoaded||!t.intersectsClippingArea)&&((0,Vp.GH)(e.has(t)||(0,gm.lR)(n,t)<0),i(n,t),!0))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,Vp.L8&&Vp.NR&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const n=this.view.state.fixedContentCamera;let r=!1;for(;!e.done;){r=!0;let s=!1;const a=!this._allTiles.some((r=>{if(!i&&!n&&!r.visible)return e.done;let a=r;if(r.hasPendingUpdate(Sm.MERGE)){if(!t||r.unmergableChildCount>0)return e.done;for(r.resetPendingUpdate(Sm.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(Sm.MERGE);)a=a.parent;this._mergeTile(a),s=!0,e.madeProgress()}else if(r.resetPendingUpdate(Sm.SPLIT)){let t=!0;const i=r.level;if(i>=j.nU){const e=e=>e.isLeaf||i-e.level<j.nU;for(let n=0;n<4;++n){const s=r.findNeighborTile(Vp.Rz[n],e);null!=s&&i-s.level===j.nU&&(t=!1,Vp.L8&&((0,Vp.GH)(s.isLeaf),(0,Vp.GH)(s.hasPendingUpdate(Sm.SPLIT))))}}t?(this._splitTile(r),e.madeProgress(),s=!0):r.setPendingUpdate(Sm.SPLIT)}return e.done}));if(s&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!s)break}else this._allTilesDirty=!0}r?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(Sm.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Wp.C7.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*j.CU}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,_e.qE)(e-this._lodBias,0,t.length-1),n=i-Math.floor(i);return t[Math.floor(i)].scale*(1-n)+t[Math.ceil(i)].scale*n}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return;const t=e.children.slice();e.unsetChildren();for(let i=0;i<4;++i)this._purgeTile(t[i])}_purgeTile(e){e.isLeaf?Ff(e):this._purgeDescendantTiles(e),this._allTiles.removeUnordered(e),this._unloadTile(e),this._tileCache.put(Cf._tileMemcacheKey,e)}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){(0,Vp.bk)(e.isLeaf,"Tile that is already split should not be split again!"),(0,Vp.bk)(e.rendered,"Tile marked to split is not rendered"),Ff(e);const t=e.level+1,i=2*e.lij[1],n=2*e.lij[2],r=e.setChildren(this._createTile(t,i,n,e),this._createTile(t,i,n+1,e),this._createTile(t,i+1,n,e),this._createTile(t,i+1,n+1,e));this._allTiles.pushArray(r),e.updateAgentSuspension(),(0,Vp.bk)(e.rendered,"parent should be rendered"),this._unloadTile(e),r.forEach((e=>this._loadTile(e))),r.forEach((e=>this._pendingTilesToUpdate.add(e))),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),r.forEach((e=>Lf(e,e.hasPendingUpdate(Sm.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;Of.spatialReference=this.spatialReference,Of.extent=e.extent,Of.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Of)}_createTile(e,t,i,n){(0,Vp.bk)(!!n,"_createTile sanity check");const r=this._acquireTile(e,t,i,n);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(Sm.SPLIT),r}get _shortBatches(){return this.view.state.mode!==So.M.IDLE}_mergeTile(e){(0,Vp.bk)(!e.hasPendingUpdate(Sm.SPLIT),"_mergeTile sanity check"),(0,Vp.bk)(!e.isLeaf,"Cannot merge a leaf"),e.isLeaf||(this._purgeDescendantTiles(e),(0,Vp.bk)(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Lf(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,t,i){const n=new Lp(e.lij,e.extent,i);e.dataArrived(t,tu.ELEVATION,n);const r=[e],s=e.level,a=this._iteratorPool.acquire();for(a.reset(r);!a.done;){const e=a.next();e.findElevationBoundsForLayer(t,s),e.computeElevationBounds()}0===s&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(r)}_handleLayerViewChanges(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:qt.Bb;if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let n=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const e=this.view.allLayerViews.items[r];if(i.add(e.uid),(0,Vp.eS)(e)||(0,Vp.Gk)(e))if(this._basemapLayerViewHandles.has(e.uid)&&!(0,Vp.Gk)(e)){const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);null!=r&&((r<n||null==n)&&(t=!0),n=r)}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){var e;let t=0===(null===(e=this.view.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity);for(const i of this.view.allLayerViews.items)if((0,Vp.LC)(i)&&!(0,H.rz)(i.layer)&&0!==i.fullOpacity)return t=!1,t;return t}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(((0,Vp.KE)(e)||(0,Vp.Gk)(e))&&(0,pg.aO)(pg.wy[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return(0,Vp.oX)(e)?tu.ELEVATION:tu.MAP}_registerTiledLayerView(e){const t=[];if(((0,Vp.KE)(e)||(0,Vp.Gk)(e))&&t.push((0,g.watch)((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(Gp.ZY.UNFADED)}))),!(0,Vp.Gk)(e)){const i=this._layerClassFromLayerView(e);t.push((0,g.watch)((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push((0,g.watch)((()=>e.fullOpacity),(()=>this._updateTileTextures(Gp.ZY.UNFADED)))),t.push((0,g.watch)((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!(0,Vp.eS)(e)||!e.fullExtent)return;const n=this._layerClassFromLayerView(e);if(n===tu.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[n].push(e)}));for(const n of au){const e=this._layerViews[n],i=t[n];i.reverse();const r=i.length;let s=e.length!==r;const a=new Array(r),o=new Array(e.length);this._layerIndexByUid[n].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[n].set(r,t);const l=e.indexOf(i[t]);a[t]=l,t!==l&&(s=!0),l>-1&&(o[l]=t)}if(s){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;)e.next().modifyLayers(o,a,n);this._layerViews[n]=i,this._restartAllAgents(n),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===tu.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(tu.MAP),e===Gp.ZY.IMMEDIATE?this.renderer.updateTileTexture(t,Sm.TEXTURE_NOFADING):t.updateRenderData(tu.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wp.C7.UPDATE;this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,n){const r=this.layerViewByIndex(t,i),s=r.layer;return!s.tilemapCache||(0,Vp.G3)(r)?this._requestTileData(e,i,r,n):(++this._asyncWorkItems,s.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...n,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,_.Te)(n),(0,_.zf)(t)||this._dataMissing(e,i,r,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,r,n)),n.signal))))}_requestTileData(e,t,i,n){return t===tu.ELEVATION?(0,Vp.oX)(i)?this._requestElevationTileData(e,i,n):Promise.reject():(0,Vp.LC)(i)?this._requestMapTileData(e,i,n):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const n=n=>{if((0,_.G4)(i))return;const r=this._layerIndexByUid[tu.ELEVATION].get(t.uid);null!=r?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,r,n)):u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",tu.ELEVATION,e.lij.toString())},r=i=>{(0,_.zf)(i)||(this._dataMissing(e,tu.ELEVATION,t,i),this.requestUpdate())};if((0,Vp.Cs)(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:j.Gm,signal:i.signal}).then((e=>{if(!(0,_.G4)(i))return this._frameTask.schedule((()=>n(e)),i.signal,r);u.A.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),r).finally((()=>{--this._asyncWorkItems}));const s=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(s,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:j.Gm},i.signal))).then((e=>{e?n(new Sp.i(e)):r(new Error("LERC decoding failed"))}),r).finally((()=>{--this._asyncWorkItems}))}_requestMapTileData(e,t,i){var n=this;++this._asyncWorkItems;const r=(n,r)=>{--this._asyncWorkItems,(0,Vp.Mm)(r),(0,_.G4)(i)||(this._dataMissing(e,tu.MAP,t,n),this.requestUpdate())},s=e=>t=>r(t,e),a=n=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),(0,_.G4)(i)?(0,Vp.Mm)(n):this._mapTileDataArrived(e,t,n)}),i.signal,s(n)).catch(s(n)),o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n._frameTask.schedule((()=>r(e,t)))};if((0,Vp.G3)(t)){const n=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(n[0],n[1],n[2],i).then(a,o)}if((0,Vp.n9)(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,o);if((0,Vp.ri)(t)&&(0,Vp.Cs)(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if((0,_.G4)(i))return u.A.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o((0,_.NK)());a(e)}),o);let l=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(0,Ap.p)(t.layer)&&t.layer.refreshTimestamp&&(l+="".concat(l.includes("?")?"&":"?","_ts=").concat(t.layer.refreshTimestamp));const c=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,c,i).then(a,o)}_mapTileDataArrived(e,t,i){const n=this._getLayerIdxByUID(tu.MAP,t.uid);null!=n?e.dataArrived(n,tu.MAP,i):((0,Vp.Mm)(i),u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i,n){const r=this._getLayerIdxByUID(t,i.uid);null!=r?e.dataMissing(r,t,n):u.A.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}get usedMemory(){var e;return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),null!==(e=this._usedMemory)&&void 0!==e?e:0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),n=this._getLayerIdxByUID(i,e.uid);return null!=n&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,n))),t}getTile(e){if(null==e||null==this._rootTiles)return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this._rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=t[0],n=t[1]>>i,r=t[2]>>i;let s;if(this._rootTiles.some((e=>e.lij[1]===n&&e.lij[2]===r&&(s=e,!0))),s){let e=1<<t[0]-1;for(;s.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!s.children[i])return null;s=s.children[i],e>>=1}return(0,Vp.bk)(s.lij[0]===t[0]&&s.lij[1]===t[1]&&s.lij[2]===t[2],"not the right tile?"),s}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{null!=e._rootTiles&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){Rf.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Rf.push(e)}));const t=Rf.toArray();return(0,gm.Ey)(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}checkAllTilesWaterproofness(){if(!Vp.NR)return;const e=this._rootTiles;if(null==e)return;const t=e=>{var t;return(null===e||void 0===e||null===(t=e.renderData)||void 0===t||null===(t=t.geometry)||void 0===t||null===(t=t.indices)||void 0===t?void 0:t.length)>0},i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},n=e=>{var r,s,a;if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!(null!==(r=e.renderData)&&void 0!==r&&r.geometry)||(null!==(s=null===(a=e.renderData.geometry.indices)||void 0===a?void 0:a.length)&&void 0!==s?s:0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)n(t)},r=e=>{var t,i;const n=null===(t=null===(i=e.parent)||void 0===i?void 0:i.visible)||void 0===t||t,s=e.visible;e.computeVisibility();const a=e.visible;if(s!==a&&n&&console.error(" Tile[",e.lij,"] has out of date visibility: ",s," instead of ",a),!e.isLeaf)for(const o of e.children)r(o)};for(const s of e)n(s),r(s)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const n=(i+(i<0?t:0))%t;return[e[0],e[1],n]}enableInternalChecks(e){(0,Vp.T7)(e)}enableWaterproofnessChecks(e){(0,Vp.Mq)(e)}};Tf._tileMemcacheKey="TerrainTileMemcache",(0,n._)([(0,b.MZ)()],Tf.prototype,"_renderer",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Tf.prototype,"_scaleRangeQueries",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Tf.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Tf.prototype,"overlayManager",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_hasPendingUpdates",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_asyncWorkItems",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_allTilesDirty",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_allTilesSorted",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_viewChanged",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_splitLimits",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"_watchUpdatingTracking",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_frameTask",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"snapLevel",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"lodSnapping",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"_userClippingExtent",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"_rootTilesExtent",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"extent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"groundExtent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"_tilingSchemeExtent",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"updating",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"running",null),(0,n._)([(0,b.MZ)(Op.S)],Tf.prototype,"updatingProgress",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"updatingProgressValue",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"_maxNumUpdating",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"baseOpacity",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"hasCompositeBlendMode",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"viewingMode",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"maxTextureScale",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"ready",null),(0,n._)([(0,b.MZ)({value:Y_.X.FRONT_TO_BACK})],Tf.prototype,"renderOrder",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"rootTiles",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"_rootTiles",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"spatialReference",null),(0,n._)([(0,b.MZ)({type:Yd.A})],Tf.prototype,"backgroundColor",null),(0,n._)([(0,b.MZ)({value:!1})],Tf.prototype,"slicePlaneEnabled",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"tilingScheme",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"tilingSchemeLocked",null),(0,n._)([(0,b.MZ)({readOnly:!0})],Tf.prototype,"tilingSchemeLogic",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"wireframe",null),(0,n._)([(0,b.MZ)({value:!1})],Tf.prototype,"suspended",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"fadeDuration",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"visibleElevationBounds",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"rootTileElevationBounds",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"_layerViewsDirty",void 0),(0,n._)([(0,b.MZ)()],Tf.prototype,"renderPatchBorders",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"visualizeNormals",null),(0,n._)([(0,b.MZ)()],Tf.prototype,"renderingDisabled",null),Tf=Cf=(0,n._)([(0,x.$)("esri.views.3d.terrain.TerrainSurface")],Tf);const Af=Tf,Mf=(0,P.vt)(),Sf=(0,vn.c)(),Pf=(0,L.vt)(),Rf=new oc.A,Ef=new Ep.L("ground"),Of={spatialReference:null,extent:null,scale:0};function Df(e,t,i){for(const s of e){var n,r;if(!s.containsPointXY(t,i))continue;let e=s;for(;e&&!e.renderData;){const n=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[n]}return Fp(t,i,null!==(n=null===(r=e)||void 0===r||null===(r=r.renderData)||void 0===r?void 0:r.geometryState.samplerData)&&void 0!==n?n:null)}return null}class If{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let n=0;n<t;++n)this._data[i+n]=e[n];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Lf(e,t){!e.isLeaf||e.level<j.nU||Hf(e,(e=>{t&&Nf(e);const i=Vf(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=Vf(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function Nf(e){if(e.hasPendingUpdate(Sm.SPLIT))return;let t=e.parent;for(;t&&t.resetPendingUpdate(Sm.MERGE);)t=t.parent;e.resetPendingUpdate(Sm.MERGE),e.isLeaf&&e.setPendingUpdate(Sm.SPLIT),e.level<j.nU||Hf(e,(e=>{Nf(e)}))}function Ff(e){e.level<j.nU||Hf(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,Vf(t));)t=t.parent}}))}function Vf(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function Hf(e,t){if(e.level<j.nU)return;const i=e.level-j.nU,n=e.lij[1]>>j.nU,r=e.lij[2]>>j.nU,s=e=>e.isLeaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(Vp.Rz[a],s);if(!o||o.level!==i)continue;const l=o.lij;l[1]===n&&l[2]===r||t(o)}}var Uf=i(63496),zf=i(44513),qf=i(8918),Gf=i(87634),Bf=i(97583),kf=i(57824);class Wf{constructor(e,t,i,n){this.operation=e,this.geometry=t,this.states=i,this.sync=n}}let Zf=class extends T.A{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,n)=>{const r=this._ensureGeomRecord(e,n);i.forEach(((e,i)=>{let{geometry:s,operation:a,states:o}=e,l=!1;if(a===kf.q.UPDATE){const e=r.get(i);if(e){if(o&kf.k.TRANSFORMATION){const t=this.model.getObject(n);this.model.updateRenderGeometryTransformation(t,s,e)&&(l=!0)}l||t.updates.push({renderGeometry:e,updateType:o})}else(0,fi.vA)(!1,"ModelDirtySet.commitLayer: invalid update")}if(a===kf.q.REMOVE||l){const e=r.get(i);e?(t.removes.push(e),r.delete(i)):a===kf.q.REMOVE&&(0,fi.vA)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(a===kf.q.ADD||l){const e=this.model.getObject(n);if(null!=e){const n=this.model.getRenderGeometry(e,s);t.adds.push(n),r.set(i,n)}}})),0===r.size&&this._residentGeomRecords.get(e).delete(n)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.get(e);i&&i.forEach(((i,n)=>{const r=this._ensureGeomRecord(e,n);i.forEach(((e,i)=>{let{geometry:s,operation:a,states:o,sync:l}=e,c=!1;if(a===kf.q.UPDATE&&l){const e=r.get(i);if(e){if(o&kf.k.TRANSFORMATION){const t=this.model.getObject(n);this.model.updateRenderGeometryTransformation(t,s,e)&&(c=!0)}c||t.updates.push({renderGeometry:e,updateType:o})}else(0,fi.vA)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e)))))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,kf.q.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(kf.k.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(kf.k.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(kf.k.OCCLUDEE,e)}attributesChanged(e){let{object:t,geometry:i,sync:n}=e;this._updateOrCreateDirtyRecord(t,i,null,kf.q.UPDATE,kf.k.GEOMETRY,n)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const n of t.geometries)this._geometryAdded(t,n,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const n of t.geometries)this._geometryRemoved(t,n,i)}transformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i.geometry,t,kf.q.UPDATE,kf.k.TRANSFORMATION)}))}shaderTransformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>{t.objectShaderTransformationChanged(e.shaderTransformation)}))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,kf.q.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,i,kf.q.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,n){var r;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:kf.k.NONE,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];i=null!==(r=i)&&void 0!==r?r:this._getParentLayerId(e);const o=e.id,l=t.id,c=this._ensureDirtyRecord(i,o),h=c.get(l);if(h){const e=h.operation;e===kf.q.REMOVE&&n===kf.q.ADD&&h.states!==kf.k.NONE?h.operation=kf.q.UPDATE:e===kf.q.REMOVE&&n===kf.q.ADD||e===kf.q.ADD&&n===kf.q.REMOVE?c.delete(l):e!==kf.q.UPDATE||n!==kf.q.REMOVE&&n!==kf.q.UPDATE?((0,fi.vA)((e===kf.q.REMOVE||e===kf.q.ADD)&&n===kf.q.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=s):(h.operation=n,h.states|=s),h.sync=h.sync||a}else c.set(l,new Wf(n,t,s,a));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let n=i.get(t);return n||(n=new Map,i.set(t,n)),n}get _hasDirtyGeometryRecords(){return(0,ac.Bs)(this._dirtyGeomRecords,(e=>(0,ac.Bs)(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let n=i.get(t);return n||(n=new Map,i.set(t,n)),n}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:jc.M}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,n)=>{i.forEach(((i,r)=>{t.length>0&&(t+="\n"),t+=n+"."+r;const s=[];i.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometry.id)}));for(let n=0;n<s.length;n++)if(s[n]){t+=" "+e[n-1]+": ";for(let e=0;e<s[n].length;e++)t+=s[n][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)},commit:t=>e._dirtyGeomRecords.forEach(((i,n)=>e.commitLayer(n,t)))}}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Zf.prototype,"model",void 0),(0,n._)([(0,b.MZ)()],Zf.prototype,"dirty",void 0),Zf=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Zf);const jf=Zf;var Qf=i(442);let Xf=class extends T.A{constructor(){super(...arguments),this.dirtySet=new jf({model:this}),this._content=new Map,this._originFactory=new Bf.g(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;(0,fi.vA)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),(0,qf.r)(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),(0,qf.r)(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&((0,fi.vA)(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&((0,fi.vA)(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const i=new Qf.$(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,Yf);const{localOrigin:n}=t;return i.localOrigin=null!=n?n:this._originFactory.getOrigin((0,vn.g)(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,Yf);const n=this._originFactory.getOrigin((0,vn.g)(i.boundingSphere));return i.localOrigin!==n}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<Gf.X.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};(0,n._)([(0,b.MZ)({constructOnly:!0})],Xf.prototype,"dirtySet",void 0),Xf=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.parts.Model")],Xf);const Yf=(0,Mt.vt)();var $f=i(78393),Kf=i(38496),Jf=i(45136),ev=i(64591),tv=i(51990),iv=i(59231);class nv{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let i=0,n=t.length/2;if(e<t[2*i]||e>t[2*n]+t[2*n+1])return!1;for(;n-i>0;){const r=Math.floor(.5*(i+n)),s=t[2*r];if(e<s){if(n-i==1)return!1;n=r}else{if(e<s+t[2*r+1])return!0;if(n-i==1)return!1;i=r+1}}return!1}}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],n=1;for(let r=1;r<e.length;r++){const s=e[r];i+n===s?n+=1:(t.push(i),t.push(n),i=s,n=1)}return t.push(i),t.push(n),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const n=t[i],r=n+t[i+1];for(let t=n;t<r;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const n=t[i];if(!e(n,n+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let n=0;n<i.length;n+=2){const r=i[n],s=r+i[n+1],a=e[r],o=e[s];t[n]=a,t[n+1]=o-a}return t}}class rv{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const i=this.count;this.visibility=new nv(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let n=0;n<i;n++)this.materialDataIndices[n]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this.cachedGeometryRanges&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return null==this.highlightCounts?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return null==this.highlightCounts?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((null==this.cachedHighlightRanges||null==this.cachedDefaultRanges)&&null!=this.highlightCounts){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const n=[],r=[];let s=i.length,a=i.length;return t.forEachComponent((t=>(e[t]>0?(s!==t-1&&(n.length&&n.push(i[s+1]-n[n.length-1]),n.push(i[t])),s=t):(a!==t-1&&(r.length&&r.push(i[a+1]-r[r.length-1]),r.push(i[t])),a=t),!0))),n.length&&n.push(i[s+1]-n[n.length-1]),r.length&&r.push(i[a+1]-r[r.length-1]),{highlightRanges:n,defaultRanges:r}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}class sv{constructor(e,t,i,n,r,s){this.transform=e,this.toMapSpace=t,this.obb=i,this.components=n,this.renderable=r,this.intersectionGeometry=s,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=(0,p.pR)(this.intersectionGeometry),this.renderable=(0,p.pR)(this.renderable),this.components=(0,p.pR)(this.components)}}function av(e,t,i,n){if(i>=t)return e;null==e&&(e=function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return{isVisibleBit:!e,data:new Uint32Array(0)}}());const r=e.isVisibleBit;let s=e.data;const a=lv(s),o=i/a|0,l=i-a*o,c=(t-1)/a|0,h=s,d=n===r;if(!(i<h.length*a)&&d){const e=o+1,t=Math.ceil(h.length*Pu.Ji),i=c+1;let n=Math.max(e,t);n=Math.min(n,i),s=new Uint32Array(n),s.set(h)}return o<s.length&&(s[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(s[o],l,d)),e.data=s,e}function ov(e,t){if(null==e)return!0;const{isVisibleBit:i,data:n}=e,r=lv(n);return t<n.length*r?function(e,t,i,n){const r=i/n|0,s=i-r*n;return function(e,t){return 0!=(e&1<<t)}(t[r],s)===e}(i,n,t,r):!e.isVisibleBit}function lv(e){return 8*e.BYTES_PER_ELEMENT}class cv{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this._planetCenter=(0,P.vt)(),this._planetNorth=(0,P.vt)(),this._componentIndicesForBsp=null,this._componentBspNodes=[],this._aabb=[0,0,0,0,0,0],this._indices=t.indices?(0,Kf.Dg)(t.indices):(0,Kf.tM)(t.positions.length/3),this._positions=t.positions,this._componentIntersectionData=new Array(i.count)}destroy(){this._positions=null,this._indices=null,this._componentIntersectionData.length=0,this._perComponentAabbs=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),n=6*e;return t[0]=i[n],t[1]=i[n+1],t[2]=i[n+2],t[3]=i[n+3],t[4]=i[n+4],t[5]=i[n+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,n,r,s,a,o){const{position:l}=a,c=(0,Ge.z)(mv,e,l),h=(0,Ge.z)(_v,t,l),d=(0,Tt.B8)(gv,a.rotationScale);(0,Ge.t)(c,c,d),(0,Ge.t)(h,h,d);const u=(0,Tt.mg)(fv,d),p=new rf.K(this._positions,3),m=this._indices,_=this._components.offsets,g=(0,j_.OO)(c,h,dv);if(this.viewingMode===te.RT.Global){const e=this._planetCenter;(0,Ge.F)(e,l),(0,Ge.t)(e,e,d);const t=this._planetNorth;(0,Ge.s)(t,0,0,1),(0,Ge.t)(t,t,d),(0,Ge.n)(t,t)}const f=(0,Ge.c)(vv,c),v=(0,Ge.c)(yv,h),y=(0,Ge.z)(bv,h,c);(0,Ge.n)(y,y);this._intersectComponents((e=>{const t=this.getComponentAabb(e,uv);if(null!=r){const t=r[e];null==n||o?(c[2]=f[2]-t,h[2]=v[2]-t):n.componentOffset=t}if(null==n||o||n.applyToAabb(t),!(0,j_.Wb)(t,c,g,i))return;const a=_[e]/3,l=_[e+1]/3,d=(t,i,n)=>s(e,t,(0,Ge.t)(i,i,u),n);(null==n||o)&&l-a>200?(null==this._componentIntersectionData[e]&&(this._componentIntersectionData[e]=new Yg(this._indices,a,l,p)),this._componentIntersectionData[e].intersectRay(c,h,d)):(0,j_.Z$)(c,h,a,l,m,p,void 0,n,d)}),o,c,h)}_intersectComponents(e,t,i,n){const r=this._components.pickability,s=this._components.visibility;if(this._components.visibility.componentCount<Pv){const t=t=>(ov(r,t)&&e(t),!0);return void s.forEachComponent(t)}0===this._componentBspNodes.length&&this._generateComponentBspRoot();const a=this._componentIndicesForBsp,o=t=>{ov(r,t)&&s.isVisible(t)&&e(t)},l=(e,t)=>{for(let i=e;i<t;++i)o(a[i])};if(t){let e=0;for(;e>=0;){const t=this._componentBspNodes[e],n=t.plane;if(!n||-1===t.child0&&-1===t.child1){l(t.minComponentIndexIndex,t.maxComponentIndexIndex);break}{l(t.minMidComponentIndexIndex,t.maxMidComponentIndexIndex);const r=(0,Ge.k)(n,i)-n[3];if(r<0){if(-1===t.child0){l(t.minComponentIndexIndex,t.minMidComponentIndexIndex);break}e=t.child0}else{if(!(r>0))break;if(-1===t.child1){l(t.maxMidComponentIndexIndex,t.maxComponentIndexIndex);break}e=t.child1}}}}else{const e=Rv;(0,Ge.z)(e,n,i),(0,Ge.n)(e,e);const t=this._componentBspNodes,r=n=>{const s=t[n],a=s.plane;if(!a||-1===s.child0&&-1===s.child1)l(s.minComponentIndexIndex,s.maxComponentIndexIndex);else{const t=(0,Ge.k)(a,i)-a[3],n=(0,Ge.k)(a,e);s.minComponentIndexIndex<s.minMidComponentIndexIndex&&(t<=0||n<0)&&(-1!==s.child0?r(s.child0):l(s.minComponentIndexIndex,s.minMidComponentIndexIndex)),l(s.minMidComponentIndexIndex,s.maxMidComponentIndexIndex),s.maxMidComponentIndexIndex<s.maxComponentIndexIndex&&(t>=0||n>0)&&(-1!==s.child1?r(s.child1):l(s.maxMidComponentIndexIndex,s.maxComponentIndexIndex))}};r(0)}}_generateComponentBspRoot(){const e=this._components.count,t=new Uint16Array(e);this._componentIndicesForBsp=t;for(let g=0;g<e;++g)t[g]=g;const i=this._ensureComponentAabbs(),n=this._planetCenter,r=this._planetNorth,s=Cv;(0,Ge.F)(s,n),(0,Ge.n)(s,s),(0,Ge.b)(Tv,r,s);const a=this._aabb,o=a[2],l=[];let c=0;const h=this._componentBspNodes;h.length=0;const d=(e,t)=>{const n=6*e,r=i[n],s=i[n+1],a=i[n+2],o=i[n+3],l=i[n+4],c=i[n+5],h=(0,Ge.s)(Av,.5*(r+o),.5*(s+l),.5*(a+c)),d=.5*(o-r),u=.5*(l-s),p=.5*(c-a),m=Math.sqrt(d*d+u*u+p*p),_=t,g=t[3],f=(0,Ge.k)(_,h)-g;return Math.abs(f)>m?Math.sign(f):0},u=(e,n,r)=>{let s=1/0,a=1/0,o=1/0,l=-1/0,c=-1/0,h=-1/0;for(let d=n;d<r;++d){const e=6*t[d];s=Math.min(s,i[e]),l=Math.max(l,i[e+3]),a=Math.min(a,i[e+1]),c=Math.max(c,i[e+4]),o=Math.min(o,i[e+2]),h=Math.max(h,i[e+5])}e[0]=s,e[1]=a,e[2]=o,e[3]=l,e[4]=c,e[5]=h},p=this.viewingMode===te.RT.Local;let m=!1;if(!p){const e=(0,Ge.s)(Av,.5*(a[0]+a[3]),.5*(a[1]+a[4]),.5*(a[2]+a[5])),t=(0,Ge.o)(n,e);m=o>.5*t}const _=(e,i,s,a,o)=>{const c=h.length;let g;if(m||s>=Sv||i-e<Mv)g=new hv(e,i,i,i,null);else{u(pv,e,i);const a=pv[0],o=pv[1],h=pv[2],m=pv[3],f=pv[4],v=m-a,y=f-o,b=(0,Ye.vt)(),w=b;if(p)v>=y?((0,Ge.s)(w,1,0,0),b[3]=-.5*(a+m)):((0,Ge.s)(w,0,1,0),b[3]=-.5*(o+f));else{const e=wv,t=xv;(0,Ge.s)(e,.5*(a+m),.5*(o+f),h),(0,Ge.z)(e,e,n),(0,Ge.n)(e,e),(0,Ge.b)(t,e,r),(0,Ge.n)(t,t),v>=y?(0,Ge.c)(w,t):((0,Ge.b)(w,t,e),(0,Ge.n)(w,w)),b[3]=(0,Ge.k)(w,n)}let x,C;{let n=e,r=i;for(;n<r;){const e=t[n];d(e,b)<0?++n:(--r,t[n]=t[r],t[r]=e)}x=n;let s=n;for(r=i;s<r;){const e=t[r-1];d(e,b)>0?--r:(t[r-1]=t[s],t[s]=e,++s)}C=r}g=new hv(e,x,C,i,b),x>=e+Mv&&l.push((()=>_(e,x,s+1,c,!0))),i>=C+Mv&&l.push((()=>_(C,i,s+1,c,!1)))}if(h.push(g),-1!==a){const e=h[a];o?e.child0=c:e.child1=c}};for(l.push((()=>_(0,e,0,-1,!1)));c<l.length;)(0,l[c])(),++c}_computePerComponentAabbs(){const e=this._components.count,t=(0,_i.oe)(6*e),i=this._indices,n=this._positions,r=this._components.offsets;let s=0,a=1/0,o=1/0,l=1/0,c=-1/0,h=-1/0,d=-1/0;for(let u=0;u<e;u++){const e=r[u],p=r[u+1];let m=1/0,_=1/0,g=1/0,f=-1/0,v=-1/0,y=-1/0;for(let t=e;t<p;t++){const e=3*i[t],r=n[e],s=n[e+1],a=n[e+2];m=Math.min(m,r),_=Math.min(_,s),g=Math.min(g,a),f=Math.max(f,r),v=Math.max(v,s),y=Math.max(y,a)}t[s++]=m,t[s++]=_,t[s++]=g,t[s++]=f,t[s++]=v,t[s++]=y,a=Math.min(a,m),o=Math.min(o,_),l=Math.min(l,g),c=Math.max(c,f),h=Math.max(h,v),d=Math.max(d,y)}return this._aabb[0]=a,this._aabb[1]=o,this._aabb[2]=l,this._aabb[3]=c,this._aabb[4]=h,this._aabb[5]=d,t}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}class hv{constructor(e,t,i,n,r){this.minComponentIndexIndex=e,this.minMidComponentIndexIndex=t,this.maxMidComponentIndexIndex=i,this.maxComponentIndexIndex=n,this.plane=r,this.child0=-1,this.child1=-1}}const dv=(0,P.vt)(),uv=(0,am.vt)(),pv=[0,0,0,0,0,0],mv=(0,P.vt)(),_v=(0,P.vt)(),gv=(0,zr.vt)(),fv=(0,zr.vt)(),vv=(0,P.vt)(),yv=(0,P.vt)(),bv=(0,P.vt)(),wv=(0,P.vt)(),xv=(0,P.vt)(),Cv=(0,P.vt)(),Tv=(0,P.vt)(),Av=(0,P.vt)(),Mv=5,Sv=10,Pv=7,Rv=(0,P.vt)();class Ev{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class Ov{constructor(e,t,i,n){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=n}dispose(){this.vao.dispose()}}class Dv{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}}function Iv(e){return e?Lv(e,1/0,-1/0):function(e,t){return{near:e,far:t}}(1/0,-1/0)}function Lv(e,t,i){return e.near=t,e.far=i,e}function Nv(e,t){null!=t&&(e.near=Math.min(e.near,t.near),e.far=Math.max(e.far,t.far))}function Fv(e,t){return e.near<=t&&t<=e.far}const Vv={near:0,far:0};function Hv(e,t){const i=Iv(),{eye:n,frustum:r,viewForward:s}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=(0,Ge.k)((0,Ge.z)(Jv,t.center,n),s),o=t.projectedRadius(s);if(Fv(i,a-o)&&Fv(i,a+o))return;const l=function(e,t){let i=0;for(let n=0;n<Yv;n++){const r=e.intersectPlane(t[n]);if(r>0)return-1;0===r&&(i|=1<<n)}return i}(t,r);if(-1===l)return;if(0===l)return zv.far=a+o,zv.near=a-o,void Nv(i,zv);const c=Uv.pushNew();c.near=a-o,c.far=a+o,c.mask=l,c.object=e}));for(let a=0;a<Uv.length;a++){const e=Uv.data[a];if(Fv(i,e.near)&&Fv(i,e.far))continue;zv.far=e.far,zv.near=1/0;const t=Qv(null!=e.object.offsetObb?e.object.offsetObb:e.object.obb,n,Bv,(t=>{let i=kv;for(let n=0;n<Yv&&t.length>0;n++){if(0==(e.mask&1<<n))continue;Wv(r[n],t,i);const s=t;t=i,i=s}for(let e=0;e<t.length;e+=3){(0,Ge.s)(qv,t.data[e],t.data[e+1],t.data[e+2]);const i=(0,Ge.k)((0,Ge.z)(qv,qv,n),s);zv.near=Math.min(zv.near,i)}}));0===t&&(zv.near=0),Nv(i,zv)}return Uv.length=0,i}const Uv=new oc.A({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),zv=Iv(),qv=(0,P.vt)(),Gv=(0,P.vt)(),Bv=new oc.A({deallocator:null}),kv=new oc.A({deallocator:null});function Wv(e,t,i){i.length=0;const n=t.length-3;Zv(qv,t,n);const r=(0,zs.mN)(e,qv);r<=0&&(i.push(qv[0]),i.push(qv[1]),i.push(qv[2]));let s=0,a=r;for(;s<n;s+=3){Zv(Gv,t,s);const n=(0,zs.mN)(e,Gv);a*n<0&&((0,Ge.m)(qv,Gv,qv,n/(n-a)),jv(i,qv)),n<=0&&jv(i,Gv),a=n,(0,Ge.c)(qv,Gv)}a*r<0&&(Zv(Gv,t,n),(0,Ge.m)(qv,Gv,qv,r/(r-a)),jv(i,qv))}function Zv(e,t,i){return(0,Ge.s)(e,t.data[i],t.data[i+1],t.data[i+2])}function jv(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function Qv(e,t,i,n){(0,Os.Xr)(Kv,e.quaternion),(0,Ge.z)(Jv,t,e.center),(0,Ge.u)(Jv,Jv,Kv);const r=e.halfSize,s=8*((Jv[0]<-r[0]?-1:Jv[0]>r[0]?1:0)+3*(Jv[1]<-r[1]?-1:Jv[1]>r[1]?1:0)+9*(Jv[2]<-r[2]?-1:Jv[2]>r[2]?1:0)+13),a=Xv[s];if(0===a)return a;(0,Tt.I0)($v,e.quaternion),(0,Tt.hs)($v,$v,e.halfSize);const o=(t,i)=>{const n=Xv[s+i+1];return(0,Ge.s)(t,((1&n)<<1)-1,(2&n)-1,((4&n)>>1)-1),(0,Ge.t)(t,t,$v),(0,Ge.g)(t,e.center,t)};return i.length=0,jv(i,o(ey,0)),jv(i,o(ty,1)),jv(i,o(Jv,2)),jv(i,o(iy,3)),n(i),1===a||(i.length=0,jv(i,ey),jv(i,iy),jv(i,o(Jv,4)),jv(i,o(ny,5)),n(i),2===a||(i.length=0,jv(i,ey),jv(i,ny),jv(i,o(Jv,6)),jv(i,ty),n(i))),a}const Xv=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let n=0;n<i.length;n++)e[t+n]=i[n];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),Yv=4;const $v=(0,zr.vt)(),Kv=(0,Ds.vt)(),Jv=(0,P.vt)(),ey=(0,P.vt)(),ty=(0,P.vt)(),iy=(0,P.vt)(),ny=(0,P.vt)();class ry{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?Hv(e,this._objects.visibleObjects):null}}var sy=i(16449);class ay{constructor(){this.externalColor=(0,Ye.vt)(),this.externalColorMixMode=tv.k5.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}var oy=i(91555),ly=i(63599),cy=i(13545),hy=i(96141),dy=i(8775);class uy{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}class py{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new Ht.R(this.textureWidth,1);i.samplingMode=st.Cj.NEAREST,i.wrapMode=st.pF.CLAMP_TO_EDGE,this._texture=new hi.g(this._rctx,i),this._data=new cg.XP(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,n,r,s){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,n),this._data.set(a,2,r),this._data.set(a,3,s)}setDataElement(e,t,i,n){const r=e*this._fieldCount+t;this._dirty=!0,this._data.set(r,i,n)}getDataElement(e,t,i){const n=e*this._fieldCount+t;return this._dirty=!0,this._data.get(n,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new cg.XP(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class my{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.textureBuffer=new py(e,t),this._indexManager=new uy(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class _y{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>65536)return null;const t=new my(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}var gy=i(36911);const fy=()=>u.A.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class vy{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new oc.A,this._hidden=new oc.A,this._renderSubmit=new ry(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=(0,d.A)("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new _y(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){(0,fi.vA)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._hidden.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,i=new rv(this._componentBufferManager,(0,Kf.Dg)(t.componentOffsets)),n=this._createRenderable(e,i),r=new cv(this._viewingMode,t.positionData,i),s=new sv(e.transform,e.toMapSpace,e.obb.clone(),i,n,r);return(s.visible?this._visible:this._hidden).push(s),s}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=(0,Ge.a)(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount;return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){var i;const n=e,r=n.renderable.material,s=n.components,a=s.materialDataBuffer,o=s.materialDataIndices,l=new ay,c=a.textureBuffer,h=new Uint8Array(4),d=new Uint32Array(h.buffer);let u=0,p=0,m=0,_=s.verticalOffsets,g=1/0,f=-1/0,v=!1,y=!1,b=0;for(let w=0;w<s.count;w++){t(w,l),u+=+(l.externalColor[3]<1),p+=+(l.externalColorMixMode===tv.k5.Replace&&1===l.externalColor[3]),m+=+l.castShadows,(0,tv._j)(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(o[w],0,h[0],h[1],h[2],h[3]),v||(v=w>0&&b!==d[0]),b=d[0],y||(y=0!==l.elevationOffset),y&&null==_&&(_=new Array(w).fill(0)),null!=_&&(_[w]=l.elevationOffset),g=Math.min(g,l.elevationOffset),f=Math.max(f,l.elevationOffset),(0,cy.B)(l.elevationOffset,h),c.setData(o[w],1,h[0],h[1],h[2],h[3]);const e=l.objectAndLayerIdColor;null!=e&&c.setData(o[w],2,e[0],e[1],e[2],e[3]),l.pickable!==ov(s.pickability,w)&&(s.pickability=av(s.pickability,s.count,w,l.pickable))}s.verticalOffsets=y?_:null,n.offsetObb=y?(0,iv.gm)(n.obb,g,f,this._viewingMode,null!==(i=n.offsetObb)&&void 0!==i?i:n.obb.clone()):null,v||y||this._hasObjectAndLayerId?(r.componentParameters=new oy.em,r.componentParameters.castShadows=by(m,s.count),r.componentParameters.transparent=by(u,s.count),r.componentParameters.opaqueOverride=by(p,s.count),r.componentParameters.texture=c,c.updateTexture()):(r.componentParameters=new oy.Wo,r.componentParameters.castShadows=l.castShadows?oy.d0.All:oy.d0.None,r.componentParameters.externalColor=l.externalColor,r.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,i);const r=e,s=r.components.verticalOffsets;if(n||null==s)return i;const a=s[t];if(this._viewingMode===te.RT.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=(0,Ws.XG)(a);return o.localOrigin=r.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,n){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||n.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const r=e,s=r.components,a=s.count,o=s.verticalOffsets,l=r.intersectionGeometry,c=this._viewingMode===te.RT.Local,h=l.getComponentAabbs(),d=wy;let u=1/0,p=-1/0;for(let _=0;_<a;_++){var m;const e=6*_,s=null!==(m=null===o||void 0===o?void 0:o[_])&&void 0!==m?m:0;let a=1/0,l=-1/0;if(c)a=h[e+2]+s+t,l=h[e+5]+s+t;else{if(d[0]=h[e],d[1]=h[e+1],d[2]=h[e+2],d[3]=h[e+3],d[4]=h[e+4],d[5]=h[e+5],0!==s){const e=(0,Ws.XG)(s);e.localOrigin=r.transform.position,e.applyToAabb(d)}const a=Math.max(Math.abs(d[3]),Math.abs(d[0])),o=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+i;n.expandElevationRangeValues(t+d[2],Math.sqrt(a*a+o*o+l*l)-i)}n.expandElevationRangeValues(a,l),u=Math.min(u,a),p=Math.max(p,l)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=u,this._elevationRangeCacheMax=p}intersect(e,t,i,n,r,s,a){const o=e,{transform:l}=o,{position:c}=l;return null!=r&&(r.localOrigin=c),o.intersectionGeometry.intersect(t,i,n,r,o.components.verticalOffsets,s,l,null!==a&&void 0!==a&&a)}addEdges(e,t,i,n){const r=e,{indices:s,positions:a}=r.intersectionGeometry,o=r.components.offsets;return t.addComponentObject(r,a,s,o,i,n)}async extractEdgeInformation(e,t,i){const n=e,r=n.components.visibility;if(r.allInvisible())return{buffer:dy.HY.createBuffer(0),origin:[0,0,0]};const{indices:s,positions:a}=n.intersectionGeometry,o=n.components.offsets,l=hy.I$.createBuffer(a.length/3);(0,ev.c)(l.position.typedBuffer,a,l.position.typedBufferStride,3),(0,Jf.c)(l.position,l.position,n.transform.rotationScale),this._setComponentIndices(l.componentIndex,s,o);const c=l.count,h=this._computeVisibilityIndices(s,r,o,c);return{origin:(0,P.o8)(n.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:h,indicesLength:h.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let n=0;for(let r=0;r<i.length-1;r++){const s=i[r],a=i[r+1];for(let i=s;i<a;i++){const r=t?t[i]:i;e.set(r,n)}n++}}_computeVisibilityIndices(e,t,i,n){if(e&&t.allVisible())return e;let r=0;t.forEachComponentRange(((e,t)=>(r+=i[t]-i[e],!0)));const s=(0,$f.cy)(e)?new Array(r):2===(null===e||void 0===e?void 0:e.BYTES_PER_ELEMENT)||n<=65536?new Uint16Array(r):new Uint32Array(r);let a=0;return t.forEachComponentRange(((t,n)=>{const r=i[t],o=i[n];for(let i=r;i<o;i++)s[a++]=e?e[i]:i;return!0})),s}addComponentHighlight(e,t){const i=e.components;null==i.highlightCounts&&(i.highlightCounts=new Uint32Array(i.count+1)),0===i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(null==i.highlightCounts)return void fy().warn("Removing non-existing highlight.");const n=i.highlightCounts[t],r=i.highlightCounts[i.count];if(0!==n){if(n>1)return i.highlightCounts[t]=n-1,void(i.highlightCounts[i.count]=r-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===r?i.highlightCounts=null:i.highlightCounts[i.count]=r-1}else fy().warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;null!=t.highlightCounts&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,n=e.geometry,r=n.vertices.layoutParameters,s=ci.g.createVertex(i,st._U.STATIC_DRAW,n.vertices.data),a=n.indices?ci.g.createIndex(i,st._U.STATIC_DRAW,n.indices):null,o=(0,ri.U)((0,sy.h)(r)),l=new Uint16Array(n.vertices.count);for(let m=0;m<t.count;m++){const e=t.offsets[m],i=t.offsets[m+1],r=t.materialDataIndices[m];if(null!=n.indices)for(let t=e;t<i;t++)l[n.indices[t]]=r;else for(let t=e;t<i;t++)l[t]=r}const c=ci.g.createVertex(i,st._U.STATIC_DRAW,l.buffer),h=new oy.f5(e.transform,e.toMapSpace),d=new gy.Z(i,ly.T,{data:o,componentIndices:yy},{data:s,componentIndices:c},a),u=new Ov(d,st.WR.TRIANGLES,r,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:s.usedMemory+c.usedMemory+(null!=a?a.usedMemory:0)};return new Ev(h,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const yy=(0,ri.U)((0,si.BP)().u16(li.r.COMPONENTINDEX));function by(e,t){return e===t?oy.d0.All:0===e?oy.d0.None:oy.d0.Some}const wy=(0,am.vt)();var xy,Cy=i(58229),Ty=i(80517);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(xy||(xy={}));class Ay extends ct.K{constructor(){super(...arguments),this.alphaMode=xy.None,this.hasOpacityFactor=!1}}(0,n._)([(0,ct.W)({count:xy.COUNT})],Ay.prototype,"alphaMode",void 0),(0,n._)([(0,ct.W)()],Ay.prototype,"hasOpacityFactor",void 0);class My extends it.w{initializeProgram(e){return new rt.B(e.rctx,My.shader.get().build(this.configuration),nt.D)}initializePipeline(){switch(this.configuration.alphaMode){case xy.None:return(0,at.Ey)({colorWrite:at.wE});case xy.Alpha:return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE});case xy.PremultipliedAlpha:case xy.COUNT:return(0,at.Ey)({blending:(0,at.ox)(st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE})}}}My.shader=new tt.$(Ty.a,(()=>i.e(71043).then(i.bind(i,71043))));var Sy=i(35072);class Py extends it.w{initializeProgram(e){return new rt.B(e.rctx,Py.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}Py.shader=new tt.$(Sy.a,(()=>i.e(12362).then(i.bind(i,12362))));var Ry=i(16309);class Ey extends it.w{initializeProgram(e){return new rt.B(e.rctx,Ey.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE})}}Ey.shader=new tt.$(Ry.a,(()=>i.e(33547).then(i.bind(i,33547))));class Oy{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new Ay,this._passParameters=new Ty.C,this._oitParameters=new Ry.O,this._hudParameters=new Sy.H}compositeOIT(e,t,i,n){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=n;const r=this._techniqueRepository.acquire(Ey);this._rctx.bindTechnique(r,e,this._oitParameters),this._rctx.screen.draw(),r.release()}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniqueRepository.acquire(Py);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw(),i.release()}composite(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:xy.None,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=1!==n,this._passParameters.texture=t,this._passParameters.opacity=n;const r=this._techniqueRepository.acquire(My,this._configuration);this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.screen.draw(),r.release()}}var Dy=i(14522),Iy=i(94536);const Ly=100,Ny=500,Fy=500,Vy=.1;function Hy(e,t,i){return(0,Dy.T)(t,e)*(i[1]-i[0])+i[0]}function Uy(e,t,i){let n=0;if(!t.some((e=>!!e.materialReference&&(n+=e.numGeometries,n>=1e4))))return Qy.compute(e,t);const r=Iv();return i.forAll((t=>Nv(r,function(e,t){if(!t.visible)return;const i=Iv(),n=t.getSpatialQueryAccelerator();return n?function(e,t,i){const n=t.eye,r=t.viewForward,s=t.frustum,a=e=>e.visible,o=i.objectCount;if(o<Ny)Lv(Zy,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(n,r,Iy.A.DepthOrder.FRONT_TO_BACK,Zy,((i,n)=>{zy(e,t,i),Zy.far=e.near,n.setRange(Zy)}),s,a),Lv(Zy,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(n,r,Iy.A.DepthOrder.BACK_TO_FRONT,Zy,((i,n)=>{zy(e,t,i),Zy.near=e.far,n.setRange(Zy)}),s,a);else{const n=Math.max(Math.min(o,Fy),Math.ceil(o*Vy)),l=i.findClosest(r,Iy.A.DepthOrder.FRONT_TO_BACK,s,a,n),c=i.findClosest(r,Iy.A.DepthOrder.BACK_TO_FRONT,s,a,n);l&&c&&(Gy(e,t,l.boundingVolumeWorldSpace.bounds),Gy(e,t,c.boundingVolumeWorldSpace.bounds))}}(i,e,n):function(e,t,i){jy.clear(),i.forAll((e=>{e.visible&&0!==e.geometries.length&&jy.add(e)})),jy.empty||(jy.sort(t),Lv(Zy,t.near,Math.min(e.near,t.far)),jy.forEachInDepthRange(Zy,Iy.A.DepthOrder.FRONT_TO_BACK,((i,n)=>{n<e.near&&zy(e,t,i)})),Lv(Zy,Math.max(e.far,t.near),t.far),jy.forEachInDepthRange(Zy,Iy.A.DepthOrder.BACK_TO_FRONT,((t,i,n)=>{e.far=Math.max(e.far,n)})))}(i,e,t.objects),i}(e,t)))),r}function zy(e,t,i){if(!i.visible)return;if(!(0,Xc.m7)(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const n=i.transformation,r=Wy;i.geometries.forEach((i=>{(0,At.lw)(r,n,i.transformation);const s=(0,fe.hG)(r);qy(e,t,i.boundingInfo,r,s)}))}function qy(e,t,i,n,r){if(null==i)return;(0,Ge.e)((0,vn.g)(ky),i.center,n);const{eye:s,viewForward:a}=t,o=a[0]*(ky[0]-s[0])+a[1]*(ky[1]-s[1])+a[2]*(ky[2]-s[2]);if(ky[3]=i.radius*r,!(o-ky[3]>e.near&&o+ky[3]<e.far)&&(0,Xc.m7)(t.frustum,ky))if(i.radius>Ly&&i.getChildren())for(const l of i.getChildren())qy(e,t,l,n,r);else Xy.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,i.bbMin,i.bbMax)}function Gy(e,t,i){const n=t.eye,r=t.viewForward,s=(i[0]-n[0])*r[0]+(i[1]-n[1])*r[1]+(i[2]-n[2])*r[2];e.near=Math.min(e.near,s-i[3]),e.far=Math.max(e.far,s+i[3])}const By=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],ky=(0,vn.c)(),Wy=(0,Mt.vt)(),Zy=Iv(),jy=new class{constructor(){this._items=new oc.A({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const n=e.object.boundingVolumeWorldSpace.bounds,r=(n[0]-t[0])*i[0]+(n[1]-t[1])*i[1]+(n[2]-t[2])*i[2];e.distance=r,e.near=r-n[3],e.far=r+n[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===Iy.A.DepthOrder.FRONT_TO_BACK)for(let n=0;n<this._items.length;++n){const t=this._items.data[n];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}else for(let n=this._items.length-1;n>=0;--n){const t=this._items.data[n];t.far<e.near||t.near>e.far||i(t.object,t.near,t.far)}}},Qy=new class{constructor(){this._view=(0,Mt.vt)(),this._viewProj=(0,Mt.vt)(),this._frustum=(0,Xc.vt)(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),(0,At.C)(this._view,e.viewMatrix),(0,At.lw)(this._viewProj,e.projectionMatrix,this._view),(0,Xc.C)(this._frustum,e.frustum);const i=this._view,n=i[2],r=i[6],s=i[10],a=i[14];t.forAll((e=>{e.materialReference&&e.forEachGeometry&&e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,i=n*t[0]+r*t[1]+s*t[2]+a,o=i-t[3],l=i+t[3];this._geometries.push(e),this._near.push(-l),this._far.push(-o)}))}));const o=new Dv;if(0===this._geometries.length)return o;for(let d=0;d<this._geometries.length;++d)this._near[d]>o.far&&(o.far=this._near[d]),this._near[d]>2&&this._far[d]<o.near&&(o.near=this._far[d]);const l=this._looseRange;l.near=Math.max(.5*o.near,2),l.far=2*o.far;let c=0,h=0;for(let d=0;d<this._geometries.length;++d)this._near[d]<o.near&&(this._near[d]>=l.near?o.near=this._near[d]:this._nearCandidates[c++]=d),this._far[d]>o.far&&(this._far[d]<=l.far?o.far=this._far[d]:this._farCandidates[h++]=d);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return o;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let d=0;d<this._nearCandidates.length;++d){const e=this._nearCandidates[d];if(this._near[e]<o.near){const t=this._geometries[e],i=t.boundingInfo;this._includeNearBoundingInfoRec(i,t.shaderTransformation,o)}}for(let d=0;d<this._farCandidates.length;++d){const e=this._farCandidates[d];if(this._far[e]>o.far){const t=this._geometries[e],i=t.boundingInfo;this._includeFarBoundingInfoRec(i,t.shaderTransformation,o)}}return this._reset(),o}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,i){if(null==e)return;const n=e.center;(0,Ge.e)((0,vn.g)(ky),n,t);const r=(0,fe.hG)(t),s=ky[0],a=ky[1],o=ky[2],l=e.radius*r,c=this._frustum;if(c[0][0]*s+c[0][1]*a+c[0][2]*o+c[0][3]>l||c[1][0]*s+c[1][1]*a+c[1][2]*o+c[1][3]>l||c[2][0]*s+c[2][1]*a+c[2][2]*o+c[2][3]>l||c[3][0]*s+c[3][1]*a+c[3][2]*o+c[3][3]>l)return;const h=this._view[2]*s+this._view[6]*a+this._view[10]*o+this._view[14],d=h+l;if(!(-(h-l)<2||-d>=i.near))if(-d>this._looseRange.near)i.near=-d;else{if(l>Ly){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeNearBoundingInfoRec(e,t,i);return}}Xy.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,i){if(null==e)return;let n=e.radius;const r=e.center;(0,Ge.e)((0,vn.g)(ky),r,t);const s=(0,fe.hG)(t),a=ky[0],o=ky[1],l=ky[2];n*=s;const c=this._frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*l+c[0][3]>n||c[1][0]*a+c[1][1]*o+c[1][2]*l+c[1][3]>n||c[2][0]*a+c[2][1]*o+c[2][2]*l+c[2][3]>n||c[3][0]*a+c[3][1]*o+c[3][2]*l+c[3][3]>n)return;const h=this._view[2]*a+this._view[6]*o+this._view[10]*l+this._view[14]-n;if(!(-h<=i.far))if(-h<this._looseRange.far)i.far=-h;else{if(n>Ly){const n=e.getChildren();if(void 0!==n){for(const e of n)this._includeFarBoundingInfoRec(e,t,i);return}}Xy.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}},Xy=new class{constructor(){this._modelViewProj=(0,Mt.vt)(),this._clipPosition=[(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)(),(0,Ye.vt)()]}unionDepthRangeWithAABB(e,t,i,n,r){const s=this._modelViewProj;(0,At.lw)(s,t,i);let a=!1;for(let o=0;o<8;++o){const e=this._clipPosition[o],t=0===o||3===o||4===o||7===o?n[0]:r[0],i=0===o||1===o||4===o||5===o?n[1]:r[1],a=o<4?n[2]:r[2];e[0]=s[0]*t+s[4]*i+s[8]*a+s[12],e[1]=s[1]*t+s[5]*i+s[9]*a+s[13],e[2]=s[2]*t+s[6]*i+s[10]*a+s[14],e[3]=s[3]*t+s[7]*i+s[11]*a+s[15]}for(let o=0;o<12;++o){const t=this._clipPosition[By[o][0]],i=this._clipPosition[By[o][1]],n=this._clipPosition[By[o][2]],r=this._clipTriangle(t,i,n);let s=!0;for(let e=0;e<r.length;++e)if(r[e][3]>=2){s=!1;break}if(!s){a=!0;for(let t=0;t<r.length;++t){const i=r[t][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return a}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,fi.vA)(!1)}_intersect(e,t,i){let n=0;return 0===i?n=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?n=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?n=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(n=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Xe.l)((0,Ye.vt)(),e,t,n)}_clipTriangle(e,t,i){let n=[e,t,i];for(let r=0;r<4;++r){const e=n;n=[];for(let t=0;t<e.length;++t){const i=e[t],s=e[(t+1)%e.length];this._inside(s,r)?(this._inside(i,r)||n.push(this._intersect(i,s,r)),n.push(s)):this._inside(i,r)&&n.push(this._intersect(i,s,r))}}return n}};var Yy,$y,Ky=i(30988),Jy=i(49003),eb=i(57528),tb=i(53736),ib=i(58350),nb=i(32307),rb=i(70367);class sb{}class ab extends et.Y{constructor(){super(...arguments),this.textures=new sb}}function ob(){const e=new nb.N5;return e.attributes.add(li.r.POSITION,"vec2"),e.vertex.uniforms.add(new ib.E("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,n=e.magnifier.offset.x*i,r=e.magnifier.offset.y*i;(0,v.WA)(e.magnifier.position,lb);const s=t.camera.screenToRender(lb,cb),a=Math.ceil(i*e.magnifier.size),o=t.camera.fullWidth,l=t.camera.fullHeight;return(0,Xe.s)(hb,(s[0]+n)/o*2-1,(s[1]-r)/l*2-1,a/o*2,a/l*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.code.add((0,et.H)(Yy||(Yy=(0,eb.A)(["void main(void) {\nvUV = position;\ngl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);\n}"])))),e.fragment.uniforms.add(new rb.N("textureInput",(e=>e.textures.input))),e.fragment.uniforms.add(new rb.N("textureMask",(e=>e.textures.mask))),e.fragment.uniforms.add(new rb.N("textureOverlay",(e=>e.textures.overlay))),e.fragment.uniforms.add(new tb.e("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new tb.e("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add((0,et.H)($y||($y=(0,eb.A)(["const float barrelFactor = 1.1;\nvec2 barrel(vec2 uv) {\nvec2 uvn = uv * 2.0 - 1.0;\nif (uvn.x == 0.0 && uvn.y == 0.0) {\nreturn vec2(0.5, 0.5);\n}\nfloat theta = atan(uvn.y, uvn.x);\nfloat r = pow(length(uvn), barrelFactor);\nreturn r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;\n}\nvoid main() {\nfloat mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;\nvec4 inputColor = texture(textureInput, barrel(vUV)) * mask;\nvec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);\nfragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;\n}"])))),e}const lb=(0,v.gs)(),cb=(0,v.QG)(),hb=(0,Ye.vt)();var db=i(92271);let ub=class extends T.A{constructor(){super(...arguments),this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new ab,this.events=new B.A,this.attributeLocations=new Map([[li.r.POSITION,0]]),this._tmpScreenPoint=(0,v.gs)(),this._tmpRenderPoint=(0,v.QG)()}get updating(){return null==this._imageSources&&null!=this._imageLoadTask&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};null!=this._magnifier&&this.addHandles((0,g.watch)((()=>{var e;return null===(e=this._magnifier)||void 0===e?void 0:e.version}),t)),t()}get enabled(){return null!=this._validMagnifier}get _validMagnifier(){return null!=this._magnifier&&this._magnifier.visible&&null!=this._magnifier.position&&this._magnifier.size>0?this._magnifier:null}get _factor(){return null!=this._magnifier&&this._magnifier.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(null==i)return;const n=t.camera.pixelRatio,r=Math.ceil(n*i.size);if(this._updateResources(e,r),null==this._resources)return;const s=this._passParameters.textures,a=Math.ceil(1/this._factor*r);s.input.resize(a,a),(0,v.WA)(i.position,this._tmpScreenPoint);const o=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),l=t.camera.fullWidth,c=t.camera.fullHeight,h=.5*a,d=.5*a;o[0]=(0,_e.qE)(o[0],h,l-h-1),o[1]=(0,_e.qE)(o[1],d,c-d-1);const u=Math.floor(o[0]-h),p=Math.floor(o[1]-d),m=this._resources.program;m.bindTexture("textureInput",s.input),e.gl.copyTexImage2D(s.input.descriptor.target,0,s.input.descriptor.pixelFormat,u,p,a,a,0),this._passParameters.magnifier=i,e.useProgram(m),m.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(st.WR.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(null==e)return;const t=e.maskUrl,i=e.overlayUrl;null==this._imageLoadTask||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),null==this._imageSources&&null==this._imageLoadTask&&(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:(0,oe.UT)((async e=>{const n=null==t||null==i?(0,db.u)(e):null,r=null!=t?(0,Jy.D)(t,{signal:e}):n.then((e=>e.mask)),s=null!=i?(0,Jy.D)(i,{signal:e}):n.then((e=>e.overlay));this._imageSources={mask:await r,overlay:await s},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(null!=this._resources){if(this._passParameters.textures.size!==t){const i=this._createTextureResources(e,t);if(null==i)return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=i}return}const i=this._createTextureResources(e,t);null!=i&&(this._resources={program:this._createProgram(e),vao:(0,pt.Q)(e,ut.lK,this.attributeLocations,0,1),pipelineState:(0,at.Ey)({blending:(0,at.ox)(st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:at.wE})},this._passParameters.textures=i)}_disposeResources(){null!=this._resources&&(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(null==this._imageSources)return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Ht.R;i.internalFormat=st.Ab.RGBA,i.wrapMode=st.pF.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!(0,Iu.XJ)(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result;const n=new hi.g(e,i,this._imageSources.overlay);i.pixelFormat=i.internalFormat=st.Ab.ALPHA,i.preMultiplyAlpha=!1;const r=new hi.g(e,i,this._imageSources.mask);return i.pixelFormat=i.internalFormat=st.Ab.RGBA,i.flipped=!1,{input:new hi.g(e,i),mask:r,overlay:n,size:t}}_createProgram(e){return new rt.B(e,ob(),this.attributeLocations)}};(0,n._)([(0,b.MZ)()],ub.prototype,"_imageSources",void 0),(0,n._)([(0,b.MZ)()],ub.prototype,"_imageLoadTask",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],ub.prototype,"updating",null),ub=(0,n._)([(0,x.$)("esri/views/3d/webgl-engine/lib/MagnifierHelper")],ub);var pb=i(75941);class mb{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new cg.XP(new ArrayBuffer(4)),this._layerToOidToColor=new pb.O,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new pb.O,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e&&t&&i&&n&&(this._layerUidToId.set(n,i),this._layerUidToPopupEnabled.set(n,r),r&&this._layerUidToGraphicsUidToObjectId.set(n,t,{objectId:e,attributeNodeId:s,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return(0,Ye.fA)(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var t;if(!e.layerUid||!e.graphicUid)return this.colorZero;const i=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===i)return u.A.getLogger(this).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(!1===i)return this.colorZero;const n=null===(t=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))||void 0===t?void 0:t.objectId;if(!n)return this.colorZero;let r=this._layerToOidToColor.get(e.layerUid,n);if(!r){for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,n,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new cg.XP(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const n=this._layerUidToGraphicsUidToObjectId.get(i.layerUid,i.graphicUid);n||u.A.getLogger(this).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid);const r=this._layerUidToId.get(i.layerUid);r||u.A.getLogger(this).warn("no layerId found for uid "+i.layerUid),n&&r&&e.set(t,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:n.objectId,lid:r,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",oid:n.objectId,lid:r})}return e}}var _b;i(39299),i(15434),i(62754);class gb{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(){++this._refCount}release(){return 0===this._refCount?(console.log("Releasing already released FBO attachment in ".concat((new Error).stack)),!0):(--this._refCount,0===this._refCount&&(this.free(),!0))}}!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(_b||(_b={}));class fb extends gb{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}}class vb extends fb{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=_b.COLOR}}class yb extends fb{constructor(){super(...arguments),this.type=_b.DEPTH}}class bb extends gb{constructor(e,t,i,n,r,s){super(e,s),this.type=_b.FBO,this._colors=new Map,this._name="composite-color",this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=i,this.acquireDepth=n,this.acquireColor=r}dispose(){this.fbo.dispose()}get usedMemory(){return this.fbo.usedMemory}get name(){return this._name}setName(e){this._name=e}getTexture(){var e,t;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st.Nm.COLOR_ATTACHMENT0;return i===st.nI?null===(e=this.fbo)||void 0===e?void 0:e.depthStencilTexture:null===(t=this.fbo)||void 0===t?void 0:t.getColorTexture(i)}getAttachment(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:st.Nm.COLOR_ATTACHMENT0;return e===st.nI?this._depth:this._colors.get(e)}attachDepth(e){return null!==e&&void 0!==e&&e.retain(),this.detachDepth(),e&&this.fbo.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo.detachDepthStencilTexture(),this.fbo.detachDepthStencilBuffer(),this._depth=(0,p.Gz)(this._depth)}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),null===t||void 0===t||t.release()}detachAll(){this._colors.forEach(((e,t)=>this.detachColor(t))),this.detachDepth()}}class wb{constructor(e,t){this._last=new oc.A,this._incarnation=0,this._cache=new Cp.I(e,t)}destroy(){var e;null!==(e=this._last)&&void 0!==e&&e.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new oc.A:e||(null!==(t=this._last)&&void 0!==t&&t.forAll((e=>e.dispose())),this._last=null)}clean(){var e;null===(e=this._last)||void 0===e||e.filterInPlace((e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1)))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e,t;return null!==(e=null===(t=this._last)||void 0===t?void 0:t.reduce(((e,t)=>e+t.usedMemory),0))&&void 0!==e?e:0}}var xb=i(62881);class Cb{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new wb(e.newCache,"FBOCache"),this._depthCache=new wb(e.newCache,"DepthAttachmentCache"),this._colorCache=new wb(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===_b.FBO&&e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>{var i,n;return e+("getTexture"in t?null!==(i=null===(n=t.getTexture())||void 0===n?void 0:n.usedMemory)&&void 0!==i?i:0:t.usedMemory)}),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:dt.N.RGBA;const r=Tb(n,e,t);let s=this._cache.pop(r);return s?(s.retain(),s.setName(i)):s=new bb(r,i,new Vt.H(this.rctx,{...Db[n],width:e,height:t}),(e=>{var t;null!==(t=e)&&void 0!==t||(e=dt.z.DEPTH_STENCIL_TEXTURE);const i=this._acquireDepth(e,s.fbo.width,s.fbo.height,"".concat(s.name," depth"));return s.attachDepth(i),i.release(),s}),((i,n)=>{var r;null!==(r=n)&&void 0!==r||(n=dt.N.RGBA);const a=this._acquireColor(n,e,t,"".concat(s.name," color ").concat(i));return s.attachColor(a,i),a.release(),s}),(()=>{this.debugCallback&&this.debugCallback(s.name,s.fbo),this._acquired.delete(s),s.detachAll(),this._cache.put(s)})),this._trackHandle(s)}acquireDepth(e,t,i,n){return this._acquireDepth(e,t,i,n)}_acquireDepth(e,t,i,n){const r=Tb(e,t,i),s=this._depthCache.pop(r);if(s)return s.retain(),s.name=n,this._trackHandle(s);const a=e===dt.z.DEPTH_STENCIL_TEXTURE?new yb(r,new hi.g(this.rctx,{...Lb[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)})):new yb(r,new xb.l(this.rctx,{...Lb[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)}));return a.name=n,this._trackHandle(a)}_acquireColor(e,t,i,n){const r=Tb(e,t,i),s=this._colorCache.pop(r);if(s)return s.retain(),s.name=n,this._trackHandle(s);const a=new vb(r,new hi.g(this.rctx,{...Db[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._colorCache.put(a)}));return a.name=n,this._trackHandle(a)}_trackHandle(e){return this._acquired.add(e),e}}function Tb(e,t,i){return"".concat(e,"x").concat(t,"x").concat(i)}const Ab=new Ht.R;Ab.pixelFormat=st.Ab.RED,Ab.internalFormat=st.H0.R8,Ab.wrapMode=st.pF.CLAMP_TO_EDGE;const Mb=new Ht.R;Mb.pixelFormat=st.Ab.RG,Mb.internalFormat=st.H0.RG8,Mb.wrapMode=st.pF.CLAMP_TO_EDGE;const Sb=new Ht.R;Sb.internalFormat=st.H0.RGBA4,Sb.dataType=st.ld.UNSIGNED_SHORT_4_4_4_4,Sb.wrapMode=st.pF.CLAMP_TO_EDGE;const Pb=new Ht.R;Pb.wrapMode=st.pF.CLAMP_TO_EDGE;const Rb=new Ht.R;Rb.wrapMode=st.pF.CLAMP_TO_EDGE,Rb.samplingMode=st.Cj.LINEAR_MIPMAP_LINEAR,Rb.hasMipmap=!0,Rb.maxAnisotropy=8;const Eb=new Ht.R;Eb.pixelFormat=st.Ab.RED,Eb.dataType=st.ld.HALF_FLOAT,Eb.internalFormat=st.H0.R16F,Eb.samplingMode=st.Cj.NEAREST;const Ob=new Ht.R;Ob.dataType=st.ld.HALF_FLOAT,Ob.internalFormat=st.H0.RGBA16F,Ob.samplingMode=st.Cj.NEAREST;const Db={[dt.N.RED]:Ab,[dt.N.RG]:Mb,[dt.N.RGBA4]:Sb,[dt.N.RGBA]:Pb,[dt.N.RGBA_MIPMAP]:Rb,[dt.N.R16F]:Eb,[dt.N.RGBA16F]:Ob},Ib=new Ht.R;Ib.pixelFormat=st.Ab.DEPTH_STENCIL,Ib.dataType=st.ld.UNSIGNED_INT_24_8,Ib.samplingMode=st.Cj.NEAREST,Ib.wrapMode=st.pF.CLAMP_TO_EDGE;const Lb={[dt.z.DEPTH_STENCIL_TEXTURE]:Ib,[dt.z.DEPTH16_BUFFER]:new Ig.q(st.yQ.DEPTH_COMPONENT16,4)};var Nb,Fb=i(89712),Vb=i(10773);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(Nb||(Nb={}));class Hb{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Nb.FrontToBack;this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new oc.A({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,n){var r;const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=n,s.indexType=null!==(r=t.indexed?t.vao.indexBuffer.indexType:null)&&void 0!==r?r:0}prepare(e,t){return this._draws.map((i=>i.material.prepareTechnique(this._techniqueRepository,e,t,i.geometry.parameters)))}dispatch(e,t,i){const n=this._rctx;this._previouslyBoundDraw.clear();let r=null;const s=this._draws.length;for(let a=0;a<s;a++){const s=i[a];s===r&&s.configuration.transparencyPassType===Vb.y.NONE||(n.bindTechnique(s,t,e),r=s);const o=this._draws.data[a],l=o.geometry;n.bindVAO(l.vao),this._previouslyBoundDraw.get(s)!==o.material&&(s.program.bindDraw(o.material,t,e),this._previouslyBoundDraw.set(s,o.material));const c=o.geometryRanges,h=c.length;if(0!==o.indexType){const e=Ub.get(o.indexType);for(let t=0;t<h;t+=2){const i=c[t],r=c[t+1];n.drawElements(l.primitiveType,r,o.indexType,i*e)}}else for(let e=0;e<h;e+=2){const t=c[e],i=c[e+1];n.drawArrays(l.primitiveType,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===Nb.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const n=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==n?n:t.geometry.vao.byteSize-i.geometry.vao.byteSize}))}get count(){return this._draws.length}}const Ub=new Map;Ub.set(st.pe.UNSIGNED_BYTE,1),Ub.set(st.pe.UNSIGNED_SHORT,2),Ub.set(st.pe.UNSIGNED_INT,4);var zb=i(77845);let qb=class extends $i.tI{constructor(){super({}),this._passes=null,this.produces=new Map([[Ki.N.OPAQUE_MATERIAL,e=>this._produces(e)],[Ki.N.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[Ki.N.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new Fb.Dh,this._shadowPassParameters=new Fb.kR,this._highlightPassParameters=new Fb.eF,this._systems=new Set}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx,i=e.techniqueRepository;this._passes={materialOpaque:new Hb(t,i),materialTransparent:new Hb(t,i,Nb.BackToFront),materialIntegratedMesh:new Hb(t,i),shadowMap:new Hb(t,i),highlight:new Hb(t,i),highlightIntegratedMesh:new Hb(t,i),highlightShadowMap:new Hb(t,i),defaultShadowMap:new Hb(t,i)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return 0!==this._systems.size&&null!==this._passes&&(e===tf.V.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==tf.V.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(0!==this._systems.size&&null!==this._passes){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this._context.techniqueRepository.frameUpdate()}}prepareTechniques(e){if(0===this._systems.size)return null;const t=e.output===tf.V.Shadow||e.output===tf.V.ShadowHighlight||e.output===tf.V.ShadowExcludeHighlight?this._shadowPassParameters:e.output===tf.V.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bindParameters;return this._updateParameters(i.camera,t,i.slot===Ki.N.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,((t,i)=>t.prepare(i,e.bindParameters)))}renderNode(e,t){this._invoke(e,((i,n)=>i.dispatch(n,e.bindParameters,t)))}_invoke(e,t){if(null===this._passes)return null;switch(e.bindParameters.slot){case Ki.N.OPAQUE_MATERIAL:switch(e.output){case tf.V.Color:case tf.V.LinearDepth:case tf.V.Normal:case tf.V.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case tf.V.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case tf.V.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case tf.V.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case tf.V.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case Ki.N.TRANSPARENT_MATERIAL:switch(e.output){case tf.V.Color:case tf.V.Alpha:case tf.V.LinearDepth:case tf.V.Normal:case tf.V.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case Ki.N.INTEGRATED_MESH:switch(e.output){case tf.V.Color:case tf.V.LinearDepth:case tf.V.Normal:case tf.V.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case tf.V.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new Dv;return this._systems.forEach((i=>Nv(t,i.queryShadowCasterDepthRange(e)))),t}_updateParameters(e,t,i){const n=e.viewInverseTransposeMatrix;(0,Ge.s)(Gb,n[3],n[7],n[11]),kb.set(Gb),(0,Ge.c)(t.transformWorldFromViewTH,kb.high),(0,Ge.c)(t.transformWorldFromViewTL,kb.low),(0,Ge.c)(t.slicePlaneLocalOrigin,Gb),(0,Tt.z0)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,At.C)(t.transformProjFromView,e.projectionMatrix),t.identifier===Fb.zq.Material&&(this._materialPassParameters.transparent=i,(0,Tt.mg)(Bb,t.transformViewFromCameraRelativeRS),(0,Tt.B8)(t.transformNormalViewFromGlobal,Bb))}};qb=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],qb);const Gb=(0,P.vt)(),Bb=(0,zr.vt)(),kb=new zb.p;var Wb=i(98521),Zb=i(61678);class jb{constructor(e){this._context=e,this._nodes=new oc.A}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),Zb.Ns&&console.log("Registered render nodes: ".concat(this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")))}remove(e){this._nodes.remove(e),Zb.Ns&&console.log("Registered render nodes: ".concat(this._nodes.map((e=>{let{declaredClass:t}=e;return t})).join(", ")))}produces(e){return this._nodes.some((t=>{let{produces:i}=t;return i===e}))}require(e,t){return this._nodes.reduce(((i,n)=>{let{consumes:r,produces:s}=n;return i+(r.required.includes(e)&&s===t?1:0)}),0)}optional(e,t){return this._nodes.reduce(((i,n)=>{var r;let{consumes:s,produces:a}=n;return i+(null!==(r=s.optional)&&void 0!==r&&r.includes(e)&&a===t?1:0)}),0)}updateAnimation(){return this._nodes.reduce(((e,t)=>t.updateAnimation()||e),!1)}render(e,t,i){const n=e.name,r=this._nodes.filter((e=>{let{produces:t}=e;return t===n}));return 0===r.length||(r.forEach((r=>{const s=[e];for(const e of r.consumes.required){if(e===n)continue;const r=t.get(e);if(!r)return void i(s);s.push(r)}if(r.consumes.optional)for(const e of r.consumes.optional){if(e===n)continue;const i=t.get(e);i&&s.push(i)}try{const i=r.doRender(s,this._context);i&&i!==e&&(e.release(),e=i,t.set(n,e))}catch(Y){u.A.getLogger(r).errorOnce(Y)}i(s)})),this._context.rctx.enforceState()),e}}class Qb{constructor(e){this._context=e,this._renderPlugins=new oc.A,this._slots=new Array,this._renderVersion=(0,vu.v)(0);for(let t=0;t<Ki.N.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(null!==t&&void 0!==t&&t.aborted)throw e.uninitializeRenderContext(),(0,_.NK)();this._renderPlugins.push(e),e.produces.forEach(((t,i)=>{this._slots[i].push(e)})),this._context.requestRender(),this._renderVersion.value++},n=e.initializeRenderContext(this._context,t);if((0,_.$X)(n))return n.then(i);i()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>{i.updateAnimation&&(t=i.updateAnimation(e)||t)})),t}renderFeatureChanged(){this._renderPlugins.forAll((e=>{e.renderFeatureChanged&&e.renderFeatureChanged()}))}prepare(e){this._context.renderContext.bindParameters.slot=e,this._slots[e].forEach((t=>{const i=t.produces.get(e);i&&i(tf.V.Color)&&((0,$i.zo)(t)&&t.prepareTechnique(this._context.renderContext),(0,$i.ss)(t)&&t.prepareTechniques(this._context.renderContext))}))}_getRenderables(e){var t;this._context.renderContext.bindParameters.slot=e;const i=null!==(t=this._context.renderContext.output)&&void 0!==t?t:tf.V.Color,n=new Map;return this._slots[e].forEach((t=>{const r=t.produces.get(e);if(r&&r(i)&&(!t.isDecoration||this._context.renderContext.bindParameters.decorations!==Wp.ID.OFF))if((0,$i.zo)(t)){const e=t.prepareTechnique(this._context.renderContext);null!=e&&n.set(t,e)}else if((0,$i.ss)(t)){const e=t.prepareTechniques(this._context.renderContext);null!=e&&n.set(t,e)}else n.set(t,null)})),n}render(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this._getRenderables(e).forEach(((e,n)=>i=n.renderNode(this._context.renderContext,e,t,i))),i}queryDepthRange(e){const t=new Dv;return this._renderPlugins.forAll((i=>{var n;const r=null===(n=i.queryDepthRange)||void 0===n?void 0:n.call(i,e);Nv(t,r)})),t}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:tf.V.Color;return this._slots[e].some((i=>{const n=i.produces.get(e);return!!n&&n(t)}))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}getMaterialRenderer(e){return this._renderPlugins.find((t=>t.materialReference===e))}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace((e=>!e.materialReference||0!==e.numGeometries||(e.destroy(),!1)))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),jp.m$.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>{var i;return null!==t.materialReference?e:e+(null!==(i=t.usedMemory)&&void 0!==i?i:0)}),0)}get test(){return{plugins:this._renderPlugins}}}let Xb=class extends $i.RW{constructor(e){super(e),this._context=null,this.opacity=1,this.alphaMode=xy.None,this._blitConfiguration=new Ay,this._blitParameters=new Ty.C,this.produces=new Map([[Ki.N.BLIT,()=>null!=this._context]])}consumes(){return $i.cD}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){this._context=null}destroy(){}renderNode(e,t,i,n){var r;const s=null===i||void 0===i||null===(r=i.get("composite-color"))||void 0===r?void 0:r.getTexture();if(!this._context||!s)return n;const a=this._context.techniqueRepository.acquire(My,this._blitConfiguration);return null!==a&&void 0!==a&&a.compiled?(e.rctx.bindFramebuffer(null===n||void 0===n?void 0:n.fbo),this._blitParameters.texture=s,this._blitParameters.opacity=this.opacity,e.rctx.bindTechnique(a,e.bindParameters,this._blitParameters),e.rctx.screen.draw(),a.release(),n):(this._context.requestRender(),n)}};(0,n._)([(0,b.MZ)()],Xb.prototype,"_context",void 0),(0,n._)([(0,b.MZ)()],Xb.prototype,"opacity",void 0),(0,n._)([(0,b.MZ)()],Xb.prototype,"alphaMode",void 0),Xb=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.effects.blit.Blit")],Xb);var Yb=i(61157);class $b extends it.w{initializeProgram(e){return new rt.B(e.rctx,$b.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE})}}$b.shader=new tt.$(Yb.H,(()=>i.e(82671).then(i.bind(i,82671))));var Kb=i(43666);class Jb extends it.w{initializeProgram(e){return new rt.B(e.rctx,Jb.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:at.wE})}}Jb.shader=new tt.$(Kb.a,(()=>i.e(9616).then(i.bind(i,9616))));var ew=i(21019);class tw extends it.w{initializeProgram(e){return new rt.B(e.rctx,tw.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:at.wE})}}tw.shader=new tt.$(ew.a,(()=>i.e(51521).then(i.bind(i,51521))));class iw extends et.Y{constructor(){super(...arguments),this.color=(0,Ye.fA)(1,0,1,1),this.haloColor=(0,Ye.fA)(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.coverageRounding=(0,Ke.fA)(1,1)}}let nw=class extends $i.RW{constructor(e){super(e),this._context=null,this._passParameters=new iw,this._downsampleDrawParameters=new ew.H,this._blurDrawParameters=new Kb.H,this._blurColorFormat=(0,d.A)("mac")?dt.N.RGBA:dt.N.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this.produces=new Map([[Ki.N.HIGHLIGHT,()=>!0]])}consumes(){return $i.Ao}initializeRenderContext(e){this._context=e,null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(Jb)),null==this._downsampleTechnique&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(tw)),null==this._applyTechnique&&(this._applyTechnique=this._context.techniqueRepository.acquire($b)),this.addHandles([(0,g.watch)((()=>this.view.highlightOptions.color),(e=>{this._passParameters.color=(0,Ze.QP)(null!==e&&void 0!==e?e:$d),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this._context.requestRender()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.haloColor),(e=>{this._passParameters.haloColor=null!=e?(0,Ze.QP)(e):this._passParameters.color,this._context.requestRender()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.haloOpacity),(e=>{this._passParameters.haloOpacity=null!==e&&void 0!==e?e:1,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this._context.requestRender()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.fillOpacity),(e=>{this._passParameters.fillOpacity=null!==e&&void 0!==e?e:.25,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this._context.requestRender()}),g.syncAndInitial)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=(0,p.Gz)(this._blurTechnique),this._downsampleTechnique=(0,p.Gz)(this._downsampleTechnique),this._applyTechnique=(0,p.Gz)(this._applyTechnique),this._grid.coverage=(0,p.Gz)(this._grid.coverage),this._grid.vao=(0,p.WD)(this._grid.vao)}renderNode(e,t,i,n){var r,s;const a=null===i||void 0===i||null===(r=i.get("highlights"))||void 0===r?void 0:r.getTexture();if(!this._context||!a)return;if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return void this._context.requestRender();const o=e.bindParameters.camera,l=o.fullWidth,c=o.fullHeight,h=o.pixelRatio,d=Math.ceil(l/h),u=Math.ceil(c/h),p=this._context.fbos,m=p.rctx;this._gridUpdateResources(a),this._gridComputeCoverage(a,e.bindParameters),this._passParameters.highlightTexture=a,this._passParameters.coverageTexture=null===(s=this._grid.coverage)||void 0===s?void 0:s.getTexture();const{width:_,height:g}=a.descriptor;(0,Qe.hZ)(this._passParameters.coverageRounding,_/(Math.ceil(_/ew.g)*ew.g),g/(Math.ceil(g/ew.g)*ew.g));const f=this._grid.vao;m.bindVAO(f);const v=p.acquire(d,u,"highlight blur",this._blurColorFormat);m.unbindTexture(v.fbo.colorTexture),m.bindFramebuffer(v.fbo),m.setClearColor(0,0,0,0),m.clearSafe(st.hn.COLOR_BUFFER_BIT),m.setViewport(0,0,d,u),this._blurDrawParameters.blurInputTexture=a,(0,Qe.hZ)(this._blurDrawParameters.blurSize,1/d,0);const y=m.bindTechnique(this._blurTechnique,e.bindParameters,this._passParameters,this._blurDrawParameters);m.drawArrays(this._blurTechnique.primitiveType,0,(0,di.mT)(f,"geometry"));const b=p.acquire(d,u,"highlight blur",this._blurColorFormat);m.unbindTexture(b.fbo.colorTexture),m.bindFramebuffer(b.fbo),m.setClearColor(0,0,0,0),m.clearSafe(st.hn.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=v.getTexture(),(0,Qe.hZ)(this._blurDrawParameters.blurSize,0,1/u),y.bindDraw(this._blurDrawParameters,e.bindParameters,this._passParameters),m.drawArrays(this._blurTechnique.primitiveType,0,(0,di.mT)(f,"geometry")),m.bindFramebuffer(null===n||void 0===n?void 0:n.fbo),m.setViewport4fv(o.fullViewport),this._passParameters.blurTexture=b.getTexture(),m.bindTechnique(this._applyTechnique,e.bindParameters,this._passParameters),m.drawArrays(this._applyTechnique.primitiveType,0,(0,di.mT)(f,"geometry")),v.release(),b.release()}_gridUpdateResources(e){var t;if(!this._context)return;const i=this._context.fbos.rctx,n=this._grid,r=Math.ceil(e.descriptor.height/ew.g),s=Math.ceil(e.descriptor.width/ew.g);if(n.vao&&n.verticalCellCount===r&&n.horizontalCellCount===s)return;n.verticalCellCount=r,n.horizontalCellCount=s;const a=r+1,o=s+1,l=1/r,c=1/s,h=new Float32Array(24*a*o);let d=0;for(let u=0;u<a;u++)for(let e=0;e<o;e++)h[d++]=(e-.5)*c*2-1,h[d++]=(u-.5)*l*2-1,h[d++]=e*c,h[d++]=u*l,h[d++]=(e+.5)*c*2-1,h[d++]=(u-.5)*l*2-1,h[d++]=e*c,h[d++]=u*l,h[d++]=(e-.5)*c*2-1,h[d++]=(u+.5)*l*2-1,h[d++]=e*c,h[d++]=u*l,h[d++]=(e-.5)*c*2-1,h[d++]=(u+.5)*l*2-1,h[d++]=e*c,h[d++]=u*l,h[d++]=(e+.5)*c*2-1,h[d++]=(u-.5)*l*2-1,h[d++]=e*c,h[d++]=u*l,h[d++]=(e+.5)*c*2-1,h[d++]=(u+.5)*l*2-1,h[d++]=e*c,h[d++]=u*l;null!==(t=n.vao)&&void 0!==t&&t.dispose(),n.vao=new oi.Z(i,nt.D,{geometry:ut.u7},{geometry:ci.g.createVertex(i,st._U.STATIC_DRAW,h)})}_gridComputeCoverage(e,t){var i;if(!this._context)return;const n=this._context.fbos.rctx,r=this._grid,s=e.descriptor,a=Math.ceil(s.width/ew.g),o=Math.ceil(s.height/ew.g);this._downsampleDrawParameters.input=e,null!==(i=r.coverage)&&void 0!==i&&i.release(),r.coverage=this._context.fbos.acquire(a,o,"highlight coverage",dt.N.RG),n.unbindTexture(r.coverage.fbo.colorTexture),n.bindFramebuffer(r.coverage.fbo),n.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),n.setViewport(0,0,a,o),n.screen.draw()}get test(){return{coverage:this._grid.coverage}}};(0,n._)([(0,b.MZ)()],nw.prototype,"_context",void 0),(0,n._)([(0,b.MZ)()],nw.prototype,"view",void 0),nw=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.effects.highlight.Highlight")],nw);var rw=i(1773);class sw extends ct.K{constructor(){super(...arguments),this.receiveShadows=!0}}(0,n._)([(0,ct.W)()],sw.prototype,"receiveShadows",void 0);var aw=i(97157);class ow extends rw.QR{constructor(){super(...arguments),this.shadowColor=(0,Ye.fA)(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class lw extends it.w{constructor(e){super(e,new sw,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,lw.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.SRC_ALPHA,st.dn.ONE,st.dn.ONE_MINUS_SRC_ALPHA,st.dn.ONE_MINUS_SRC_ALPHA),colorWrite:at.wE,depthTest:null,depthWrite:null})}get primitiveType(){return st.WR.TRIANGLE_STRIP}}lw.shader=new tt.$(aw.S,(()=>i.e(98655).then(i.bind(i,98655))));let cw=class extends $i.RW{constructor(e){super(e),this._maxOpacity=1,this._passParameters=new ow,this._shadowDifference=.2,this._context=null,this.produces=new Map([[Ki.N.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return $i.Ao}initializeRenderContext(e){this._context=e,this.addHandles([(0,g.watch)((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=null!==e&&void 0!==e?e:.4,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=null!==e&&void 0!==e?e:.2,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),g.syncAndInitial),(0,g.watch)((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=(0,Ze.QP)(null!==e&&void 0!==e?e:Kd),this._updateMaxOpacity()}),g.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&null==this._technique&&(this._technique=this._context.techniqueRepository.acquire(lw))}renderNode(e,t,i,n){var r,s;const a=null===i||void 0===i||null===(r=i.get("highlights"))||void 0===r?void 0:r.getTexture();if(!this._context||!a||!this._isVisible)return;if(null===(s=this._technique)||void 0===s||!s.compiled)return void this._context.requestRender();const o=e.bindParameters;if(!o.shadowMap.enabled||!o.linearDepth)return;this._passParameters.highlight=a,this._passParameters.origin=o.camera.center;const l=e.rctx;l.bindFramebuffer(null===n||void 0===n?void 0:n.fbo),l.bindTechnique(this._technique,o,this._passParameters),l.screen.draw()}updateParameters(e,t){this._passParameters.opacityElevation=1-(0,_e.TF)(4e4,5e4,e.relativeElevation);const i=this.viewingMode===te.RT.Global?(0,Ge.n)(hw,e.center):(0,Ge.s)(hw,0,0,1),n=(0,Ge.k)(i,t);this._passParameters.dayNightTerminator=(0,_e.TF)(0,1,(0,_e.qE)(30*n,0,1)),this._isVisible&&this.enable()}get _isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=.001953125}};(0,n._)([(0,b.MZ)()],cw.prototype,"_context",void 0),(0,n._)([(0,b.MZ)()],cw.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],cw.prototype,"viewingMode",void 0),cw=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],cw);const hw=(0,P.vt)();var dw=i(32581);class uw extends it.w{initializeProgram(e){return new rt.B(e.rctx,uw.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:at.wE})}}uw.shader=new tt.$(dw.B,(()=>i.e(79379).then(i.bind(i,79379))));var pw=i(58090);class mw extends it.w{initializeProgram(e){return new rt.B(e.rctx,mw.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:at.wE})}}mw.shader=new tt.$(pw.B,(()=>i.e(24884).then(i.bind(i,24884))));var _w=i(21199);class gw extends it.w{initializeProgram(e){return new rt.B(e.rctx,gw.shader.get().build(),nt.D)}initializePipeline(){return(0,at.Ey)({colorWrite:at.wE})}}gw.shader=new tt.$(_w.E,(()=>i.e(72713).then(i.bind(i,72713))));class fw extends et.Y{}let vw=class extends $i.RW{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new fw,this.produces=new Map([[Ki.N.ANTIALIASING,()=>this._isEnabled&&null!=this._context]])}consumes(){return $i.cD}get updating(){return null!=this._abortController}initializeRenderContext(e){this._context=e,this.addHandles([(0,g.watch)((()=>this.view.qualitySettings.antialiasingEnabled),(()=>this.renderFeatureChanged()),g.syncAndInitial)])}renderFeatureChanged(){var e;this.view.qualitySettings.antialiasingEnabled||null!==(e=this._context)&&void 0!==e&&e.isFeatureEnabled(Mo.n.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}async enable(){var e,t,n;if(this._isEnabled||!this._context||this._abortController)return;if(null!==(e=this._edgeTechnique)&&void 0!==e||(this._edgeTechnique=this._context.techniqueRepository.acquire(gw)),null!==(t=this._blendTechnique)&&void 0!==t||(this._blendTechnique=this._context.techniqueRepository.acquire(uw)),null!==(n=this._blurTechnique)&&void 0!==n||(this._blurTechnique=this._context.techniqueRepository.acquire(mw)),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const r=this._abortController.signal;try{var s;const e=await i.e(77004).then(i.bind(i,77004));await this._loadTextures(this._context,e,r),null===(s=this._context)||void 0===s||s.requestRender()}catch{}this._abortController=null}async _loadTextures(e,t,i){if((0,_.Te)(i),!e)throw(0,_.NK)();const[n,r]=await Promise.allSettled([(0,Jy.D)(t.areaTexture,{signal:i}),(0,Jy.D)(t.searchTexure,{signal:i})]);(0,_.Te)(i),"fulfilled"===n.status&&"fulfilled"===r.status&&(this._areaTexture=yw(e.fbos.rctx,st.Cj.LINEAR,st.Ab.RGB,n.value),this._searchTexture=yw(e.fbos.rctx,st.Cj.NEAREST,st.Ab.LUMINANCE,r.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=(0,p.WD)(this._areaTexture),this._searchTexture=(0,p.WD)(this._searchTexture)}disable(){this._abortController=(0,p.DC)(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,i,n){var r,s,a,o;const l=null===i||void 0===i||null===(r=i.get("composite-color"))||void 0===r?void 0:r.getTexture();if(!(this._isEnabled&&this._context&&i&&l))return n;if(!(null!==(s=this._edgeTechnique)&&void 0!==s&&s.compiled&&null!==(a=this._blendTechnique)&&void 0!==a&&a.compiled&&null!==(o=this._blurTechnique)&&void 0!==o&&o.compiled))return this._context.requestRender(),n;const c=l.descriptor.width,h=l.descriptor.height,d=this._context.fbos,u=e.rctx;u.setViewport(0,0,c,h);const p=d.acquire(c,h,"smaa edges",dt.N.RG);u.unbindTexture(p.fbo.colorTexture),u.bindFramebuffer(p.fbo),u.setClearColor(0,0,0,1),u.clear(st.hn.COLOR_BUFFER_BIT),this._smaaParameters.color=l,u.bindTechnique(this._edgeTechnique,null,this._smaaParameters),u.screen.draw();const m=d.acquire(c,h,"smaa blend");return u.unbindTexture(m.fbo.colorTexture),u.bindFramebuffer(m.fbo),u.setClearColor(0,0,1,1),u.clear(st.hn.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=p.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,u.bindTechnique(this._blendTechnique,null,this._smaaParameters),u.screen.draw(),u.bindFramebuffer(null===n||void 0===n?void 0:n.fbo),p.release(),u.setClearColor(0,1,0,1),u.clear(st.hn.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=m.getTexture(),u.bindTechnique(this._blurTechnique,null,this._smaaParameters),u.screen.draw(),m.release(),n}};function yw(e,t,i,n){const r=new Ht.R;return r.pixelFormat=i,r.wrapMode=st.pF.CLAMP_TO_EDGE,r.width=n.width,r.height=n.height,r.samplingMode=t,new hi.g(e,r,n)}(0,n._)([(0,b.MZ)()],vw.prototype,"view",void 0),(0,n._)([(0,b.MZ)()],vw.prototype,"_context",void 0),(0,n._)([(0,b.MZ)()],vw.prototype,"_abortController",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],vw.prototype,"updating",null),vw=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],vw);var bw=i(37958);class ww{constructor(){this._step=Sw,this._dilation=1,this._firstIdleTime=(0,Si.l5)(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,Si.l5)(performance.now())):this._firstIdleTime=(0,Si.l5)(0),(0,d.A)("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=Cw+Tw)return this._step=(0,Si.l5)(1/0),void(this._dilation=1);this._dilation=e>=Cw?Aw:1}const i=(0,_e.qE)(e/xw,Sw,Pw);this._step===1/0?this._step=(0,Si.l5)(i):this._step=(0,Si.l5)(this._step*Mw+i*(1-Mw))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=(0,Si.l5)(0)}}const xw=.5,Cw=(0,Si.l5)(12e4),Tw=(0,Si.l5)(1e4),Aw=10,Mw=.9,Sw=(0,Si.l5)(1e3),Pw=(0,Si.l5)(1e3/30);var Rw=i(85086),Ew=i(13840);class Ow{constructor(e,t){this._fbos=e,this.compositingHelper=t,this._width=4,this._height=4,this._clearColor=(0,Ye.vt)()}dispose(){this._color=(0,p.Gz)(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(e,t,i){this._fbos.interactive=i===Ew.f.Default;const n=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,(0,Vt.T)(this,n.parameters.maxTextureSize);const r=this._color;return this._color=null,this.releaseBuffers(),(0,Xe.c)(this._clearColor,t),r}releaseBuffers(){var e;null!==(e=this._color)&&void 0!==e&&e.detachDepth(),this._depth=(0,p.Gz)(this._depth)}renderHUDVisibility(e,t,i){var n,r,s;return(null===(n=e)||void 0===n?void 0:n.fbo.width)===this._width&&(null===(r=e)||void 0===r?void 0:r.fbo.height)===this._height||(null!==(s=e)&&void 0!==s&&s.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",dt.N.RGBA4)),e.attachDepth(i||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(Dw),t(),e.detachDepth(),e}compositeToHUDVisibility(e,t){var i;this._fbos.rctx.bindFramebuffer(null===(i=e.hudVisibility)||void 0===i?void 0:i.fbo),this.compositingHelper.compositeHUD(e,t)}renderOITPass(e,t,i){let n,r;const{_width:s,_height:a}=this;switch(t){case Vb.y.Color:n=this._fbos.acquire(s,a,i?"oit hud color":"oit color",dt.N.RGBA16F),r=[0,0,0,0];break;case Vb.y.Alpha:n=this._fbos.acquire(s,a,i?"oit hud alpha":"oit alpha",dt.N.R16F),r=[1,1,1,1];break;case Vb.y.FrontFace:n=this._fbos.acquire(s,a,i?"oit hud front":"oit front"),r=[0,0,0,0]}return i?n.acquireDepth(dt.z.DEPTH16_BUFFER):n.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(n.fbo),this._fbos.rctx.clearFramebuffer(r,i,i),e(),n.detachDepth(),n}compositeToFramebuffer(e,t,i,n){this.bindFbo(),this.compositingHelper.composite(e,t,i,n)}compositeTransparentOntoOpaque(e,t,i,n,r){r?(this._fbos.rctx.bindFramebuffer(r.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clearSafe(st.hn.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),i.getTexture(),n.getTexture())}renderDepthDetached(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,t,i,n){var r,s,a;let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:dt.N.RGBA,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:dt.z.DEPTH16_BUFFER,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this._width,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:this._height,d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;return(null===(r=e)||void 0===r?void 0:r.fbo.width)===c&&(null===(s=e)||void 0===s?void 0:s.fbo.height)===h||(e=(0,p.Gz)(e)),e=null!==(a=e)&&void 0!==a?a:this._fbos.acquire(c,h,t,o),null!==d&&void 0!==d&&d.forEach((t=>e.acquireColor(t.attachment,t.format))),null!=l&&e.acquireDepth(l),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(n,!0,!0),i(),e}renderToTargets(e,t,i,n){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this._bindTarget(t,i),this._fbos.rctx.clearFramebuffer(n,r,s),e(),t.detachDepth()}bindFbo(){const e=null==this._color;if(this._bindTarget(this.color,this.depth),e){const e=this._fbos.rctx;e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clearSafe(st.hn.COLOR_BUFFER_BIT|st.hn.DEPTH_BUFFER_BIT|st.hn.STENCIL_BUFFER_BIT)}}_bindTarget(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(e,t){const i=this._ensureColor();i.attachDepth(this.depth),i.setName(t),this._color=e(i)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(dt.z.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const Dw=[0,1,0,1];var Iw=i(23187),Lw=i(99604),Nw=i(60322);class Fw extends it.w{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,Fw.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:Nw.V0,colorWrite:at.wE,depthTest:null,depthWrite:null})}get primitiveType(){return st.WR.TRIANGLE_STRIP}}Fw.shader=new tt.$(Lw.a,(()=>i.e(37874).then(i.bind(i,37874))));var Vw=i(50578);const Hw=1/512;let Uw=class extends T.A{constructor(e,t,i,n){super({}),this._techniqueRepository=e,this._rctx=t,this._data=i,this._requestRender=n,this._passParameters=new Lw.S(this._data),this._techniqueConfig=new Vw.q,this._enabled=!1,this._vao=(0,pt.Q)(t)}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=(0,p.WD)(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(Fw,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,(0,di.mT)(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>Hw}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;(0,Xe.a)(e,t)||((0,Xe.c)(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};(0,n._)([(0,b.MZ)()],Uw.prototype,"opacityFromElevation",null),Uw=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Uw);var zw=i(90877),qw=i(59922);class Gw extends it.w{constructor(e){super(e,new sw,(()=>this.destroy()))}initializeProgram(e){return new rt.B(e.rctx,Gw.shader.get().build(this.configuration),nt.D)}initializePipeline(){return(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ONE,st.dn.ONE,st.dn.ONE),colorWrite:at.wE,depthTest:null,depthWrite:null})}get primitiveType(){return st.WR.TRIANGLE_STRIP}}Gw.shader=new tt.$(qw.a,(()=>i.e(50216).then(i.bind(i,50216))));let Bw=class extends T.A{constructor(e,t,i,n,r,s){super({}),this.fbos=e,this._stage=i,this._prepareForShadowMapPass=n,this._renderToShadowMap=r,this._requestRender=s,this._progress=0,this._sampleCount=0,this._passParameters=new rw.QR,this._cachedLightDirections=[],this._depthRange=Vv,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new zt.k(new zw.p(e,i.viewingMode),null),this._bindParameters.shadowMap.enabled=!0,this._vao=(0,pt.Q)(this._rctx),this._accumulationRenderer=new Uw(t,this._rctx,this,s);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(qt.W6.SHADOW_ACCUMULATOR,this),(0,g.watch)((()=>i.renderView),(e=>{this.removeHandles(Ww),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),Ww)}),g.syncAndInitial),(0,g.watch)((()=>this._previewing),(()=>this._requestRenderIfEnabled()),g.sync)],this._shadowAccumulatorKey)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,p.WD)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,p.WD)(this._fbo),this._vao=(0,p.WD)(this._vao),this._accumulationTechniqueCached=(0,p.Gz)(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var e;return null===(e=this._fbo)||void 0===e?void 0:e.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(null==this._accumulationTechniqueCached){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new Gw(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return null!=this._fbo&&this._sampleCount>0}get canAccumulate(){var e;return null!==(null===(e=this._bindParameters.linearDepth)||void 0===e?void 0:e.getTexture())&&this._depthRange!==Vv&&this._opacityFromElevation>Hw}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if((0,Pu.aI)(t,e,Ge.G))return;const i=Math.min(qw.S,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r){var n;t[r]=(0,Ge.c)(null!==(n=t[r])&&void 0!==n?n:(0,P.vt)(),e[r])}this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,n){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=n,this._bindParameters.linearDepth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const r=this._cameraForcedForScreenshot?this._sampleCount:Math.min(kw,this._sampleCount-this._progress);for(let s=0;s<r;++s)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(void 0!==e.enabled){const t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,st.Ab.RED,st.ld.UNSIGNED_BYTE,Zw),Zw[0]/this._progress)}_enable(){this._progress=0;const e=new Ht.R;e.pixelFormat=st.Ab.RED,e.internalFormat=st.H0.R8,e.wrapMode=st.pF.CLAMP_TO_EDGE,this._fbo=new Vt.H(this._rctx,e),this._requestRender()}_disable(){this._fbo=(0,p.WD)(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(st.hn.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,(0,di.mT)(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,_e.TF)(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};(0,n._)([(0,b.MZ)()],Bw.prototype,"_progress",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_sampleCount",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_fbo",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_depthRange",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_previewing",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_accumulationRenderer",void 0),(0,n._)([(0,b.MZ)()],Bw.prototype,"_isRefining",null),(0,n._)([(0,b.MZ)()],Bw.prototype,"_isActive",null),(0,n._)([(0,b.MZ)()],Bw.prototype,"canAccumulate",null),(0,n._)([(0,b.MZ)()],Bw.prototype,"_isDoneAccumulating",null),(0,n._)([(0,b.MZ)()],Bw.prototype,"_opacityFromElevation",null),(0,n._)([(0,b.MZ)()],Bw.prototype,"running",null),Bw=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Bw);const kw=6,Ww="renderView",Zw=new Uint8Array(1),jw=(0,N.a)();class Qw{constructor(){this._plane=(0,N.a)()}get isEnabled(){return!(0,N.d)(this.plane,jw)}get plane(){return this._plane}set plane(e){(0,N.c)(e||jw,this._plane)}}class Xw{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const t=this._originData.get(e.id)||new Yw(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}release(e){e.refCount--,0===e.refCount&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach((t=>{(0,At.C)(t.viewMatrix,e),function(e,t){const i=e[0],n=e[1],r=e[2];t[12]+=i*t[0]+n*t[4]+r*t[8],t[13]+=i*t[1]+n*t[5]+r*t[9],t[14]+=i*t[2]+n*t[6]+r*t[10],t[14]+=i*t[3]+n*t[7]+r*t[11]}(t.origin.vec3,t.viewMatrix)}))}}class Yw{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=(0,Mt.vt)()}}var $w=i(37046),Kw=i(69413),Jw=i(83661),ex=i(85827),tx=i(36358);class ix extends tx.dO{constructor(e,t){super(),this.distanceFalloffFactor=e,this.transparency=t,this.transformNormalViewFromGlobal=(0,zr.vt)()}}class nx extends tx.EM{constructor(){super(...arguments),this.transformNormalViewFromGlobal=(0,zr.vt)(),this.slicePlaneLocalOrigin=(0,P.vt)(),this.transformNormalGlobalFromModel=(0,zr.vt)()}}var rx=i(49249);class sx extends it.w{initializeProgram(e){return new rt.B(e.rctx,sx.shader.get().build(this.configuration),hy.JS)}initializePipeline(e){return(0,at.Ey)({blending:(0,at.p3)(st.dn.ONE,st.dn.ONE,st.dn.ZERO,st.dn.ONE,st.Tb.ADD,e.rctx.gl.MAX),depthTest:{func:st.MT.LEQUAL},colorWrite:at.wE})}}sx.shader=new tt.$(rx.E,(()=>i.e(12165).then(i.bind(i,12165))));var ax=i(28014);class ox extends hf.E{constructor(){super(...arguments),this.mode=ax.Z5.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.doublePrecisionRequiresObfuscation=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.spherical=!1}}(0,n._)([(0,ct.W)({count:ax.Z5.COUNT})],ox.prototype,"mode",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"hasSlicePlane",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"silhouette",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"legacy",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"multipassEnabled",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"cullAboveGround",void 0),(0,n._)([(0,ct.W)()],ox.prototype,"spherical",void 0),(0,n._)([(0,ct.W)({constValue:!1})],ox.prototype,"occlusionPass",void 0),(0,n._)([(0,ct.W)({constValue:af.W.Compressed})],ox.prototype,"normalType",void 0);var lx=i(46702);const cx={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},hx={solid:ax.Z5.SOLID,sketch:ax.Z5.SKETCH,uber:ax.Z5.MIXED};class dx{constructor(e,t,i){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new ox,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[lx.x.TRANSPARENT]:{[lx.x.TRANSPARENT]:new oc.A,[lx.x.OPAQUE]:new oc.A},[lx.x.OPAQUE]:{[lx.x.TRANSPARENT]:new oc.A,[lx.x.OPAQUE]:new oc.A}},this._renderablesDirty=!1,this._drawParameters=new nx,this._settings={...cx,...i},this.key=dx.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const n=this._settings.strokesTexture.variants;this.writerSettings={variants:n,reducedPrecision:lc.b.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=hx[this._settings.type],this._configuration.silhouette=!1,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=(0,p.Gz)(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables();const i=this._sortedRenderables[t];i[lx.x.TRANSPARENT].forAll(e),i[lx.x.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.multipassEnabled=!!e.multipassEnabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(sx,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),t,e)}bindSilhouetteEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),t,e)}renderRegularEdges(e,t,i,n,r){this._render(e,t,t.regular.vao,i,n,r)}renderSilhouetteEdges(e,t,i,n,r){this._render(e,t,t.silhouette.vao,i,n,r)}_render(e,t,i,n,r,s){s>0&&(this._bindDraw(e,t,n,r),this._rctx.bindVAO(i),this._rctx.drawArraysInstanced(st.WR.TRIANGLE_FAN,0,4,s))}_bindDraw(e,t,i,n){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{const e=new zb.p(t.transform.position),i=(0,Tt.mg)(ux,(0,Tt.B8)(ux,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=i;const r=n.camera.viewInverseTransposeMatrix;(0,Ge.s)(this._drawParameters.slicePlaneLocalOrigin,r[3],r[7],r[11])}e.bindDraw(this._drawParameters,n,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[lx.x.TRANSPARENT][lx.x.TRANSPARENT].clear(),this._sortedRenderables[lx.x.TRANSPARENT][lx.x.OPAQUE].clear(),this._sortedRenderables[lx.x.OPAQUE][lx.x.TRANSPARENT].clear(),this._sortedRenderables[lx.x.OPAQUE][lx.x.OPAQUE].clear(),this._renderables.forEach((e=>{e.objectTransparency!==lx.x.INVISIBLE&&e.edgeTransparency!==lx.x.INVISIBLE&&this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform?"origin"in t.transform?e.transform.origin.origin.id<t.transform.origin.origin.id?-1:e.transform.origin.origin.id>t.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[lx.x.TRANSPARENT][lx.x.TRANSPARENT].sort(e),this._sortedRenderables[lx.x.TRANSPARENT][lx.x.OPAQUE].sort(e),this._sortedRenderables[lx.x.OPAQUE][lx.x.TRANSPARENT].sort(e),this._sortedRenderables[lx.x.OPAQUE][lx.x.OPAQUE].sort(e)}static getKey(e,t,i){return"edges-t:".concat(e,":").concat(t,":").concat(i)}}const ux=(0,ex.vt)();var px,mx=i(74527);function _x(e,t){if(!e)return null;const i=e.length/2,n=gx*i,r=new Array(i);let s=0;const a=t===px.PRESSURE;for(let o=0;o<e.length;o+=2){const t=(e[o]+e[o+1])/2;r[s++]=a?Math.min(n,1-(1-t)*fx):Math.min(n,t*fx)}return r}!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(px||(px={}));const gx=.1,fx=.5;class vx{constructor(e,t,i,n,r){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=n,this.texture=r}dispose(){this.texture=(0,p.WD)(this.texture)}}const yx={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function bx(e){let t=null;for(const i of e){const e=i.type;if(Tx(i))if(null==t)t=e;else if(t!==e)return"uber"}return null!=t?t:"uber"}function wx(e){let t=lx.x.INVISIBLE;for(const{material:i}of e)if(Cx(i)){if(i.color[3]*i.opacity<1)return lx.x.TRANSPARENT;t=lx.x.OPAQUE}return t}function xx(e){let t=lx.x.INVISIBLE;for(const{material:i}of e)if(Cx(i)){switch(i.objectTransparency){case lx.x.TRANSPARENT:case lx.x.INVISIBLE:return lx.x.TRANSPARENT;case lx.x.OPAQUE:if(i.opacity<1)return lx.x.TRANSPARENT}t=lx.x.OPAQUE}return t}function Cx(e){return e.size*e.color[3]*e.opacity>0}function Tx(e){return e.size*e.color[3]>0}function Ax(e,t,i,n){for(let r=0;r<e.length;r++){const s=e[r].index,a=t[r],o=t[r+1];if(n)for(let e=a;e<o;e++){const t=n[e];i.set(t,s)}else for(let e=a;e<o;e++)i.set(e,s)}}let Mx=class extends T.A{constructor(e){super(e),this._updatingHandles=new Pi.U,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=(0,P.vt)(),this._localOrigins=new Xw(new Bf.g(e.renderSR))}initialize(){this._worker=new mx.U(this.schedule),this._componentColorManager=new _y(this.rctx,3);const e=hy.vJ.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=ci.g.createVertex(this.rctx,st._U.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=(0,p.WD)(this._strokesTexture),this._componentColorManager=(0,p.pR)(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=(0,p.WD)(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",Hx))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,i,n,r,s){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let a;const o=new Px(new Promise((e=>a=e)),e.obb.center,e.obb.radius);this._perObjectData.set(e,o);const l=await this._updatingHandles.addPromise(this._addComponentGeometry(e.transform,o,t,i,n,r,s));return this.setNeedsRender(),a(),l}async addOrUpdateObject3D(e,t,i,n){if(this.destroyed)return void u.A.getLogger(this).warn("Attempt to add an object to a destroyed instance");const r=this._perObjectData.get(e);let s;(null===r||void 0===r?void 0:r.renderables.length)>0&&this._perObjectDataEvictionCache.add(r);const a=e.boundingVolumeWorldSpace.bounds,o=new Px(new Promise((e=>s=e)),(0,vn.g)(a),(0,vn.b)(a));this._perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometries[r];if(s.material.supportsEdges){if(t){if(!(0,Pu.aI)(t,s.transformation))return!1}else t=s.transformation;var n;if(i||null==s.localOrigin){if(null!=(null===(n=i)||void 0===n?void 0:n.localOrigin)&&null!=s.localOrigin&&i.localOrigin.id!==s.localOrigin.id)return!1}else i=s}}return!0}(e))l.push(this._addObjectMergedGeometries(e,o,t,i,n));else for(let c=0;c<e.geometries.length;c++){const r=e.geometries[c];r.material.supportsEdges&&l.push(this._addGeometry(e,o,r,t[0],i,n))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(o),this._discardObjectEntry(r),this.setNeedsRender(),s()}fastUpdateObject3DEdgesTransform(e){if(this.destroyed)return!1;const t=this._perObjectData.get(e);if(!t)return!1;const{geometries:i}=e,{renderables:n}=t;if(0===i.length||0===n.length)return!0;if(n.length>1)return!1;const[r]=n,s=r.transform;if(!(s instanceof Ox))return!1;const[a]=i;if(a.localOrigin!==s.origin.origin)return!1;const o=(0,Mt.vt)(),l=this._computeModelTransformWithLocalOrigin(e,a,o);return r.transform=new Ox(o,l),this.setNeedsRender(),!0}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(null==i)return;const n=t instanceof Array?e=>t[e]:()=>t;i.renderables.forEach((e=>{const t=e.components.meta.length;for(let i=0;i<t;i++){const t=n(i),r=e.components.meta[i],s=r.index;r.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(s,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return null!=t?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}async updateAllComponentMaterials(e,t,i,n){const r=e instanceof $w.B,s=!!i.hasSlicePlane,a=bx(t),o=dx.getKey(a,s,r),l=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=l&&(l.renderables.forEach((e=>{if(o!==e.rendererKey){const t=this._renderers.get(e.rendererKey),i=this._acquireRenderer(a,s,r);t.removeRenderable(e),--t.refCount,e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];n&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=i&&(i.renderables.forEach((e=>{const i=e.components.meta;for(let r=0;r<i.length;r++){var n;e.components.meta[r].verticalOffset=null!==(n=null===t||void 0===t?void 0:t[r])&&void 0!==n?n:0}this._updateComponentBuffer(e.components)})),this.setNeedsRender())}async updateObjectVisibility(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=i&&(i.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}removeObject(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this._perObjectData.get(e);if(!t)throw new Error("no object");return await t.loaded,null==t.loaded?null:t}render(e,t){if(null==this._componentColorManager)return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,n=(0,P.vt)(),r=new zb.p;let s=0,a=0;if(this._renderers.forEach((i=>{if(0===i.refCount)return this._renderers.delete(i.key),void i.dispose();let n=!0,r=!0;i.forEachRenderable((t=>{t.visible&&(s+=t.statistics.averageEdgeLength,a++,n&&t.regular&&(i.updateTechnique(e,!1),n=!1),r&&t.silhouette&&(i.updateTechnique(e,!0),r=!1))}),t)})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===a)return;const o=new ix(40*s/a,t);(0,Ge.s)(n,i[3],i[7],i[11]),r.set(n),(0,Ge.c)(o.transformWorldFromViewTH,r.high),(0,Ge.c)(o.transformWorldFromViewTL,r.low),(0,Tt.z0)(o.transformViewFromCameraRelativeRS,e.camera.viewMatrix),(0,Tt.mg)(Vx,o.transformViewFromCameraRelativeRS),(0,Tt.B8)(o.transformNormalViewFromGlobal,Vx),o.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,o),this._renderSilhouetteEdges(t,e,o)}))}_updateTransparency(e){const t=wx(e.components.meta),i=xx(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){e.getCombinedShaderTransformation(t,i);const n=null!=t.localOrigin?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire((0,Ge.s)(this._tmpModelPosition,i[12],i[13],i[14]));return t.localOrigin=n.origin,function(e,t){const i=-e[0],n=-e[1],r=-e[2],s=t[3],a=t[7],o=t[11],l=t[15];t[0]+=s*i,t[1]+=s*n,t[2]+=s*r,t[4]+=a*i,t[5]+=a*n,t[6]+=a*r,t[8]+=o*i,t[9]+=o*n,t[10]+=o*r,t[12]+=l*i,t[13]+=l*n,t[14]+=l*r}(n.origin.vec3,i),n}_updateComponentBuffer(e){const{meta:t,buffer:i}=e,n=new Uint8Array(4);for(let r=0;r<t.length;r++){const e=t[r].material,s=t[r].index,a=(0,_e.qE)(Math.round(8*e.size),0,255),o=(0,_e.qE)(e.extensionLength,-128,127)+128,l="solid"===e.type?Jw.g.SOLID:Jw.g.SKETCH,c=255*e.opacity,h=e.color,d=255*h[0],u=255*h[1],p=255*h[2],m=255*h[3];i.textureBuffer.setData(s,0,d,u,p,m),i.textureBuffer.setData(s,1,a,o,l,c),(0,cy.B)(t[r].verticalOffset,n),i.textureBuffer.setData(s,2,n[0],n[1],n[2],n[3])}}_createComponentBuffers(e){if(null==this._componentColorManager)return null;const t=new Array,i=this._componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const n=e[r],s=i.acquireIndex();t.push({index:s,verticalOffset:0,material:n})}const n=new Rx(i,t);return this._updateComponentBuffer(n),n}_extractEdges(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:r.length;return this._worker.process({data:t,indices:r,indicesLength:s,writerSettings:e,skipDeduplicate:i},this._workerAbort.signal,n)}_createRenderable(e,t,i,n,r){var s,a;const o=t=>null!=this._verticesBufferObject?new Ex(new oi.Z(this.rctx,hy.JS,{vertices:hy.wO,instances:t===ax.s0.REGULAR?Kw.TM.glLayout:Kw.TK.glLayout},{vertices:this._verticesBufferObject,instances:ci.g.createVertex(this.rctx,st._U.STATIC_DRAW,t===ax.s0.REGULAR?e.regular.instancesData.buffer:e.silhouette.instancesData.buffer)}),t===ax.s0.REGULAR?e.regular.lodInfo:e.silhouette.lodInfo):null,l=e.regular.lodInfo.lengths.length>0?o(ax.s0.REGULAR):null,c=e.silhouette.lodInfo.lengths.length>0?o(ax.s0.SILHOUETTE):null,h=(null!==(s=null===l||void 0===l?void 0:l.vao.usedMemory)&&void 0!==s?s:0)+(null!==(a=null===c||void 0===c?void 0:c.vao.usedMemory)&&void 0!==a?a:0);return new Dx(l,c,{gpuMemoryUsage:h,externalMemoryUsage:r,averageEdgeLength:e.averageEdgeLength},i,wx(t.meta),xx(t.meta),t,n)}async _addGeometry(e,t,i,n,r,s){if(i.edgeIndicesLength<=0)return;const a=i.attributes.get(li.r.POSITION),o=(0,Mt.vt)(),l=this._computeModelTransformWithLocalOrigin(e,i,o),c=new Fx(a,o,l);return this._addPositionData(t,c,i.edgeIndicesLength,n,r,s)}async _addPositionData(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(null==e.loaded)return;const a=this._createComponentBuffers([n]);if(null==a)return;const o=this._acquireRenderer(n.type,!!r.hasSlicePlane,!0),{modelTransform:l,origin:c}=t,h=t.position.indices,d=t.position,u=d.data.length/d.size,p=hy.I$.createBuffer(u);for(let g=0;g<u;g++)p.position.set(g,0,d.data[g*d.size]),p.position.set(g,1,d.data[g*d.size+1]),p.position.set(g,2,d.data[g*d.size+2]);Ax(a.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,p,!1,s,h,i));if(null==e.loaded)return;const _=this._createRenderable(m,a,new Ox(l,c),o.key,!1);e.renderables.push(_),o.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,i,n,r,s,a){if(null==t.loaded)return 0;const o=this._createComponentBuffers(s);if(null==o)return 0;const l=bx(s),c=this._acquireRenderer(l,a.hasSlicePlane||!1,!1),h=hy.I$.createBuffer(i.length/3);(0,ev.c)(h.position.typedBuffer,i,h.position.typedBufferStride,3),Ax(o.meta,r,h.componentIndex,n);const d=c.writerSettings,u=await this._updatingHandles.addPromise(this._extractEdges(d,h,!0,!1,n));if(null==t.loaded)return 0;const p=this._createRenderable(u,o,e,c.key,!0);return t.renderables.push(p),c.addRenderable(p),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,i,n,r){const s=new Map;let a=0,o=null,l=0;const c=e.geometries.filter((e=>{if(e.edgeIndicesLength<=0||!e.material.supportsEdges)return!1;!o&&e.localOrigin&&(o=e);const t=e.attributes.get(li.r.POSITION);return l+=t.data.length/t.size,a+=e.edgeIndicesLength,!0}));if(0===c.length)return;const h=l>=65536?Uint32Array:Uint16Array,d=a?new h(a):null,u=[];let p=0;c.forEach((e=>{const t=e.attributes.get(li.r.POSITION),i=t.indices;let n=s.get(t.data);if(null==n){n=u.length/3;for(let e=0;e<t.data.length;e+=t.size)u.push(t.data[e]),u.push(t.data[e+1]),u.push(t.data[e+2]);s.set(t.data,n)}for(let r=0;r<e.edgeIndicesLength;r++)d[p++]=n+i[r]}));const m=o||e.geometries[0],_=(0,Mt.vt)(),g=this._computeModelTransformWithLocalOrigin(e,m,_);for(let v=0;v<e.geometries.length;v++)e.geometries[v].localOrigin=g.origin;const f=new Fx(new rf.n(u,d,3),_,g);await this._updatingHandles.addPromise(this._addPositionData(t,f,d.length,i[0],n,r))}_acquireRenderer(e,t,i){const n=dx.getKey(e,t,i);let r=this._renderers.get(n);return null==this._strokesTexture&&(this._strokesTexture=function(e){const t=yx.resolution,i=t/2,n=new Uint8Array(4*t*t),r=4*t*i,s=yx.amplitude,a=2*s,o=4*t,l=Math.log2(t)+1,c=yx.strokes.length;let h=(l-1)*c*o;for(const{distance:u,pressure:p}of yx.strokes){let e=u,t=p,i=h;for(let s=0;s<l;s++){0!==s&&(e=_x(e,px.DISTANCE),t=_x(t,px.PRESSURE));for(let s=0;s<yx.resolution;s++){const o=.5+(e?e[s%e.length]/a:0),l=t?t[s%t.length]:1;(0,Dy.U)(o,n,i),(0,Dy.U)(l,n,i+r),i+=4}i-=o*(c+1)}h+=o}const d=new hi.g(e,new Ht.R(t),n);return new vx(t,a,s,c,d)}(this.rctx)),r||(r=new dx(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:i,spherical:this.viewingMode===te.RT.Global}),this._renderers.set(n,r)),++r.refCount,r}_removeRenderable(e){Sx(e.regular),Sx(e.silhouette);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,n=(0,P.vt)(),r=e=>{(0,Ge.z)(n,e.center,t);const r=(0,Ge.k)(n,i),s=e.radius,a=r<-s?1/0:r<s?0:r-s;e.renderables.forEach((e=>e.distanceToCamera=a))};this._perObjectData.forEach(r),this._perObjectDataEvictionCache.forEach(r)}_renderRegularEdges(e,t,i){const n=e.bindRegularEdges(i,t),r=i.transparency,s=t.camera.perScreenPixelRatio;e.forEachRenderable((r=>{if(!Ix(r)||!r.visible)return;const a=Nx(r.regular.lod.lengths,r.distanceToCamera,s);e.renderRegularEdges(n,r,i,t,a)}),r)}_renderSilhouetteEdges(e,t,i){const n=e.bindSilhouetteEdges(i,t),r=i.transparency,s=t.camera.perScreenPixelRatio;e.forEachRenderable((r=>{if(!Lx(r)||!r.visible)return;const a=Nx(r.silhouette.lod.lengths,r.distanceToCamera,s);e.renderSilhouetteEdges(n,r,i,t,a)}),r)}get test(){return{hasRenderedPrimitives:e=>{let t=!1;const i=e.perScreenPixelRatio,n=(e,n)=>e.forEachRenderable((e=>{e.visible&&!t&&(Ix(e)&&(t=Nx(e.regular.lod.lengths,e.distanceToCamera,i)>0),!t&&Lx(e)&&(t=Nx(e.silhouette.lod.lengths,e.distanceToCamera,i)>0))}),n);return this._renderers.forEach((e=>{t||(n(e,lx.x.OPAQUE),n(e,lx.x.TRANSPARENT))})),t},getObjectData:e=>this._perObjectData.get(e)}}};function Sx(e){null!=e&&(e.vao.vertexBuffers.instances.dispose(),e.vao.disposeVAOOnly(),e.vao=null)}(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"rctx",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"renderSR",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"viewingMode",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"techniqueRepository",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"setNeedsRender",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],Mx.prototype,"schedule",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Mx.prototype,"_updatingHandles",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],Mx.prototype,"updating",null),Mx=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Mx);class Px{constructor(e,t,i){this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)})),this.center=(0,P.o8)(t)}}class Rx{constructor(e,t){this.buffer=e,this.meta=t}}class Ex{constructor(e,t){this.vao=e,this.lod=t}}class Ox{constructor(e,t){this.modelMatrix=e,this.origin=t}}class Dx{constructor(e,t,i,n,r,s,a,o){this.regular=e,this.silhouette=t,this.statistics=i,this.transform=n,this.edgeTransparency=r,this.objectTransparency=s,this.components=a,this.rendererKey=o,this.distanceToCamera=0,this.visible=!0}}function Ix(e){return null!=e.regular}function Lx(e){return null!=e.silhouette}function Nx(e,t,i){const n=t*i,r=(0,Pu.FQ)(e,n,!0);return-1===r?n<e[0]?e.length:0:e.length-r}class Fx{constructor(e,t,i){this.position=e,this.modelTransform=t,this.origin=i}}const Vx=(0,zr.vt)(),Hx=()=>Promise.reject();var Ux,zx=i(52583),qx=i(32634),Gx=i(28163);class Bx{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){Gx.z0||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.LINEAR_DEPTH="linear depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.OPAQUE="opaque",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.ENVIRONMENT="environment",e.LASER_LINES="laser lines",e.OCCLUDED="occluded",e.ANTIALIASING="antialiasing",e.HIGHLIGHTS="highlights",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(Ux||(Ux={}));const kx="Total";class Wx{constructor(e){this._rctx=e,this._startTimeStampCPU=(0,Si.l5)(0),this._lastTimeStampCPU=(0,Si.l5)(0),this._totalCPUTime=new qx.A(kx),this._cpuTimeSamplers=new Map(Object.values(Ux).map((e=>[e,new qx.A(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new qx.A("GPU"),this._gpuTimeSamplers=new Map(Object.values(Ux).map((e=>[e,new qx.A(e)]))),this._totalTime=(0,Si.l5)(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return(0,Si.l5)(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...Object.values(Ux),kx];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new Bx(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=(0,p.WD)(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,Si.l5)(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}advance(e){const t=(0,Si.l5)(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(Ux.FINISH);this._gpuTimeSamplers.get(Ux.FINISH).record(e),this._rctx.gl.flush()}const e=(0,Si.l5)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,Si.l5)(this._totalTime+e),this._totalCPUTime.record(e),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}class Zx{constructor(e,t,i,n,r,s,a,o){this._stage=e,this._techniqueRepository=n,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=a,this._requestRender=o,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=(0,Ye.fA)(0,0,0,1),this._sliceHelper=new Qw,this._state=(0,vu.v)(So.M.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=pf.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new ww,this._reprojectionMatrixVersion=(0,vu.v)(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseNormals=e=>{var t;(null===(t=e.find((e=>{let{name:t}=e;return"normals"===t})))||void 0===t?void 0:t.release())&&this._pluginInput.delete("normals")},this._debugLinearDepth=!1,this.fboCache=new Cb(r),this._renderStateFeatures=(0,vu.v)((0,Mo.u)(!(0,d.A)("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new Ow(this.fboCache,this._compositingHelper),this.performanceInfo=new Wx(this._rctx),this._shadowMap=new zw.p(this.fboCache,e.viewingMode),this._highlight=new nw({view:e.view}),this._shadowHighlight=new cw({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new Bw(this.fboCache,n,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{const n=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,t,i,!0,n),this._renderShadowCascades(tf.V.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.contentCamera)}),o),this._ssao=new bw.n({view:this._stage.view}),this._renderContext=new Iw.AZ(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new jb(this._renderContext),this._plugins=new Qb({renderContext:this._renderContext,techniqueRepository:n,textureRepository:i,materialRepository:t,requestRender:o,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new qb,this._plugins.add(this.renderPassManager),this._smaa=new vw({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new Xb({opacity:1,alphaMode:xy.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[(0,g.watch)((()=>this._stage.view.state.camera),(()=>o()),g.syncAndInitial),(0,g.watch)((()=>lc.b.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(lx.x.TRANSPARENT):()=>{},o()}),g.initial),(0,g.watch)((()=>{var e;return null===(e=this._stage.view.environment.background)||void 0===e?void 0:e.color}),(e=>{const t=e?(0,Ze.QP)(e):Ye.uY;(0,Xe.s)(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),o()}),g.syncAndInitial)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=(0,p.xt)(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=(0,p.pR)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),Rw.j.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!(0,d.A)("disable-feature:high-quality-idle");this._renderStateFeatures.value=(0,Mo.u)(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state.value;return null!==(t=this._renderStateFeatures.value.get(i,e))&&void 0!==t&&t}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((n=>n.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Mo.n.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(Mo.n.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(Ki.N.OPAQUE_MATERIAL,tf.V.Highlight)||this._plugins.produces(Ki.N.TRANSPARENT_MATERIAL,tf.V.Highlight)||this._plugins.produces(Ki.N.DRAPED_MATERIAL,tf.V.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===Wp.ID.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Mo.n.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=(0,p.Gz)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=(0,p.Gz)(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=(0,p.Gz)(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=(0,p.Gz)(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=(0,p.Gz)(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new Mx({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:eC(e)}),this._handles.push((0,g.watch)((()=>{var e;return null===(e=this._edgeView)||void 0===e?void 0:e.updating}),(()=>this._requestRender()),g.sync)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&(0,At.aI)(this._bindParameters.ssr.reprojectionMatrix,Mt.zK)}set _reprojectionMatrix(e){(0,Pu.yo)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!(null===(e=this._shadowMap)||void 0===e||!e.enabled)}setParameters(e){var t;const{_shadowMap:i,_bindParameters:n}=this;if(void 0!==(null===(t=e.qualitySettings)||void 0===t?void 0:t.reflections)&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const t="virtual"!==e.environment.lighting.type;n.enableFillLights!==t&&(n.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:n,updates:r}=e;if(0===i.length&&0===n.length&&0===r.length)return;const s=(0,Ew.$)(e);let a=!1;s.forEach(((i,n)=>{if(t.done)return;let r=this._plugins.getMaterialRenderer(n);if(null==r&&i.adds.length>0){const e=new zx.y({material:n});e.initializeRenderContext(this._plugins._context),r=e,this._plugins.add(r)}r&&(r.modify(i),0===r.numGeometries&&(a=!0)),i.removes.forEach((t=>e.removes.removeUnordered(t))),i.adds.forEach((t=>e.adds.removeUnordered(t))),i.updates.forEach((t=>e.updates.removeUnordered(t))),t.madeProgress()})),a&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(Ki.N.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(Ki.N.HUD_MATERIAL)||this._plugins.produces(Ki.N.LABEL_MATERIAL),e.water=this._plugins.produces(Ki.N.DRAPED_WATER,tf.V.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?(0,p.xt)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ew.f.Default,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Wp.ID.ON;this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const s=this._offscreen,{camera:a,contentCamera:o,mode:l,alignPixelEnabled:c}=e;this._state.value=l,this._bindParameters.overlay=this.renderOverlay(t),this.performanceInfo.advance(Ux.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=Vb.y.NONE,this._bindParameters.alignPixelEnabled=c,this._bindParameters.decorations=r,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const h=(0,N.a)(this._sliceHelper.plane);r===Wp.ID.OFF&&(this._sliceHelper.plane=null),a.setGLViewport(this._rctx);const d=s.initializeFrame(a,this._backgroundColor,n);this.hasReflections?this._bindParameters.ssr.lastFrameColor=d:null===d||void 0===d||d.release(),this._ensureBindParametersCamera(a,o),this._plugins.prepareRender(),this.performanceInfo.advance(Ux.PREPARE);const u=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,u),this.performanceInfo.advance(Ux.SHADOW_MAP),this._ensureBindParametersCamera(a,o);const m=this._plugins.produces(Ki.N.OPAQUE_TERRAIN)&&(this._terrainTransparency===pf.Semitransparent||this._terrainTransparency===pf.TransparentWithDraped),_=this._highQualityTransparency&&m,g=this._plugins.produces(Ki.N.TRANSPARENT_MATERIAL,tf.V.Color);this._prepareShaders(_,g),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(Ux.NORMALS),this._renderSSAO(),this.performanceInfo.advance(Ux.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(Ux.LINEAR_DEPTH),this._renderShadowAccumulation(u,a,o),this.performanceInfo.advance(Ux.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(t),this._renderContext.output=tf.V.Color,s.bindFbo(),this._bindParameters.mainColor=s.colorTexture,this._bindParameters.mainDepth=s.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"opaque-color"),this._plugins.render(Ki.N.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(Ux.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(_),this._setMultipassTerrain(_),this._renderEdges(lx.x.OPAQUE),this.performanceInfo.advance(Ux.OPAQUE_EDGES),s.bindFbo(),this._plugins.render(Ki.N.VOXEL),this.performanceInfo.advance(Ux.VOXEL),this._renderHiddenTransparentEdges(),g&&(this._oitEnabled?this._renderOITPass(jx.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"transparent-color"),this.performanceInfo.advance(Ux.TRANSPARENT);const f=this._renderGeometryLinearDepth(_);this._renderHUDVisibility(f),_||this._plugins.render(Ki.N.LINE_CALLOUTS),this.performanceInfo.advance(Ux.HUD_VISIBILITY);const v=n===Ew.f.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(Ux.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(lx.x.TRANSPARENT,f),null!==f&&void 0!==f&&f.release(),this.performanceInfo.advance(Ux.TRANSPARENT_EDGES);const y=m?this._renderTransparentTerrain():null;y&&this._bindParameters.hudVisibility&&(_?this._renderLineCallouts(Wb.D.Occluded):s.compositeToHUDVisibility(this._bindParameters,y.getTexture()),this._renderHUD(Wb.D.Occluded,s.color),this.performanceInfo.advance(Ux.HUD_OCCLUDED)),this.performanceInfo.advance(Ux.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),y&&(s.compositeToFramebuffer(this._bindParameters,y.getTexture(),xy.PremultipliedAlpha,1),y.release(),_&&(this._renderEdges(lx.x.OPAQUE),this.performanceInfo.advance(Ux.OPAQUE_EDGES),g&&(this._oitEnabled?this._renderOITPass(jx.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(Ux.TRANSPARENT),this._renderEdges(lx.x.TRANSPARENT),this.performanceInfo.advance(Ux.TRANSPARENT_EDGES))),this._bindParameters.ssao=(0,p.Gz)(this._bindParameters.ssao),_&&this._renderLineCallouts(Wb.D.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),s.bindFbo(),this._plugins.render(Ki.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(Ki.N.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(Ux.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(Ux.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(Ux.OCCLUDED);let b=this._renderHighlightPrepass();b&&this._renderShadowHighlights(b,this._bindParameters);const w=this._magnifierEnabled&&n===Ew.f.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,x=n!==Ew.f.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,C=null!==(i=this._renderComposite(null!==w&&void 0!==w?w:x,b))&&void 0!==i?i:x;return this.performanceInfo.advance(Ux.ANTIALIASING),this._renderHUD(Wb.D.NotOccluded,C),this.performanceInfo.advance(Ux.HUD),b&&(this._renderHighlights(C,b,this._bindParameters),b=(0,p.Gz)(b)),this.performanceInfo.advance(Ux.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),C!==x&&(this._rctx.bindFramebuffer(null===x||void 0===x?void 0:x.fbo),this._compositingHelper.composite(this._bindParameters,null===w||void 0===w?void 0:w.getTexture(),xy.None)),n===Ew.f.Default&&null!==w&&void 0!==w&&w.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=h,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),n!==Ew.f.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:x,oid:v}}_prepareShaders(e,t){this._renderContext.output=tf.V.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(Ki.N.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(Ki.N.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(Ki.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(Ki.N.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(Ki.N.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!(0,d.A)("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(dt.z.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(tf.V.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=Wb.D.NotOccluded,this._plugins.render(Ki.N.HUD_MATERIAL),this._renderContext.output=e,t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===Wp.C7.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0,n=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),r=Math.max(e,n);this._animationTimestep.frame(r,i)}}readDepthPixels(e,t,i){var n;const r=null===(n=this._bindParameters.linearDepth)||void 0===n?void 0:n.fbo;if(null!==r&&void 0!==r&&r.colorTexture)return void r.readPixels(t[0],t[1],t[2],t[3],st.Ab.RGBA,st.ld.UNSIGNED_BYTE,i);const s=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(dt.z.DEPTH16_BUFFER);this._rctx.bindFramebuffer(s.fbo),this._ensureBindParametersCamera(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=st.hn.COLOR_BUFFER_BIT|st.hn.DEPTH_BUFFER_BIT|st.hn.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderAllGeometry(tf.V.LinearDepth),s.fbo.readPixels(t[0],t[1],t[2],t[3],st.Ab.RGBA,st.ld.UNSIGNED_BYTE,i),s.release()}readHUDVisibility(e,t,i,n,r){var s;null===(s=this._bindParameters.hudVisibility)||void 0===s||s.fbo.readPixels(e,t,i,n,st.Ab.RGBA,st.ld.UNSIGNED_BYTE,r)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,t){const i=this._edgeView;if(null!==i&&void 0!==i&&i.shouldRender()){const{width:n,height:r,depth:s}=this._offscreen,a=this.fboCache.acquire(n,r,"edges"),o=()=>i.render(this._bindParameters,e);this._offscreen.renderToTargets(o,a,null!==t&&void 0!==t?t:s,Xx),this._offscreen.compositeToFramebuffer(this._bindParameters,a.getTexture(),xy.Alpha,1),a.release()}}_renderShadowMap(e,t,i){const n=this._shadowMap;n.enabled&&(n.start(e,t,i,this.isFeatureEnabled(Mo.n.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,t),this._needsShadowHighlight?(this._renderShadowCascades(tf.V.ShadowHighlight,this._shadowMap),n.moveSnapshot(zw.z.Highlight),this._renderShadowCascades(tf.V.ShadowExcludeHighlight,this._shadowMap),n.copySnapshot(zw.z.ExcludeHighlight),this._renderShadowCascades(tf.V.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(tf.V.Shadow),n.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap;for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(tf.V.LinearDepth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",(()=>this._renderAllGeometry(tf.V.LinearDepth)),[0,0,0,0],dt.N.RGBA,dt.z.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=(0,p.Gz)(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=tf.V.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=(0,p.Gz)(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=(0,p.Gz)(this._bindParameters.multipassGeometry.linearDepth));const t=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",(()=>this._renderOpaqueGeometryAndTransparentMaterial(tf.V.LinearDepth)),[1,1,1,1]),this._renderContext.output=t;const i=this._bindParameters.multipassGeometry.linearDepth.getAttachment(st.nI);return null!==i&&void 0!==i&&i.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),i}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return Vv;const t=Uy(e,this._plugins.plugins,this._stage.layers);return Nv(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderNormals(){const e=this._plugins.produces(Ki.N.SSAO),t=this._nodes.require("normals","composite-color")+this._nodes.require("normals","opaque-color")+this._nodes.require("normals","transparent-color");let i=(e?1:0)+t+(e||t>0?this._nodes.optional("normals","composite-color")+this._nodes.optional("normals","opaque-color")+this._nodes.optional("normals","transparent-color"):0);if(0===i)return;const n=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(tf.V.Normal)),[0,0,0,0],dt.N.RGBA,dt.z.DEPTH_STENCIL_TEXTURE);for(;--i>0;)n.retain();return n}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(Ki.N.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(Ki.N.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(Ki.N.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(Ki.N.TRANSPARENT_MATERIAL),this._plugins.prepare(Ki.N.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(Ki.N.INTEGRATED_MESH),this._plugins.render(Ki.N.OPAQUE_TERRAIN),this._plugins.render(Ki.N.OPAQUE_MATERIAL),this._plugins.render(Ki.N.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(Ki.N.INTEGRATED_MESH),this._plugins.prepare(Ki.N.OPAQUE_TERRAIN),this._plugins.prepare(Ki.N.OPAQUE_MATERIAL),this._plugins.prepare(Ki.N.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(Ki.N.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(Ki.N.INTEGRATED_MESH),this._plugins.render(Ki.N.OPAQUE_TERRAIN),this._plugins.render(Ki.N.OPAQUE_MATERIAL),this._plugins.render(Ki.N.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(Ki.N.TRANSPARENT_MATERIAL),this._plugins.render(Ki.N.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(Ki.N.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(Ki.N.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==tf.V.Color)return void e();const{width:t,height:i,depth:n}=this._offscreen,r=this.fboCache.acquire(t,i,"transparent terrain");return this._offscreen.renderToTargets(e,r,n,[0,0,0,0]),r}_renderHUDVisibility(e){this._plugins.produces(Ki.N.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(Ki.N.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=(0,p.Gz)(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Wb.D.Occluded){const e=()=>{this._plugins.render(Ki.N.LINE_CALLOUTS)},{width:t,height:i,color:n}=this._offscreen,r=this.fboCache.acquireDepth(dt.z.DEPTH16_BUFFER,t,i,"line callouts");this._offscreen.renderToTargets(e,n,r,void 0,!0,!0),r.release()}else this._plugins.render(Ki.N.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(Ki.N.LASERLINES),this._plugins.produces(Ki.N.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:t,height:i,depth:n}=e,r=this.fboCache.acquire(t,i,"laser lines"),s=()=>this._plugins.render(Ki.N.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(s,r,n,Xx),e.compositeToFramebuffer(this._bindParameters,r.getTexture(),xy.PremultipliedAlpha,1),r.release()}}_renderHUD(e,t){if(this._pluginsHas.hudElements)if(this._oitEnabled){const i=this._renderOITPass(jx.HUD,e);this._rctx.bindFramebuffer(null===t||void 0===t?void 0:t.fbo),this._compositingHelper.composite(this._bindParameters,i.getTexture(),xy.PremultipliedAlpha),i.release()}else if(e===Wb.D.Occluded){this._renderContext.output=tf.V.Color;const t=()=>this._renderHUDElements(e),{width:i,height:n,color:r}=this._offscreen,s=this.fboCache.acquireDepth(dt.z.DEPTH16_BUFFER,i,n,"hud");this._offscreen.renderToTargets(t,r,s,void 0,!0,!0),s.release()}else this._renderContext.output=tf.V.Color,this._rctx.bindFramebuffer(null),null!==t&&void 0!==t&&t.acquireDepth(dt.z.DEPTH16_BUFFER),this._rctx.bindFramebuffer(null===t||void 0===t?void 0:t.fbo),this._renderHUDElements(e),null===t||void 0===t||t.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(Ki.N.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(Ki.N.HUD_MATERIAL),this._plugins.prepare(Ki.N.LABEL_MATERIAL),this._plugins.render(Ki.N.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(Ki.N.HUD_MATERIAL),this._plugins.render(Ki.N.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(Ki.N.SHADOW_HIGHLIGHT)&&this._plugins.produces(Ki.N.OPAQUE_MATERIAL,tf.V.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=this._offscreen.renderToCachedFBO(null,"highlights",(()=>{this._renderAllGeometry(tf.V.Highlight),this._rctx.clearSafe(st.hn.DEPTH_BUFFER_BIT),this._renderHUDElements(Wb.D.Both)}),[0,0,0,0],dt.N.RGBA4,dt.z.DEPTH_STENCIL_TEXTURE);return e.detachDepth(),e}_renderShadowHighlights(e,t){this.hasHighlights&&t.decorations!==Wp.ID.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor((t=>(this._pluginInput.set("highlights",e),this._plugins.render(Ki.N.SHADOW_HIGHLIGHT,this._pluginInput,t),t)),"transparent-color")}_renderHighlights(e,t,i){this.hasHighlights&&i.decorations!==Wp.ID.OFF&&this._plugins.produces(Ki.N.HIGHLIGHT)&&(this._pluginInput.set("highlights",t),this._plugins.render(Ki.N.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,i){var n;this._needsShadowCast&&(null===(n=this._bindParameters.linearDepth)||void 0===n?void 0:n.getTexture())&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,t,i)}_prepareTransparencySlots(){this._renderContext.output=tf.V.Alpha,this._bindParameters.transparencyPassType=Vb.y.Alpha,this._plugins.prepare(Ki.N.TRANSPARENT_MATERIAL),this._renderContext.output=tf.V.Color,this._bindParameters.transparencyPassType=Vb.y.Color,this._plugins.prepare(Ki.N.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=Vb.y.FrontFace,this._plugins.prepare(Ki.N.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=Vb.y.NONE}_renderOITPass(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Wb.D.Both;const i=e===jx.HUD,n=i?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,r=i?()=>this._renderHUDElements(t):()=>this._renderTransparentMaterial(),s=this._renderContext.output;this._renderContext.output=tf.V.Alpha,this._bindParameters.transparencyPassType=Vb.y.Alpha;const a=this._offscreen.renderOITPass(r,Vb.y.Alpha,i);this._renderContext.output=tf.V.Color,this._bindParameters.transparencyPassType=Vb.y.Color;const o=this._offscreen.renderOITPass(r,Vb.y.Color,i);this._bindParameters.transparencyPassType=Vb.y.FrontFace;const l=this._offscreen.renderOITPass(r,Vb.y.FrontFace,i);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,o,a,l,n),null!==n&&void 0!==n&&n.detachDepth(),l.release(),o.release(),a.release(),this._bindParameters.transparencyPassType=Vb.y.NONE,this._renderContext.output=s,n}_renderOccluded(){let e=0;Yx.clear(),this._plugins.plugins.forAll((t=>{t.materialReference&&t.queryRenderOccludedState(jp.m$.OccludeAndTransparentStencil)&&(e|=jp.m$.OccludeAndTransparentStencil,Yx.push(t))}));const t=this._offscreen,i=(i,n,r,s,a)=>{if(0==(e&n))return;const{width:o,height:l,depth:c}=t,h=this.fboCache.acquire(o,l,"tmp color");t.renderToTargets(r,h,c,[0,0,0,0],s,a),t.compositeToFramebuffer(this._bindParameters,h.getTexture(),xy.PremultipliedAlpha,i),h.release()},n=(e,t)=>{this._bindParameters.slot=e,t.forAll((e=>{if((0,$i.zo)(e)){const t=e.prepareTechnique(this._renderContext);t&&e.renderNode(this._renderContext,t)}}))};0!==Yx.length&&(n(Ki.N.OCCLUDER_MATERIAL,Yx),i(.5,jp.m$.OccludeAndTransparentStencil,(()=>n(Ki.N.TRANSPARENT_OCCLUDER_MATERIAL,Yx)),!1,!1)),Yx.clear(),this._plugins.plugins.forAll((t=>{if(!t.materialReference)return;const i=t.queryRenderOccludedState(jp.m$.OccludeAndTransparent),n=t.queryRenderOccludedState(jp.m$.Transparent),r=t.queryRenderOccludedState(jp.m$.Opaque);(i||n||r)&&(e|=i?jp.m$.OccludeAndTransparent:n?jp.m$.Transparent:jp.m$.Opaque,Yx.push(t))}));const r=this._plugins.renderOccludedFlags;if(e|=r,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,r>jp.m$.Occlude&&this._plugins.render(Ki.N.OCCLUDED_TERRAIN),n(Ki.N.OPAQUE_MATERIAL,Yx),n(Ki.N.TRANSPARENT_MATERIAL,Yx),n(Ki.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Yx),this._renderContext.renderOccludedMask=Iw.Vr};this._renderContext.output=tf.V.Color,i(.5,jp.m$.OccludeAndTransparent,(()=>s(jp.m$.OccludeAndTransparent)),!0,Wp.dd.OutlineVisualElementMask),i(.5,jp.m$.Transparent,(()=>s(jp.m$.Transparent)),!0,Wp.dd.OutlineVisualElementMask),i(1,jp.m$.Opaque,(()=>s(jp.m$.Opaque)),!0,Wp.dd.OutlineVisualElementMask),Yx.clear()}_invokeRenderNodes(e){return this._nodes.render(e,this._pluginInput,this._releaseNormals)}_renderComposite(e,t){this._offscreen.updateColor((e=>(this._pluginInput.set("highlights",t),e=this._nodes.render(e,this._pluginInput,this._releaseNormals),this._pluginInput.set(e.name,e),this._pluginInput.delete("highlights"),e)),"composite-color");const i=this._plugins.produces(Ki.N.ANTIALIASING);return this._plugins.render(i?Ki.N.ANTIALIASING:Ki.N.BLIT,this._pluginInput,e)}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Mt.zK:((0,At.B8)(Kx,this._bindParameters.camera.viewMatrix),(0,At.B8)($x,this._bindParameters.camera.projectionMatrix),(0,At.lw)(Jx,Kx,$x),(0,At.lw)(Jx,this._renderContext.lastFrameCamera.viewMatrix,Jx),(0,At.lw)(Jx,this._renderContext.lastFrameCamera.projectionMatrix,Jx),this._reprojectionMatrix=Jx);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Mt.zK,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){var e,t;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:null!==(e=null===(t=this.edgeView)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=(0,Mo.u)(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:e=>{var t,i;switch(e){case Qx.Color:return this._offscreen.colorTexture;case Qx.LinearDepth:return null===(t=this._bindParameters.linearDepth)||void 0===t?void 0:t.getTexture();case Qx.ShadowMap:return this._shadowMap.depthTexture;case Qx.HudVisibility:return null===(i=this._bindParameters.hudVisibility)||void 0===i?void 0:i.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var jx,Qx;(0,n._)([(0,b.MZ)({readOnly:!0})],Zx.prototype,"fullResolutionAtmosphere",null),(0,n._)([(0,b.MZ)()],Zx.prototype,"_smaa",void 0),(0,n._)([(0,b.MZ)()],Zx.prototype,"_blit",void 0),(0,n._)([(0,b.MZ)()],Zx.prototype,"_edgeView",void 0),(0,n._)([(0,b.MZ)()],Zx.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(jx||(jx={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility"}(Qx||(Qx={}));const Xx=[0,0,0,0],Yx=new oc.A,$x=(0,Mt.vt)(),Kx=(0,Mt.vt)(),Jx=(0,Mt.vt)();function eC(e){return t=>e.immediate.schedule(t)}class tC{constructor(e){this._rctx=e,this._vao=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ut.lK,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:nt.D;const n=new Float32Array([-1,-1,3,-1,-1,3]);return new oi.Z(e,i,{geometry:t},{geometry:ci.g.createVertex(e,st._U.STATIC_DRAW,n)})}(e)}destroy(){this._vao=(0,p.WD)(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(st.WR.TRIANGLES,0,3))}get test(){var e,t,i;return{cachedWebGLObjects:iC(null===(e=this._vao)||void 0===e?void 0:e.glName)+iC(null===(t=this._vao)||void 0===t||null===(t=t.indexBuffer)||void 0===t?void 0:t.glName)+iC(null===(i=this._vao)||void 0===i?void 0:i.vertexBuffers.geometry)}}}function iC(e){return null!=e?1:0}var nC=i(343),rC=i(66105);class sC extends rC.e{constructor(e,t,i){super(e,t),this.gl=e,this.newCache=i,this._appleAmdDriverHelper=null,this._refCount=1,this.screen=new tC(this)}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),null!==(e=this._appleAmdDriverHelper)&&void 0!==e&&e.dispose(),this.screen.destroy()}bindTechnique(e,t,i,n,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!r)),e.program.bindPass(i,t),n&&e.program.bindDraw(n,t,i),e.program}runAppleAmdDriverHelper(){var e;this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(null!==(e=this._appleAmdDriverHelper)&&void 0!==e||(this._appleAmdDriverHelper=new nC.H(this)),this._appleAmdDriverHelper.run())}get test(){var e,t;return{cachedWebGLObjects:this.programCache.test.cachedWebGLProgramObjects+this.screen.test.cachedWebGLObjects+(null!==(e=null===(t=this._appleAmdDriverHelper)||void 0===t?void 0:t.test.cachedWebGLObjects)&&void 0!==e?e:0)}}}function aC(e){return!!e.frameUpdate}var oC=i(40325),lC=i(86967);let cC=class extends T.A{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new B.A,this._frameTask=e.view.resourceController.scheduler.registerTask(qt.W6.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Gf.X.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return null==this._textureTechnique&&(this._textureTechnique=this._techniqueRepository.acquire(oC.e,new lC.M)),this._textureTechnique}acquire(e){var t;const i=this._textures.get(e);return i?(i.ref(),null!==(t=i.loadingPromise)&&void 0!==t?t:i):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",Wp.C7.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(null==t)return(0,fi.vA)(void 0!==t),null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),n=new hC(e,(()=>{this._frameTask.schedule((()=>{n.isUnreferenced&&t.unload()}))}));return this._textures.set(e,n),n.ref(),t.glTexture?(this._updateGLTexture(n,t.glTexture),aC(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),n):(this._loadingCount++,n.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._rctx),r=i=>(this._loadingCount--,n.loadingPromise=null,this._updateGLTexture(n,i),aC(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),n);return(0,_.$X)(i)?i.then(r,(e=>(this._loadingCount--,n.loadingPromise=null,(0,_.zf)(e)||u.A.getLogger(this).error(e),null))):r(i)})),n.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Wp.C7.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};(0,n._)([(0,b.MZ)()],cC.prototype,"_loadingCount",void 0),(0,n._)([(0,b.MZ)()],cC.prototype,"_frameTask",void 0),(0,n._)([(0,b.MZ)()],cC.prototype,"updating",null),cC=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.lib.TextureRepository")],cC);class hC{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(u.A.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}var dC=i(99443),uC=i(73999);var pC=i(95901);let mC=class extends T.A{constructor(){super(...arguments),this._passParameters=new _C,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=(0,p.DC)(this._resourcesTask),this._passParameters.waveNormal=(0,p.WD)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,p.WD)(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=(0,oe.UT)((async t=>{await Promise.allSettled([this._loadImageResource(e,(0,Hi.s)("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,(0,Hi.s)("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?Wp.Am.LOADED:Wp.Am.LOADING}async _loadImageResource(e,t,i,n){try{const r=await(0,Jy.D)(t,{signal:n});(0,_.Te)(n);const s=new Ht.R(r.width,r.height);s.pixelFormat=st.Ab.RGB,s.samplingMode=st.Cj.LINEAR_MIPMAP_LINEAR,s.hasMipmap=!0,s.maxAnisotropy=8,i(new hi.g(e,s,r))}catch(Te){u.A.getLogger(this).error("Failed to load water material normal texture.",Te)}}};(0,n._)([(0,b.MZ)()],mC.prototype,"_resourcesTask",void 0),(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],mC.prototype,"updating",null),mC=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],mC);class _C extends et.Y{}const gC=new Map;function fC(){return gC}var vC=i(30068),yC=i(16770);class bC{constructor(e,t,i){this.parameters=e,this.frameHasDecorations=t,this.fbos=i}}class wC{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Wp.C7.BACKGROUND);const t=(0,_.Tw)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const n={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},r=this._renderScreenshot(e,n,t);i.resolver(r)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const n=e.getContext("2d"),r=i.pixelRatio;return n.save(),n.translate(0,t.height),n.scale(1,-1),i.region&&n.translate(-i.region.x,-i.region.y),n.scale(r,r),t=this._renderFunctions.renderOverlay(e,i.disableDecorations?Wp.ID.OFF:Wp.ID.ON,t),n.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:n,region:r,resample:s}=e,a=this._ensureScreenshotEncodeCanvas();let o=(0,yC.xR)(i,n,a);this._rctx.gl.readPixels(0,0,i,n,st.Ab.RGBA,st.pe.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=(0,yC.xR)(r.width,r.height,a);return(0,vC.Go)(o,l,!0,s.region.x,n-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:n}=e,r=this._ensureScreenshotEncodeCanvas(),s=(0,yC.xR)(n.width,n.height,r);return this._rctx.gl.readPixels(n.x,i-(n.y+n.height),n.width,n.height,st.Ab.RGBA,st.pe.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),this._renderScreenshotOverlay(r,s,e)}_renderScreenshot(e,t,i){var n;const r=e.parameters.camera,s={width:t.framebufferWidth,height:t.framebufferHeight};(0,Vt.T)(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let a=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s.width!==r.fullWidth||s.height!==r.fullHeight,c=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=l||o||c||t.objectAndLayerIdColor;let d=null,u=null;if(h){const e=r.clone();if(t.ignorePadding){const i=(0,Ye.o8)(e.padding);for(let n=0;n<4;n++)i[n]=Math.round(i[n]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s.width,e.fullHeight=s.height,e.pixelRatio=t.pixelRatio;const n=r.fovX-e.fovX,o=r.fovY-e.fovY;n<0&&n<o?e.fovX=r.fovX:o<0&&o<n&&(e.fovY=r.fovY);const l={camera:e,contentCamera:e,mode:So.M.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(l),a=!0;const c=this._renderFunctions.renderScene(l,i,t.objectAndLayerIdColor?Ew.f.ObjectAndLayerID:Ew.f.Screenshot,t.disableDecorations?Wp.ID.OFF:Wp.ID.ON);u=c.screen,d=c.oid}this._rctx.bindFramebuffer(null===(n=u)||void 0===n?void 0:n.fbo);const p=this._readbackScreenshot(t,(()=>{var e;this._rctx.bindFramebuffer(null),null===(e=u)||void 0===e||e.release()}));let m=null;if(t.objectAndLayerIdColor){var _;const e=()=>{var e;this._rctx.bindFramebuffer(null),null===(e=d)||void 0===e||e.release()};this._rctx.bindFramebuffer(null===(_=d)||void 0===_?void 0:_.fbo),m=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(h&&!this._rctx.contextAttributes.alpha)for(let g=3;g<p.data.length;g+=4)p.data[g]=255;if(m&&!this._rctx.contextAttributes.alpha)for(let g=3;g<m.data.length;g+=4)m.data[g]=255;return a&&this._forceCameraHook(e.parameters),[p,m]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const xC=!1;var CC=i(28007);let TC=class extends T.A{constructor(e){super({}),this.events=new B.A,this.waterTextures=new mC,this._magnifierHelper=new ub,this.objectAndLayerIdRenderHelper=(0,d.A)("enable-feature:objectAndLayerId-rendering")?new mb:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode;try{this._initializeContext(e)}catch(re){return void console.error("Failed to initialize context",re)}this.addHandles([(0,g.watch)((()=>{var e;return null===(e=this.waterTextures)||void 0===e?void 0:e.updating}),(()=>this.requestRender()),g.initial),(0,g.watch)((()=>e.view.qualityProfile),(e=>{var t;return null===(t=this.renderer)||void 0===t?void 0:t.updateRenderFeatures(e)}),g.syncAndInitial),this._magnifierHelper.events.on("request-render",(()=>this.requestRender()))]);const{memoryController:t}=e.view.resourceController;this.stippleTextures=(0,pC.Ry)(this._rctx,t),this.markerTextures=function(e,t){return new uC.f((t=>(0,dC.sS)(t,e)),(e=>e),t)}(this._rctx,t),this._shaderTechniques=new Cy.I({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this.stippleTextures,waterTextureRepository:this.waterTextures,markerTextureRepository:this.markerTextures}),this._textures=new cC(e,this._shaderTechniques,this._rctx),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e)))),this._materialRepository=new Ky.v(this._textures,this._shaderTechniques,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new Oy(this._rctx,this._shaderTechniques),this.renderer=new Zx(e,this._materialRepository,this._textures,this._shaderTechniques,this._rctx,this._compositingHelper,this._magnifierHelper,(e=>this.requestRender(e)));const i={renderScene:(e,t,i,n)=>this.renderer.render(e,t,i,n),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(t,i,n)=>e.options.screenshot.renderOverlay(t,i,n)};this._screenshotManager=new wC(this._rctx,i,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=(0,p.xt)(this._frameTask),this._shaderTechniques=(0,p.pR)(this._shaderTechniques),this._componentObjects=(0,p.pR)(this._componentObjects),this._screenshotManager=(0,p.pR)(this._screenshotManager),(0,p.pR)(this.renderer),this._textures=(0,p.pR)(this._textures),(0,p.pR)(this._magnifierHelper),(0,p.pR)(this.waterTextures),(0,p.pR)(this.markerTextures),(0,p.pR)(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=(0,p.pR)(this._rctx)}requestRender(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wp.C7.UPDATE;this._needsRender=!0,e===Wp.C7.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating||this._magnifierHelper.updating}get textureRepository(){return this._textures}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:r;const a=n.constrainWindowSize(t,i,r*n.pixelRatio,s*n.pixelRatio),o=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(n,a,o);let l=Number.MAX_VALUE;for(let c=0;c<a[2]*a[3];c++){const e=Hy(4*c,o,n.nearFar);l>e&&e!==n.nearFar[0]&&e!==n.nearFar[1]&&(l=e)}if(e){const r=e.pickDepth(t*n.pixelRatio,i*n.pixelRatio,n);null!=r&&l>r&&r!==n.nearFar[0]&&r!==n.nearFar[1]&&(l=r)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){Xp(),await this._shaderTechniques.reloadAll(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,n=Wp.C7.BACKGROUND,r=!1;const s={preRender:r=>{let{time:s}=r;i=this.updating,n=this._needsUpdate?Wp.C7.UPDATE:Wp.C7.BACKGROUND,e.commitSyncLayers();const a=(0,Si.l5)(s-this._lastAnimationUpdate);if(a>this.renderer.animationTimestep||null!=t.forcedAnimationTime||i||this._needsRender){const e=(0,Si.l5)(a/this.renderer.animationTimeDilation),i=new jp.sP(t.camera,e,t.forcedAnimationTime);this.renderer.updateAnimation(i)&&this.requestRender(Wp.C7.BACKGROUND),this._lastAnimationUpdate=s}},render:e=>{let{time:i}=e;if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(t,i),r=!0,e&&this.renderer.hasReflections&&(this.requestRender(Wp.C7.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:e=>{let{time:i}=e;const n=this.renderer.hasSlicePlane||this._magnifierHelper.enabled||this.renderer.hasDecorations||this.renderer.hasHighlights,r=new bC(t,n,this.renderer.fboCache);this._textures.update(),this._screenshotManager.update(r,i)},finish:()=>{r&&(this.renderer.finish(t.mode===So.M.IDLE?n:Wp.C7.UPDATE),r=!1)}};this._frameTask=(0,f.mg)(s)}_initializeContext(e){var t,i;const n=e.options;this._canvas=n.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:n.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null===(t=n.stencil)||void 0===t||t,powerPreference:"high-performance",preserveDrawingBuffer:null!==(i=n.preserveDrawingBuffer)&&void 0!==i&&i},s=(0,CC.q)(this._canvas,r);null!=s?(this._rctx=this._newRenderingContext(s,e),this._loadShaderOnlyExtensions(),!n.alpha&&this._rctx.contextAttributes.alpha&&u.A.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,d.A)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):u.A.getLogger(this).error("A WebGL2 context could not be created.")}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},n=(e,i)=>t.view.resourceController.memoryController.newCache(e,i);if(xC){let t=AC.get(e);return t?(t.configure(i),t.newCache=n,t.ref(),t):(t=new sC(e,i,n),AC.set(e,t),t.ref(),t)}return new sC(e,i,n)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return null!=this.objectAndLayerIdRenderHelper?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new vy(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}};(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0})],TC.prototype,"updating",null),(0,n._)([(0,b.MZ)()],TC.prototype,"_rctx",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_container",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_canvas",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"stippleTextures",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"markerTextures",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"waterTextures",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_magnifierHelper",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],TC.prototype,"objectAndLayerIdRenderHelper",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_textures",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],TC.prototype,"renderer",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_screenshotManager",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"componentObjectCollection",null),(0,n._)([(0,b.MZ)()],TC.prototype,"_componentObjects",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_needsUpdate",void 0),(0,n._)([(0,b.MZ)()],TC.prototype,"_needsWaterReflectionUpdate",void 0),TC=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.parts.RenderView")],TC);const AC=fC();let MC=class extends T.A{constructor(e){super(e),this._model=new Xf,this._layers=new oc.A,this._asyncChangeSet=new Uf.VR,this._syncChangeSet=new Uf.VR,this._layerSyncSet=new Set}initialize(){this._set("renderView",new TC(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(qt.W6.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var e;return null===(e=this.renderView)||void 0===e?void 0:e.renderer}add(e){this._model.add(e),(0,qf.r)(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){null!=e&&!this.destroyed&&this._model.remove(e)&&((0,qf.r)(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){null!=e&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){var t,i;null!=e&&(null!==(t=this._model)&&void 0!==t&&t.removeMany(e),null===(i=this.renderView)||void 0===i||i.requestRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return Gt.G}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const n=this._layerSyncSet.has(i.id)||i.updatePolicy===zf.q.SYNC,r=n?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,r),this._layerSyncSet.delete(i.id),r.empty||(this.renderer.modify(r,n?qt.Bb:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qt.Bb),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==zf.q.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===zf.q.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qt.Bb),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qt.Bb),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,qt.Bb))}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),n=()=>{Vd(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,_.$X)(i))return i.then(n);n()}removeRenderPlugin(e){this.destroyed||(Vd(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get performanceInfo(){return this._model.getStats()}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};MC.DebugSettings={endFrameContentValidation:!1},(0,n._)([(0,b.MZ)({constructOnly:!0})],MC.prototype,"view",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],MC.prototype,"options",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],MC.prototype,"viewingMode",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],MC.prototype,"container",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],MC.prototype,"updating",null),(0,n._)([(0,b.MZ)({constructOnly:!0})],MC.prototype,"_model",void 0),(0,n._)([(0,b.MZ)()],MC.prototype,"renderView",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],MC.prototype,"renderer",null),(0,n._)([(0,b.MZ)({readOnly:!0})],MC.prototype,"running",null),MC=(0,n._)([(0,x.$)("esri.views.3d.webgl-engine.Stage")],MC);var SC=i(90992),PC=i(11500),RC=i(59801),EC=i(5404),OC=i(7133);let DC=class extends OC.A{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,n._)([(0,b.MZ)()],DC.prototype,"components",void 0),DC=(0,n._)([(0,x.$)("esri.views.ui.3d.DefaultUI3D")],DC);const IC=DC;let LC=class extends((0,z.c)((0,K.e)((0,q.u)(J.A)))){constructor(e){var t;super(e),t=this,this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new Ao.M({slicePlane:N.B},this),this._resourceController=function(e){return new Cu({view:e})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new kc({view:this}),this.labeler=new Zc.C({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new U.X,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Se,this.environment=new ze,this.environmentManager=new ln,this.floors=new a.A,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new pe({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Cd,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new IC,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new eu,(0,y.n_)();const i=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===m.R.MOVE||(t._updatingChanged(),t.map&&t.map.allLayers.forEach((async e=>{try{await e.when()}catch{}t._updatingChanged()})))};this.addHandles([(0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.allLayers}),"after-changes",(e=>i(e)),{onListenerAdd:()=>i(),onListenerRemove:()=>i(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),(0,g.watch)((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new sc({view:this}),this.stateManager=new Po({view:this})}initialize(){this.groundView=new $({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.addHandles((0,g.on)((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.allLayers}),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),g.initial),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),g.initial),this.updatingHandles.add((()=>{var e;return null!==(e=this.qualitySettings.frameRate)&&void 0!==e?e:0}),(e=>(0,f.QL)(e>0?1e3/Math.ceil(e):0)),g.initial),this.updatingHandles.add((()=>{var e;return null===(e=this.map)||void 0===e?void 0:e.ground}),e,g.syncAndInitial),this.updatingHandles.add((()=>{var e;return null===(e=this.map)||void 0===e||null===(e=e.ground)||void 0===e?void 0:e.opacity}),(()=>this._updateDefaultHitTestOptions()),g.syncAndInitial),this.addHandles((0,g.watch)((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),g.sync))}destroy(){var e;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,p.pR)(this.sharedSymbolResources),this._set("labeler",(0,p.pR)(this.labeler)),this._set("deconflictor",(0,p.pR)(this.deconflictor)),this._resourceController=(0,p.pR)(this._resourceController),this._set("stateManager",(0,p.pR)(this.stateManager)),this._set("inputManager",(0,p.pR)(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,p.pR)(this.environmentManager)),this._set("environment",(0,p.pR)(this.environment)),this.groundView=(0,p.pR)(this.groundView),this._exitBasemapTerrain(),null===(e=this._stage)||void 0===e||e.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.spatialReference}get animation(){var e;return null===(e=this.state)||void 0===e?void 0:e.animation}get camera(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}get center(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||(0,p.eJ)(e,"clippingArea");return!this._userClippingArea&&!(0,p.eJ)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof ao.A?this.spatialReference&&(t=NC(t,this.spatialReference),null==t)?(u.A.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(u.A.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?u.A.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===te.RT.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:NC(t,e)}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||k.A.WGS84,i=NC(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const n=this._get("dataExtent");return null!=e&&e.equals(n)?n:e}get _groundAndLayersExtent(){var e,t;const i=this.spatialReference||k.A.WGS84;let n;const r=e=>{const t=NC(e,i);null!=t&&(null!=n?n.union(t):n=t.clone())},s=this.basemapTerrain;if(null!==s&&void 0!==s&&s.spatialReference){const e=s.groundExtent;r(new ao.A({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map){const e=e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||r(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(null==n)return null;n.hasZ?(n.zmin=Math.min(0,null!==(e=n.zmin)&&void 0!==e?e:0),n.zmax=Math.max(0,null!==(t=n.zmax)&&void 0!==t?t:0)):(n.zmin=0,n.zmax=0);const a=this._get("_groundAndLayersExtent");return n.equals(a)?a:n}castEnvironment(e){var t,i;return e?e instanceof ze?e:e instanceof Fe.A?null!==(t=null===(i=this.environment)||void 0===i?void 0:i.cloneWithWebsceneEnvironment(e))&&void 0!==t?t:ze.fromWebsceneEnvironment(e):(0,C.dp)(ze,e):new ze}get extent(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.screenCenter}get frustum(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var e,t;return this.navigating||null!==(e=null===(t=this.toolViewManager)||void 0===t?void 0:t.interacting)&&void 0!==e&&e}get stationary(){return!this.animation&&!this.resizing&&(null==this.state||this.state.stationary)}get navigating(){var e,t;return null!==(e=null===(t=this.state)||void 0===t?void 0:t.navigating)&&void 0!==e&&e}get padding(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){Qd.isValidProfile(e)&&(Qd.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||Qd.getDefaultProfile()}set slicePlane(e){if(null!=this._stage&&this._stage.renderer.setParameters({slicePlane:e}),null==e)return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");(0,N.c)(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&this.stateManager.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?(0,V.i1)(this.scale,this.spatialReference):0}get scale(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?E.A.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return!1;let n=0,r=this.layerViewManager.updating,s=r?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(r=!0,e.suspended||(0,Vp.eS)(e))return;++s,n+=e.updatingProgress}}else++s}));for(const o of this._updatingObjects)if(null!=o&&o.updating){const e=.1;s+=e,n+=.5*e}for(const o of this._updatingObjectsWithProgress)null!=o&&o.updating&&(++s,n+=o.updatingProgress);const a=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(r=!!(r||s>0||this.updatingHandles.updating||!this.ready||!this.stationary||a||this._createGraphicsViewController||null!==(e=this.inputManager)&&void 0!==e&&e.updating||null!==(t=this.map)&&void 0!==t&&null!==(t=t.allLayers)&&void 0!==t&&t.some((e=>!e.isFulfilled()))||null!==(i=this.textures)&&void 0!==i&&i.updating),r?(this._numUpdating=Math.max(s,this._numUpdating),n+=this._numUpdating-s):this._numUpdating=0,this._numUpdating>0?n/=this._numUpdating:n=r?0:1,this._get("updatingProgress")!==n){const e=performance.now();if(n<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);n=this.updatingProgress*(1-t)+n*t}this._set("updatingProgress",n),this._lastUpdateTime=r&&n<1?e:0}return r}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var e;const t=this._predeterminedViewingMode;if(null!=t)return(0,te._s)(t);const i=this.spatialReference;return i?null!=(null===(e=this.defaultsFromMap)||void 0===e?void 0:e.viewingMode)&&i.equals(this.defaultsFromMap.spatialReference)?(0,te._s)(this.defaultsFromMap.viewingMode):(0,RC.M)(i,te.RT.Global)?"global":"local":"global"}set viewingMode(e){this.ready?u.A.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get resourceController(){return this._resourceController}get quality(){var e,t;return null!==(e=null===(t=this._resourceController)||void 0===t||null===(t=t.memoryController)||void 0===t?void 0:t.memoryFactor)&&void 0!==e?e:1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Su(this)}on(e,t,i,n){return this.viewEvents.on(e,t,i,n)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return u.A.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=(0,PC.FV)(e)?(0,PC.xB)(this,e):e;return(0,Sd.av)(this,i,t,this._defaultToMapOptions)}toScreen(e){var t;if(!this.ready)return u.A.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const i=null!==(t=null==e.z?(0,Xd.R1)(this.elevationProvider,e):null)&&void 0!==t?t:0;return(0,I.g)(e,FC,this.renderSpatialReference,i),this.state.camera.projectToScreen(FC,VC),(0,v.tc)(VC[0],VC[1])}pixelSizeAt(e){return this.ready?e?((0,I.g)(e,FC,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(FC)):0:(u.A.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return u.A.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,PC.FV)(e)?(0,PC.xB)(this,e):e;return(0,Sd.CB)(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return lu(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new l.A("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return(0,vC.lF)(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return(0,vC.Rt)(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t);return[(0,vC.Rt)(i[0],this._pixelFormat()),(0,vC.Rt)(i[1],this._pixelFormat())]}_completeSettings(e){const t=(0,vC.Qn)(e,this);return t.pixelRatio/=this.state.pixelRatio,(0,vC.LK)(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e),takeScreenshotWithObjectAndLayerId:e=>this._takeScreenshotWithObjectAndLayerId(e)}}async takeScreenshotWithObjectAndLayerId(e){if(!(0,d.A)("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t),n=(0,vC.lF)(i[0],t,this._pixelFormat()),r=this._completeSettings(e);return r.format="png",[n,(0,vC.lF)(i[1],r,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(null==this._stage.renderView.objectAndLayerIdRenderHelper)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return ae(e)}hasLayerViewModule(e){return se(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i;return this.map&&"initialViewProperties"in this.map&&(null===(e=this.map.initialViewProperties)||void 0===e?void 0:e.spatialReference)||(null===(t=this.defaultsFromMap)||void 0===t?void 0:t.spatialReference)||(null===(i=this.defaultsFromMap)||void 0===i?void 0:i.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=(0,EC.z)(this.type);const t=(0,d.A)("safari");if(t&&t<9&&(e=new l.A("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw u.A.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){var e,t;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):null!==(e=this.map&&"initialViewProperties"in this.map?null===(t=this.map.initialViewProperties)||void 0===t?void 0:t.viewingMode:null)&&void 0!==e?e:null;return null!=i?(0,te.yX)(i):null}getSpatialReferenceSupport(e){let{spatialReference:t,layer:i}=e;const n=this._predeterminedViewingMode;if(null!=n)return this._validateSpatialReferenceForViewingMode(t,i,n)?{constraints:this._makeSpatialReferenceConstraints(t,i,n)}:null;const r=this._validateSpatialReferenceForViewingMode(t,i,te.RT.Local),s=this._validateSpatialReferenceForViewingMode(t,i,te.RT.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(t,i,null)}:r?{constraints:this._makeSpatialReferenceConstraints(t,i,te.RT.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,i,te.RT.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!(0,RC.M)(e,i)&&(null==t||!!(0,H.qC)(t)||(!(0,H.qK)(t)||null!=(0,Vp.Uo)(t,e,i))&&(!(0,H.qe)(t)||i!==te.RT.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const n=e.isWebMercator,r=e.isWGS84;return(0,H.qC)(t)&&(n||r)?r&&i!==te.RT.Local&&null!==(0,Vp._y)(t.tileInfo,t.fullExtent,e,te.RT.Global)?[{spatialReference:n?k.A.WGS84:k.A.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:k.A.WebMercator,viewingMode:i}]:(0,H.qK)(t)||(0,H.qe)(t)||!n&&!r?(0,H.qK)(t)&&n&&i!==te.RT.Global?[{spatialReference:e,viewingMode:i},{spatialReference:k.A.WGS84,viewingMode:te.RT.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:n?k.A.WGS84:k.A.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport({spatialReference:e}),i=this._predeterminedViewingMode;return t||(null!=i?u.A.getLogger(this).warnOnce("Spatial reference defined on view not supported in ".concat((0,te._s)(i)," viewing mode.")):e.isGeographic&&u.A.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return u.A.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,n=!1;const r=t=>{var r;!n&&null!=t&&"processor"in t&&"graphics-3d"===(null===(r=t.processor)||void 0===r?void 0:r.type)&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?r(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>r(e)),(()=>{})).catch((()=>{})),(0,h.hA)((()=>{n=!0,null!=i&&(i.remove(),i=null)}))}highlight(e){if(Array.isArray(e))return(0,h.vE)(e.map((e=>this.highlight(e))));if(a.A.isCollection(e))return(0,h.vE)(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):(0,h.hA)()}maskOccludee(e){if(!e)return u.A.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,n=!1;const r=t=>{!n&&null!=t&&(0,SC.Uk)(t)&&(i=t.maskOccludee(e))};return null!=t?r(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>r(e)),(()=>{})).catch((()=>{})),(0,h.hA)((()=>{n=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await(0,g.whenOnce)((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new l.A("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const n=this.map.allLayers.on("change",(r=>{r.added.includes(e.layer)&&(n.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new Af({view:this})),this._set("elevationProvider",new Bd({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new fp({view:this})),this._set("featureTiles",new fd({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{var e;const t=null===(e=this.basemapTerrain)||void 0===e?void 0:e.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?(0,O.project)((0,L.w1)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;null!=this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>lc.b.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(i.e(14458).then(i.bind(i,14458))).then((e=>{let{FeatureTileTree3DDebugger:t}=e;!this._featureTreeDebugger&&lc.b.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))})):e||!this._featureTreeDebugger||lc.b.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),g.syncAndInitial),this.updatingHandles.add((()=>this.clippingArea),e,g.syncAndInitial),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,g.syncAndInitial)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new su(this.map,e));const t=this.state.isGlobal,i=(0,F.Gs)(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",fu.d.create(this.state.viewingMode,i)),t||this.addHandles((0,g.watch)((()=>{var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.extent}),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!(0,D.S)(e,this.basemapTerrain.spatialReference,HC,t)||(this.renderCoordsHelper.extent=HC)}),g.sync),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Ms.TH/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!=e&&e.type===m.R.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles((0,g.watch)((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),g.sync),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const n=e.getContext("2d");return n.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t===Wp.ID.OFF}),n.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Ed(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=(0,o.$H)(this.surface);this._stage=new MC({view:this,options:e,container:i}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),g.initial),(0,g.watch)((()=>this.magnifier),(e=>this._stage.renderView.magnifier=e),g.syncAndInitial),this.on("pointer-move",(()=>{var e;return null===(e=this._stage)||void 0===e?void 0:e.renderer.resetAnimation()})),(0,c.on)(this._stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new l.A("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Ms.TH/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=(0,p.pR)(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Uu({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await Promise.all([i.e(27391),i.e(43894)]).then(i.bind(i,15477))).default;(0,_.Te)(e),await(0,g.whenOnce)((()=>{var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.ready}),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){var e;const t=(0,te.yX)(this.viewingMode);t===te.RT.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.addHandles((0,g.on)((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded();const i=this.map&&"initialViewProperties"in this.map?null===(e=this.map.initialViewProperties)||void 0===e?void 0:e.environment:void 0;i&&S(this.environment,i),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new Lu(this._stage,this.resourceController.scheduler));const n=this._resolveWhenReady;this._resolveWhenReady=[],n.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",(0,p.pR)(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Ws.fo);for(const e of this.map.allLayers.items)(0,H.Eq)(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Ws.fo);for(const e of this.map.allLayers.items)(0,H.Eq)(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function NC(e,t){return null!=e&&(0,O.canProjectWithoutEngine)(e.spatialReference,t)?(0,O.project)(e,t):null}LC.type="3d",(0,n._)([(0,b.MZ)()],LC.prototype,"_userClippingArea",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"_resourceController",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"_stage",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"deconflictor",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"labeler",void 0),(0,n._)([(0,b.MZ)((0,R.C)(U.X,"analyses"))],LC.prototype,"analyses",void 0),(0,n._)([(0,b.MZ)({type:ee.A,readOnly:!0})],LC.prototype,"animation",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"basemapTerrain",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"elevationProvider",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"camera",null),(0,n._)([(0,b.MZ)({type:r.A})],LC.prototype,"contentCamera",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"canvas",void 0),(0,n._)([(0,b.MZ)({type:oo.A})],LC.prototype,"center",null),(0,n._)([(0,b.MZ)({type:ao.A})],LC.prototype,"clippingArea",null),(0,n._)([(0,b.MZ)({type:Se})],LC.prototype,"constraints",void 0),(0,n._)([(0,b.MZ)({type:ao.A,readOnly:!0})],LC.prototype,"renderDataExtent",null),(0,n._)([(0,b.MZ)({type:ao.A,readOnly:!0})],LC.prototype,"dataExtent",null),(0,n._)([(0,b.MZ)({type:ao.A,readOnly:!0})],LC.prototype,"_groundAndLayersExtent",null),(0,n._)([(0,b.MZ)({type:ze})],LC.prototype,"environment",void 0),(0,n._)([(0,w.w)("environment")],LC.prototype,"castEnvironment",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"environmentManager",void 0),(0,n._)([(0,b.MZ)({type:ao.A})],LC.prototype,"extent",null),(0,n._)([(0,b.MZ)()],LC.prototype,"floors",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"screenCenter",null),(0,n._)([(0,b.MZ)()],LC.prototype,"frustum",null),(0,n._)([(0,b.MZ)({type:Number,readOnly:!0})],LC.prototype,"fullOpacity",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"graphicsView",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"analysisViewManager",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"groundView",void 0),(0,n._)([(0,b.MZ)({type:Boolean})],LC.prototype,"initialExtentRequired",null),(0,n._)([(0,b.MZ)()],LC.prototype,"_defaultsFromMapSettings",null),(0,n._)([(0,b.MZ)()],LC.prototype,"interacting",null),(0,n._)([(0,b.MZ)()],LC.prototype,"stationary",null),(0,n._)([(0,b.MZ)()],LC.prototype,"navigating",null),(0,n._)([(0,b.MZ)()],LC.prototype,"map",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"mapCoordsHelper",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"padding",null),(0,n._)([(0,b.MZ)({type:fp,readOnly:!0})],LC.prototype,"pointsOfInterest",void 0),(0,n._)([(0,b.MZ)({type:fd,readOnly:!0})],LC.prototype,"featureTiles",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"_featureTreeDebugger",void 0),(0,n._)([(0,b.MZ)({type:Boolean})],LC.prototype,"screenSizePerspectiveEnabled",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],LC.prototype,"deactivatedWebGLExtensions",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],LC.prototype,"debugWebGLExtensions",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],LC.prototype,"renderCanvas",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],LC.prototype,"state",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"inputManager",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"stateManager",void 0),(0,n._)([(0,b.MZ)({type:["low","medium","high"]})],LC.prototype,"qualityProfile",null),(0,n._)([(0,b.MZ)({type:gu,get(){let e=this._get("qualitySettings");return e||(e=new gu,Qd.apply(this.qualityProfile,e)),e}})],LC.prototype,"qualitySettings",void 0),(0,n._)([(0,b.MZ)()],LC.prototype,"slicePlane",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"typeSpecificPreconditionsReady",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"renderCoordsHelper",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"sceneIntersectionHelper",void 0),(0,n._)([(0,b.MZ)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],LC.prototype,"resolution",null),(0,n._)([(0,b.MZ)({type:Number})],LC.prototype,"scale",null),(0,n._)([(0,b.MZ)()],LC.prototype,"heightModelInfo",null),(0,n._)([(0,b.MZ)()],LC.prototype,"spatialReference",void 0),(0,n._)([(0,b.MZ)({type:Boolean,constructOnly:!0})],LC.prototype,"alphaCompositingEnabled",void 0),(0,n._)([(0,b.MZ)({constructOnly:!0})],LC.prototype,"preserveDrawingBufferEnabled",void 0),(0,n._)([(0,b.MZ)({type:Boolean})],LC.prototype,"supersampleScreenshotsEnabled",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"type",void 0),(0,n._)([(0,b.MZ)(),(0,w.w)((e=>e instanceof OC.A?e:(0,C.PZ)(IC,e)))],LC.prototype,"ui",void 0),(0,n._)([(0,b.MZ)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],LC.prototype,"updating",null),(0,n._)([(0,b.MZ)()],LC.prototype,"_updatingObjects",null),(0,n._)([(0,b.MZ)()],LC.prototype,"_updatingObjectsWithProgress",null),(0,n._)([(0,b.MZ)({type:Number,readOnly:!0,dependsOn:["updating"]})],LC.prototype,"updatingProgress",void 0),(0,n._)([(0,b.MZ)({type:["global","local"]})],LC.prototype,"viewingMode",null),(0,n._)([(0,b.MZ)({type:s.A})],LC.prototype,"viewpoint",null),(0,n._)([(0,b.MZ)({type:Number})],LC.prototype,"zoom",null),(0,n._)([(0,b.MZ)({type:eu})],LC.prototype,"highlightOptions",void 0),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"quality",null),(0,n._)([(0,b.MZ)({readOnly:!0})],LC.prototype,"resolutionScale",null),(0,n._)([(0,b.MZ)()],LC.prototype,"textures",void 0),LC=(0,n._)([(0,x.$)("esri.views.SceneView")],LC);const FC=(0,P.vt)(),VC=(0,v.gs)(),HC=(0,L.vt)(),UC=LC},92271:(e,t,i)=>{i.d(t,{u:()=>s});var n=i(50346),r=i(49003);async function s(e){const t=i.e(5047).then(i.bind(i,5047)),s=i.e(68193).then(i.bind(i,68193)),a=(0,r.D)((await t).default,{signal:e}),o=(0,r.D)((await s).default,{signal:e}),l={mask:await a,overlay:await o};return(0,n.Te)(e),l}},65353:(e,t,i)=>{i.d(t,{S:()=>n});class n{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}},92e3:(e,t,i)=>{i.d(t,{t:()=>n});class n{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}},25600:(e,t,i)=>{i.d(t,{P:()=>a});var n=i(15941),r=i(65353),s=i(92e3);class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=n,this.enabled=!0,this.value=new r.S(.8),this.time=new r.S(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,n.qE)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new s.t(e,t,i)}}},95395:(e,t,i)=>{i.d(t,{O:()=>l});var n=i(20664),r=i(9392),s=i(65353),a=i(92e3);class o extends a.t{constructor(e,t,i,n,r){super(e,t,i),this._sceneVelocity=n,this.direction=r}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}class l{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new s.S(.6),this._screen=[new s.S(.4),new s.S(.4)],this._scene=[new s.S(.6),new s.S(.6),new s.S(.6)],this._tmpDirection=(0,r.vt)()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),n=this._time.filteredDelta,r=null==n||null==i?0:i/n;return Math.abs(r)<this._minimumInitialVelocity?null:this.createMomentum(r,this._stopVelocity,this._friction)}createMomentum(e,t,i){var r,s,a;(0,n.s)(this._tmpDirection,null!==(r=this._scene[0].filteredDelta)&&void 0!==r?r:0,null!==(s=this._scene[1].filteredDelta)&&void 0!==s?s:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);const l=(0,n.l)(this._tmpDirection);l>0&&(0,n.h)(this._tmpDirection,this._tmpDirection,1/l);const c=this._time.filteredDelta;return new o(e,t,i,null==c?0:l/c,this._tmpDirection)}}},31158:(e,t,i)=>{i.d(t,{H:()=>r});var n=i(25600);class r extends n.P{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){const i=this.value.lastValue;if(null!=i){let t=e-i;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=i+t}super.add(e,t)}}},13121:(e,t,i)=>{i.d(t,{y:()=>a});var n=i(92e3),r=i(25600);class s extends n.t{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),n=super.value(e+t)-i;return Math.exp(n)}}class a extends r.P{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new s(e,t,i)}}},53787:(e,t,i)=>{async function n(e,t){var i;if("2d"===e.type)return e.hitTest(t);const n=await e.hitTest(t);if(0===n.results.length)return n;const s=n.results[0],a=(null!==(i=s.distance)&&void 0!==i?i:0)*(1+r),o=n.results.findIndex((e=>{var t;return(null!==(t=e.distance)&&void 0!==t?t:0)>a}));return-1!==o&&(n.results=n.results.slice(0,o)),s&&n.ground.distance>a&&(n.ground.mapPoint=null),n}i.d(t,{h$:()=>o,oZ:()=>n,zF:()=>a});const r=.05;function s(e){return"graphic"===(null===e||void 0===e?void 0:e.type)}function a(e){var t;return null!==(t=e.find(s))&&void 0!==t?t:null}function o(e){return e.filter(s)}},90992:(e,t,i)=>{function n(e){return e&&"function"==typeof e.highlight}function r(e){return e&&"function"==typeof e.maskOccludee}function s(e,t,i){return null==e||e>i&&(0===t||e<t)}function a(e,t){return null!=e&&e>0||null!=t&&t>0}function o(e){var t,i;const n=e.effectiveScaleRange;return{minScale:null!==(t=null===n||void 0===n?void 0:n.minScale)&&void 0!==t?t:0,maxScale:null!==(i=null===n||void 0===n?void 0:n.maxScale)&&void 0!==i?i:0}}function l(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatures"in e&&"layer"in e&&"view"in e}i.d(t,{Cf:()=>o,JU:()=>s,Of:()=>n,Uk:()=>r,WK:()=>a,lO:()=>l})},71853:(e,t,i)=>{i.d(t,{EO:()=>g,OI:()=>m,Pp:()=>d,Qg:()=>u,VC:()=>p,b4:()=>o,hB:()=>f,hE:()=>c,kc:()=>l,xV:()=>h,z:()=>_});var n=i(72745),r=i(93345),s=i(98433),a=i(96673);function o(e,t){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest";const o=!(arguments.length>3&&void 0!==arguments[3]&&arguments[3]&&"u8"===t.pixelType),l=o?r.ld.FLOAT:r.ld.UNSIGNED_BYTE,c=null==t.pixels||0===t.pixels.length?null:o?t.getAsRGBAFloat():t.getAsRGBA(),h=null===(i=e.capabilities.textureFloat)||void 0===i?void 0:i.textureFloatLinear,d=new a.R;return d.width=t.width,d.height=t.height,d.internalFormat=o?r.H0.RGBA32F:r.Ab.RGBA,d.samplingMode=!h||"bilinear"!==n&&"cubic"!==n?r.Cj.NEAREST:r.Cj.LINEAR,d.dataType=l,d.wrapMode=r.pF.CLAMP_TO_EDGE,new s.g(e,d,c)}function l(e,t){const{spacing:i,offsets:n,coefficients:o,size:[l,c]}=t,h=i[0]>1,d=new a.R;d.width=h?4*l:l,d.height=c,d.internalFormat=r.H0.RGBA32F,d.dataType=r.ld.FLOAT,d.samplingMode=r.Cj.NEAREST,d.wrapMode=r.pF.CLAMP_TO_EDGE;const u=new Float32Array(h?l*c*16:2*n.length);if(h&&null!=o)for(let r=0,s=0;r<o.length;r++)u[s++]=o[r],r%3==2&&(u[s++]=1);else for(let r=0;r<c;r++)for(let e=0;e<l;e++){const t=4*(r*l+e),i=2*(e*c+r);u[t]=n[i],u[t+1]=n[i+1],u[t+3]=-1===n[i]?0:1}return new s.g(e,d,u)}function c(e,t){const i=new a.R;return i.internalFormat=r.Ab.RGBA,i.width=t.length/4,i.height=1,i.samplingMode=r.Cj.NEAREST,i.wrapMode=r.pF.CLAMP_TO_EDGE,new s.g(e,i,t)}function h(e,t,i){return{u_flipY:!(arguments.length>4&&void 0!==arguments[4])||arguments[4],u_applyTransform:!!e,u_opacity:arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,u_transformSpacing:e?e.spacing:n.uY,u_transformGridSize:e?e.size:n.uY,u_targetImageSize:t,u_srcImageSize:i}}function d(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function u(e,t){return{u_scale:e,u_offset:t}}function p(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function m(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}function _(e,t){const i=e.gl,n=t.glName,r=new Map;if(null==n)return r;const s=i.getProgramParameter(n,i.ACTIVE_UNIFORMS);let a;for(let o=0;o<s;o++)a=i.getActiveUniform(n,o),a&&r.set(a.name,{location:i.getUniformLocation(n,a.name),info:a});return r}function g(e,t,i){Object.keys(i).forEach((n=>{const s=t.get(n)||t.get(n+"[0]");s&&function(e,t,i,n){if(null===n||null==i)return!1;const{info:s}=n;switch(s.type){case r.xV.FLOAT:s.size>1?e.setUniform1fv(t,i):e.setUniform1f(t,i);break;case r.xV.FLOAT_VEC2:e.setUniform2fv(t,i);break;case r.xV.FLOAT_VEC3:e.setUniform3fv(t,i);break;case r.xV.FLOAT_VEC4:e.setUniform4fv(t,i);break;case r.xV.FLOAT_MAT3:e.setUniformMatrix3fv(t,i);break;case r.xV.FLOAT_MAT4:e.setUniformMatrix4fv(t,i);break;case r.xV.INT:s.size>1?e.setUniform1iv(t,i):e.setUniform1i(t,i);break;case r.xV.BOOL:e.setUniform1i(t,i?1:0);break;case r.xV.INT_VEC2:case r.xV.BOOL_VEC2:e.setUniform2iv(t,i);break;case r.xV.INT_VEC3:case r.xV.BOOL_VEC3:e.setUniform3iv(t,i);break;case r.xV.INT_VEC4:case r.xV.BOOL_VEC4:e.setUniform4iv(t,i);break;default:return!1}}(e,n,i[n],s)}))}function f(e,t,i,n){i.length===n.length&&(n.some((e=>null==e))||i.some((e=>null==e))||i.forEach(((i,r)=>{t.setUniform1i(i,r),e.bindTexture(n[r],r)})))}},41653:(e,t,i)=>{i.d(t,{A:()=>x});var n=i(35143),r=i(42553),s=i(53084),a=i(76460),o=i(46053),l=(i(81806),i(85842)),c=i(68814),h=i(53203),d=i(30650),u=i(98277),p=i(99372),m=i(13206),_=i(45355);const g={base:m.A,key:"type",typeMap:{color:_.A}};const f={types:g,json:{read:(v=g,(e,t,i)=>{if(!e)return e;for(const n in v.typeMap)if(e.type===n){const t=new v.typeMap[n];return t.read(e,i),t}}),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var v,y;const b=(e,t,i)=>({enabled:!i||!i.isPresentation});let w=y=class extends r.oY{constructor(e){super(e),this.lighting=new u.A,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){(0,h.TJ)(null===e||void 0===e?void 0:e.type,a.A.getLogger(this))&&this._set("weather",e)}clone(){return new y(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?p.A.prototype.clone.call(this.lighting):u.A.prototype.clone.call(this.lighting),background:(0,s.o8)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};(0,n._)([(0,o.MZ)({types:d.S,nonNullable:!0,json:{write:!0}})],w.prototype,"lighting",void 0),(0,n._)([(0,o.MZ)(f)],w.prototype,"background",void 0),(0,n._)([(0,o.MZ)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:b}}})],w.prototype,"atmosphereEnabled",void 0),(0,n._)([(0,o.MZ)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:b}}})],w.prototype,"starsEnabled",void 0),(0,n._)([(0,o.MZ)({types:h.eM,nonNullable:!0,json:{write:!0},value:new c.A})],w.prototype,"weather",null),w=y=(0,n._)([(0,l.$)("esri.webscene.Environment")],w);const x=w},98277:(e,t,i)=>{i.d(t,{A:()=>d});var n,r=i(35143),s=i(42553),a=i(46053),o=(i(81806),i(76460),i(47249),i(28379)),l=i(85842),c=i(17707);let h=n=class extends s.oY{constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new n(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};(0,r._)([(0,a.MZ)({readOnly:!0,type:["sun"],json:{write:!0}})],h.prototype,"type",void 0),(0,r._)([(0,a.MZ)({type:Date,json:{type:Number,write:{target:"datetime"}}})],h.prototype,"date",void 0),(0,r._)([(0,o.w)("date",["datetime"])],h.prototype,"readDate",null),(0,r._)([(0,c.K)("date")],h.prototype,"writeDate",null),(0,r._)([(0,a.MZ)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],h.prototype,"directShadowsEnabled",void 0),(0,r._)([(0,o.w)("directShadowsEnabled",["directShadows"])],h.prototype,"readDirectShadowsEnabled",null),(0,r._)([(0,c.K)("directShadowsEnabled")],h.prototype,"writedirectShadowsEnabled",null),(0,r._)([(0,a.MZ)({type:Number,json:{write:!0}})],h.prototype,"displayUTCOffset",void 0),(0,r._)([(0,c.K)("displayUTCOffset")],h.prototype,"writeDisplayUTCOffset",null),h=n=(0,r._)([(0,l.$)("esri.webscene.SunLighting")],h);const d=h},99372:(e,t,i)=>{i.d(t,{A:()=>c});var n,r=i(35143),s=i(42553),a=i(46053),o=(i(81806),i(76460),i(47249),i(85842));let l=n=class extends s.oY{constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new n(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};(0,r._)([(0,a.MZ)({readOnly:!0,type:["virtual"],json:{write:!0}})],l.prototype,"type",void 0),(0,r._)([(0,a.MZ)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=n=(0,r._)([(0,o.$)("esri.webscene.VirtualLighting")],l);const c=l},13206:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(35143),r=i(42553),s=i(46053),a=(i(81806),i(76460),i(47249),i(85842));let o=class extends r.oY{constructor(e){super(e)}clone(){}};(0,n._)([(0,s.MZ)({readOnly:!0,json:{read:!1}})],o.prototype,"type",void 0),o=(0,n._)([(0,a.$)("esri.webscene.background.Background")],o);const l=o},45355:(e,t,i)=>{i.d(t,{A:()=>p});var n,r=i(35143),s=i(69539),a=i(46053),o=(i(81806),i(76460),i(47249),i(6409)),l=i(85842),c=i(85192),h=i(13206);const d={...c.E,nonNullable:!0};let u=n=class extends h.A{constructor(e){super(e),this.type="color",this.color=new s.A([0,0,0,1])}clone(){return new n(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,r._)([(0,o.e)({color:"color"},{readOnly:!0})],u.prototype,"type",void 0),(0,r._)([(0,a.MZ)(d)],u.prototype,"color",void 0),u=n=(0,r._)([(0,l.$)("esri.webscene.background.ColorBackground")],u);const p=u},30650:(e,t,i)=>{i.d(t,{S:()=>s});var n=i(98277),r=i(99372);const s={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:n.A,virtual:r.A}}}}]);
//# sourceMappingURL=86575.f7a4bf75.chunk.js.map